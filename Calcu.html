<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>EnCho-エンチョ- | 延長・預り保育ツール</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="icon" href="favicon.svg" type="image/svg+xml" />
  <script src="theme.js"></script>
  <script>
    window.EnchoTheme?.applyCurrentTheme(document);
  </script>
  <script src="session.js"></script>
  <link rel="stylesheet" href="swipe-rail.css">
  <script src="swipe-rail.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    :root{
      --accent:#8b5cf6;
      --accent-2:#f59e0b;
      --accent-3:#22d3ee;
      --accent-4:#fb7185;
      --muted:#2f2a40;
      --window-layer:220;
      --nougat-layer:220;
      --panel:#ffffff;
      --panel-sub:#fdf7ff;
      --border:#e7dff2;
      --text:#1f1b2d;
      --subtext:#6b6477;
      --bg:radial-gradient(circle at 18% 20%, rgba(255,221,235,.8), transparent 40%), radial-gradient(circle at 80% 8%, rgba(189,227,255,.7), transparent 34%), linear-gradient(180deg,#fff8fd,#f5f7ff);
      --panel-overlay:rgba(255,255,255,.92);
      --weekend-bg:rgba(139,92,246,.16);
      --weekday-bg:rgba(245,158,11,.12);
      --glow:0 10px 30px rgba(139,92,246,.18);
      --header-peek-height:calc(64px + env(safe-area-inset-top, 0px));
      --toast-bg:#1f1b2d;
      --theme-h:265;
      --theme-s:78%;
      --theme-l:66%;
      --theme:hsl(var(--theme-h) var(--theme-s) var(--theme-l));
      --glass-bg:rgba(255,255,255,0.14);
      --glass-border:rgba(255,255,255,0.28);
      --glass-blur:16px;
      --summary-layer-height:0px;
      --layer-handle-height:28px;
      --layer-handle-offset:calc(var(--layer-handle-height) / 2);

      /* カードサイズ（ミディアム） */
      --daycard-width:104px;
      --daycard-col-width:116px;
      --daycard-min-height:118px;
      --daycard-gap:6px;
      --daycard-padding:7px 7px;
      --daycard-date-size:19px;
      --daycard-week-size:10px;
      --daycard-label-size:10px;
      --daycard-chip-font-size:10px;
      --daycard-chip-padding:7px 7px;

      /* ブログカードサイズ（ミディアム） */
      --blogcard-min-width:260px;
      --blogcard-min-height:180px;
      --blogcard-gap:12px;
      --blogcard-padding:12px;
      --blogcard-title-size:15px;
      --blogcard-desc-size:12px;
      --blogcard-tag-size:11px;
      --blogcard-meta-size:12px;
      --blogcard-visual-ratio:4 / 3;
    }
    *{box-sizing:border-box;}
    html,body{margin:0;padding:0;}
    body{
      font-family:"Noto Sans JP","Inter",system-ui,-apple-system,"Segoe UI",sans-serif;
      background:#fff;
      color:var(--text);line-height:1.6;
      touch-action: manipulation;
      overscroll-behavior: none;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      position:relative;
      overflow-x:hidden;
      overflow-y:auto;
    }

    header{
      background:var(--panel-overlay, rgba(255,255,255,.92));
      color:var(--text);padding:12px 18px 14px;
      display:flex;justify-content:center;
      align-items:stretch;
      position:sticky;top:0;z-index:calc(var(--window-layer) + 10);
      box-shadow:0 12px 30px rgba(61,51,92,.12);
      border-bottom:1px solid var(--border);
      backdrop-filter:blur(10px);
      transition:max-height .24s ease, box-shadow .24s ease, opacity .24s ease;
      overflow:visible;
      max-height:2000px;
      touch-action: pan-y;
    }
    header[data-stage="expanded"]{max-height:2000px;}
    header[data-stage="collapsed"]{
      max-height:var(--header-peek-height);
      opacity:.94;
      box-shadow:0 6px 16px rgba(61,51,92,.12);
      padding:8px 18px 10px;
    }
    .header-hidden{
      transform:translateY(-105%);
      opacity:.92;
      box-shadow:0 6px 14px rgba(61,51,92,.06);
    }
    .header-inner{
      width:100%;
      max-width:1440px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    header[data-stage="collapsed"] .header-inner{
      justify-content:flex-end;
      gap:4px;
    }
    .header-topline{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:nowrap;
      width:100%;
    }
    .header-actions{
      position:relative;
      z-index:calc(var(--nougat-layer) + 120);
      display:flex;
      align-items:center;
      gap:12px;
      margin-left:auto;
    }
    .header-brand{
      display:flex;
      align-items:center;
      gap:10px;
      flex:0 0 auto;
      min-width:0;
    }
    .header-title-stack{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    .header-handle{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:8px;
      color:var(--subtext);
      font-weight:800;
      font-size:11px;
      user-select:none;
      touch-action:pan-y;
      cursor:pointer;
      padding:6px 12px;
      border-radius:14px;
      border:none;
      background:var(--panel);
      box-shadow:0 10px 24px rgba(61,51,92,.12);
      flex-wrap:nowrap;
      min-height:var(--layer-handle-height);
      position:relative;
      z-index:240;
    }
    .header-handle-hit{
      position:fixed;
      z-index:260;
      background:transparent;
      border-radius:14px;
      pointer-events:auto;
    }
    .handle-label{
      font-size:11px;
      font-weight:800;
      letter-spacing:.06em;
      color:var(--subtext);
      white-space:nowrap;
    }
    .header-handle .handle-bar{
      width:68px;
      height:6px;
      border-radius:999px;
      background:linear-gradient(120deg, rgba(139,92,246,.35), rgba(34,211,238,.35));
      border:none;
      box-shadow:0 6px 18px rgba(61,51,92,.18);
    }
    .header-row{
      display:grid;
      grid-template-columns:1fr;
      grid-template-rows:auto auto;
      align-items:center;
      gap:8px;
      position:relative;
    }
    .header-tabs{
      grid-column:1;
      grid-row:1;
    }
    .header-tab-panes{
      grid-column:1;
      grid-row:2;
      width:100%;
      margin-top:2px;
    }
    .header-detail-bar{
      grid-column:1;
      grid-row:2;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      padding:4px 8px;
      border-radius:12px;
      border:1px solid rgba(211,200,233,.9);
      background:var(--panel);
      box-shadow:0 8px 18px rgba(61,51,92,.08);
      box-sizing:border-box;
      width:100%;
      align-self:stretch;
    }
    .header-detail-bar .detail-range{
      display:flex;
      align-items:center;
      gap:4px;
      flex:0 0 auto;
    }
    .header-detail-bar .detail-meta{
      justify-content:flex-end;
      flex:0 1 auto;
    }
    .header-detail-bar .detail-meta-item{
      padding:3px 6px;
    }
    .header-handle{
      justify-self:center;
      align-self:center;
      justify-content:center;
      width:160px;
      margin:14px auto 0;
    }
    .header-tabs{
      display:flex;
      align-items:center;
      gap:8px;
      flex:1 1 auto;
      min-width:0;
      position:relative;
      z-index:240;
    }
    .display-tabs{
      display:flex;
      align-items:center;
      gap:6px;
      flex:0 0 auto;
    }
    .ctrl-dock{
      position:fixed;
      left:18px;
      bottom:18px;
      z-index:calc(var(--window-layer) + 10);
      padding:8px 10px;
      border-radius:18px;
      background:var(--glass-bg);
      border:1px solid var(--glass-border);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.38),
        inset 0 -1px 0 rgba(0,0,0,0.14),
        0 10px 26px rgba(0,0,0,0.12);
      -webkit-backdrop-filter:blur(var(--glass-blur));
      backdrop-filter:blur(var(--glass-blur));
      display:flex;
      align-items:center;
      gap:8px;
      touch-action:manipulation;
      will-change:transform;
      overflow:visible;
    }
    .ctrl-dock.is-collapsed .ctrl-items{
      max-width:0;
      opacity:0;
      pointer-events:none;
      transform:translateX(8px);
      overflow:hidden;
    }
    .ctrl-dock.is-expanded #ctrlDockExpandBtn{
      display:none;
    }
    .ctrl-dock.is-collapsed #ctrlDockCollapseBtn{
      display:none;
    }
    .ctrl-dock.is-dragging{
      cursor:grabbing;
    }
    .placement-radial{
      position:absolute;
      left:50%;
      top:50%;
      width:240px;
      height:240px;
      transform:translate(-50%, -50%) scale(.92);
      opacity:0;
      pointer-events:none;
      transition:opacity .2s ease, transform .2s ease;
    }
    body.is-memo-placement .placement-radial{
      opacity:1;
      transform:translate(-50%, -50%) scale(1);
      pointer-events:auto;
    }
    .placement-node{
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%, -50%) translate(var(--x), var(--y));
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      pointer-events:none;
    }
    .placement-node button{
      pointer-events:auto;
    }
    .placement-orb{
      width:84px;
      height:84px;
      border-radius:22px;
      border:1px solid rgba(255,255,255,0.6);
      background:rgba(255,255,255,0.92);
      color:var(--text);
      box-shadow:0 16px 30px rgba(15,23,42,0.18);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      font-size:12px;
      font-weight:800;
      cursor:pointer;
      transition:transform .2s ease, box-shadow .2s ease;
    }
    .placement-orb:hover{
      transform:translateY(-4px);
      box-shadow:0 18px 34px rgba(15,23,42,0.22);
    }
    .placement-orb .icon{
      font-size:20px;
    }
    .placement-orb--issue{
      background:linear-gradient(135deg, rgba(255,248,248,0.96), rgba(255,237,234,0.96));
      border-color:rgba(239,68,68,0.25);
    }
    .placement-orb--request{
      background:linear-gradient(135deg, rgba(248,250,255,0.96), rgba(237,245,255,0.96));
      border-color:rgba(59,130,246,0.25);
    }
    .placement-menu{
      display:none;
      flex-direction:column;
      gap:6px;
      background:rgba(255,255,255,0.96);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      min-width:160px;
      box-shadow:0 12px 24px rgba(15,23,42,0.16);
    }
    .placement-node.is-open .placement-menu{
      display:flex;
    }
    .placement-menu button{
      border:none;
      background:rgba(148,163,184,0.18);
      color:var(--text);
      padding:8px 10px;
      border-radius:10px;
      font-size:12px;
      font-weight:700;
      cursor:pointer;
      text-align:left;
    }
    .placement-menu button:hover{
      background:rgba(59,130,246,0.16);
    }
    body.is-target-selecting,
    body.is-target-selecting *{
      cursor:crosshair !important;
    }
    .ctrl-dock.is-collapsed .ctrl-items{
      max-width:0;
      opacity:0;
      pointer-events:none;
      transform:translateX(8px);
      overflow:hidden;
    }
    .ctrl-dock.is-expanded #ctrlDockExpandBtn{
      display:none;
    }
    .ctrl-dock.is-collapsed #ctrlDockCollapseBtn{
      display:none;
    }
    .ctrl-dock.is-dragging{
      cursor:grabbing;
    }
    .ctrl-label{
      font-size:11px;
      font-weight:800;
      color:var(--subtext);
      padding:6px 10px;
      border-radius:12px;
      background:rgba(255,255,255,0.18);
      border:1px solid rgba(255,255,255,0.28);
      letter-spacing:.3px;
      white-space:nowrap;
    }
    .ctrl-icon{
      width:18px;
      height:18px;
      display:block;
    }
    .ctrl-btn .ctrl-icon{
      width:16px;
      height:16px;
    }
    .ctrl-sep{
      color:var(--subtext);
      font-weight:700;
      padding:0 2px;
      opacity:.6;
    }
    .ctrl-memo{
      position:relative;
    }
    .ctrl-memo-menu,
    .ctrl-edit-menu{
      position:absolute;
      right:-6px;
      bottom:calc(100% - 6px);
      width:120px;
      height:120px;
      z-index:5;
      opacity:0;
      pointer-events:none;
      transform:translateY(8px);
      transition:opacity .18s ease, transform .18s ease;
    }
    .ctrl-memo.is-open .ctrl-memo-menu,
    .ctrl-edit.is-open .ctrl-edit-menu{
      opacity:1;
      pointer-events:auto;
      transform:translateY(0);
    }
    .ctrl-memo-menu .ctrl-btn,
    .ctrl-edit-menu .ctrl-btn{
      position:absolute;
      width:36px;
      height:36px;
      padding:0;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .ctrl-memo-menu .ctrl-btn:nth-child(1){
      right:0;
      bottom:0;
      transform:translate(-48px, -18px);
    }
    .ctrl-memo-menu .ctrl-btn:nth-child(2){
      right:0;
      bottom:0;
      transform:translate(-22px, -64px);
    }
    .ctrl-memo-menu .ctrl-btn:nth-child(3){
      right:0;
      bottom:0;
      transform:translate(8px, -40px);
    }
    .ctrl-edit{
      position:relative;
    }
    .ctrl-edit-menu .ctrl-btn:nth-child(1){
      right:0;
      bottom:0;
      transform:translate(-60px, -12px);
    }
    .ctrl-edit-menu .ctrl-btn:nth-child(2){
      right:0;
      bottom:0;
      transform:translate(-38px, -64px);
    }
    .ctrl-edit-menu .ctrl-btn:nth-child(3){
      right:0;
      bottom:0;
      transform:translate(0px, -78px);
    }
    .ctrl-edit-menu .ctrl-btn:nth-child(4){
      right:0;
      bottom:0;
      transform:translate(38px, -64px);
    }
    .ctrl-edit-menu .ctrl-btn:nth-child(5){
      right:0;
      bottom:0;
      transform:translate(60px, -12px);
    }
    .ctrl-edit-menu .ctrl-btn:nth-child(6){
      right:0;
      bottom:0;
      transform:translate(0px, 12px);
    }
    .ctrl-drag-handle{
      cursor:grab;
      touch-action:none;
      user-select:none;
    }
    .ctrl-dock.smoke{
      --glass-bg:rgba(30,30,38,0.46);
      --glass-border:rgba(255,255,255,0.22);
    }
    @supports not ((-webkit-backdrop-filter: blur(1px)) or (backdrop-filter: blur(1px))){
      .ctrl-dock{
        background:rgba(255,255,255,0.26);
      }
      .ctrl-dock.smoke{
        background:rgba(30,30,38,0.62);
      }
    }
    .ctrl-strip{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    .ctrl-primary{
      display:flex;
      align-items:center;
      gap:8px;
      flex:0 0 auto;
    }
    .ctrl-items{
      display:flex;
      align-items:center;
      gap:8px;
      max-width:520px;
      opacity:1;
      transform:translateX(0);
      pointer-events:auto;
      transition:opacity .18s ease, transform .18s ease, max-width .18s ease;
    }
    .ctrl-btn{
      border:none;
      border-radius:12px;
      background:rgba(255,255,255,0.10);
      color:var(--text);
      font-weight:700;
      font-size:12px;
      cursor:pointer;
      padding:7px 12px;
      transition:transform .18s ease, box-shadow .18s ease;
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.34),
        inset 0 -1px 0 rgba(0,0,0,0.18),
        0 4px 10px rgba(0,0,0,0.18);
      white-space:nowrap;
      line-height:1;
    }
    .ctrl-btn:disabled{
      opacity:.4;
      cursor:not-allowed;
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.2),
        inset 0 -1px 0 rgba(0,0,0,0.12),
        0 2px 6px rgba(0,0,0,0.12);
    }
    .ctrl-btn:active{
      transform:translateY(1px);
      box-shadow:
        inset 0 2px 0 rgba(255,255,255,0.3),
        inset 0 -2px 0 rgba(0,0,0,0.22),
        0 2px 6px rgba(0,0,0,0.16);
    }
    .ctrl-btn.is-active,
    .ctrl-btn.active,
    .display-tab.active{
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.34),
        inset 0 -2px 0 var(--theme),
        0 4px 10px rgba(0,0,0,0.18);
    }
    .ctrl-dock .display-tabs{
      gap:6px;
    }
    .ctrl-btn.ctrl-primary-save{
      font-weight:900;
    }
    .header-summary-tabs{
      display:flex;
      align-items:center;
      flex:1 1 320px;
      min-width:240px;
    }
    header[data-stage="collapsed"] .header-tabs{display:flex;}
    header[data-stage="collapsed"] .header-brand,
    header[data-stage="collapsed"] .header-info,
    header[data-stage="collapsed"] .header-actions,
    header[data-stage="collapsed"] #loginBtn,
    header[data-stage="collapsed"] .user-menu-wrap{
      display:none;
    }
    header[data-stage="collapsed"] .header-row{
      justify-content:flex-end;
      gap:8px;
    }
    header[data-stage="collapsed"] .header-handle{
      display:flex;
      position:relative;
      left:auto;
      bottom:auto;
      transform:none;
      z-index:240;
      background:rgba(255,255,255,.6);
      box-shadow:0 10px 22px rgba(61,51,92,.18);
      backdrop-filter:blur(8px);
      margin:0 auto 2px;
    }
    header[data-stage="expanded"] .header-handle{
      color:#0f766e;
    }
    header[data-stage="collapsed"] .header-handle .handle-bar{
      background:linear-gradient(120deg, rgba(99,102,241,.32), rgba(14,165,233,.28));
    }
    header[data-stage="expanded"] .header-handle .handle-bar{
      background:linear-gradient(120deg, rgba(14,165,233,.3), rgba(34,197,94,.28));
    }
    .summary-handle,
    .detail-handle{
      margin:18px auto 0;
      border:1px solid var(--border);
      background:var(--panel);
      box-shadow:0 10px 24px rgba(61,51,92,.12);
      padding:6px 12px;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:8px;
      width:max-content;
      position:relative;
      z-index:140;
      cursor:pointer;
    }
    .summary-handle{
      align-self:center;
      margin:12px auto 0;
    }
    .detail-handle{
      margin-top:12px;
      position:sticky;
      top:auto;
      bottom:calc(env(safe-area-inset-bottom, 0px) + 8px);
    }
    .summary-handle-badge{
      font-size:12px;
      font-weight:700;
      color:#0c4a6e;
      background:rgba(14,165,233,.16);
      border:1px solid rgba(14,165,233,.35);
      border-radius:999px;
      padding:2px 10px;
      white-space:nowrap;
      box-shadow:0 6px 14px rgba(14,165,233,.12);
    }
    .summary-layer{
      position:sticky;
      top:var(--header-height, var(--header-peek-height));
      z-index:1;
      padding:0 18px;
      display:flex;
      flex-direction:column;
      min-height:calc(100vh - var(--header-height, var(--header-peek-height)));
    }
    .summary-layer.is-hidden{
      display:block;
      min-height:0;
    }
    .summary-layer.is-collapsed{
      min-height:0;
    }
    .summary-layer.is-hidden .summary-inner{
      gap:0;
      display:none;
    }
    .detail-layer{
      width:100%;
      padding:0 18px 18px;
      min-height:calc(100vh - var(--header-height, var(--header-peek-height)) - var(--summary-layer-height, 0px));
      display:flex;
      flex-direction:column;
    }
    .manual-layer{
      position:sticky;
      top:var(--header-height, var(--header-peek-height));
      width:100%;
      max-width:100%;
      padding:0 18px 24px;
      min-height:calc(100vh - var(--header-height, var(--header-peek-height)));
    }
    .summary-layer.is-collapsed{
      z-index:2;
    }
    .summary-layer.is-collapsed .summary-inner{
      gap:8px;
    }
    .summary-layer.is-collapsed .line-actions-panel{
      display:none;
    }
    .summary-inner{
      max-width:1440px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:18px;
      flex:1 1 auto;
      min-height:0;
      position:relative;
      padding-top:0;
    }
    header .header-handle{
      align-self:center;
      margin:0 auto 2px;
    }
    .detail-inner{
      max-width:none;
      width:100%;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:18px;
      flex:1 1 auto;
      min-height:0;
    }
    .manual-layer-inner{
      width:100%;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .header-bulk{
      display:flex;
      justify-content:center;
    }
    .header-bulk .bulk-card{
      width:min(980px, 100%);
    }
    header[data-stage="collapsed"] .header-bulk{
      display:none;
    }

    .logo-circle{
      width:48px;height:48px;border-radius:14px;
      background:linear-gradient(135deg,var(--accent-3),var(--accent));
      color:#fff;font-weight:900;font-size:18px;
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 6px 20px rgba(0,0,0,.18);
      border:1px solid rgba(0,0,0,.05);
    }
    header h1{margin:0;font-size:22px;font-weight:900;letter-spacing:.2px;}
    header p{margin:2px 0 0;font-size:12px;opacity:.9;color:var(--subtext);}
    .header-info{display:flex;align-items:center;gap:8px;flex:0 0 auto;min-width:0;}
    .version-badge{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:2px;
      margin-top:0;
      padding:6px 10px;
      border-radius:10px;
      background:var(--panel-sub);
      border:1px solid var(--border);
      color:var(--subtext);
      font-weight:800;
      font-size:12px;
      width:max-content;
    }
    .version-badge-line{
      display:flex;
      align-items:center;
      gap:8px;
      line-height:1.2;
      white-space:nowrap;
    }
    .version-badge .dot{
      width:8px;
      height:8px;
      border-radius:50%;
      background:var(--accent);
      box-shadow:0 0 0 4px rgba(139,92,246,.12);
    }
    .user-icon{
      width:40px;
      height:40px;
      border-radius:12px;
      background:linear-gradient(135deg,var(--accent-3),var(--accent));
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      border:1px solid var(--border);
      box-shadow:0 8px 20px rgba(61,51,92,.16);
    }
    .user-icon .user-initial{font-size:15px;}
    .user-chip{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:800;
      color:var(--text);
      background:var(--panel-sub);
      border:1px solid var(--border);
      border-radius:12px;
      padding:6px 10px;
      cursor:pointer;
    }
    .user-chip:hover,
    .user-chip:focus-visible{
      background:var(--panel);
      border-color:var(--accent);
      outline:none;
    }
    .user-meta{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:2px;
      line-height:1.1;
    }
    .user-label{
      font-size:11px;
      color:var(--subtext);
      letter-spacing:.02em;
    }
    .user-name{
      font-size:12px;
      font-weight:900;
      color:var(--text);
    }
    .icon-button{
      min-width:40px;
      height:40px;
      padding:0 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel-sub);
      color:var(--text);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      font-size:12px;
      font-weight:900;
      box-shadow:0 8px 20px rgba(61,51,92,.12);
      cursor:pointer;
      transition:background .2s, transform .2s, border-color .2s;
      text-decoration:none;
    }
    .icon-button:hover,
    .icon-button:focus-visible{
      background:var(--panel);
      transform:translateY(-1px);
      outline:none;
      border-color:var(--accent);
    }
    .icon-button .icon-emoji{
      font-size:18px;
      line-height:1;
    }
    .icon-button .icon-label{
      font-size:12px;
      font-weight:800;
      line-height:1;
    }
    .icon-button .sr-only{line-height:0;}
    .header-icons{display:flex;align-items:center;gap:10px;flex-wrap:nowrap;}
    .header-actions{
      display:flex;
      align-items:center;
      gap:10px;
      margin-left:auto;
      flex-wrap:nowrap;
      justify-content:flex-end;
      flex:0 1 auto;
    }
    .header-select{
      display:flex;flex-direction:column;gap:4px;
      color:var(--subtext);font-weight:800;font-size:12px;
    }
    .header-select select{
      padding:8px 10px;border-radius:12px;border:1px solid var(--border);
      background:var(--panel);color:var(--text);font-weight:700;min-width:160px;
    }
    .header-chip{
      border:none;border-radius:12px;
      padding:10px 14px;font-weight:800;cursor:pointer;
      background:var(--panel-sub);color:var(--text);
      border:1px solid var(--border);
      transition:background .2s,border-color .2s,transform .2s;
    }
    .header-chip:hover{background:var(--panel);transform:translateY(-1px);}
    .header-chip.primary{background:linear-gradient(120deg,var(--accent),var(--accent-2));border-color:transparent;color:#fff;}
    .header-chip.ghost{background:var(--panel-sub);}

    .header-tools{display:flex;gap:8px;flex-wrap:nowrap;}
    .tool{position:relative;z-index:0;}
    .tool.open{z-index:calc(var(--nougat-layer) + 130);}
    .tool-trigger{min-width:0;text-align:center;}
    .tool.open .tool-trigger{box-shadow:0 10px 30px rgba(139,92,246,.45);}
    .tool-panel{
      position:absolute;top:calc(100% + 10px);right:0;
      width:min(520px,90vw);
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;padding:14px;
      box-shadow:0 16px 40px rgba(61,51,92,.14);
      display:none;z-index:calc(var(--nougat-layer) + 130);
      max-height:calc(100vh - 48px);
      overflow:visible;
      flex-direction:column;
      gap:10px;
      min-height:0;
    }
    .tool.open .tool-panel{display:flex;}
    .tool-panel h2{display:flex;align-items:center;gap:8px;}
    .tool-panel::before{
      content:"";position:absolute;right:22px;top:-10px;
      width:14px;height:14px;background:inherit;
      border-left:1px solid var(--border);border-top:1px solid var(--border);
      transform:rotate(45deg);
    }
    @media (max-width: 960px){
      .header-actions, .header-tools, .header-icons{flex-wrap:wrap;}
    }
    @media (max-width: 720px){
      .header-topline{
        flex-wrap:wrap;
      }
      .header-actions{
        order:3;
        width:100%;
        margin-left:0;
        justify-content:flex-start;
      }
      .header-brand{
        order:2;
        flex:1 1 100%;
      }
      #loginBtn{
        order:1;
      }
    }
    .tool.icon-tool.compact .tool-panel{
      width:min(420px,90vw);
    }
    .tool-tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      border-bottom:1px solid rgba(139,92,246,.2);
      padding-bottom:10px;
    }
    .tool-tab{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.9), rgba(250,247,255,.9));
      color:var(--text);
      border-radius:10px;
      padding:8px 12px;
      font-weight:800;
      cursor:pointer;
      transition:background .2s,border-color .2s,transform .2s, box-shadow .2s;
      box-shadow:0 6px 18px rgba(61,51,92,.08);
    }
    .tool-tab.active{
      background:linear-gradient(120deg,var(--accent),var(--accent-2));
      color:#fff;
      border-color:transparent;
      transform:translateY(-1px);
      box-shadow:0 8px 24px rgba(139,92,246,.35);
    }
    .tool-panel-scroll{
      flex:1;
      overflow-y:auto;
      padding-right:6px;
      min-height:0;
      overscroll-behavior:contain;
    }
    .tool-body{display:grid;gap:12px;}
    .tab-pane{display:none;}
    .tab-pane.active{display:grid;}
    .tool-panel-footer{
      border-top:1px solid var(--border);
      padding-top:6px;
    }
    .theme-icon-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(160px, 1fr));
      gap:8px;
      width:100%;
    }
    .theme-icon{
      width:100%;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      background:var(--panel-sub);
      display:flex;
      align-items:center;
      gap:10px;
      cursor:pointer;
      transition:transform .15s, box-shadow .15s, border-color .15s, background .15s;
      color:var(--text);
    }
    .theme-icon:hover,
    .theme-icon:focus-visible{
      transform:translateY(-1px);
      outline:none;
      border-color:var(--accent);
      box-shadow:0 10px 24px rgba(139,92,246,.18);
    }
    .theme-icon.active{
      background:linear-gradient(120deg,var(--accent),var(--accent-2));
      color:#0b1021;
      border-color:transparent;
      box-shadow:0 12px 32px rgba(139,92,246,.28);
    }
    .theme-icon .swatch{
      width:40px;
      height:40px;
      border-radius:10px;
      background:linear-gradient(135deg,var(--accent),var(--accent-2),var(--accent-3));
      border:1px solid rgba(0,0,0,.04);
      box-shadow:0 6px 16px rgba(0,0,0,.08);
      flex-shrink:0;
    }
    .theme-icon .label{
      font-weight:900;
      font-size:13px;
      line-height:1.4;
    }
    .panel.slim{margin:0;}

    main{
      flex:1 1 auto;
      width:100%;
      padding:0;
      display:flex;
      justify-content:center;
      align-items:stretch;
      overflow:visible;
    }
    .content{
      min-width:0;
      width:100%;
      max-width:1440px;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .panel{
      background:var(--panel);border:1px solid var(--border);border-radius:16px;
      padding:16px 16px;box-shadow:var(--glow);
      margin-bottom:16px;
    }
    #summaryPanel{
      background:linear-gradient(180deg, rgba(255,255,255,.82), rgba(255,255,255,.72));
      border-color:rgba(231,223,242,.65);
      box-shadow:0 8px 20px rgba(61,51,92,.1);
      color:var(--subtext);
    }
    .summary-panel{margin:0;position:relative;}
    .detail-panel{margin:0;position:relative;}
    .summary-panel,
    .detail-panel{
      display:flex;
      flex-direction:column;
      flex:1 1 auto;
      min-height:0;
    }
    .summary-panel#summaryPanel:not(.is-collapsed){
      padding-bottom:calc(16px + var(--layer-handle-height));
    }
    .summary-head{align-items:center;}
    .summary-title{
      font-size:14px;
      font-weight:900;
      color:var(--text);
      letter-spacing:.04em;
    }
    .summary-handle,
    .detail-handle{
      cursor:pointer;
      position:relative;
      z-index:2;
      margin-top:4px;
    }
    .summary-handle .handle-bar,
    .detail-handle .handle-bar{
      width:68px;
      height:6px;
      padding:0;
      border-radius:999px;
      background:linear-gradient(120deg, rgba(139,92,246,.35), rgba(34,211,238,.35));
      border:1px solid var(--border);
      box-shadow:0 6px 18px rgba(61,51,92,.18);
    }
    .summary-handle .summary-handle-label,
    .detail-handle .summary-handle-label{
      pointer-events:none;
      white-space:nowrap;
      text-align:center;
    }
    .summary-toolbar{
      display:flex;
      justify-content:flex-end;
      margin:-4px -16px 12px;
      padding:0 16px;
    }
    .summary-tabs-layer{
      margin:0;
      padding-bottom:4px;
      flex:1 1 auto;
      min-width:0;
    }
    .summary-panel.is-collapsed{
      padding:0;
      border:none;
      background:transparent;
      box-shadow:none;
    }
    .summary-panel.is-collapsed .summary-head{
      display:flex;
    }
    .summary-panel.is-collapsed .summary-title{
      display:block;
    }
    .summary-panel.is-collapsed .summary-head,
    .summary-panel.is-collapsed .summary-actions{
      flex-wrap:nowrap;
    }
    .summary-panel.is-collapsed .summary-toolbar{
      margin-bottom:0;
    }
    .summary-panel.is-collapsed .collapsible-body{
      display:none;
    }
    .detail-panel.is-collapsed{
      padding:0;
      border:none;
      background:transparent;
      box-shadow:none;
    }
    .detail-panel.is-collapsed .collapsible-body{
      display:none;
    }
    .summary-panel .collapsible-body,
    .detail-panel .collapsible-body{
      flex:1 1 auto;
      min-height:0;
      max-height:none;
      overflow-y:auto;
      overscroll-behavior:contain;
      padding-right:4px;
    }
    .summary-layer.is-collapsed .header-detail-bar{
      display:flex;
      padding:4px 8px;
      min-height:auto;
      height:auto;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--panel-overlay);
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      box-shadow:0 10px 22px rgba(61,51,92,.14);
    }
    .summary-layer.is-collapsed .header-detail-bar .detail-tabs{
      flex-wrap:nowrap;
    }
    .summary-layer.is-collapsed .header-detail-bar .detail-meta{
      gap:6px;
      font-size:11px;
      justify-content:flex-end;
      flex:0 1 auto;
    }
    .summary-layer.is-collapsed .header-detail-bar .detail-range{
      display:none;
      font-size:11px;
    }
    .summary-layer.is-collapsed .header-detail-bar .detail-meta-item{
      padding:3px 6px;
      border-radius:999px;
    }
    .summary-layer.is-collapsed .header-detail-bar .detail-meta-label{
      font-size:10px;
    }
    .summary-layer.is-collapsed .detail-tab{
      padding:5px 10px;
      font-size:11px;
      border-radius:10px;
      box-shadow:none;
    }
    .summary-layer.is-collapsed .summary-handle{
      margin-top:8px;
      background:var(--panel-overlay);
      box-shadow:0 10px 22px rgba(61,51,92,.18);
      border:1px solid var(--border);
      backdrop-filter:blur(8px);
      width:160px;
    }
    .detail-layer.is-collapsed .detail-handle{
      margin-top:8px;
      background:var(--panel-overlay);
      box-shadow:0 10px 22px rgba(61,51,92,.18);
      border:1px solid var(--border);
      backdrop-filter:blur(8px);
      width:160px;
    }
    .display-settings-group{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:14px;
    }
    .display-settings-group:first-child{
      margin-top:0;
    }
    .settings-subtitle{
      font-size:13px;
      font-weight:800;
      color:var(--subtext);
      letter-spacing:.04em;
    }
    .summary-layer.is-collapsed .summary-handle .handle-bar{
      background:var(--panel);
      box-shadow:0 8px 18px rgba(61,51,92,.16);
    }
    .detail-layer.is-collapsed .detail-handle .handle-bar{
      background:var(--panel);
      box-shadow:0 8px 18px rgba(61,51,92,.16);
    }
    #summaryPanel h2{color:var(--text);opacity:.82;}
    .panel h2{margin:0 0 10px;font-size:16px;font-weight:800;letter-spacing:.05em;}
    label{display:block;font-size:13px;font-weight:700;color:var(--subtext);margin-bottom:6px;}
    input[type="file"],input[type="number"],input[type="text"],select,button{
      font:inherit;
    }
    input[type="file"],input[type="number"],input[type="text"],select{
      width:100%;padding:10px 12px;border:1px solid var(--border);
      border-radius:12px;background:var(--panel);color:var(--text);
    }
    input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(255,143,177,.25);} 

    .row{display:flex;gap:10px;align-items:flex-start;flex-wrap:wrap;}
    .row > div{flex:1;min-width:120px;}
    .vacation-periods{
      align-items:flex-start;
    }
    .vacation-period{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:220px;
      flex:1 1 240px;
    }
    .vacation-period-fields{
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
    }
    .vacation-period-fields input[type="date"]{
      flex:1 1 140px;
      min-width:140px;
    }
    .vacation-period-fields .range-separator{
      font-size:12px;
      font-weight:800;
      color:var(--subtext);
    }
    .toggle-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      font-weight:700;
      color:var(--subtext);
    }
    .switch-toggle{
      position:relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:46px;
      height:26px;
    }
    .switch-toggle .switch-track{
      position:absolute;
      inset:0;
      border-radius:999px;
      background:var(--border);
      transition:background .2s ease;
    }
    .switch-toggle .switch-track::after{
      content:"";
      position:absolute;
      top:3px;
      left:3px;
      width:20px;
      height:20px;
      border-radius:50%;
      background:#fff;
      box-shadow:0 2px 6px rgba(0,0,0,.12);
      transition:transform .2s ease;
    }
    .switch-toggle input:focus-visible + .switch-track{
      box-shadow:0 0 0 3px rgba(255,143,177,.35);
    }
    .switch-toggle input:checked + .switch-track{
      background:var(--accent);
    }
    .switch-toggle input:checked + .switch-track::after{
      transform:translateX(20px);
    }
    .visually-hidden{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      border:0;
    }
    .csv-upload-row{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .csv-file-button{
      padding:10px 14px;
    }
    .csv-file-name{
      font-weight:800;
      color:var(--muted);
    }

    button{
      border:none;border-radius:12px;
      padding:10px 12px;font-weight:800;cursor:pointer;
      background:linear-gradient(120deg,var(--accent),var(--accent-2));color:#fff;
      box-shadow:0 8px 20px rgba(255,143,177,.26);
    }
    .swipe-rail.swipe-rail--linked{
      top:var(--swipe-rail-top, 0px);
      bottom:var(--swipe-rail-bottom, 0px);
      height:auto;
    }
    button.small{
      padding:4px 10px;font-size:11px;border-radius:10px;
      background:var(--panel-sub);color:var(--text);border:1px solid var(--border);
      font-weight:700;
    }
    button.small.primary{
      background:linear-gradient(120deg,var(--accent),var(--accent-2));color:#fff;border-color:transparent;
    }
    button.small.warn{
      background:#f97316;color:#fff;border-color:#f97316;
    }
    button:disabled{opacity:.6;cursor:not-allowed;}
    .muted{color:var(--subtext);font-size:12px;}
    .date-range{font-weight:800;margin-bottom:6px;color:var(--muted);}

    table{width:100%;border-collapse:collapse;margin-top:10px;background:transparent;}
    th,td{border:1px solid var(--border);padding:8px 10px;font-size:12px;vertical-align:top;background:var(--panel);}
    th{background:var(--panel-sub);font-weight:800;color:var(--muted);}
    .detail-table thead th{
      position:sticky;
      top:0;
      z-index:5;
      box-shadow:0 4px 10px rgba(0,0,0,.06);
    }
    .detail-table thead th.col-day{
      padding:6px 8px;
      border:1px solid var(--border);
      vertical-align:middle;
    }
    .detail-table{
      table-layout:fixed;
      min-width:940px;
    }
    .detail-table th,
    .detail-table td{
      padding:6px 8px;
    }
    .detail-table .col-day{width:var(--daycard-col-width);}
    .detail-table .col-time{width:150px;}
    .detail-table .calc-col{width:320px;}
    .detail-table .col-total{width:120px;}
    .detail-table tbody tr + tr td{
      border-top:2px solid rgba(139,92,246,.22);
    }
    .detail-table tbody tr + tr td.col-day{
      border-top:2px solid rgba(139,92,246,.22);
      padding-top:6px;
    }
    caption{text-align:left;font-weight:800;margin-bottom:6px;}

    .tabs{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;}
    .tab-button{
      padding:8px 14px;border-radius:999px;border:1px solid var(--border);
      background:var(--panel-sub);color:var(--muted);font-weight:700;font-size:13px;cursor:pointer;
      transition:background .2s,border-color .2s,transform .2s;
    }
    .tab-button.active{background:linear-gradient(120deg,var(--accent),var(--accent-2));border-color:transparent;color:#fff;transform:translateY(-1px);}
    .tab-panel{display:none;}
    .tab-panel.active{display:block;}

    /* 日カード */
    th.col-day,td.col-day{width:var(--daycard-col-width);border:none;}
    td.col-day{padding-top:6px;vertical-align:top;}
    .daycard{
      width:100%;min-height:var(--daycard-min-height);
      border:1px solid var(--border);border-radius:16px;
      margin:0 auto;background:linear-gradient(180deg,#fff,#fff8fd);
      position:relative;padding:var(--daycard-padding);
      display:flex;flex-direction:column;gap:var(--daycard-gap);align-items:stretch;
      box-shadow:0 10px 26px rgba(61,51,92,.12);
    }
    .daycard::before{
      content:"";position:absolute;left:10px;top:10px;height:10px;width:10px;
      border-radius:50%;background:var(--accent);
    }
    .daycard.type-1gou::before{background:#6dd3b8;}
    .daycard.type-short::before{background:#f8c77e;}
    .daycard.type-standard::before{background:var(--accent);}
    .daycard.status-vacation::before{background:#0ea5e9;}
    .daycard.status-absent::before{background:#ef4444;}
    .daycard.status-closed::before{background:#9ca3af;}
    .daycard.status-vacation{
      background:linear-gradient(180deg,#f0f9ff,#ecfeff);
      border-color:#bae6fd;
    }
    .daycard.status-absent{
      background:linear-gradient(180deg,#fff1f2,#fef2f2);
      border-color:#fecdd3;
    }
    .daycard.status-closed{
      background:linear-gradient(180deg,#f8fafc,#f1f5f9);
      border-color:#e5e7eb;
    }
    .daycard.missing-clock{
      background:linear-gradient(180deg,#fff7ed,#fffbeb);
      border-color:#fed7aa;
      box-shadow:0 12px 30px rgba(251,146,60,.14);
    }
    .daycard.missing-clock::before{background:#fb923c;}
    .daycard.type-1gou{
      background:linear-gradient(180deg,#ecfeff,#eff6ff);
      border-color:#c7d2fe;
    }
    .daycard .missing-note{
      width:100%;
      text-align:center;
      padding:6px 8px;
      border-radius:10px;
      font-size:11px;
      font-weight:900;
      color:#9a3412;
      background:linear-gradient(120deg,#fff7ed,#fffbeb);
      border:1px dashed #fdba74;
    }

    .dc-head{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
    }
    .dc-date-wrap{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding-left:0;
      flex:1;
      text-align:center;
    }
    .dc-week{font-size:var(--daycard-week-size);color:#6b7280;font-weight:800;}
    .dc-date{font-size:var(--daycard-date-size);font-weight:900;}
    .time-input{
      width:78px;font-size:12px;padding:6px 8px;border-radius:10px;border:1px solid var(--border);
      background:var(--panel);color:var(--text);
    }
    .diff{font-size:11px;color:#9ca3af;margin-top:2px;}

    .auto-note{font-size:10px;color:#6b7280;}

    .az-col .az-actions{
      display:flex;
      flex-direction:column;
      gap:6px;
      height:100%;
    }
    .az-chip{
      width:100%;border:1px dashed var(--border);border-radius:12px;
      padding:6px 8px;background:var(--panel-sub);
      display:flex;flex-direction:column;gap:4px;align-items:center;
      font-size:11px;font-weight:700;color:var(--muted);
    }
    .az-chip.off{opacity:.6;}
    .az-chip .fee{font-size:12px;font-weight:900;color:var(--text);}
    .vacation-note{font-size:11px;color:var(--subtext);display:none;} 

    /* 計算内訳の3段表示 */
    .calc-col{min-width:320px;}
    .calc-stack{display:grid;gap:6px;width:100%;}
    .calc-chip{
      width:100%;
      text-align:left;
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--panel-sub);
      color:var(--text);
      padding:9px 10px;
      font-weight:800;
      display:grid;
      gap:3px;
      cursor:pointer;
      transition:transform .2s, box-shadow .2s, border-color .2s, background .2s;
    }
    .calc-chip[data-float="azukari"]{
      grid-template-columns:auto 1fr auto;
      grid-template-areas:"title value meta";
      align-items:center;
      column-gap:6px;
    }
    .calc-chip[data-float="azukari"] .title{grid-area:title;}
    .calc-chip[data-float="azukari"] .value{grid-area:value;}
    .calc-chip[data-float="azukari"] .meta{
      grid-area:meta;
      justify-content:flex-end;
      flex-wrap:nowrap;
    }
    .calc-chip[data-float="azukari"] .note{grid-column:1 / -1;}
    .calc-chip[data-float="ext"]{
      grid-template-columns:auto 1fr;
      grid-template-areas:
        "title value"
        "meta meta";
      align-items:start;
      row-gap:6px;
    }
    .calc-chip[data-float="ext"] .title{grid-area:title;}
    .calc-chip[data-float="ext"] .value{grid-area:value;}
    .calc-chip[data-float="ext"] .meta{grid-area:meta;}
    .calc-chip[data-float="ext"] .note{grid-column:1 / -1;}
    .calc-chip:hover{transform:translateY(-2px);box-shadow:0 10px 26px rgba(139,92,246,.18);border-color:var(--accent);}    
    .calc-chip.off{opacity:.7;border-style:dashed;}
    .calc-chip .title{font-size:12px;color:var(--subtext);display:flex;align-items:center;gap:6px;}
    .calc-chip .value{
      font-size:14px;
      letter-spacing:.01em;
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .calc-chip .meta{font-size:11px;color:var(--subtext);display:flex;flex-wrap:wrap;gap:6px;}
    .calc-chip .note{font-size:11px;color:#be123c;font-weight:900;}
    .calc-chip .note-inline{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 8px;
      border-radius:999px;
      background:rgba(190,18,60,.08);
      border:1px solid rgba(190,18,60,.16);
    }
    .calc-chip .bubble{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:rgba(139,92,246,.12);color:var(--muted);font-size:11px;}
    .calc-chip .bubble.strong{background:rgba(34,211,238,.16);color:var(--text);border:1px solid rgba(34,211,238,.35);}
    .ext-reference{display:grid;gap:4px;margin-top:4px;}
    .ext-row{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
    .ext-label{font-weight:900;color:var(--subtext);font-size:11px;}
    .calc-chip.is-floating{animation:floaty 1.2s ease-out;box-shadow:0 16px 36px rgba(139,92,246,.28);}
    .calc-chip[data-float="azukari"]{
      display:flex;
      align-items:center;
      flex-wrap:nowrap;
      gap:10px;
      padding:6px 10px;
    }
    .calc-chip[data-float="azukari"] .title,
    .calc-chip[data-float="azukari"] .value,
    .calc-chip[data-float="azukari"] .meta{
      display:inline-flex;
      align-items:center;
      gap:6px;
      margin:0;
      white-space:nowrap;
    }
    .calc-chip[data-float="azukari"] .meta{
      margin-left:auto;
    }
    .calc-chip[data-float="azukari"] .bubble{white-space:nowrap;}
    .calc-chip[data-float="azukari"] .note{flex-basis:100%;}
    @keyframes floaty{
      0%{transform:translateY(0);}
      30%{transform:translateY(-8px);}
      60%{transform:translateY(-4px);}
      100%{transform:translateY(0);}
    }

    .day-actions{width:100%;display:flex;flex-direction:column;gap:8px;}
    .day-chip{
      width:100%;border-radius:12px;border:1px solid var(--border);
      background:var(--panel-sub);color:var(--muted);font-weight:800;font-size:var(--daycard-chip-font-size);
      padding:var(--daycard-chip-padding);
      transition:background .2s,border-color .2s,color .2s;
      text-align:center;
    }
    .day-chip.type-chip{
      font-size:12px;
      cursor:pointer;
      box-shadow:0 6px 16px rgba(0,0,0,.06);
    }
    .day-chip.type-chip:hover,
    .day-chip.type-chip:focus-visible{
      border-color:var(--accent);
      color:var(--accent);
      outline:none;
      transform:translateY(-1px);
    }
    .day-chip.status-chip{
      cursor:pointer;
      border-style:solid;
    }
    .day-chip.status-chip.locked{
      cursor:not-allowed;
      opacity:.86;
    }
    .day-chip.status-chip:hover,
    .day-chip.status-chip:focus-visible{
      border-color:var(--accent);
      outline:none;
      transform:translateY(-1px);
    }
    .day-chip.status-chip.locked:hover,
    .day-chip.status-chip.locked:focus-visible{
      border-color:var(--border);
      transform:none;
    }
    .day-chip.status-chip.attend{background:#e9fbf1;border-color:#86efac;color:#166534;}
    .day-chip.status-chip.vacation{background:#ecfeff;border-color:#bae6fd;color:#0ea5e9;}
    .day-chip.status-chip.absent{background:#fef2f2;border-color:#fecdd3;color:#991b1b;}
    .day-chip.status-chip.closed{background:#f8fafc;border-color:#e5e7eb;color:#475569;}
    .day-chip.status-chip.missing{
      border-style:dashed;
      background:#fff7ed;
      border-color:#fdba74;
      color:#c2410c;
    }
    .day-chip.type-chip.type-1gou{background:#ffedd5;border-color:#fdba74;color:#9a3412;}
    .day-chip.type-chip.type-short{background:#fce7f3;border-color:#f9a8d4;color:#9d174d;}
    .day-chip.type-chip.type-standard{background:#dcfce7;border-color:#86efac;color:#166534;}

    .time-cell{display:flex;flex-direction:column;gap:6px;align-items:flex-start;}
    .time-input-row{display:flex;align-items:center;gap:6px;}
    .time-buttons{
      display:grid;
      grid-template-columns:repeat(5, minmax(36px, 1fr));
      gap:3px;
      width:100%;
    }
    .time-buttons .time-btn{
      width:100%;
      white-space:nowrap;
      padding:4px 6px;
      font-size:11px;
      min-height:26px;
    }
    .time-btn.exempt-btn{
      background:#fef2f2;
      border:1px solid rgba(248,113,113,.35);
      color:#b91c1c;
      font-weight:700;
    }
    .time-btn.exempt-btn.is-active{
      background:#b91c1c;
      border-color:#b91c1c;
      color:#fff;
      box-shadow:0 6px 14px rgba(185,28,28,.2);
    }
    .time-badges{
      display:flex;
      flex-wrap:nowrap;
      gap:4px;
      align-items:center;
    }
    .time-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(139,92,246,.12);
      color:var(--muted);
      font-size:11px;
      white-space:nowrap;
    }
    .time-badge.strong{
      background:rgba(34,211,238,.16);
      color:var(--text);
      border:1px solid rgba(34,211,238,.35);
    }

    .row-selected td{outline:2px solid var(--accent);outline-offset:-2px;}
    .detail-filters{
      display:flex;gap:10px;align-items:flex-start;flex-wrap:wrap;
      margin-bottom:10px;
    }
    .detail-filters .filter{
      display:flex;flex-direction:column;gap:4px;
      min-width:140px;
    }
    .detail-filters select{
      padding:8px 10px;border-radius:12px;border:1px solid var(--border);
      font-size:13px;background:var(--panel);color:var(--text);
    }
    .detail-table{width:100%;}
    .detail-table th.col-type,.detail-table td.col-type{width:94px;}
    .az-col{width:160px;}
    .az-chip.mini{min-width:140px;margin:0 auto;}
    /* 計算内訳の3段表示 */
    .calc-col{min-width:320px;}
    .calc-stack{display:grid;gap:6px;width:100%;}
    .calc-chip{
      width:100%;
      text-align:left;
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--panel-sub);
      color:var(--text);
      padding:9px 10px;
      font-weight:800;
      display:grid;
      gap:3px;
      cursor:pointer;
      transition:transform .2s, box-shadow .2s, border-color .2s, background .2s;
    }
    .calc-chip:hover{transform:translateY(-2px);box-shadow:0 10px 26px rgba(139,92,246,.18);border-color:var(--accent);}    
    .calc-chip.off{opacity:.7;border-style:dashed;}
    .calc-chip .title{font-size:12px;color:var(--subtext);display:flex;align-items:center;gap:6px;}
    .calc-chip .value{
      font-size:14px;
      letter-spacing:.01em;
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .calc-chip .meta{font-size:11px;color:var(--subtext);display:flex;flex-wrap:wrap;gap:6px;}
    .calc-chip .note{font-size:11px;color:#be123c;font-weight:900;}
    .calc-chip .note-inline{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 8px;
      border-radius:999px;
      background:rgba(190,18,60,.08);
      border:1px solid rgba(190,18,60,.16);
    }
    .calc-chip .bubble{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:rgba(139,92,246,.12);color:var(--muted);font-size:11px;}
    .calc-chip.is-floating{animation:floaty 1.2s ease-out;box-shadow:0 16px 36px rgba(139,92,246,.28);}
    @keyframes floaty{
      0%{transform:translateY(0);}
      30%{transform:translateY(-8px);}
      60%{transform:translateY(-4px);}
      100%{transform:translateY(0);}
    }
    .table-scroll{width:100%;overflow:auto;}
    .detail-table-wrapper{overflow:auto;border-radius:12px;border:1px solid var(--border);background:var(--panel);max-height:65vh;}
    .detail-table-wrapper table{margin:0;}
    .detail-row.missing-clock td{
      background:
        linear-gradient(180deg, var(--panel), var(--panel-sub)),
        linear-gradient(180deg, rgba(249,115,22,.06), rgba(251,191,36,.08));
    }
    .detail-row{position:relative;}
    .panel-head{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;}
    .panel-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
    .panel-actions .date-range{margin:0;}
    .detail-meta{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      font-size:12px;
      color:var(--subtext);
    }
    .detail-meta-item{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      background:var(--panel-sub);
      border:1px solid var(--border);
      font-weight:800;
      color:var(--text);
    }
    .detail-meta-label{
      color:var(--subtext);
      font-weight:900;
    }
    .panel-collapse-footer{
      display:flex;
      justify-content:flex-end;
      margin-top:12px;
      padding-top:10px;
      border-top:1px solid rgba(0,0,0,.05);
    }
    .collapse-btn{
      padding:8px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel-sub);
      color:var(--text);
      font-weight:800;
      cursor:pointer;
    }
    .collapse-btn--detail{
      background:rgba(16,185,129,.12);
      border-color:rgba(16,185,129,.35);
      color:#059669;
    }
    #detailPanel{
      flex:1 1 auto;
      display:flex;
      flex-direction:column;
      min-height:0;
      margin-bottom:0;
      position:relative;
      z-index:0;
    }
    #detailBody{
      flex:1 1 auto;
      overflow:auto;
    }
    .detail-tabs{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .detail-tab{
      padding:7px 12px;
      border-radius:12px;
      border:1px solid rgba(16,185,129,.35);
      background:rgba(16,185,129,.08);
      color:#047857;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      transition:transform .15s, box-shadow .15s, border-color .15s;
    }
    .detail-tab.active{
      border-color:#10b981;
      background:linear-gradient(120deg, rgba(16,185,129,.18), rgba(34,197,94,.12));
      box-shadow:0 10px 24px rgba(16,185,129,.2);
      transform:translateY(-1px);
    }
    .detail-tab.secondary{
      border-color:rgba(14,165,233,.35);
      background:rgba(14,165,233,.1);
      color:#0369a1;
    }
    .detail-tab.secondary.active{
      border-color:#0ea5e9;
      background:linear-gradient(120deg, rgba(14,165,233,.2), rgba(56,189,248,.16));
      box-shadow:0 10px 24px rgba(14,165,233,.2);
    }
    .bulk-tabs{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      margin:12px 0 16px;
    }
    .bulk-header-actions{
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
    }
    .bulk-header-actions .header-btn{
      padding:6px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel-sub);
      color:var(--text);
      font-weight:800;
      font-size:12px;
      cursor:pointer;
      transition:transform .2s ease, box-shadow .2s ease;
    }
    .bulk-header-actions .header-btn.primary{
      background:linear-gradient(120deg, rgba(139,92,246,.18), rgba(34,211,238,.18));
      border-color:rgba(139,92,246,.35);
    }
    .bulk-header-actions .header-btn:disabled{
      opacity:.5;
      cursor:not-allowed;
      box-shadow:none;
    }
    .bulk-tab{
      padding:7px 12px;
      border-radius:12px;
      border:1px solid rgba(59,130,246,.3);
      background:rgba(59,130,246,.08);
      color:#1d4ed8;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      transition:transform .15s, box-shadow .15s, border-color .15s;
    }
    .bulk-tab.active{
      border-color:#3b82f6;
      background:linear-gradient(120deg, rgba(59,130,246,.22), rgba(14,165,233,.16));
      box-shadow:0 10px 24px rgba(59,130,246,.2);
      transform:translateY(-1px);
    }
    .bulk-pane{
      display:none;
    }
    .bulk-pane.active{
      display:block;
    }
    .bulk-selector{
      display:grid;
      grid-template-columns:minmax(120px, 160px) minmax(220px, 1fr);
      gap:8px;
      align-items:center;
    }
    .bulk-selector label{
      margin:0;
    }
    .bulk-selector select{
      width:100%;
      padding:9px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel-sub);
      color:var(--text);
      font-weight:700;
    }
    .bulk-month-list,
    .bulk-change-list,
    .child-type-list{
      margin-top:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .bulk-month-row{
      display:grid;
      grid-template-columns:minmax(120px, 150px) minmax(220px, 1fr);
      gap:12px;
      align-items:center;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel-sub);
    }
    .bulk-change-row{
      display:grid;
      grid-template-columns:minmax(240px, 1fr) minmax(200px, 240px);
      gap:12px;
      align-items:start;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel-sub);
    }
    .bulk-month-row .month-label,
    .bulk-change-row .month-label{
      font-weight:900;
      color:var(--text);
    }
    .bulk-month-controls,
    .bulk-change-controls{
      display:grid;
      gap:8px;
      align-items:start;
    }
    .bulk-type-buttons{
      display:grid;
      gap:8px;
      grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));
      align-items:start;
    }
    .bulk-change-row .bulk-type-buttons{
      grid-template-columns:1fr;
    }
    .bulk-type-btn{
      padding:6px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      font-weight:800;
      font-size:12px;
      cursor:pointer;
      transition:transform .2s ease, box-shadow .2s ease;
    }
    .bulk-type-btn.is-original{
      background:rgba(34,197,94,.15);
      border-color:rgba(34,197,94,.35);
      color:#166534;
    }
    .bulk-type-btn.is-selected{
      background:linear-gradient(120deg, rgba(139,92,246,.22), rgba(34,211,238,.2));
      border-color:rgba(139,92,246,.45);
      color:var(--text);
      box-shadow:0 6px 14px rgba(61,51,92,.12);
    }
    .bulk-change-main{
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:stretch;
    }
    .bulk-change-calendar{
      display:flex;
      justify-content:flex-end;
      align-items:stretch;
    }
    .bulk-calendar-card{
      display:grid;
      grid-template-rows:auto auto auto;
      gap:8px;
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(139,92,246,.2);
      background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(249,247,255,.96));
      box-shadow:0 10px 24px rgba(61,51,92,.08);
      font-weight:800;
      font-size:12px;
      color:var(--text);
    }
    .bulk-calendar-card.is-missing{
      color:var(--subtext);
      background:rgba(255,255,255,.75);
    }
    .bulk-calendar-line{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .bulk-calendar-date{
      font-weight:900;
      font-size:13px;
      color:var(--text);
    }
    .bulk-calendar-label{
      color:var(--subtext);
      font-weight:800;
    }
    @media (max-width: 720px){
      .bulk-change-row{
        grid-template-columns:1fr;
      }
      .bulk-change-calendar{
        justify-content:flex-start;
      }
    }
    .change-history-header{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    .change-history-title{
      font-size:16px;
      font-weight:900;
    }
    .change-history-meta{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      font-size:12px;
      color:var(--subtext);
    }
    .bulk-field-label{
      font-size:12px;
      font-weight:700;
      color:var(--subtext);
    }
    .bulk-month-controls input[type="date"],
    .bulk-month-controls select,
    .bulk-change-controls input[type="date"],
    .bulk-change-controls select{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      font-weight:700;
    }
    .bulk-child-list{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:6px;
      margin-top:6px;
    }
    .bulk-selector-tabs{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    .bulk-selector-tabs .selector-tab{
      padding:6px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--panel-sub);
      font-weight:900;
      font-size:12px;
      color:var(--subtext);
      cursor:pointer;
    }
    .bulk-selector-tabs .selector-tab.active{
      background:linear-gradient(120deg, rgba(139,92,246,.18), rgba(34,211,238,.18));
      border-color:rgba(139,92,246,.35);
      color:var(--text);
    }
    .bulk-option-list{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
      gap:8px;
      margin-bottom:12px;
    }
    .bulk-option-btn{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel-sub);
      font-weight:800;
      color:var(--text);
      text-align:center;
      cursor:pointer;
      transition:transform .2s ease, box-shadow .2s ease;
    }
    .bulk-option-btn:disabled{
      cursor:default;
      opacity:.55;
      box-shadow:none;
      transform:none;
    }
    .bulk-option-btn.active{
      background:linear-gradient(120deg, rgba(139,92,246,.2), rgba(34,211,238,.18));
      border-color:rgba(139,92,246,.45);
      color:var(--text);
      box-shadow:0 8px 18px rgba(61,51,92,.12);
    }
    .bulk-child-btn{
      padding:10px 12px;
      min-height:44px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel-sub);
      font-weight:700;
      color:var(--text);
      cursor:pointer;
      transition:transform .15s, box-shadow .15s, border-color .15s;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
    }
    .bulk-child-btn.is-selected{
      outline:2px solid #10b981;
      outline-offset:2px;
      box-shadow:0 10px 24px rgba(16,185,129,.18);
    }
    .bulk-change-meta{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom:8px;
    }
    .bulk-change-period{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:var(--subtext);
    }
    .bulk-change-range{
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:12px;
      color:var(--subtext);
    }
    .bulk-change-range span:first-child{
      font-weight:700;
      color:var(--subtext);
    }
    .bulk-change-range-value{
      font-weight:800;
      color:var(--text);
    }
    .bulk-change-field{
      display:flex;
      align-items:center;
      gap:6px;
      font-weight:700;
    }
    .bulk-change-start{
      border-radius:8px;
      border:1px solid var(--border);
      padding:4px 6px;
      font-size:12px;
      background:var(--panel-sub);
      color:var(--text);
    }
    .bulk-change-type-summary{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      font-size:12px;
      color:var(--subtext);
      font-weight:700;
    }
    .bulk-change-type-summary strong{
      color:var(--text);
      font-weight:900;
    }
    .bulk-child-btn.type-standard{
      background:#dcfce7;
      border-color:#86efac;
      color:#166534;
    }
    .bulk-child-btn.type-short{
      background:#fef9c3;
      border-color:#fde68a;
      color:#92400e;
    }
    .bulk-child-btn.type-1gou{
      background:#e0f2fe;
      border-color:#bfdbfe;
      color:#1d4ed8;
    }
    .bulk-child-btn .change-indicator{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:18px;
      height:18px;
      border-radius:50%;
      background:#f97316;
      color:#fff;
      font-size:11px;
      font-weight:900;
      flex:0 0 auto;
    }
    .bulk-change-panel{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .bulk-change-targets{
      display:flex;
      flex-direction:column;
      gap:6px;
      padding:8px 10px;
      border-radius:10px;
      border:1px dashed var(--border);
      background:var(--panel);
      font-size:12px;
      color:var(--subtext);
      flex:1 1 100%;
    }
    .bulk-change-targets div{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .bulk-change-targets .bulk-target-chip{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(99,102,241,.12);
      color:#4f46e5;
      font-weight:800;
      font-size:12px;
    }
    .bulk-row-actions{
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
    }
    .bulk-row-remove{
      background:transparent;
      border:1px solid var(--border);
      color:var(--subtext);
      border-radius:8px;
      padding:4px 8px;
      font-weight:700;
      cursor:pointer;
    }
    .child-type-table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    .child-type-table th,
    .child-type-table td{
      padding:8px 10px;
      border-bottom:1px solid var(--border);
      text-align:left;
    }
    .child-type-table th{
      font-weight:900;
      color:var(--subtext);
      background:rgba(0,0,0,.03);
    }
    .child-type-table select{
      width:100%;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid var(--border);
      background:var(--panel-sub);
      color:var(--text);
      font-weight:700;
    }
    .changed-type-list{
      margin-top:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .changed-type-table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    .changed-type-table th,
    .changed-type-table td{
      padding:8px 10px;
      border-bottom:1px solid var(--border);
      text-align:left;
    }
    .changed-type-table th{
      font-weight:900;
      color:var(--subtext);
      background:rgba(0,0,0,.03);
    }
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(15, 16, 30, 0.45);
      display:flex;
      align-items:center;
      justify-content:center;
      opacity:0;
      pointer-events:none;
      transition:opacity .2s ease;
      z-index:calc(var(--window-layer) + 20);
      padding:24px;
    }
    .modal-overlay.open{
      opacity:1;
      pointer-events:auto;
    }
    .modal-dialog{
      width:min(980px, 100%);
      max-height:85vh;
      overflow:auto;
    }
    .test-data-body{
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .test-data-list{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .test-data-item{
      display:flex;
      gap:12px;
      align-items:flex-start;
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px 14px;
      background:var(--panel-sub);
    }
    .test-data-item input{
      margin-top:4px;
      accent-color:var(--accent);
    }
    .test-data-copy{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .test-data-title{
      font-weight:900;
      color:var(--text);
    }
    .test-data-meta{
      font-size:12px;
      color:var(--subtext);
    }
    .test-data-actions{
      display:flex;
      justify-content:flex-end;
    }
    .test-data-download{
      font-size:12px;
      color:var(--accent);
      text-decoration:none;
      font-weight:700;
    }
    .test-data-download:hover{
      text-decoration:underline;
    }
    .guide-dialog{
      width:min(940px, 100%);
      position:relative;
      z-index:2;
    }
    #usageGuideModal{
      background:transparent;
    }
    .guide-panel{
      background:var(--panel);
      border-radius:18px;
      border:1px solid var(--border);
      box-shadow:0 18px 45px rgba(45, 29, 67, 0.18);
      padding:18px 20px 16px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .guide-step-indicator{
      font-size:12px;
      font-weight:800;
      color:var(--subtext);
      text-align:right;
    }
    .guide-step{
      display:none;
      gap:12px;
      flex-direction:column;
    }
    .guide-step.is-active{
      display:flex;
    }
    .guide-section-title{
      font-size:16px;
      font-weight:900;
      color:var(--text);
      margin:0;
    }
    .guide-list{
      margin:0;
      padding-left:20px;
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:13px;
      color:var(--text);
    }
    .guide-list strong{
      color:var(--text);
    }
    .guide-note{
      font-size:12px;
      color:var(--subtext);
      background:var(--panel-sub);
      border-radius:12px;
      padding:10px 12px;
      border:1px solid var(--border);
    }
    .guide-actions{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-top:6px;
    }
    .guide-spotlight-layer{
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:0;
      transition:opacity .2s ease;
      z-index:1;
    }
    .guide-spotlight-layer.is-active{
      opacity:1;
    }
    .guide-spotlight-frame{
      position:fixed;
      border-radius:16px;
      border:2px solid rgba(255,255,255,0.9);
      box-shadow:
        0 0 0 9999px rgba(15, 16, 30, 0.55),
        0 0 24px rgba(255,255,255,0.25);
      transition:top .2s ease, left .2s ease, width .2s ease, height .2s ease;
    }
    .guide-callout{
      position:fixed;
      max-width:280px;
      padding:12px 14px;
      border-radius:14px;
      background:var(--panel);
      border:1px solid var(--border);
      box-shadow:0 14px 30px rgba(15, 16, 30, 0.18);
      color:var(--text);
      font-size:12px;
      line-height:1.6;
    }
    .guide-callout-title{
      font-weight:900;
      margin-bottom:4px;
      font-size:13px;
    }
    .guide-callout::before{
      content:"";
      position:absolute;
      width:0;
      height:0;
      border-style:solid;
    }
    .guide-callout[data-direction="right"]::before{
      left:-8px;
      top:18px;
      border-width:8px 8px 8px 0;
      border-color:transparent var(--panel) transparent transparent;
      filter:drop-shadow(-1px 0 0 var(--border));
    }
    .guide-callout[data-direction="left"]::before{
      right:-8px;
      top:18px;
      border-width:8px 0 8px 8px;
      border-color:transparent transparent transparent var(--panel);
      filter:drop-shadow(1px 0 0 var(--border));
    }
    .guide-callout[data-direction="bottom"]::before{
      left:18px;
      top:-8px;
      border-width:0 8px 8px 8px;
      border-color:transparent transparent var(--panel) transparent;
      filter:drop-shadow(0 -1px 0 var(--border));
    }
    .guide-callout[data-direction="top"]::before{
      left:18px;
      bottom:-8px;
      border-width:8px 8px 0 8px;
      border-color:var(--panel) transparent transparent transparent;
      filter:drop-shadow(0 1px 0 var(--border));
    }
    .modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .startup-choice-body{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .startup-choice-info{
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--border);
      background:var(--panel-sub);
    }
    .startup-choice-section{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .startup-choice-section-title{
      font-weight:800;
      font-size:13px;
      color:var(--text);
    }
    .startup-choice-meta{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(160px, 1fr));
      gap:8px;
      font-size:12px;
    }
    .startup-choice-meta-row{
      display:flex;
      flex-direction:column;
      gap:4px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel);
    }
    .startup-choice-meta-label{
      font-weight:700;
      color:var(--subtext);
    }
    .startup-choice-meta-value{
      font-weight:700;
      color:var(--text);
    }
    .startup-choice-history{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .startup-calendar-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .startup-calendar-nav{
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      padding:6px 10px;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
    }
    .startup-calendar-label{
      font-weight:800;
      color:var(--text);
    }
    .startup-calendar-weekdays{
      display:grid;
      grid-template-columns:repeat(7, minmax(0, 1fr));
      gap:6px;
      font-size:11px;
      color:var(--subtext);
      text-align:center;
    }
    .startup-calendar-grid{
      display:grid;
      grid-template-columns:repeat(7, minmax(0, 1fr));
      gap:8px;
    }
    .startup-calendar-cell{
      min-height:96px;
      border-radius:12px;
      border:1px dashed transparent;
      background:transparent;
    }
    .startup-calendar-day{
      width:100%;
      height:100%;
      padding:8px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel);
      text-align:left;
      font-size:11px;
      display:flex;
      flex-direction:column;
      gap:4px;
      cursor:pointer;
      transition:transform .2s ease, box-shadow .2s ease;
    }
    .startup-calendar-day .date{
      font-weight:800;
      color:var(--text);
      font-size:12px;
    }
    .startup-calendar-day .meta{
      color:var(--subtext);
      font-size:10px;
    }
    .startup-calendar-day.has-work{
      border-color:rgba(34,197,94,.5);
      background:rgba(34,197,94,.08);
    }
    .startup-calendar-day.is-selected{
      border-color:rgba(139,92,246,.6);
      background:rgba(139,92,246,.12);
      box-shadow:0 6px 18px rgba(139,92,246,.15);
    }
    .startup-calendar-day:disabled{
      cursor:not-allowed;
      opacity:.5;
    }
    .startup-calendar-actions{
      display:flex;
      justify-content:flex-end;
    }
    .startup-choice-history-list{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .startup-choice-dataset{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel);
      font-size:12px;
      cursor:pointer;
      text-align:left;
    }
    .startup-choice-dataset.is-active{
      border-color:rgba(139,92,246,.55);
      background:rgba(139,92,246,.08);
    }
    .startup-choice-dataset-label{
      font-weight:800;
      color:var(--text);
    }
    .startup-choice-dataset-meta{
      color:var(--subtext);
    }
    .startup-choice-empty{
      font-size:12px;
      color:var(--subtext);
      padding:10px 0;
    }
    .startup-choice-actions{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .startup-choice-btn{
      padding:8px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel-sub);
      color:var(--text);
      font-weight:800;
      font-size:13px;
      cursor:pointer;
      transition:transform .2s ease, box-shadow .2s ease;
    }
    .startup-choice-btn.is-active{
      border-color:rgba(139,92,246,.55);
      background:rgba(139,92,246,.12);
      box-shadow:0 6px 18px rgba(139,92,246,.18);
    }
    .startup-choice-btn.primary{
      background:linear-gradient(120deg, rgba(139,92,246,.18), rgba(34,211,238,.18));
      border-color:rgba(139,92,246,.35);
    }
    .window-warning-body{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .window-warning-list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin:0;
      padding:0;
    }
    .window-warning-card{
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel-sub);
      padding:10px 12px;
      display:block;
      cursor:pointer;
    }
    .window-warning-title{
      font-size:14px;
      font-weight:900;
      margin-bottom:6px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .window-warning-select{
      margin:0;
    }
    .window-warning-meta{
      font-size:12px;
      color:var(--subtext);
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .window-warning-actions{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:4px;
    }
    .bulk-change-actions{
      display:flex;
      justify-content:flex-end;
      align-items:center;
      gap:8px;
      margin-top:6px;
    }
    .bulk-history-btn{
      border-radius:999px;
      border:1px solid var(--border);
      padding:6px 12px;
      font-size:12px;
      background:var(--panel);
      color:var(--muted);
      font-weight:800;
      cursor:pointer;
    }
    .bulk-history-btn:hover{
      border-color:var(--accent);
      box-shadow:0 8px 16px rgba(139,92,246,.18);
      transform:translateY(-1px);
    }
    .delete-history-list{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:8px;
    }
    .delete-history-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel-sub);
      font-size:12px;
      font-weight:700;
      color:var(--text);
    }
    .small.danger{
      background:#fee2e2;
      color:#991b1b;
      border-color:#fecaca;
    }
    .toast-container{
      position:fixed;
      right:20px;
      bottom:24px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:calc(var(--window-layer) + 60);
      max-width:min(320px, 80vw);
      pointer-events:none;
    }
    .toast{
      background:rgba(17, 24, 39, .92);
      color:#f9fafb;
      padding:10px 14px;
      border-radius:12px;
      font-size:12px;
      font-weight:700;
      box-shadow:0 12px 28px rgba(15,23,42,.28);
      transform:translateY(8px);
      opacity:0;
      animation:toast-in .25s ease forwards;
    }
    .toast.is-leaving{
      animation:toast-out .2s ease forwards;
    }
    @keyframes toast-in{
      to{transform:translateY(0);opacity:1;}
    }
    @keyframes toast-out{
      to{transform:translateY(10px);opacity:0;}
    }
    .modal-title{
      font-weight:900;
      font-size:14px;
      color:var(--text);
    }
    .modal-close{
      padding:6px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel-sub);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
    }
    .data-node-body{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .data-node-list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .data-node-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel);
      box-shadow:0 8px 18px rgba(61,51,92,.08);
    }
    .data-node-row.is-active{
      border-color:rgba(139,92,246,.4);
      box-shadow:0 10px 20px rgba(139,92,246,.2);
    }
    .data-node-info{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .data-node-user{
      font-weight:900;
      color:var(--text);
    }
    .data-node-meta{
      font-size:11px;
      color:var(--subtext);
      font-weight:800;
    }
    .data-node-actions{
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
    }
    .data-node-actions button{
      border:none;
      border-radius:10px;
      padding:4px 10px;
      font-size:11px;
      font-weight:800;
      cursor:pointer;
      background:var(--panel-sub);
      color:var(--text);
    }
    .data-node-actions button.primary{
      background:var(--accent);
      color:#fff;
    }
    .dataset-compare-tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin:12px 0 8px;
    }
    .dataset-compare-tab{
      padding:6px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--panel-sub);
      color:var(--text);
      font-weight:800;
      cursor:pointer;
    }
    .dataset-compare-tab.active{
      border-color:#0ea5e9;
      background:linear-gradient(120deg, rgba(14,165,233,.2), rgba(56,189,248,.16));
      box-shadow:0 10px 24px rgba(14,165,233,.2);
    }
    .dataset-compare-panel[hidden]{display:none;}
    .dataset-compare-section{
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel-sub);
    }
    .dataset-compare-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:8px 0;
      border-bottom:1px dashed rgba(0,0,0,.08);
    }
    .dataset-compare-row:last-child{border-bottom:none;}
    .dataset-compare-title{
      font-size:13px;
      font-weight:800;
      color:var(--text);
    }
    .dataset-compare-sub{
      font-size:11px;
      color:var(--subtext);
    }
    .dataset-compare-actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .dataset-compare-actions button{
      padding:5px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:800;
      cursor:pointer;
    }
    .dataset-compare-actions button.active{
      border-color:#0ea5e9;
      background:rgba(14,165,233,.12);
      color:#0369a1;
    }
    .dataset-compare-meta{
      margin-top:6px;
      display:grid;
      gap:4px;
    }
    .dataset-compare-meta-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:11px;
    }
    .dataset-compare-meta-label{
      min-width:72px;
      font-weight:700;
      color:var(--text);
    }
    .dataset-compare-meta-value{
      color:var(--subtext);
    }
    .dataset-compare-footer{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:12px;
    }
    .history-dataset-layout{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
    }
    .history-dataset-pane{
      display:flex;
      flex-direction:column;
      gap:8px;
      min-width:0;
    }
    .history-dataset-pane-title{
      font-weight:900;
      font-size:12px;
      color:var(--text);
    }
    .history-dataset-pane-sub{
      font-size:11px;
      color:var(--subtext);
    }
    .history-dataset-list{
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height:52vh;
      overflow:auto;
      padding-right:4px;
    }
    .history-dataset-row{
      cursor:pointer;
    }
    .history-dataset-row.is-selected{
      border-color:rgba(99,102,241,.5);
      box-shadow:0 10px 20px rgba(99,102,241,.25);
    }
    .history-dataset-badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 6px;
      margin-left:6px;
      border-radius:999px;
      font-size:10px;
      font-weight:700;
      color:var(--primary);
      background:rgba(99,102,241,.15);
      letter-spacing:.02em;
    }
    .history-dataset-empty{
      padding:10px 12px;
      border-radius:12px;
      border:1px dashed var(--border);
      color:var(--subtext);
      font-size:12px;
    }
    .exempt-modal-body{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .exempt-reason-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap:8px;
    }
    .exempt-reason-btn{
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 12px;
      background:var(--panel-sub);
      color:var(--text);
      font-weight:700;
      cursor:pointer;
      transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .exempt-reason-btn:hover{
      transform:translateY(-1px);
      box-shadow:0 6px 16px rgba(15, 23, 42, 0.12);
    }
    .exempt-reason-btn.is-active{
      border-color:var(--accent);
      background:rgba(124, 58, 237, 0.12);
      color:var(--accent);
    }
    .exempt-reason-input{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel);
      font-size:14px;
      color:var(--text);
    }
    .exempt-modal-actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .summary-layout{
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:stretch;
    }
    .summary-tabs{
      display:flex;
      gap:8px;
      margin:0;
      flex-direction:row;
      align-items:stretch;
      flex-wrap:nowrap;
      overflow-x:auto;
      padding-bottom:6px;
      scrollbar-width:thin;
      scrollbar-color:var(--accent) rgba(0,0,0,.06);
    }
    .summary-tab-btn{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:8px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:linear-gradient(180deg, var(--panel), var(--panel-sub));
      color:var(--text);
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      transition:background .2s, box-shadow .2s, transform .2s, border-color .2s;
      white-space:nowrap;
      flex:1 0 auto;
      box-shadow:0 10px 24px rgba(61,51,92,.08);
    }
    .summary-tab-btn.summary-action-button{
      min-width:40px;
      height:40px;
      padding:0 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel-sub);
      box-shadow:0 8px 20px rgba(61,51,92,.12);
      font-size:12px;
      font-weight:900;
      flex:0 0 auto;
      white-space:nowrap;
    }
    .summary-tab-btn.active,
    .summary-tab-btn.is-persistent-active{
      background:linear-gradient(135deg, rgba(139,92,246,.12), rgba(34,211,238,.16));
      border-color:var(--accent);
      box-shadow:0 12px 28px rgba(139,92,246,.2);
    }
    .summary-tab-btn.summary-action-button.active,
    .summary-tab-btn.summary-action-button.is-persistent-active{
      background:var(--panel);
      border-color:var(--accent);
      box-shadow:0 10px 24px rgba(61,51,92,.16);
    }
    .summary-layer.is-collapsed .summary-tabs-layer .summary-tab-btn[data-summary-tab="child"]{
      display:none;
    }
    #headerChildFilterHost{
      display:block;
      position:sticky;
      top:8px;
      z-index:160;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:16px;
      padding:8px 10px;
      box-shadow:0 8px 18px rgba(61,51,92,.12);
    }
    .child-notify-bubble{
      position:absolute;
      z-index:40;
      min-width:300px;
      max-width:420px;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow:0 18px 34px rgba(15,23,42,.18);
      padding:8px 10px;
      display:flex;
      align-items:center;
      gap:6px;
      transform:translate(-50%, 0);
      animation:childNotifyFloat 3.2s ease-in-out infinite;
    }
    .child-notify-bubble--pending{
      min-width:140px;
      max-width:220px;
      background:var(--panel-sub);
      padding:6px 12px;
      font-size:11px;
      font-weight:800;
      color:var(--text);
      animation:none;
    }
    .child-notify-bubble[aria-hidden="true"]{
      display:none;
    }
    .child-notify-bubble::before{
      content:"";
      position:absolute;
      top:-8px;
      left:var(--bubble-arrow-left, 50%);
      transform:translateX(-50%);
      width:0;
      height:0;
      border-left:8px solid transparent;
      border-right:8px solid transparent;
      border-bottom:8px solid var(--panel);
      filter:drop-shadow(0 -2px 2px rgba(15,23,42,.08));
    }
    .child-notify-bubble--pending::before{
      border-bottom-color:var(--panel-sub);
    }
    @keyframes childNotifyFloat{
      0%, 100%{ transform:translate(-50%, 0); }
      50%{ transform:translate(-50%, -6px); }
    }
    .child-notify-row{
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap:nowrap;
      width:100%;
    }
    .child-notify-badges{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      min-width:0;
    }
    .child-notify-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px 8px;
      border-radius:999px;
      font-size:10px;
      font-weight:900;
      border:1px solid transparent;
      white-space:nowrap;
    }
    .child-notify-badge.is-linked{
      background:rgba(6,199,85,.12);
      color:#0f5132;
      border-color:rgba(6,199,85,.4);
    }
    .child-notify-badge.is-unlinked{
      background:rgba(148,163,184,.18);
      color:#475569;
      border-color:rgba(148,163,184,.4);
    }
    .child-notify-badge.is-chat{
      background:rgba(59,130,246,.12);
      color:#1d4ed8;
      border-color:rgba(59,130,246,.35);
    }
    .child-notify-badge.is-replied{
      background:rgba(34,197,94,.14);
      color:#166534;
      border-color:rgba(34,197,94,.35);
    }
    .child-notify-badge.is-muted{
      background:rgba(148,163,184,.12);
      color:var(--subtext);
      border-color:rgba(148,163,184,.24);
    }
    .child-notify-actions{
      display:flex;
      gap:4px;
      flex-wrap:nowrap;
      margin-left:auto;
      flex:0 0 auto;
    }
    .child-notify-btn{
      border:1px solid var(--border);
      background:var(--panel-sub);
      color:var(--text);
      border-radius:10px;
      padding:6px 10px;
      font-size:11px;
      font-weight:900;
      cursor:pointer;
    }
    .child-notify-btn.line-button{
      background:#06c755;
      border-color:#06c755;
      color:#fff;
      min-width:72px;
      padding:5px 8px;
      font-size:10px;
      text-align:center;
    }
    .child-notify-btn.is-primary{
      background:linear-gradient(120deg,var(--accent),var(--accent-2));
      color:#fff;
      border-color:transparent;
    }
    .summary-tab-pane[hidden]{display:none;}
    .summary-tab-pane{margin-top:0;}
    .panel.is-collapsed:not(.summary-panel) .collapsible-body{display:none;}
    .summary-pane-wrapper{
      width:100%;
      max-height:min(60vh, 520px);
      overflow-y:auto;
      padding-right:4px;
      flex:1 1 auto;
      min-height:0;
    }
    body.display-summary #summaryPanel .collapsible-body{
      display:flex;
      flex-direction:column;
    }
    body.display-summary #summaryPanel .summary-layout{
      flex:1 1 auto;
      min-height:0;
    }
    body.display-summary .summary-pane-wrapper{
      max-height:none;
      overflow:visible;
    }
    .summary-pane-wrapper.is-manual-full{
      max-height:none;
      overflow:visible;
    }
    .summary-child-grid{
      display:grid;
      grid-template-columns:minmax(240px, 320px) minmax(0, 1fr);
      gap:16px;
      align-items:start;
    }
    .summary-dataset{
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .summary-dataset-head{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .summary-dataset-title{
      font-size:18px;
      font-weight:800;
      margin:0;
    }
    .summary-dataset-sub{
      color:var(--subtext);
      font-size:13px;
      font-weight:600;
    }
    .summary-dataset-groups{
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .summary-dataset-group{
      border:1px solid var(--border);
      border-radius:16px;
      background:var(--panel);
      padding:16px;
      box-shadow:0 10px 24px rgba(61,51,92,.08);
    }
    .summary-dataset-group-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      font-weight:800;
      margin-bottom:12px;
    }
    .summary-dataset-group-meta{
      color:var(--subtext);
      font-size:12px;
      font-weight:600;
    }
    .summary-dataset-list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .summary-dataset-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(148,163,184,0.12);
      border:1px solid rgba(148,163,184,0.25);
    }
    .summary-dataset-name{
      font-weight:700;
      min-width:120px;
    }
    .summary-dataset-values{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .summary-dataset-value{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:90px;
      text-align:right;
    }
    .summary-dataset-value .label{
      color:var(--subtext);
      font-size:11px;
      font-weight:700;
    }
    .summary-dataset-value.total .label{
      color:var(--text);
    }
    .summary-dataset-value .value{
      font-weight:800;
      font-size:14px;
    }
    .summary-dataset-loading{
      color:var(--subtext);
      font-weight:700;
      letter-spacing:.08em;
    }
    .summary-changed-section{
      margin-top:18px;
      border:1px solid var(--border);
      border-radius:16px;
      background:var(--panel);
      padding:14px;
      box-shadow:0 10px 24px rgba(61,51,92,.08);
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .summary-changed-only{
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .summary-changed-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .summary-changed-title{
      font-weight:900;
      font-size:13px;
      color:var(--text);
    }
    .summary-changed-sub{
      font-size:11px;
      color:var(--subtext);
      font-weight:700;
    }
    .summary-changed-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .summary-changed-actions button{
      border:none;
      border-radius:10px;
      padding:6px 12px;
      font-size:11px;
      font-weight:800;
      cursor:pointer;
      background:var(--panel-sub);
      color:var(--text);
      box-shadow:0 8px 20px rgba(61,51,92,.12);
    }
    .summary-changed-actions button.primary{
      background:linear-gradient(135deg, rgba(139,92,246,.22), rgba(34,211,238,.22));
      color:var(--accent);
    }
    .summary-changed-list{
      display:grid;
      gap:12px;
    }
    .summary-changed-card{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:var(--panel-sub);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .summary-changed-card-body{
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .summary-changed-card-info{
      flex:1;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .summary-changed-card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .summary-changed-card-name{
      font-weight:900;
      font-size:14px;
      line-height:1.4;
    }
    .summary-changed-card-meta{
      font-size:10px;
      color:var(--subtext);
      font-weight:700;
    }
    .summary-copy-btn{
      border:none;
      border-radius:10px;
      padding:6px 12px;
      font-size:11px;
      font-weight:800;
      cursor:pointer;
      background:var(--panel);
      color:var(--text);
      box-shadow:0 8px 20px rgba(61,51,92,.12);
      min-width:88px;
    }
    .summary-changed-card-actions{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .summary-type-change-btn{
      border:none;
      border-radius:10px;
      padding:6px 12px;
      font-size:11px;
      font-weight:800;
      cursor:pointer;
      background:rgba(16,185,129,.16);
      color:#047857;
      box-shadow:0 8px 20px rgba(61,51,92,.12);
    }
    .summary-type-change-btn:disabled{
      opacity:.5;
      cursor:not-allowed;
      box-shadow:none;
    }
    .summary-changed-type-badges{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      align-items:center;
    }
    .summary-type-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid transparent;
      font-size:10px;
      font-weight:800;
      color:var(--text);
      background:var(--panel);
    }
    .summary-type-badge.is-loading{
      background:var(--panel-sub);
      border-color:var(--border);
      color:var(--muted);
    }
    .summary-type-badge .label{
      color:var(--subtext);
      font-weight:800;
    }
    .summary-type-badge.type-standard{background:#dcfce7;border-color:#86efac;color:#166534;}
    .summary-type-badge.type-short{background:#fce7f3;border-color:#f9a8d4;color:#9d174d;}
    .summary-type-badge.type-1gou{background:#ffedd5;border-color:#fdba74;color:#9a3412;}
    .summary-changed-badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:4px 10px;
      border-radius:999px;
      font-size:10px;
      font-weight:800;
      background:var(--panel-sub);
      color:var(--muted);
      border:1px dashed var(--border);
      margin-top:6px;
    }
    .summary-changed-badge.is-loading{
      background:rgba(59,130,246,.12);
      color:#2563eb;
      border-color:rgba(59,130,246,.4);
    }
    .summary-changed-card.is-pending{
      opacity:.85;
    }
    .summary-changed-calendar{
      width:240px;
      border:1px solid var(--border);
      border-radius:12px;
      padding:8px;
      background:var(--panel);
      box-shadow:0 10px 22px rgba(61,51,92,.08);
    }
    .summary-changed-calendar-header{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom:6px;
    }
    .summary-changed-calendar-title{
      font-size:11px;
      font-weight:900;
      color:var(--text);
    }
    .summary-changed-calendar-legend{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .summary-changed-legend-item{
      display:flex;
      align-items:center;
      gap:4px;
      font-size:10px;
      color:var(--subtext);
      font-weight:800;
    }
    .summary-changed-legend-chip{
      width:10px;
      height:10px;
      border-radius:999px;
      border:1px solid transparent;
      display:inline-block;
    }
    .summary-changed-legend-chip.standard{background:#dcfce7;border-color:#86efac;}
    .summary-changed-legend-chip.short{background:#fce7f3;border-color:#f9a8d4;}
    .summary-changed-legend-chip.onegou{background:#ffedd5;border-color:#fdba74;}
    .summary-changed-calendar-weekdays{
      display:grid;
      grid-template-columns:repeat(7, 1fr);
      gap:4px;
      font-size:9px;
      font-weight:800;
      color:var(--subtext);
      text-align:center;
      margin-bottom:4px;
    }
    .summary-changed-calendar-grid{
      display:grid;
      grid-template-columns:repeat(7, 1fr);
      gap:4px;
    }
    .summary-changed-calendar-cell{
      border:1px solid var(--border);
      border-radius:6px;
      padding:4px 0;
      text-align:center;
      font-size:10px;
      font-weight:800;
      color:var(--text);
      background:var(--panel-sub);
      min-height:22px;
    }
    .summary-changed-calendar-cell.type-standard{background:#dcfce7;border-color:#86efac;color:#166534;}
    .summary-changed-calendar-cell.type-short{background:#fce7f3;border-color:#f9a8d4;color:#9d174d;}
    .summary-changed-calendar-cell.type-1gou{background:#ffedd5;border-color:#fdba74;color:#9a3412;}
    .summary-changed-calendar-cell.is-empty{
      color:var(--muted);
      border-style:dashed;
      background:var(--panel);
    }
    .summary-changed-calendar-cell.is-outside{
      opacity:.35;
    }
    @media (max-width: 980px){
      .summary-changed-card-body{
        flex-direction:column;
      }
      .summary-changed-calendar{
        width:100%;
      }
    }
    .summary-copy-btn.primary{
      background:linear-gradient(135deg, rgba(139,92,246,.24), rgba(34,211,238,.22));
      color:var(--accent);
    }
    .type-change-modal-body{
      display:grid;
      gap:12px;
      padding:4px 2px 8px;
    }
    .type-change-modal-child{
      font-size:12px;
      font-weight:900;
      color:var(--text);
    }
    .type-change-field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .type-change-label{
      font-size:11px;
      font-weight:800;
      color:var(--subtext);
    }
    .type-change-date{
      border-radius:12px;
      border:1px solid var(--border);
      padding:8px 12px;
      font-weight:800;
      font-size:12px;
      background:var(--panel-sub);
      color:var(--text);
      box-shadow:0 8px 20px rgba(61,51,92,.12);
    }
    .type-change-buttons{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .type-change-btn{
      width:auto;
      min-width:120px;
      padding:6px 12px;
      font-size:12px;
    }
    .type-change-btn.is-selected{
      box-shadow:0 10px 24px rgba(16,185,129,.2);
      transform:translateY(-1px);
    }
    .type-change-actions{
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }
    .summary-copy-btn[disabled]{
      cursor:not-allowed;
      opacity:.6;
      box-shadow:none;
    }
    .summary-copy-preview{
      font-size:11px;
      font-weight:700;
      color:var(--subtext);
      white-space:pre-wrap;
      background:rgba(15,23,42,.04);
      border-radius:10px;
      padding:8px 10px;
    }
    .copy-fallback-body{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .copy-fallback-body textarea{
      width:100%;
      min-height:140px;
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px;
      font-size:12px;
      font-family:inherit;
    }
    .summary-child-panel{
      border:1px solid var(--border);
      border-radius:16px;
      background:var(--panel);
      padding:12px;
      box-shadow:0 10px 24px rgba(61,51,92,.08);
      position:sticky;
      top:12px;
      align-self:start;
    }
    .summary-child-table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    .summary-child-table th,
    .summary-child-table td{
      padding:8px 10px;
      border-bottom:1px solid var(--border);
      text-align:left;
      vertical-align:top;
    }
    .summary-child-table th{
      width:46%;
      color:var(--subtext);
      font-weight:800;
    }
    .summary-child-table td{
      font-weight:800;
      color:var(--text);
    }
    .summary-child-table tr:last-child th,
    .summary-child-table tr:last-child td{
      border-bottom:none;
    }
    .summary-pair{
      display:inline-flex;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
    }
    .summary-pair-divider{
      color:var(--subtext);
      font-weight:700;
    }
    .summary-pair-after{
      color:var(--accent);
      font-weight:900;
      display:inline-flex;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
    }
    .summary-total-stack{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .summary-total-row{
      display:flex;
      align-items:center;
      gap:6px;
      font-weight:800;
    }
    .summary-total-row .summary-change-label{
      font-size:10px;
    }
    .summary-total-row .summary-total-value{
      font-size:12px;
      font-weight:900;
    }
    .summary-total-row.is-after .summary-total-value{
      color:var(--accent);
    }
    .summary-calendar{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .summary-calendar-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      font-weight:900;
      font-size:12px;
      color:var(--text);
    }
    .summary-calendar-title{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .summary-calendar-legend{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:10px;
      color:var(--subtext);
      font-weight:800;
    }
    .summary-legend-item{
      display:flex;
      align-items:center;
      gap:4px;
    }
    .summary-legend-chip{
      width:12px;
      height:12px;
      border-radius:6px;
      border:2px solid transparent;
      background:linear-gradient(90deg,#dcfce7 0%,#dcfce7 33%,#fce7f3 33%,#fce7f3 66%,#ffedd5 66%,#ffedd5 100%);
      box-sizing:border-box;
    }
    .summary-legend-chip.before{
      background:
        linear-gradient(#fff,#fff) padding-box,
        linear-gradient(90deg,#dcfce7 0%,#dcfce7 33%,#fce7f3 33%,#fce7f3 66%,#ffedd5 66%,#ffedd5 100%) border-box;
    }
    /* Keep explicit .after rule to mirror `.before` and allow future visual
       differentiation; currently uses the same gradient as the base chip. */
    .summary-legend-chip.after{
      background:linear-gradient(90deg,#dcfce7 0%,#dcfce7 33%,#fce7f3 33%,#fce7f3 66%,#ffedd5 66%,#ffedd5 100%);
    }
    .summary-calendar-controls{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .summary-calendar-nav{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      font-weight:800;
      color:var(--subtext);
    }
    .summary-calendar-nav button{
      border:none;
      background:var(--panel);
      border-radius:8px;
      padding:4px 8px;
      font-weight:900;
      color:var(--text);
      box-shadow:0 6px 16px rgba(61,51,92,.12);
      cursor:pointer;
    }
    .summary-calendar-current{
      font-size:12px;
      font-weight:900;
      color:var(--text);
    }
    .summary-node-actions{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .summary-node-actions .summary-node-btn{
      border:none;
      background:var(--panel);
      border-radius:10px;
      padding:4px 10px;
      font-size:11px;
      font-weight:800;
      color:var(--text);
      box-shadow:0 6px 16px rgba(61,51,92,.12);
      cursor:pointer;
    }
    .summary-node-actions .summary-node-btn.secondary{
      background:var(--panel-sub);
      color:var(--subtext);
    }
    .summary-node-current{
      font-size:10px;
      font-weight:800;
      color:var(--subtext);
    }
    .summary-calendar-weekdays{
      display:grid;
      grid-template-columns:repeat(7, minmax(0, 1fr));
      gap:6px;
      font-size:11px;
      font-weight:800;
      color:var(--subtext);
      text-align:center;
    }
    .summary-calendar-grid{
      display:grid;
      grid-template-columns:repeat(7, minmax(0, 1fr));
      gap:6px;
    }
    .summary-calendar-card{
      position:relative;
      border:1px solid var(--summary-before-border, var(--border));
      border-radius:16px;
      padding:6px;
      min-height:96px;
      background:var(--summary-after-bg, var(--panel));
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:11px;
      color:var(--summary-after-text, var(--text));
      overflow:hidden;
      box-shadow:0 10px 26px rgba(61,51,92,.12);
    }
    .summary-calendar-card.is-clickable{
      cursor:pointer;
    }
    .summary-calendar-inner{
      border-radius:10px;
      border:none;
      background:transparent;
      padding:0;
      display:flex;
      flex-direction:column;
      gap:4px;
      min-height:88px;
      box-sizing:border-box;
    }
    .summary-calendar-card.before-type-1gou{--summary-before-border:#fdba74;}
    .summary-calendar-card.before-type-short{--summary-before-border:#f9a8d4;}
    .summary-calendar-card.before-type-standard{--summary-before-border:#86efac;}
    .summary-calendar-card.after-type-1gou{--summary-after-bg:#ffedd5;--summary-after-text:#9a3412;}
    .summary-calendar-card.after-type-short{--summary-after-bg:#fce7f3;--summary-after-text:#9d174d;}
    .summary-calendar-card.after-type-standard{--summary-after-bg:#dcfce7;--summary-after-text:#166534;}
    .summary-calendar-card.is-outside{opacity:.45;}
    .summary-calendar-date{
      font-weight:900;
      font-size:11px;
    }
    .summary-calendar-line{
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
    }
    .summary-status-badge{
      padding:2px 6px;
      border-radius:999px;
      font-size:10px;
      font-weight:800;
      background:rgba(15,23,42,.08);
      color:var(--subtext);
    }
    .summary-clock-badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 6px;
      border-radius:999px;
      font-size:10px;
      font-weight:900;
      background:rgba(15,23,42,.12);
      color:var(--text);
    }
    .summary-clock-badge.arrive{background:rgba(14,165,233,.18);color:#0c4a6e;}
    .summary-clock-badge.leave{background:rgba(244,114,182,.18);color:#9d174d;}
    .summary-flag-badges{
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
    }
    .summary-flag-badge{
      padding:2px 6px;
      border-radius:999px;
      font-size:10px;
      font-weight:900;
      background:rgba(15,23,42,.1);
      color:var(--subtext);
    }
    .summary-flag-badge.is-active{
      background:rgba(34,197,94,.2);
      color:#065f46;
    }
    .summary-calendar-badges{
      margin-top:auto;
    }
    .summary-change-head{
      display:inline-flex;
      align-items:flex-start;
      gap:6px;
      flex-wrap:wrap;
    }
    .summary-change-block{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      line-height:1.2;
      min-width:0;
    }
    .summary-change-label{
      font-size:10px;
      font-weight:800;
      color:var(--subtext);
      white-space:nowrap;
    }
    .summary-change-name{
      font-size:11px;
      font-weight:900;
      color:var(--text);
      white-space:nowrap;
    }
    .summary-change-divider{
      color:var(--subtext);
      font-weight:700;
      line-height:1.1;
      padding-top:2px;
    }
    .summary-change-lines{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .summary-change-line{
      display:grid;
      grid-template-columns:auto 1fr;
      column-gap:4px;
      align-items:baseline;
    }
    .summary-change-values{
      font-size:10px;
      color:var(--subtext);
      font-weight:700;
    }
    body.display-summary #detailLayer .summary-panel{
      display:block;
    }
    body:not(.display-summary) #detailLayer .summary-panel{
      display:none;
    }
    .summary-calendar-badges{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      margin-top:auto;
      min-height:18px;
    }
    .summary-badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 6px;
      border-radius:999px;
      font-size:10px;
      font-weight:900;
      background:rgba(15,23,42,.08);
    }
    .summary-badge.ext{
      background:rgba(14,165,233,.2);
      color:#0c4a6e;
    }
    .summary-badge.az{
      background:rgba(245,158,11,.2);
      color:#92400e;
    }
    @media (max-width: 900px){
      .summary-child-grid{
        grid-template-columns:1fr;
      }
    }
    .summary-pane-wrapper .summary-tab-pane + .summary-tab-pane{
      margin-top:0;
    }
    .line-actions-panel{
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--panel);
      box-shadow:0 10px 24px rgba(61,51,92,.12);
    }
    .line-actions-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .line-actions-title{
      font-size:13px;
      font-weight:900;
      letter-spacing:.04em;
    }
    .line-actions-sub{
      font-size:12px;
      color:var(--subtext);
      margin-top:4px;
    }
    .line-actions-grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:12px;
    }
    .line-action-card{
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel-sub);
      padding:12px;
      display:grid;
      gap:10px;
    }
    .line-action-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:nowrap;
    }
    .line-action-text{
      display:flex;
      flex-direction:row;
      align-items:center;
      gap:10px;
      min-width:0;
      flex:1 1 auto;
    }
    .line-action-title{
      font-size:13px;
      font-weight:900;
      color:var(--text);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .line-action-sub{
      font-size:11px;
      color:var(--subtext);
    }
    .line-action-badges{
      display:flex;
      flex-wrap:nowrap;
      gap:6px;
      justify-content:flex-start;
    }
    .line-action-controls{
      display:flex;
      flex-wrap:nowrap;
      gap:8px;
      justify-content:flex-end;
    }
    .line-action-buttons{
      display:grid;
      gap:8px;
    }
    .line-action-buttons.is-split{
      grid-template-columns:repeat(2, minmax(0, 1fr));
      align-items:center;
    }
    .line-status-badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:11px;
      font-weight:800;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid transparent;
      background:rgba(148,163,184,.18);
      color:#475569;
      white-space:nowrap;
    }
    .line-status-badge.is-linked{
      background:rgba(6,199,85,.12);
      color:#067d38;
      border-color:rgba(6,199,85,.2);
    }
    .line-status-badge.is-unlinked{
      background:rgba(148,163,184,.2);
      color:#475569;
      border-color:rgba(148,163,184,.4);
    }
    .line-status-badge.is-replied{
      background:rgba(34,197,94,.16);
      color:#166534;
      border-color:rgba(34,197,94,.3);
    }
    .line-status-badge.is-pending{
      background:rgba(251,191,36,.2);
      color:#92400e;
      border-color:rgba(251,191,36,.4);
    }
    .line-status-badge.is-unsent{
      background:rgba(148,163,184,.2);
      color:#475569;
      border-color:rgba(148,163,184,.4);
    }
    .line-status-badge.line-chat{
      background:rgba(59,130,246,.16);
      color:#1d4ed8;
      border-color:rgba(59,130,246,.3);
    }
    .line-action-button{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      white-space:nowrap;
      transition:transform .15s, box-shadow .15s, border-color .15s;
    }
    .line-action-button.is-slim{
      padding:6px 14px;
    }
    .line-action-button:hover{
      border-color:rgba(99,102,241,.45);
      box-shadow:0 8px 18px rgba(61,51,92,.12);
      transform:translateY(-1px);
    }
    .line-action-button:disabled{
      background:#e2e8f0;
      color:#64748b;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }
    .line-send-button{
      border:none;
      background:#06c755;
      color:#fff;
      box-shadow:0 10px 20px rgba(6,199,85,.25);
    }
    .line-send-button:disabled{
      background:#cbd5e1;
      color:#64748b;
      cursor:not-allowed;
      box-shadow:none;
    }
    .line-qr-box{
      width:140px;
      height:140px;
      border-radius:12px;
      background:#fff;
      border:1px solid rgba(15,23,42,.1);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:inset 0 0 0 2px rgba(15,23,42,.04);
    }
    .line-qr-box svg{
      width:118px;
      height:118px;
    }
    .line-qr-placeholder{
      font-size:12px;
      color:#64748b;
      text-align:center;
      line-height:1.4;
      padding:0 8px;
    }
    .line-link-modal-card{
      display:grid;
      gap:14px;
    }
    .line-link-modal-body{
      display:grid;
      gap:12px;
    }
    .line-link-modal-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(200px,1fr));
      gap:16px;
      align-items:center;
    }
    .line-link-info{
      display:grid;
      gap:10px;
      font-size:12px;
    }
    .line-link-info-row{
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border-radius:10px;
      border:1px dashed var(--border);
      background:var(--panel-sub);
    }
    .line-link-info-label{
      font-weight:900;
      color:var(--subtext);
    }
    .line-link-info-value{
      font-weight:900;
      color:var(--text);
    }
    .line-link-note{
      font-size:11px;
      color:var(--subtext);
    }
    .suggestion-float{
      position:fixed;
      left:0;
      top:0;
      z-index:calc(var(--window-layer) + 25);
      pointer-events:none;
      opacity:0;
      transform:scale(.96);
      transition:opacity .2s ease, transform .2s ease;
    }
    .suggestion-float.is-open{
      opacity:1;
      transform:scale(1);
      pointer-events:auto;
    }
    .suggestion-card{
      background:rgba(255,255,255,0.96);
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px 16px 16px;
      box-shadow:var(--glow), 0 18px 40px rgba(31,27,45,.18);
      min-width:220px;
      max-width:280px;
      position:relative;
      backdrop-filter:blur(18px);
      animation:floaty 3.2s ease-in-out infinite;
      overflow:hidden;
    }
    .suggestion-card::after{
      content:"";
      position:absolute;
      inset:auto 14px -8px;
      width:18px;
      height:18px;
      background:inherit;
      border-left:1px solid var(--border);
      border-bottom:1px solid var(--border);
      transform:rotate(45deg);
      box-shadow:0 10px 16px rgba(31,27,45,.08);
    }
    .suggestion-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .suggestion-title{
      font-weight:800;
      font-size:14px;
      color:var(--text);
    }
    .suggestion-close{
      border:none;
      background:rgba(31,27,45,.06);
      color:var(--subtext);
      width:28px;
      height:28px;
      border-radius:50%;
      font-size:16px;
      font-weight:700;
      cursor:pointer;
    }
    .suggestion-context{
      margin-top:8px;
      font-size:12px;
      color:var(--subtext);
      line-height:1.5;
      max-height:56px;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .suggestion-actions{
      margin-top:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .suggestion-actions button{
      width:100%;
      border-radius:12px;
      padding:8px 10px;
      font-size:13px;
    }
    .suggestion-actions .ghost{
      background:rgba(139,92,246,.08);
      color:var(--text);
      border:1px solid rgba(139,92,246,.18);
    }
    .suggestion-actions button:disabled{
      opacity:.5;
      cursor:not-allowed;
    }
    .suggestion-form{
      display:none;
      margin-top:12px;
      padding-top:10px;
      border-top:1px dashed var(--border);
      gap:8px;
    }
    .suggestion-float.is-form-open .suggestion-form{
      display:grid;
    }
    .suggestion-form label{
      font-size:12px;
      color:var(--subtext);
      font-weight:600;
    }
    .suggestion-form textarea{
      width:100%;
      min-height:72px;
      border-radius:10px;
      border:1px solid var(--border);
      padding:8px 10px;
      font-size:12px;
      background:var(--panel);
      color:var(--text);
      resize:vertical;
    }
    .suggestion-form-actions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
    }
    .suggestion-form-actions button{
      border-radius:10px;
      padding:6px 10px;
      font-size:12px;
    }
    .suggestion-form .ghost{
      background:rgba(148,163,184,.18);
      color:var(--text);
      border:1px solid rgba(148,163,184,.3);
    }
    .suggestion-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:20px;
      height:20px;
      padding:0 6px;
      margin-left:6px;
      border-radius:999px;
      background:var(--accent);
      color:#fff;
      font-size:11px;
      font-weight:700;
    }
    .suggestion-modal-body{
      display:grid;
      gap:16px;
    }
    .suggestion-preview{
      border:1px solid #cbd5f5;
      border-radius:12px;
      padding:12px;
      background:#f8fafc;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:160px;
      position:relative;
      overflow:hidden;
    }
    .suggestion-preview img{
      max-width:100%;
      max-height:260px;
      border-radius:8px;
      display:none;
    }
    .suggestion-preview.has-image img{
      display:block;
    }
    .suggestion-preview .placeholder{
      color:#64748b;
      font-size:14px;
      text-align:center;
    }
    .suggestion-input{
      width:100%;
      min-height:110px;
      resize:vertical;
      border-radius:10px;
      border:1px solid #cbd5f5;
      padding:10px 12px;
      font-size:14px;
      font-family:inherit;
    }
    .suggestion-meta{
      font-size:12px;
      color:#64748b;
    }
    .suggestion-actions-row{
      display:flex;
      justify-content:flex-end;
      gap:10px;
    }
    .suggestion-inbox-list{
      display:grid;
      gap:14px;
      margin-top:8px;
    }
    .suggestion-inbox-item{
      border:1px solid #e2e8f0;
      border-radius:12px;
      padding:12px;
      background:#fff;
      display:grid;
      gap:10px;
    }
    .suggestion-inbox-item img{
      width:100%;
      border-radius:8px;
      border:1px solid #e2e8f0;
    }
    .suggestion-inbox-meta{
      font-size:12px;
      color:#64748b;
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    .suggestion-inbox-empty{
      text-align:center;
      color:#64748b;
      font-size:14px;
      padding:20px 0;
    }
    .suggestion-header-button{
      position:relative;
    }
    .suggestion-header-badge{
      position:absolute;
      top:2px;
      right:2px;
      background:#f97316;
      color:#fff;
      border-radius:999px;
      padding:2px 6px;
      font-size:10px;
      line-height:1;
      min-width:18px;
      text-align:center;
      box-shadow:0 2px 4px rgba(15,23,42,0.2);
    }
    .issue-header-button{
      position:relative;
    }
    .issue-header-badge{
      position:absolute;
      top:2px;
      right:2px;
      background:#ef4444;
      color:#fff;
      border-radius:999px;
      padding:2px 6px;
      font-size:10px;
      line-height:1;
      min-width:18px;
      text-align:center;
      box-shadow:0 2px 4px rgba(15,23,42,0.2);
    }
    .reply-chat-badge{
      position:absolute;
      bottom:2px;
      right:2px;
      background:#0ea5e9;
      color:#fff;
      border-radius:999px;
      padding:2px 6px;
      font-size:10px;
      line-height:1;
      min-width:18px;
      text-align:center;
      box-shadow:0 2px 4px rgba(15,23,42,0.2);
      display:none;
    }
    .reply-chat-badge.is-visible{
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .teacher-line-button,
    .suggestion-reply-button{
      position:relative;
    }
    .teacher-line-badge{
      position:absolute;
      bottom:2px;
      right:2px;
      background:#10b981;
      color:#fff;
      border-radius:999px;
      padding:2px 6px;
      font-size:10px;
      line-height:1;
      min-width:18px;
      text-align:center;
      box-shadow:0 2px 4px rgba(15,23,42,0.2);
    }
    .teacher-line-badge.is-unlinked{
      background:#94a3b8;
    }
    .teacher-line-badge.is-issued{
      background:#f59e0b;
    }
    .suggestion-group-item{
      background:#fff;
      border:1px solid #e2e8f0;
      border-radius:12px;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      box-shadow:0 8px 18px rgba(15,23,42,0.06);
    }
    .suggestion-group-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .suggestion-group-title{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:900;
      color:#0f172a;
      flex-wrap:wrap;
    }
    .suggestion-group-id{
      padding:4px 8px;
      border-radius:999px;
      background:#e2e8f0;
      font-size:12px;
      font-weight:800;
      color:#1e293b;
    }
    .suggestion-group-count{
      padding:4px 8px;
      border-radius:999px;
      background:rgba(251,146,60,0.16);
      color:#c2410c;
      font-size:12px;
      font-weight:800;
    }
    .suggestion-group-status{
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      background:#dcfce7;
      color:#166534;
    }
    .suggestion-group-status.is-new{
      background:#fee2e2;
      color:#b91c1c;
    }
    .suggestion-group-meta{
      font-size:12px;
      color:#64748b;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .suggestion-group-list{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .suggestion-group-message{
      background:#f8fafc;
      border-radius:10px;
      padding:8px 10px;
      font-size:13px;
      color:#0f172a;
      border:1px solid #e2e8f0;
    }
    .suggestion-reply-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .suggestion-reply-actions .reply-label{
      font-size:12px;
      color:#64748b;
      font-weight:700;
    }
    .suggestion-reply-options{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .suggestion-reply-options button{
      border-radius:999px;
      border:1px solid #cbd5f5;
      padding:6px 10px;
      background:#eef2ff;
      color:#4338ca;
      font-size:12px;
      font-weight:800;
      cursor:pointer;
    }
    .suggestion-reply-options button:hover{
      background:#e0e7ff;
    }
    .suggestion-reply-note{
      font-size:12px;
      color:#475569;
    }
    .issue-tag-list{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:6px;
    }
    .issue-tag{
      border:1px solid #fecaca;
      background:#fff5f5;
      color:#b91c1c;
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:700;
      cursor:pointer;
    }
    .issue-tag.is-active{
      background:#ef4444;
      color:#fff;
      border-color:#ef4444;
    }
    .issue-tag.is-add{
      border-style:dashed;
      background:#fff;
      color:#64748b;
    }
    .issue-group-meta{
      font-size:12px;
      color:#64748b;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .issue-item-list{
      display:grid;
      gap:8px;
    }
    .issue-item{
      background:#fef2f2;
      border:1px solid #fee2e2;
      border-radius:10px;
      padding:8px 10px;
      font-size:12px;
      color:#991b1b;
    }
    .issue-reply-card{
      border-radius:12px;
      border:1px dashed #fecaca;
      padding:10px;
      background:#fff7f7;
      display:grid;
      gap:8px;
    }
    .issue-reply-input{
      width:100%;
      min-height:70px;
      border-radius:8px;
      border:1px solid #fecaca;
      padding:8px;
      font-size:12px;
      font-family:inherit;
      resize:vertical;
    }
    .issue-reply-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
    }
    .range-select-overlay{
      position:fixed;
      inset:0;
      background:rgba(15, 23, 42, 0.12);
      display:none;
      z-index:1200;
    }
    .range-select-overlay.is-active{
      display:block;
    }
    .range-select-box{
      position:absolute;
      border:2px dashed #fb923c;
      background:rgba(251, 146, 60, 0.22);
      border-radius:6px;
      pointer-events:none;
    }
    .range-select-hint{
      position:fixed;
      top:20px;
      left:50%;
      transform:translateX(-50%);
      background:#0f172a;
      color:#fff;
      padding:6px 12px;
      border-radius:999px;
      font-size:12px;
      z-index:1201;
    }
    body.is-range-selecting,
    body.is-range-selecting *{
      cursor:pointer !important;
    }
    @keyframes floaty{
      0%, 100% { transform:translateY(0px); }
      50% { transform:translateY(-6px); }
    }
    .summary-note{
      color:var(--subtext);
      font-size:12px;
      margin:10px 0 0;
    }
    .summary-note-block{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:220px;
      color:var(--text);
      font-size:12px;
    }
    .summary-note-lines{
      display:flex;
      flex-direction:column;
      gap:2px;
      white-space:pre-line;
    }
    .summary-total-cell{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-start;
    }
    .copy-summary-note{
      align-self:flex-start;
      padding:6px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel-sub);
      color:var(--text);
      font-weight:800;
      font-size:11px;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(61,51,92,.12);
    }
    .copy-summary-note:hover{
      border-color:rgba(99,102,241,.45);
    }
    .summary-filter-row{
      display:flex;
      align-items:flex-end;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    .summary-filter-row label{margin:0;display:flex;align-items:center;gap:8px;color:var(--subtext);font-weight:800;}
    .badge{display:inline-flex;align-items:center;gap:4px;font-size:11px;padding:4px 8px;border-radius:999px;background:linear-gradient(120deg,var(--accent-2),var(--accent-3));color:#0f172a;border:1px solid rgba(255,255,255,.4);}
    .user-chip{
      box-shadow:0 8px 20px rgba(61,51,92,.12);
    }
    .user-chip span{
      letter-spacing:.03em;
    }
    .user-menu-wrap{
      position:relative;
      display:inline-flex;
      flex-direction:column;
      align-items:flex-end;
      gap:8px;
      z-index:calc(var(--window-layer) + 70);
    }
    .user-status-list{
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:6px 10px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel-sub);
      min-width:220px;
      font-size:11px;
      color:var(--subtext);
      margin-top:6px;
    }
    .user-status-item{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .user-status-item span{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .user-status-item strong{
      font-size:12px;
      font-weight:900;
      color:var(--text);
    }
    .user-menu{
      position:absolute;
      top:calc(100% + 8px);
      right:0;
      min-width:160px;
      padding:6px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel);
      box-shadow:0 12px 24px rgba(61,51,92,.2);
      display:none;
      z-index:calc(var(--window-layer) + 120);
    }
    .user-menu.open{
      display:block;
    }
    .user-menu-item{
      display:block;
      width:100%;
      border:none;
      background:transparent;
      padding:8px 10px;
      border-radius:8px;
      text-align:left;
      font-weight:800;
      color:var(--text);
      cursor:pointer;
      text-decoration:none;
    }
    .user-menu-item:hover,
    .user-menu-item:focus-visible{
      background:var(--panel-sub);
      outline:none;
    }
    .is-hidden{
      display:none !important;
    }
    .sr-only{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0, 0, 0, 0);
      white-space:nowrap;
      border:0;
    }
    .class-chip-group{display:flex;gap:8px;flex-wrap:wrap;}
    .class-chip{
      padding:8px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel-sub);
      color:var(--muted);
      font-weight:800;
      cursor:pointer;
      transition:transform .15s, box-shadow .15s, border-color .15s;
    }
    .class-chip.active{
      background:linear-gradient(120deg,var(--accent),var(--accent-2));
      color:#fff;
      border-color:transparent;
      box-shadow:var(--glow);
      transform:translateY(-1px);
    }
    .filter-columns{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(180px,1fr));
      background:var(--panel-sub);
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 8px 20px rgba(61,51,92,.08);
      margin-bottom:12px;
    }
    .filter-col{padding:12px;display:flex;flex-direction:column;gap:8px;}
    .filter-col:not(:first-child){border-left:1px solid rgba(0,0,0,.04);}
    .filter-title{font-size:12px;font-weight:900;color:var(--subtext);}
    .filter-buttons{display:flex;flex-wrap:wrap;gap:8px;}
    .filter-buttons.grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));
      align-items:stretch;
    }
    .filter-chip{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--muted);
      font-weight:800;
      cursor:pointer;
      transition:transform .15s, box-shadow .15s, border-color .15s;
    }
    #filterContainerSchool .filter-chip,
    #filterContainerClass .filter-chip,
    #filterContainerChildClass .filter-chip,
    #filterContainerChild .filter-chip{
      padding:6px 8px;
      font-size:12px;
    }
    #headerChildFilterHost .filter-chip{
      padding:4px 6px;
      font-size:11px;
    }
    #headerChildFilterHost .filter-buttons{
      gap:6px;
    }
    #filterContainerChild{
      margin-top:6px;
      border:1px solid var(--border);
      border-radius:12px;
      padding:6px 8px;
      background:var(--panel-sub);
    }
    #headerChildFilterHost #filterContainerChild{
      margin-top:4px;
    }
    .filter-chip.active{
      background:linear-gradient(120deg,var(--accent),var(--accent-2));
      color:#fff;
      border-color:transparent;
      box-shadow:var(--glow);
      transform:translateY(-1px);
    }
    .filter-chip.child-chip{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
    }
    .filter-chip.child-chip.type-standard{
      background:#dcfce7;
      border-color:#86efac;
      color:#166534;
    }
    .filter-chip.child-chip.type-short{
      background:#fce7f3;
      border-color:#f9a8d4;
      color:#9d174d;
    }
    .filter-chip.child-chip.type-1gou{
      background:#ffedd5;
      border-color:#fdba74;
      color:#9a3412;
    }
    .filter-chip.child-chip.active{
      border-color:var(--accent);
      box-shadow:0 0 0 2px rgba(124,58,237,.2);
    }
    .filter-chip.child-chip .change-indicator{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:18px;
      height:18px;
      border-radius:50%;
      background:#f97316;
      color:#fff;
      font-size:11px;
      font-weight:900;
      flex:0 0 auto;
    }
    .child-chip-icons{
      display:inline-flex;
      align-items:center;
      gap:4px;
      flex:0 0 auto;
    }
    .child-chip-icon{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:18px;
      height:18px;
      padding:0 5px;
      border-radius:999px;
      font-size:10px;
      font-weight:900;
      line-height:1;
      border:1px solid transparent;
    }
    .child-chip-icon.line{
      background:#06c755;
      color:#fff;
      border-color:rgba(6,199,85,.4);
    }
    .child-chip-icon.chat{
      background:rgba(59,130,246,.15);
      color:#1d4ed8;
      border-color:rgba(59,130,246,.3);
      font-size:12px;
    }
    .child-chip-icon.ok{
      background:rgba(34,197,94,.18);
      color:#166534;
      border-color:rgba(34,197,94,.35);
    }
    .manual-adders{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:12px;
      margin-bottom:10px;
    }
    .manual-card{
      border:1px dashed var(--border);
      border-radius:12px;
      padding:10px 12px;
      background:var(--panel-sub);
      display:grid;
      gap:8px;
    }
    .manual-card label{
      margin:0;
      color:var(--subtext);
      font-size:12px;
      font-weight:900;
    }
    .manual-row{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(120px,1fr));
      gap:8px;
      align-items:center;
    }
    .manual-row input,
    .manual-row select{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      font-weight:700;
      font-size:12px;
    }
    .manual-row button{
      width:100%;
      padding:9px 10px;
    }
    .manual-help{
      font-size:11px;
      color:var(--subtext);
      margin:0;
    }
    .manual-iframe-wrap{
      margin-top:18px;
      padding-top:8px;
      border-top:1px dashed var(--border);
    }
    .manual-iframe{
      width:100%;
      min-height:360px;
      height:clamp(360px, 70vh, 920px);
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--panel);
    }
    .manual-layer .manual-iframe{
      height:clamp(360px, 75vh, 960px);
    }
    .empty-actions{
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:center;
    }
    .empty-actions .small{
      width:auto;
    }
    .size-toggle{display:flex;gap:8px;flex-wrap:wrap;}
    .size-btn{
      padding:8px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel-sub);
      color:var(--muted);
      font-weight:800;
      cursor:pointer;
      transition:background .2s,border-color .2s,transform .2s;
    }
    .size-btn.active{
      background:linear-gradient(120deg,var(--accent),var(--accent-2));
      color:#fff;
      border-color:transparent;
      box-shadow:var(--glow);
      transform:translateY(-1px);
    }
    .filter-buttons.scrollable{
      display:flex;
      flex-wrap:nowrap;
      overflow-x:auto;
      overflow-y:hidden;
      padding-bottom:4px;
      scrollbar-width:thin;
      scrollbar-color: var(--accent) rgba(0,0,0,.06);
    }
    .filter-buttons.scrollable .filter-chip{
      flex:0 0 auto;
    }
    .bulk-card{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--panel);
      padding:14px;
      box-shadow:0 12px 30px rgba(61,51,92,.12);
      display:grid;
      gap:10px;
    }
    .bulk-head{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap;}
    .bulk-title{font-weight:900;font-size:14px;color:var(--text);}
    .bulk-sub{font-size:12px;color:var(--subtext);font-weight:800;}
    .bulk-name-chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;background:linear-gradient(120deg, rgba(139,92,246,.12), rgba(34,211,238,.12));color:var(--muted);font-weight:900;border:1px solid rgba(0,0,0,.05);}
    .bulk-grid{display:grid;gap:8px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));}
    .bulk-grid label{margin:0;}
    .bulk-grid select,
    .bulk-grid input[type="date"]{width:100%;padding:9px 10px;border-radius:10px;border:1px solid var(--border);background:var(--panel-sub);color:var(--text);font-weight:700;}
    .bulk-actions{display:flex;flex-direction:column;gap:6px;align-items:flex-start;}
    .bulk-actions .apply-btn{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      background:linear-gradient(120deg,var(--accent),var(--accent-2));
      color:#fff;
      font-weight:900;
      border:none;
      cursor:pointer;
      box-shadow:0 12px 30px rgba(139,92,246,.35);
    }
    .bulk-status{font-size:12px;color:var(--subtext);font-weight:800;margin:0;}
    .row-reset-btn{
      width:30px;
      height:30px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel-sub);
      color:var(--muted);
      font-weight:900;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.08);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      transition:transform .15s, box-shadow .15s, color .15s;
      flex-shrink:0;
    }
    .row-reset-btn:hover{
      transform:translateY(-1px);
      box-shadow:0 10px 20px rgba(0,0,0,.12);
      color:var(--accent);
    }
    .day-status-line{width:100%;}
    .day-action-row{width:100%;display:flex;flex-direction:column;gap:6px;}
    .day-action-row .day-chip{flex:1;width:100%;}
    .calc-stack-wrapper{
      display:none;
    }
    .calc-stack-wrapper.is-open{
      display:block;
    }
    .data-source-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .data-source-badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:10px;
      background:var(--panel-sub);
      border:1px solid var(--border);
      color:var(--muted);
      font-weight:800;
      font-size:12px;
    }
    .data-source-meta{
      font-size:12px;
      color:var(--subtext);
      margin:0;
    }
    .test-mode-box{
      margin-top:12px;
      padding:12px;
      border-radius:12px;
      border:1px dashed var(--border);
      background:var(--panel-sub);
      color:var(--muted);
    }
    .test-mode-actions{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      margin-top:6px;
    }
    .toast-stack{
      position:fixed;
      top:calc(env(safe-area-inset-top, 0px) + 16px);
      right:calc(env(safe-area-inset-right, 0px) + 16px);
      z-index:400;
      max-width:min(92vw, 340px);
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:12px;
      pointer-events:none;
    }
    .toast-group{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
    }
    .toast-bubble{
      background:var(--toast-bg);
      color:#fff;
      padding:10px 16px;
      border-radius:16px 16px 6px 16px;
      font-size:13px;
      font-weight:700;
      letter-spacing:.02em;
      box-shadow:0 14px 30px rgba(31,27,45,.28);
      opacity:0;
      transform:translate(0, -6px);
      transition:opacity .2s ease, transform .2s ease;
      max-width:100%;
      text-align:left;
      word-break:break-word;
    }
    .toast-bubble .toast-link{
      display:inline-block;
      margin-right:6px;
      font-size:11px;
      opacity:.7;
    }
    .toast-message{
      display:flex;
      flex-direction:column;
      gap:2px;
      line-height:1.35;
    }
    .toast-title{
      font-size:11px;
      font-weight:700;
      opacity:.75;
    }
    .toast-body{
      font-size:13px;
      font-weight:700;
    }
    .toast-bubble.is-chained{
      position:relative;
      padding-left:26px;
    }
    .toast-bubble.is-chained::before{
      content:"";
      position:absolute;
      left:12px;
      top:8px;
      bottom:8px;
      width:2px;
      border-radius:2px;
      background:rgba(255,255,255,.35);
    }
    .toast-bubble.is-chained .toast-link{
      position:absolute;
      left:5px;
      top:8px;
      margin:0;
      opacity:.85;
    }
    .toast-bubble.is-visible{
      opacity:1;
      transform:translate(0, 0);
    }
    .toast-bubble.is-exiting{
      opacity:0;
      transform:translate(0, -6px);
    }
    .floating-save-btn{
      position:static;
      right:auto;
      bottom:auto;
      z-index:10;
      padding:10px 16px;
      border-radius:14px;
      font-weight:900;
      box-shadow:0 12px 24px rgba(31,27,45,.2);
      letter-spacing:.04em;
    }
    .floating-save-btn.is-hidden{
      display:none;
    }
    .memo-layer{
      position:absolute;
      inset:0;
      pointer-events:none;
      z-index:80;
    }
    .memo-layer--summary,
    .memo-layer--detail{
      z-index:100;
    }
    .memo-note{
      position:absolute;
      pointer-events:auto;
      background:var(--memo-bg, linear-gradient(135deg, #fff6b7, #ffef9b));
      border-radius:16px;
      box-shadow:0 10px 24px rgba(61,51,92,.18);
      border:1px solid var(--memo-border, rgba(245,204,73,.7));
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-width:140px;
      min-height:90px;
      touch-action:none;
    }
    .memo-note[data-memo-type="text"]{
      min-width:130px;
      min-height:82px;
    }
    .memo-note[data-memo-type="handwrite"]{
      min-width:220px;
      min-height:160px;
      background:var(--memo-bg, linear-gradient(135deg, #fff2b4, #ffe684));
    }
    .memo-note.is-placement{
      cursor:grab;
      outline:2px dashed rgba(61,51,92,.3);
      outline-offset:3px;
      resize:both;
      overflow:hidden;
    }
    .memo-note.is-dragging{
      cursor:grabbing;
      opacity:.92;
    }
    .memo-note__header{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:8px;
      position:relative;
      padding-right:64px;
    }
    .memo-note__color-bar{
      display:flex;
      align-items:center;
      gap:4px;
    }
    .memo-note__color-chip{
      width:16px;
      height:16px;
      border-radius:6px;
      border:1px solid rgba(61,51,92,.2);
      padding:0;
      cursor:pointer;
      box-shadow:0 2px 6px rgba(61,51,92,.18);
    }
    .memo-note__color-chip.is-active{
      border-color:rgba(61,51,92,.6);
      box-shadow:0 2px 6px rgba(61,51,92,.28);
    }
    .memo-note__actions{
      display:flex;
      align-items:center;
      gap:6px;
      position:absolute;
      top:-6px;
      right:-6px;
    }
    .memo-note__action{
      border:none;
      background:rgba(255,255,255,.7);
      border-radius:8px;
      width:26px;
      height:26px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:14px;
      cursor:pointer;
      box-shadow:0 4px 10px rgba(61,51,92,.12);
    }
    .memo-note__action:hover{
      background:#fff;
    }
    .memo-note__body{
      flex:1;
      display:flex;
      min-height:0;
    }
    .memo-note__canvas{
      width:100%;
      height:100%;
      border-radius:10px;
      background:rgba(255,255,255,.4);
      border:1px solid rgba(61,51,92,.12);
    }
    .memo-note__image{
      width:100%;
      height:100%;
      object-fit:cover;
      border-radius:10px;
      background:rgba(255,255,255,.4);
      border:1px solid rgba(61,51,92,.12);
    }
    .memo-note__text{
      width:100%;
      min-height:44px;
      border:none;
      resize:none;
      background:transparent;
      font-size:12px;
      font-weight:600;
      color:var(--text);
      line-height:1.35;
      outline:none;
      overflow:hidden;
      white-space:pre-wrap;
      height:100%;
    }
    body.is-memo-placement .memo-note__text{
      pointer-events:none;
    }
    body.is-memo-placement .memo-note__actions,
    body.is-memo-placement .memo-note__color-bar{
      pointer-events:none;
    }
    body.is-memo-placement header,
    body.is-memo-placement .summary-panel,
    body.is-memo-placement .detail-panel{
      outline:2px solid rgba(79, 142, 255, .7);
      outline-offset:-2px;
    }
    body.is-memo-placement .summary-panel,
    body.is-memo-placement .detail-panel{
      outline-color:rgba(91, 193, 143, .7);
    }
    body.is-memo-placement .header-handle{
      box-shadow:0 0 0 2px rgba(79, 142, 255, .7);
      border-radius:18px;
    }

    .debug-log-panel{
      position:fixed;
      left:12px;
      bottom:12px;
      width:min(520px, calc(100vw - 24px));
      z-index:999999;
      display:flex;
      flex-direction:column;
      gap:6px;
      padding:10px 12px;
      border-radius:12px;
      background:var(--panel-overlay, rgba(255,255,255,.92));
      color:var(--text);
      touch-action:none;
      box-shadow:var(--glow);
      border:1px solid var(--border);
      font-family:"SFMono-Regular","Consolas","Menlo",monospace;
      font-size:12px;
      line-height:1.45;
      height:min(45vh, 360px);
    }
    .debug-log-panel.is-dragging{
      cursor:grabbing;
    }
    .debug-log-panel.is-collapsed{
      height:auto;
    }
    .debug-log-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      cursor:grab;
    }
    .debug-log-title{
      font-weight:700;
      font-size:12px;
      letter-spacing:.02em;
    }
    .debug-log-actions{
      display:flex;
      gap:6px;
      align-items:center;
    }
    .debug-log-tabs{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-top:4px;
    }
    .debug-log-tab{
      border:none;
      background:var(--panel);
      color:var(--muted);
      padding:4px 10px;
      border-radius:999px;
      font-size:11px;
      cursor:pointer;
      border:1px solid var(--border);
    }
    .debug-log-tab.active{
      background:var(--accent);
      color:#fff;
    }
    .debug-log-tab:hover{
      border-color:var(--accent);
      color:var(--accent);
    }
    .debug-log-btn{
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--muted);
      padding:4px 8px;
      border-radius:999px;
      cursor:pointer;
      font-size:11px;
    }
    .debug-log-btn:hover{
      border-color:var(--accent);
      color:var(--accent);
    }
    .debug-log-btn--close{
      border-color:rgba(251, 113, 133, .4);
      color:var(--accent-4);
    }
    .debug-log-btn--close:hover{
      border-color:var(--accent-4);
      color:var(--accent-4);
    }
    .debug-log-body{
      overflow-y:auto;
      flex:1;
      min-height:0;
      padding:8px;
      touch-action:pan-y;
      overscroll-behavior:contain;
      -webkit-overflow-scrolling:touch;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:10px;
    }
    .debug-log-panel.is-collapsed .debug-log-body{
      display:none;
    }
    .debug-log-panel.is-collapsed .debug-log-tabs{
      display:none;
    }
    .debug-log-line{
      white-space:pre-wrap;
      word-break:break-word;
      padding:2px 0;
    }
    .debug-log-line.level-warn{
      color:var(--accent-2);
    }
    .debug-log-line.level-err{
      color:var(--accent-4);
    }
    .debug-log-line.level-mark{
      color:var(--accent-3);
    }
    .print-preview-dialog{
      max-width:980px;
      width:calc(100% - 32px);
    }
    .print-preview-panel{
      gap:12px;
    }
    .print-preview-actions{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-bottom:8px;
    }
    .print-preview-area{
      background:#f8fafc;
      padding:16px;
      border-radius:12px;
      border:1px solid var(--border);
      max-height:70vh;
      overflow:auto;
    }
    .print-preview-page{
      width:210mm;
      min-height:297mm;
      background:#fff;
      margin:0 auto;
      padding:16mm 14mm 18mm;
      box-shadow:0 18px 36px rgba(15, 23, 42, 0.12);
      border:1px solid #e2e8f0;
      color:#0f172a;
      font-size:12px;
      line-height:1.5;
    }
    .print-preview-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      border-bottom:2px solid #0f172a;
      padding-bottom:10px;
      margin-bottom:14px;
    }
    .print-preview-title{
      font-size:20px;
      font-weight:700;
      margin:0 0 4px;
    }
    .print-preview-subtitle{
      font-size:12px;
      color:#475569;
      margin:0;
    }
    .print-preview-meta{
      text-align:right;
      font-size:11px;
      color:#334155;
    }
    .print-preview-meta strong{
      display:block;
      font-size:12px;
      color:#0f172a;
      margin-bottom:2px;
    }
    .print-preview-info-grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:10px 18px;
      margin-bottom:14px;
    }
    .print-preview-info-item{
      display:flex;
      gap:8px;
      align-items:flex-start;
    }
    .print-preview-info-label{
      min-width:90px;
      font-weight:700;
      color:#1e293b;
    }
    .print-preview-info-value{
      flex:1;
      color:#0f172a;
    }
    .print-preview-summary-table{
      width:100%;
      border-collapse:collapse;
      margin-bottom:16px;
      font-size:12px;
    }
    .print-preview-summary-table th,
    .print-preview-summary-table td{
      border:1px solid #cbd5f5;
      padding:6px 8px;
      text-align:left;
    }
    .print-preview-summary-table th{
      background:#eef2ff;
      color:#1e293b;
      font-weight:700;
      width:26%;
    }
    .print-preview-summary-pair{
      display:flex;
      justify-content:space-between;
      gap:8px;
      font-variant-numeric:tabular-nums;
    }
    .print-preview-summary-pair span{
      display:block;
    }
    .print-preview-summary-pair .after{
      font-weight:700;
      color:#0f172a;
    }
    .print-preview-detail-table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      margin-bottom:12px;
    }
    .print-preview-detail-table th,
    .print-preview-detail-table td{
      border:1px solid #e2e8f0;
      padding:4px 6px;
      text-align:center;
    }
    .print-preview-detail-table th{
      background:#f1f5f9;
      font-weight:700;
    }
    .print-preview-note{
      background:#f8fafc;
      border:1px dashed #cbd5f5;
      padding:8px;
      margin-bottom:12px;
      min-height:52px;
    }
    .print-preview-note-title{
      font-weight:700;
      margin-bottom:6px;
    }
    .print-preview-guardian{
      display:grid;
      grid-template-columns:1.6fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    .print-preview-guardian h3{
      font-size:13px;
      margin:0 0 6px;
    }
    .guardian-check-list{
      border:1px solid #e2e8f0;
      padding:10px;
      min-height:120px;
    }
    .guardian-check-item{
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:8px;
    }
    .guardian-check-box{
      width:16px;
      height:16px;
      border:1.6px solid #0f172a;
      display:inline-block;
    }
    .guardian-signature{
      border:1px solid #e2e8f0;
      padding:10px;
      min-height:120px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .guardian-signature .line{
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:1px solid #cbd5f5;
      padding-bottom:6px;
    }
    .guardian-stamp-box{
      border:1.6px solid #0f172a;
      width:72px;
      height:72px;
      margin-left:auto;
    }

    @media print {
      @page {
        size: A4 portrait;
        margin: 12mm;
      }
      body * {
        visibility: hidden;
      }
      .printArea, .printArea *,
      .print-preview-area, .print-preview-area * {
        visibility: visible;
      }
      .printArea,
      .print-preview-area {
        position: fixed;
        inset: 0;
        margin: 0;
        padding: 0;
        background: #fff;
        box-shadow: none;
        border: none;
      }
      .print-preview-area{
        display:flex;
        align-items:flex-start;
        justify-content:center;
      }
      .print-preview-page{
        box-shadow:none;
        border:none;
      }
      .line-link-modal-card {
        width: 100%;
      }
      .line-qr-box {
        border-color: #ddd;
      }
    }
  </style>
</head>
<body>
  <header data-stage="expanded">
    <div class="header-inner">
      <div class="header-topline">
        <button type="button" class="icon-button" id="loginBtn" title="ログイン" aria-label="ログイン">
          <span class="icon-emoji" aria-hidden="true">🔐</span>
          <span class="icon-label">ログイン</span>
        </button>
        <div class="header-brand">
          <div class="logo-circle">延長</div>
          <div class="header-title-stack">
            <h1>EnCho-エンチョ-</h1>
            <div class="header-info">
              <div class="version-badge" id="versionBadge" aria-label="このページのバージョン">
                <div class="version-badge-line">
                  <span class="dot" aria-hidden="true"></span>
                  <span class="version-text">更新情報を準備中...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <input id="csvFile" type="file" accept=".csv,text/csv" class="visually-hidden" aria-hidden="true" />
        <div class="header-actions">
          <div class="header-tools header-icons">
            <button type="button" class="icon-button teacher-line-button" id="teacherLineLinkHeaderButton" title="先生LINE連携" aria-label="先生LINE連携">
              <span class="icon-emoji" aria-hidden="true">🧑‍🏫</span>
              <span class="icon-label">先生LINE</span>
              <span class="teacher-line-badge" id="teacherLineLinkBadge" aria-hidden="true">未連携</span>
            </button>
            <button type="button" class="icon-button suggestion-reply-button" id="suggestionReplyHeaderButton" title="返信コメント" aria-label="返信コメント">
              <span class="icon-emoji" aria-hidden="true">💬</span>
              <span class="icon-label">返信</span>
              <span class="suggestion-header-badge" id="suggestionReplyHeaderBadge" aria-hidden="true">0</span>
            </button>
            <button type="button" class="icon-button issue-header-button" id="issueInboxHeaderButton" title="不具合報告" aria-label="不具合報告">
              <span class="icon-emoji" aria-hidden="true">🐞</span>
              <span class="icon-label">不具合報告</span>
              <span class="issue-header-badge" id="issueInboxHeaderBadge" aria-hidden="true">0</span>
              <span class="reply-chat-badge" id="issueReplyHeaderBadge" aria-hidden="true">💬</span>
            </button>
            <button type="button" class="icon-button" id="dataReloadButton" title="データ読込み" aria-label="データ読込み">
              <span class="icon-label">データ読込み</span>
            </button>
            <button type="button" class="icon-button" id="typeBulkMenuToggle" title="区分変更" aria-label="区分変更">
              <span class="icon-label">区分変更</span>
            </button>
            <button type="button" class="icon-button" id="lineLinkHeaderButton" title="保護者通知" aria-label="保護者通知">
              <span class="icon-label">保護者通知</span>
            </button>
            <button type="button" class="icon-button suggestion-header-button" id="suggestionInboxHeaderButton" title="希望集計" aria-label="希望集計">
              <span class="icon-emoji" aria-hidden="true">💬</span>
              <span class="icon-label">希望集計</span>
              <span class="suggestion-header-badge" id="suggestionInboxHeaderBadge" aria-hidden="true">0</span>
              <span class="reply-chat-badge" id="suggestionReplyChatBadge" aria-hidden="true">💬</span>
            </button>
            <div class="tool icon-tool" id="settingsTool">
              <button type="button" id="toggleSettings" class="icon-button tool-trigger" title="設定" aria-label="設定">
                <span class="icon-label">設定</span>
              </button>
              <div class="tool-panel">
                <div class="tool-tabs" role="tablist" aria-label="設定タブ">
                  <button type="button" class="tool-tab active" id="settingsTabCalcBtn" data-tab="calc" role="tab" aria-selected="true" aria-controls="settingsTabCalc">計算</button>
                  <button type="button" class="tool-tab" id="settingsTabVacationBtn" data-tab="vacation" role="tab" aria-selected="false" aria-controls="settingsTabVacation" tabindex="-1">長期休暇</button>
                  <button type="button" class="tool-tab" id="settingsTabExtensionBtn" data-tab="extension" role="tab" aria-selected="false" aria-controls="settingsTabExtension" tabindex="-1">延長料金</button>
                  <button type="button" class="tool-tab" id="settingsTabDisplayBtn" data-tab="display" role="tab" aria-selected="false" aria-controls="settingsTabDisplay" tabindex="-1">表示</button>
                  <button type="button" class="tool-tab" id="settingsTabDisplayEditBtn" data-tab="display-edit" role="tab" aria-selected="false" aria-controls="settingsTabDisplayEdit" tabindex="-1">表示変更</button>
                  <button type="button" class="tool-tab" id="settingsTabGuideBtn" data-tab="guide" role="tab" aria-selected="false" aria-controls="settingsTabGuide" tabindex="-1">ガイド</button>
                </div>
                <div class="tool-panel-scroll">
                  <div class="tool-body tab-pane active" id="settingsTabCalc" data-tab-pane="calc" role="tabpanel" aria-labelledby="settingsTabCalcBtn">
                    <section class="panel slim">
                      <h2 style="margin-top:20px;">時間設定</h2>
                      <div class="row" style="margin-top:10px;">
                        <div style="min-width:220px;">
                          <label>標準時間</label>
                          <div class="vacation-period-fields">
                            <input id="standardStartTime" type="time" aria-label="標準時間の開始">
                            <span class="range-separator">〜</span>
                            <input id="standardEndTime" type="time" aria-label="標準時間の終了">
                          </div>
                        </div>
                        <div style="min-width:220px;">
                          <label>短時間</label>
                          <div class="vacation-period-fields">
                            <input id="shortStartTime" type="time" aria-label="短時間の開始">
                            <span class="range-separator">〜</span>
                            <input id="shortEndTime" type="time" aria-label="短時間の終了">
                          </div>
                        </div>
                      </div>
                      <div class="row" style="margin-top:10px;">
                        <div style="min-width:220px;">
                          <label>1号認定（午前）</label>
                          <div class="vacation-period-fields">
                            <input id="onegouAmStartTime" type="time" aria-label="1号認定 午前開始">
                            <span class="range-separator">〜</span>
                            <input id="onegouAmEndTime" type="time" aria-label="1号認定 午前終了">
                          </div>
                        </div>
                        <div style="min-width:220px;">
                          <label>1号認定（午後）</label>
                          <div class="vacation-period-fields">
                            <input id="onegouPmStartTime" type="time" aria-label="1号認定 午後開始">
                            <span class="range-separator">〜</span>
                            <input id="onegouPmEndTime" type="time" aria-label="1号認定 午後終了">
                          </div>
                        </div>
                        <div style="min-width:220px;">
                          <label>1号認定（1日）</label>
                          <div class="vacation-period-fields">
                            <input id="onegouFullStartTime" type="time" aria-label="1号認定 1日開始">
                            <span class="range-separator">〜</span>
                            <input id="onegouFullEndTime" type="time" aria-label="1号認定 1日終了">
                          </div>
                        </div>
                      </div>
                      <div class="row" style="margin-top:10px;">
                        <div style="min-width:220px;">
                          <label>預かり保育（午前）</label>
                          <div class="vacation-period-fields">
                            <input id="azukariAmStartTime" type="time" aria-label="預かり保育 午前開始">
                            <span class="range-separator">〜</span>
                            <input id="azukariAmEndTime" type="time" aria-label="預かり保育 午前終了">
                          </div>
                        </div>
                        <div style="min-width:220px;">
                          <label>預かり保育（午後）</label>
                          <div class="vacation-period-fields">
                            <input id="azukariPmStartTime" type="time" aria-label="預かり保育 午後開始">
                            <span class="range-separator">〜</span>
                            <input id="azukariPmEndTime" type="time" aria-label="預かり保育 午後終了">
                          </div>
                        </div>
                        <div style="min-width:220px;">
                          <label>預かり保育（1日）</label>
                          <div class="vacation-period-fields">
                            <input id="azukariFullStartTime" type="time" aria-label="預かり保育 1日開始">
                            <span class="range-separator">〜</span>
                            <input id="azukariFullEndTime" type="time" aria-label="預かり保育 1日終了">
                          </div>
                        </div>
                      </div>

                      <h2 style="margin-top:20px;">料金設定</h2>
                      <div class="row" style="margin-top:10px;">
                        <div style="min-width:220px;">
                          <label>預かり保育（午前）料金</label>
                          <input id="azukariFeeAm" type="number" min="0" step="50" inputmode="numeric">
                        </div>
                        <div style="min-width:220px;">
                          <label>預かり保育（午後）料金</label>
                          <input id="azukariFeePm" type="number" min="0" step="50" inputmode="numeric">
                        </div>
                        <div style="min-width:220px;">
                          <label>預かり保育（1日）料金</label>
                          <input id="azukariFeeFull" type="number" min="0" step="50" inputmode="numeric">
                        </div>
                      </div>
                      <div class="row" style="margin-top:10px;">
                        <div style="min-width:220px;">
                          <label>延長保育（標準・短時間）30分</label>
                          <input id="extFeeStandardShort" type="number" min="0" step="10" inputmode="numeric">
                        </div>
                        <div style="min-width:220px;">
                          <label>延長保育（1号認定・預かり）30分</label>
                          <input id="extFeeOnegouAzukari" type="number" min="0" step="10" inputmode="numeric">
                        </div>
                      </div>
                      <h2 style="margin-top:20px;">その他料金</h2>
                      <div class="row" style="margin-top:10px;">
                        <div style="min-width:220px;">
                          <label>おやつ代</label>
                          <input id="extraSnackFee" type="number" min="0" step="10" inputmode="numeric">
                        </div>
                        <div style="min-width:220px;">
                          <label>お昼代</label>
                          <input id="extraLunchFee" type="number" min="0" step="10" inputmode="numeric">
                        </div>
                      </div>
                    </section>
                  </div>

                  <div class="tool-body tab-pane" id="settingsTabVacation" data-tab-pane="vacation" role="tabpanel" aria-labelledby="settingsTabVacationBtn" hidden>
                    <section class="panel slim">
                      <h2>長期休暇</h2>
                      <div class="row" style="margin-top:10px;">
                        <div style="min-width:220px;">
                          <label>長期休暇の期間</label>
                          <div class="muted">設定した期間は、1号認定の長期休暇日として扱います。</div>
                        </div>
                      </div>
                      <div class="row vacation-periods" style="margin-top:6px;">
                        <div class="vacation-period">
                          <label>夏休み</label>
                          <div class="vacation-period-fields">
                            <input id="vacationSummerStart" type="date" aria-label="夏休み開始日">
                            <span class="range-separator">〜</span>
                            <input id="vacationSummerEnd" type="date" aria-label="夏休み終了日">
                          </div>
                        </div>
                        <div class="vacation-period">
                          <label>冬休み</label>
                          <div class="vacation-period-fields">
                            <input id="vacationWinterStart" type="date" aria-label="冬休み開始日">
                            <span class="range-separator">〜</span>
                            <input id="vacationWinterEnd" type="date" aria-label="冬休み終了日">
                          </div>
                        </div>
                        <div class="vacation-period">
                          <label>春休み</label>
                          <div class="vacation-period-fields">
                            <input id="vacationSpringStart" type="date" aria-label="春休み開始日">
                            <span class="range-separator">〜</span>
                            <input id="vacationSpringEnd" type="date" aria-label="春休み終了日">
                          </div>
                        </div>
                      </div>
                    </section>
                  </div>

                  <div class="tool-body tab-pane" id="settingsTabExtension" data-tab-pane="extension" role="tabpanel" aria-labelledby="settingsTabExtensionBtn" hidden>
                    <section class="panel slim">
                      <h2>計算バッファ</h2>
                      <div class="row">
                        <div>
                          <label>登園バッファ（分）</label>
                          <input id="arriveBuffer" type="number" min="0" step="1" value="0">
                          <div class="muted">早朝登園の判定を緩めるため、登園時刻に加算</div>
                        </div>
                        <div>
                          <label>降園バッファ（分）</label>
                          <input id="leaveBuffer" type="number" min="0" step="1" value="0">
                          <div class="muted">遅い降園の判定を緩めるため、降園時刻から減算</div>
                        </div>
                      </div>

                      <div class="row" style="margin-top:10px;">
                        <div>
                          <label for="azJudge">預かり判定の目安時刻</label>
                          <input id="azJudge" type="text" value="15:00" placeholder="HH:MM">
                          <div class="muted">例：15:00（設定した預かり保育の判定目安）</div>
                        </div>
                        <div>
                          <label>延長判定のバッファ（分）</label>
                          <input id="extBuffer" type="number" min="0" step="1" value="0">
                          <div class="muted">延長の判定に使う（朝夕共通）</div>
                        </div>
                      </div>

                      <h2>延長料金</h2>
                      <div class="row" style="margin-top:10px;">
                        <div style="min-width:220px;">
                          <label class="toggle-row">
                            <span>登園の延長料金を徴収する</span>
                            <span class="switch-toggle">
                              <input id="chargeEarlyExtension" class="visually-hidden" type="checkbox">
                              <span class="switch-track" aria-hidden="true"></span>
                            </span>
                          </label>
                          <div class="muted">登園時間が早くなった場合の延長料金徴収の有無</div>
                        </div>
                      </div>
                    </section>
                  </div>

                  <div class="tool-body tab-pane" id="settingsTabDisplay" data-tab-pane="display" role="tabpanel" aria-labelledby="settingsTabDisplayBtn" hidden>
                    <section class="panel slim">
                      <h2>表示設定</h2>
                      <div class="display-settings-group">
                        <div class="settings-subtitle">カレンダー表示</div>
                        <div class="row">
                          <div style="min-width:220px;">
                            <label>日カードの表示サイズ</label>
                            <div class="size-toggle" id="daycardSizeToggle" role="group" aria-label="日カードの表示サイズ">
                              <button type="button" class="size-btn" data-size="small">コンパクト</button>
                              <button type="button" class="size-btn" data-size="medium">ミディアム</button>
                              <button type="button" class="size-btn" data-size="large">ラージ</button>
                            </div>
                            <div class="muted">日次明細のカード幅・高さと文字サイズを切り替えます。</div>
                          </div>
                        </div>
                        <div class="row">
                          <div style="min-width:220px;">
                            <label class="toggle-row">
                              <span>保存ボタンを表示</span>
                              <span class="switch-toggle">
                                <input id="showSaveButton" class="visually-hidden" type="checkbox">
                                <span class="switch-track" aria-hidden="true"></span>
                              </span>
                            </label>
                            <div class="muted">画面右下の保存ボタンを表示します。</div>
                          </div>
                        </div>
                      </div>
                      <div class="display-settings-group">
                        <div class="settings-subtitle">トースト表示</div>
                        <div class="row">
                          <div style="min-width:220px;">
                            <label for="toastColor">トーストカラー</label>
                            <input id="toastColor" type="color" aria-label="トーストカラー">
                            <div class="muted">変更や選択の通知トーストの背景色を変更します。</div>
                          </div>
                          <div style="min-width:220px;">
                            <label for="toastDuration">トースト表示時間（秒）</label>
                            <input id="toastDuration" type="number" min="1" max="10" step="0.5" inputmode="decimal" aria-label="トースト表示時間">
                            <div class="muted">通知トーストが消えるまでの時間を設定します。</div>
                          </div>
                        </div>
                      </div>
                      <div class="display-settings-group">
                        <div class="settings-subtitle">デバッグログ</div>
                        <div class="row">
                          <div style="min-width:220px;">
                            <label class="toggle-row">
                              <span>処理ログを表示</span>
                              <span class="switch-toggle">
                                <input id="debugLogEnabled" class="visually-hidden" type="checkbox">
                                <span class="switch-track" aria-hidden="true"></span>
                              </span>
                            </label>
                            <div class="muted">画面左下に処理ログパネルを表示します。</div>
                          </div>
                          <div style="min-width:220px;">
                            <label class="toggle-row">
                              <span>クリックログも出す</span>
                              <span class="switch-toggle">
                                <input id="debugClickLogEnabled" class="visually-hidden" type="checkbox">
                                <span class="switch-track" aria-hidden="true"></span>
                              </span>
                            </label>
                            <div class="muted">クリックイベントの捕捉結果をログに出します。</div>
                          </div>
                        </div>
                        <div class="row" style="margin-top:10px;">
                          <button type="button" class="small" id="debugLogClear">ログをクリア</button>
                          <button type="button" class="small" id="debugLogCopy">ログをコピー</button>
                          <button type="button" class="small" id="debugLogCheckOverlay">被さり要素をチェック</button>
                        </div>
                      </div>
                    </section>
                  </div>

                  <div class="tool-body tab-pane" id="settingsTabDisplayEdit" data-tab-pane="display-edit" role="tabpanel" aria-labelledby="settingsTabDisplayEditBtn" hidden>
                    <section class="panel slim">
                      <h2>表示変更</h2>
                      <div class="row" style="margin-top:10px;">
                        <div style="min-width:220px;">
                          <label for="azukariLabelInput">預かり保育の名称</label>
                          <input id="azukariLabelInput" type="text" placeholder="例：預かり保育">
                          <div class="muted">見出しや内訳に表示する名称を自由に変更できます。</div>
                        </div>
                        <div>
                          <button type="button" class="small primary" id="confirmAzukariLabel">名称を確定</button>
                        </div>
                      </div>
                    </section>
                  </div>

                  <div class="tool-body tab-pane" id="settingsTabGuide" data-tab-pane="guide" role="tabpanel" aria-labelledby="settingsTabGuideBtn" hidden>
                    <section class="panel slim">
                      <h2>ガイド</h2>
                      <div class="muted">
                        - 基本区分が1号認定で、設定した「預かり保育（1日）」の範囲をカバー → 自動で預かり保育が付与されます。<br>
                        - 長期休暇を付けた日は出欠に関わらず「登園」扱いで集計し、預かり保育の内訳に自動加算します（延長料金なし）
                      </div>
                    </section>
                  </div>
                </div>
                <div class="tool-panel-footer">
                  <section class="panel slim">
                    <h2>設定</h2>
                    <div class="row" style="margin-top:8px;">
                      <button id="saveSettings" class="small primary" type="button">設定を保存</button>
                      <button id="resetSettings" class="small" type="button">設定リセット</button>
                    </div>
                  </section>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="user-menu-wrap">
          <button type="button" class="user-chip" id="userMenuButton" aria-haspopup="true" aria-expanded="false">
            <div class="user-icon" id="userIcon" title="ログインユーザー">
              <span class="user-initial" id="activeUserInitial" aria-hidden="true">?</span>
            </div>
            <div class="user-meta">
              <span class="user-label">ユーザー</span>
              <span class="user-name" id="activeUserName">未ログイン</span>
            </div>
          </button>
          <div class="user-menu" id="userMenu" role="menu" aria-hidden="true">
            <a class="user-menu-item" href="index.html" role="menuitem">トップページへ</a>
            <button type="button" class="user-menu-item" id="usageGuideReplayBtn" role="menuitem">使用方法をもう一度見る</button>
            <button type="button" class="user-menu-item" id="logoutButton" role="menuitem">ログアウト</button>
            <div class="user-status-list" aria-label="ユーザー接続ステータス一覧">
              <div class="user-status-item">
                <strong>mode</strong>
                <span>STANDARD</span>
              </div>
              <div class="user-status-item">
                <strong>version</strong>
                <span>v2.4.1</span>
              </div>
              <div class="user-status-item">
                <strong>connect</strong>
                <span>ONLINE</span>
              </div>
              <div class="user-status-item">
                <strong>ip</strong>
                <span>192.168.0.2</span>
              </div>
              <div class="user-status-item">
                <strong>network</strong>
                <span>PRIMARY</span>
              </div>
              <div class="user-status-item">
                <strong>WiFi SSID</strong>
                <span>Office-WiFi</span>
              </div>
              <div class="user-status-item">
                <strong>node status</strong>
                <span>FAILURE / PROCEED</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="header-row">
        <div class="header-tabs">
          <div class="summary-tabs summary-tabs-layer" role="tablist" aria-label="園/クラス/園児/追加の切替">
            <button type="button" class="summary-tab-btn" data-summary-tab="school" aria-controls="summaryTabPaneSchool">園</button>
            <button type="button" class="summary-tab-btn" data-summary-tab="class" aria-controls="summaryTabPaneClass">クラス</button>
            <button type="button" class="summary-tab-btn" data-summary-tab="child" aria-controls="summaryTabPaneChild">園児</button>
            <button type="button" class="summary-tab-btn" data-summary-tab="add" aria-controls="summaryTabPaneAdd">追加</button>
          </div>
        </div>
        <div class="header-tab-panes" aria-live="polite">
          <div class="summary-tab-pane" id="summaryTabPaneSchool" data-summary-pane="school" data-summary-scope="header" hidden>
            <div id="filterContainerSchool"></div>
          </div>
          <div class="summary-tab-pane" id="summaryTabPaneClass" data-summary-pane="class" data-summary-scope="header" hidden>
            <div id="filterContainerClass"></div>
          </div>
          <div class="summary-tab-pane" id="summaryTabPaneChild" data-summary-pane="child" data-summary-scope="header" hidden>
            <div id="filterContainerChildClass"></div>
          </div>
          <div class="summary-tab-pane" id="summaryTabPaneAdd" data-summary-pane="add" data-summary-scope="header" hidden>
            <div id="addTabContainer" class="manual-adders"></div>
            <p class="summary-note">園・クラス・園児の追加はこのタブにまとめました。</p>
          </div>
        </div>
      </div>
      <div class="header-handle" id="headerHandle" aria-label="ヘッダー表示の切替">
        <div class="handle-bar" aria-hidden="true"></div>
        <span class="handle-label header-handle-label">折りたたむ</span>
      </div>
      <div class="header-handle-hit" id="headerHandleHit" aria-hidden="true"></div>
    </div>
  </header>
  <div id="ctrlDock" class="ctrl-dock is-collapsed" aria-label="コントローラーバー">
    <div class="ctrl-label ctrl-drag-handle" id="ctrlDockHandle" aria-label="機能コントローラーをドラッグして移動">
      <svg class="ctrl-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
        <circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/>
      </svg>
    </div>
    <div class="ctrl-strip">
      <div class="ctrl-primary" role="group" aria-label="主要操作">
        <div class="display-tabs ctrl-tabs" role="tablist" aria-label="表示の切替">
          <button type="button" class="ctrl-btn display-tab" role="tab" data-display-tab="detail" aria-controls="detailPanel" aria-label="日次表示" title="日次表示">
            <svg class="ctrl-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
              <rect width="18" height="18" x="3" y="3" rx="2"/><path d="M21 9H3"/><path d="M21 15H3"/>
            </svg>
          </button>
          <button type="button" class="ctrl-btn display-tab" role="tab" data-display-tab="summary" aria-controls="summaryPanel" aria-label="サマリー表示" title="サマリー表示">
            <svg class="ctrl-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
              <rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M3 15h18"/><path d="M9 3v18"/><path d="M15 3v18"/>
            </svg>
          </button>
          <button type="button" class="ctrl-btn display-tab" role="tab" data-display-tab="changed" aria-controls="summaryPanel" aria-label="区分変更表示" title="区分変更表示">
            <svg class="ctrl-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 6a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" /><path d="M3 12h18" /><path d="M12 3v18" /><path d="M4 16l4 4" /><path d="M4 20l4 -4" /><path d="M16 4l4 4" /><path d="M16 8l4 -4" /><path d="M16 18a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
            </svg>
          </button>
          <span class="ctrl-sep" aria-hidden="true">|</span>
        </div>
        <button type="button" id="quickSaveButton" class="ctrl-btn ctrl-primary-save" aria-label="保存" title="保存">
          <svg class="ctrl-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
            <path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path d="M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7"/><path d="M7 3v4a1 1 0 0 0 1 1h7"/>
          </svg>
        </button>
        <button type="button" id="ctrlDockExpandBtn" class="ctrl-btn" aria-expanded="false" aria-controls="ctrlDockItems">＞</button>
      </div>
      <div class="ctrl-items" id="ctrlDockItems" role="group" aria-label="追加操作">
        <button type="button" class="ctrl-btn" id="ctrlPrintButton" aria-label="印刷" title="印刷">
          <svg class="ctrl-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><path d="M6 9V3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6"/><rect x="6" y="14" width="12" height="8" rx="1"/>
          </svg>
        </button>
        <div class="ctrl-memo" id="memoQuickWrap">
          <button type="button" class="ctrl-btn" id="memoQuickBtn" aria-label="付箋" title="付箋" aria-expanded="false" aria-controls="memoQuickMenu">
            <svg class="ctrl-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
              <path d="M21 9a2.4 2.4 0 0 0-.706-1.706l-3.588-3.588A2.4 2.4 0 0 0 15 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2z"/><path d="M15 3v5a1 1 0 0 0 1 1h5"/>
            </svg>
          </button>
          <div class="ctrl-memo-menu" id="memoQuickMenu" role="menu" aria-label="付箋の種類">
            <button type="button" class="ctrl-btn" id="memoHandwriteBtn" role="menuitem" aria-label="付箋（手書き）" title="付箋（手書き）">
              <svg class="ctrl-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
                <circle cx="7" cy="12" r="3"/><path d="M10 9v6"/><circle cx="17" cy="12" r="3"/><path d="M14 7v8"/><path d="M22 17v1c0 .5-.5 1-1 1H3c-.5 0-1-.5-1-1v-1"/>
              </svg>
            </button>
            <button type="button" class="ctrl-btn" id="memoTextBtn" role="menuitem" aria-label="付箋（文字）" title="付箋（文字）">
              <svg class="ctrl-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
                <circle cx="7" cy="12" r="3"/><path d="M10 9v6"/><circle cx="17" cy="12" r="3"/><path d="M14 7v8"/><path d="M22 17v1c0 .5-.5 1-1 1H3c-.5 0-1-.5-1-1v-1"/>
              </svg>
            </button>
            <button type="button" class="ctrl-btn" id="memoImageBtn" role="menuitem" aria-label="付箋（画像）" title="付箋（画像）">
              <svg class="ctrl-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
                <rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
              </svg>
            </button>
          </div>
        </div>
        <button type="button" class="ctrl-btn" id="logWindowButton" aria-label="ログ" title="ログ">
          <svg class="ctrl-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
            <path d="M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z"/><path d="M7 11h10"/><path d="M7 15h6"/><path d="M7 7h8"/>
          </svg>
        </button>
        <div class="ctrl-edit" id="editQuickWrap">
          <button type="button" class="ctrl-btn" id="editQuickBtn" aria-label="編集" title="編集" aria-expanded="false" aria-controls="editQuickMenu" disabled aria-disabled="true">
            <svg class="ctrl-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
              <path d="M7 15h-3a1 1 0 0 1 -1 -1v-8a1 1 0 0 1 1 -1h12a1 1 0 0 1 1 1v3" /><path d="M11 19h-3a1 1 0 0 1 -1 -1v-8a1 1 0 0 1 1 -1h12a1 1 0 0 1 1 1v1.25" /><path d="M18.42 15.61a2.1 2.1 0 1 1 2.97 2.97l-3.39 3.42h-3v-3l3.42 -3.39" />
            </svg>
          </button>
          <div class="ctrl-edit-menu" id="editQuickMenu" role="menu" aria-label="編集メニュー">
            <button type="button" class="ctrl-btn" role="menuitem" aria-label="削除" title="削除">
              <svg class="ctrl-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
                <path d="M4 7l16 0" /><path d="M10 11l0 6" /><path d="M14 11l0 6" /><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" /><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
              </svg>
            </button>
            <button type="button" class="ctrl-btn" role="menuitem" aria-label="上に移動" title="上に移動">
              <svg class="ctrl-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
                <path d="M12 4h-6a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h8" /><path d="M18 20v-17" /><path d="M15 6l3 -3l3 3" />
              </svg>
            </button>
            <button type="button" class="ctrl-btn" role="menuitem" aria-label="下に移動" title="下に移動">
              <svg class="ctrl-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" focusable="false">
                <path d="M14 3a1 1 0 0 1 1 1v11.001h-.092a3 3 0 0 0 -2.03 5.12a.515 .515 0 0 1 -.363 .879h-6.515a3 3 0 0 1 -3 -3v-12a3 3 0 0 1 3 -3z" /><path d="M18 3a1 1 0 0 1 1 1v14.584l1.293 -1.291a1 1 0 0 1 1.32 -.083l.094 .083a1 1 0 0 1 0 1.414l-3 3a1 1 0 0 1 -.112 .097l-.11 .071l-.114 .054l-.105 .035l-.149 .03l-.117 .006l-.075 -.003l-.126 -.017l-.111 -.03l-.111 -.044l-.098 -.052l-.096 -.067l-.09 -.08l-3 -3a1 1 0 0 1 1.414 -1.414l1.293 1.293v-14.586a1 1 0 0 1 1 -1" />
              </svg>
            </button>
            <button type="button" class="ctrl-btn" role="menuitem" aria-label="テキスト編集" title="テキスト編集">
              <svg class="ctrl-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
                <path d="M3 16v-6a2 2 0 1 1 4 0v6" /><path d="M3 13h4" /><path d="M10 8v6a2 2 0 1 0 4 0v-1a2 2 0 1 0 -4 0v1" /><path d="M20.732 12a2 2 0 0 0 -3.732 1v1a2 2 0 0 0 3.726 1.01" />
              </svg>
            </button>
            <button type="button" class="ctrl-btn" role="menuitem" aria-label="ボタン編集" title="ボタン編集">
              <svg class="ctrl-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
                <path d="M4 14h16v5a1 1 0 0 1 -1 1h-14a1 1 0 0 1 -1 -1v-5" /><path d="M4 9v.01" /><path d="M4 4v.01" /><path d="M9 4v.01" /><path d="M15 4v.01" /><path d="M20 4v.01" /><path d="M20 9v.01" />
              </svg>
            </button>
            <button type="button" class="ctrl-btn" role="menuitem" aria-label="アイコン編集" title="アイコン編集">
              <svg class="ctrl-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
                <path d="M4 8v-2a2 2 0 0 1 2 -2h2" /><path d="M4 16v2a2 2 0 0 0 2 2h2" /><path d="M16 4h2a2 2 0 0 1 2 2v2" /><path d="M16 20h2a2 2 0 0 0 2 -2v-2" /><path d="M8.603 9.61a2.04 2.04 0 0 1 2.912 0l.485 .39l.5 -.396a2.035 2.035 0 0 1 2.897 .007a2.104 2.104 0 0 1 0 2.949l-3.397 3.44l-3.397 -3.44a2.104 2.104 0 0 1 0 -2.95" />
              </svg>
            </button>
          </div>
        </div>
        <button type="button" class="ctrl-btn" id="memoPlacementBtn" aria-label="設置モード" title="設置モード" aria-pressed="false">
          <svg class="ctrl-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
            <path d="M18 11V6a2 2 0 0 0-2-2a2 2 0 0 0-2 2"/><path d="M14 10V4a2 2 0 0 0-2-2a2 2 0 0 0-2 2v2"/><path d="M10 10.5V6a2 2 0 0 0-2-2a2 2 0 0 0-2 2v8"/><path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"/>
          </svg>
        </button>
        <button type="button" class="ctrl-btn" id="ctrlDockCollapseBtn" aria-expanded="true" aria-controls="ctrlDockItems">＜</button>
      </div>
    </div>
    <div class="placement-radial" id="placementRadial" aria-hidden="true">
      <div class="placement-node" id="placementIssueNode" style="--x:-90px; --y:-110px;">
        <button type="button" class="placement-orb placement-orb--issue" id="placementIssueBtn" aria-label="不具合報告">
          <span class="icon" aria-hidden="true">🐞</span>
          <span>不具合報告</span>
        </button>
        <div class="placement-menu" id="placementIssueMenu" role="menu" aria-label="不具合報告の方法">
          <button type="button" data-issue-action="select">選択して報告する</button>
          <button type="button" data-issue-action="range">範囲指定で報告する</button>
        </div>
      </div>
      <div class="placement-node" id="placementRequestNode" style="--x:90px; --y:-110px;">
        <button type="button" class="placement-orb placement-orb--request" id="placementRequestBtn" aria-label="バージョンアップ希望！">
          <span class="icon" aria-hidden="true">🚀</span>
          <span>バージョンアップ</span>
        </button>
        <div class="placement-menu" id="placementRequestMenu" role="menu" aria-label="バージョンアップ希望の方法">
          <button type="button" data-request-action="select">選択して希望する</button>
          <button type="button" data-request-action="range">範囲指定で希望する</button>
        </div>
      </div>
    </div>
  </div>
  <section class="summary-layer" id="summaryLayer" aria-label="ミドルレイヤー">
    <div class="summary-inner">
      <input type="hidden" id="selectedChildKey" />
      <div id="headerChildFilterHost" aria-label="園児一覧">
        <div id="filterContainerChild"></div>
        <div class="child-notify-bubble" id="childNotifyBubble" aria-hidden="true" role="dialog" aria-live="polite">
          <div class="child-notify-row">
            <div class="child-notify-badges">
              <span class="child-notify-badge is-unlinked" id="childNotifyLinkBadge">未連携</span>
              <span class="child-notify-badge is-muted" id="childNotifyChatBadge">トーク未作成</span>
            </div>
            <div class="child-notify-actions">
              <button type="button" class="child-notify-btn line-button" id="childNotifyLinkButton">LINE連携</button>
              <button type="button" class="child-notify-btn line-button" id="childNotifySendButton">LINEで送る</button>
            </div>
          </div>
        </div>
        <div class="child-notify-bubble child-notify-bubble--pending" id="childNotifyPendingBubble" aria-hidden="true" role="status" aria-live="polite">
          準備中‥‥
        </div>
      </div>
    </div>
    <div class="summary-handle header-handle" id="summaryHeaderHandle" aria-label="ミドルレイヤー表示の切替" aria-expanded="true">
      <div class="handle-bar" aria-hidden="true"></div>
      <span class="summary-handle-label handle-label">折りたたむ</span>
      <span class="summary-handle-badge" id="summaryLayerEmptyBadge" hidden>データ読取り・計算後に表示します。</span>
    </div>
  </section>

  <main>
    <section class="detail-layer" id="detailLayer" aria-label="サマリーレイヤー">
      <div class="detail-inner">
        <section class="panel summary-panel" id="summaryPanel">
          <div class="collapsible-body" id="summaryBody">
            <div class="summary-layout">
              <div class="summary-pane-wrapper">
                <div class="summary-tab-pane active" id="summaryTabPaneSummary" data-summary-pane="summary" data-summary-scope="layer">
                  <div id="summaryContainer" class="muted calc-result"></div>
                </div>
              </div>
            </div>
          </div>
          <div id="memoLayerSummary" class="memo-layer memo-layer--summary" aria-hidden="true"></div>
        </section>
        <section class="panel detail-panel" id="detailPanel">
          <h2 class="sr-only">日次明細</h2>
            <div class="collapsible-body" id="detailBody">
              <div id="detailContainer" class="muted calc-result" data-detail-pane="detail"></div>
              <div id="detailHistoryContainer" data-detail-pane="history" hidden>
                <div class="change-history-header">
                  <div>
                  <div class="change-history-title">標準時間、短時間、1号認定｜変更履歴</div>
                  <div class="muted" id="changeHistoryActiveChild">園児を選択してください。</div>
                </div>
                <div class="change-history-meta">
                  <span id="changeHistoryStatus">区分変更はまだありません。</span>
                </div>
              </div>
              <div class="changed-type-list" id="changeHistoryList"></div>
            </div>
          </div>
          <div id="memoLayerDetail" class="memo-layer memo-layer--detail" aria-hidden="true"></div>
          <div class="detail-handle header-handle" id="detailHeaderHandle" aria-label="日次明細表示の切替" aria-expanded="true">
            <div class="handle-bar" aria-hidden="true"></div>
            <span class="summary-handle-label handle-label">折りたたむ</span>
            <span class="summary-handle-badge" id="detailLayerEmptyBadge" hidden>データ読取り・計算後に表示します。</span>
          </div>
        </section>
      </div>
    </section>
  </main>
  <section class="manual-layer" id="manualLayer" aria-label="使い方マニュアル（全体）">
    <div class="manual-layer-inner">
      <section class="panel manual-panel">
        <h2 class="sr-only">使い方マニュアル</h2>
        <div class="manual-iframe-wrap">
          <iframe class="manual-iframe" src="encho-usage.html" title="全体の使い方マニュアル"></iframe>
        </div>
      </section>
    </div>
  </section>
  <div class="modal-overlay" id="startupChoiceModal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="startupChoiceTitle">
      <section class="panel slim">
        <div class="modal-header">
          <div class="modal-title" id="startupChoiceTitle">起動時の操作を選択</div>
        </div>
        <div class="startup-choice-body">
          <p class="muted">起動ロード時に開く内容を選択してください。</p>
          <div class="startup-choice-actions">
            <button type="button" class="startup-choice-btn primary" id="startupOpenLast">前回の画面をひらく</button>
            <button type="button" class="startup-choice-btn" id="startupOpenHistory">履歴データからひらく</button>
            <button type="button" class="startup-choice-btn" id="startupOpenCsv">CSVから新しくつくる</button>
            <button type="button" class="startup-choice-btn" id="startupOpenTest">テストデータを読込む</button>
          </div>
          <div class="startup-choice-info">
            <div class="startup-choice-section">
              <div class="startup-choice-section-title">前回の画面の作業情報</div>
              <div class="startup-choice-meta" id="startupLastMeta"></div>
            </div>
            <div class="startup-choice-section">
              <div class="startup-choice-section-title" id="startupCalendarTitle">履歴データの選択（カレンダー）</div>
              <div class="startup-choice-history">
                <div class="startup-calendar-header">
                  <button type="button" class="startup-calendar-nav" data-startup-calendar-nav="prev">◀︎</button>
                  <div class="startup-calendar-label" id="startupCalendarLabel"></div>
                  <button type="button" class="startup-calendar-nav" data-startup-calendar-nav="next">▶︎</button>
                </div>
                <div class="startup-calendar-weekdays">
                  <span>日</span><span>月</span><span>火</span><span>水</span><span>木</span><span>金</span><span>土</span>
                </div>
                <div class="startup-calendar-grid" id="startupCalendarGrid"></div>
                <div class="startup-choice-meta" id="startupHistoryMeta"></div>
                <div class="startup-calendar-actions">
                  <button type="button" class="startup-choice-btn primary" id="startupCalendarStart" disabled>作業開始</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
  <div class="modal-overlay" id="dataReloadModal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="dataReloadModalTitle">
      <section class="panel slim">
        <div class="modal-header">
          <div class="modal-title" id="dataReloadModalTitle">データ読込み</div>
          <button type="button" class="modal-close" id="dataReloadModalClose">閉じる</button>
        </div>
        <div class="test-mode-box">
          <div class="data-source-row">
            <div class="data-source-badge" id="dataSourceLabel">未読み込み</div>
            <p class="data-source-meta" id="dataUpdatedLabel"></p>
          </div>
          <div class="test-mode-actions">
            <button id="dataLoadCsv" type="button" class="header-chip primary" style="padding:8px 12px;">CSVから読み込み</button>
            <button id="dataLoadHistory" type="button" class="header-chip ghost" style="padding:8px 12px;">履歴データから読み込み</button>
            <button id="dataLoadTest" type="button" class="header-chip ghost" style="padding:8px 12px;">テストデータから読み込み</button>
            <button id="dataRefreshButton" type="button" class="header-chip ghost" style="padding:8px 12px;">データをリフレッシュ</button>
          </div>
          <span class="muted">CSVから読み込み・履歴データから読み込み・テストデータから読み込みから選択して読込みます。</span>
        </div>
      </section>
    </div>
  </div>
  <div class="modal-overlay" id="testDataModal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="testDataModalTitle">
      <section class="panel slim">
        <div class="modal-header">
          <div class="modal-title" id="testDataModalTitle">テストデータの選択</div>
          <button type="button" class="modal-close" id="testDataModalClose">閉じる</button>
        </div>
        <div class="test-data-body">
          <p class="muted">CSVのテストデータを選択してテストモードで読み込みます。</p>
          <div class="test-data-list" id="testDataList"></div>
          <div class="test-data-actions">
            <button id="testDataLoadConfirm" type="button" class="header-chip primary" style="padding:8px 12px;">選択したCSVを読み込む</button>
          </div>
        </div>
      </section>
    </div>
  </div>
  <div class="modal-overlay" id="dataNodeModal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="dataNodeModalTitle">
      <section class="panel slim">
        <div class="modal-header">
          <div class="modal-title" id="dataNodeModalTitle">データの表示切替</div>
          <button type="button" class="modal-close" id="dataNodeModalClose">閉じる</button>
        </div>
        <div class="data-node-body">
          <p class="muted" id="dataNodeModalMessage">データの中身が他のユーザーと異なります。どちらを表示しますか？</p>
          <div class="data-node-list" id="dataNodeList"></div>
        </div>
      </section>
    </div>
  </div>
  <div class="modal-overlay" id="multiWindowModal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="multiWindowModalTitle">
      <section class="panel slim">
        <div class="modal-header">
          <div class="modal-title" id="multiWindowModalTitle">複数ウィンドウを検知</div>
        </div>
        <div class="window-warning-body">
          <p class="muted" id="multiWindowModalMessage"></p>
          <div class="window-warning-list" id="multiWindowModalList"></div>
          <p class="muted">作業するウィンドウを選択してください。選択されなかったウィンドウは保存して閉じます。</p>
          <div class="window-warning-actions bulk-header-actions">
            <button type="button" class="header-btn primary" id="multiWindowModalSave" disabled>選択したウィンドウで作業</button>
          </div>
        </div>
      </section>
    </div>
  </div>
  <div class="modal-overlay" id="datasetCompareModal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="datasetCompareTitle">
      <section class="panel slim">
        <div class="modal-header">
          <div class="modal-title" id="datasetCompareTitle">データセット比較</div>
          <button type="button" class="modal-close" id="datasetCompareClose">閉じる</button>
        </div>
        <div class="data-node-body">
          <p class="muted" id="datasetCompareMessage">園単位で他のユーザーとの差分が見つかりました。表示する内容を選択してください。</p>
          <div id="datasetCompareBody"></div>
          <div class="dataset-compare-footer">
            <button type="button" id="datasetCompareApply" class="primary">適用</button>
          </div>
        </div>
      </section>
    </div>
  </div>
  <div class="modal-overlay" id="copyFallbackModal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="copyFallbackTitle">
      <section class="panel slim">
        <div class="modal-header">
          <div class="modal-title" id="copyFallbackTitle">コピーに失敗しました</div>
          <button type="button" class="modal-close" id="copyFallbackClose">閉じる</button>
        </div>
        <div class="copy-fallback-body">
          <p class="muted">長押しでコピーしてください。</p>
          <textarea id="copyFallbackTextarea" readonly></textarea>
        </div>
      </section>
    </div>
  </div>
  <div class="modal-overlay" id="historyDetailModal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="historyDetailTitle">
      <section class="panel slim">
        <div class="modal-header">
          <div class="modal-title" id="historyDetailTitle">履歴データ詳細一覧</div>
          <button type="button" class="modal-close" id="historyDetailClose">閉じる</button>
        </div>
        <div class="data-node-body">
          <p class="muted">園単位で履歴データを整理して表示します。</p>
          <div class="history-dataset-layout">
            <div class="history-dataset-pane">
              <div class="history-dataset-pane-title">データセット一覧</div>
              <div class="history-dataset-pane-sub">園単位で選択</div>
              <div class="history-dataset-list" id="historyDatasetList"></div>
            </div>
            <div class="history-dataset-pane">
              <div class="history-dataset-pane-title" id="historyDatasetDetailTitle">データセット詳細</div>
              <div class="history-dataset-pane-sub">詳細でノード組み合わせを確認し、単位をタップすると右側に入れ替え候補を表示</div>
              <div class="history-dataset-list" id="historyDatasetDetailList"></div>
            </div>
            <div class="history-dataset-pane">
              <div class="history-dataset-pane-title" id="historyDatasetSwapTitle">入れ替え候補</div>
              <div class="history-dataset-pane-sub">最終更新日・更新者・データ行・変更回数</div>
              <div class="history-dataset-list" id="historyDatasetSwapList"></div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
  <div class="modal-overlay" id="lineLinkModal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="lineLinkModalTitle">
      <section class="panel line-link-modal-card printArea">
        <div class="modal-header">
          <div class="modal-title" id="lineLinkModalTitle">保護者連携QR</div>
          <div class="bulk-header-actions" aria-label="保護者通知の操作">
            <button type="button" class="header-btn" id="btnIssueLink">発行</button>
            <button type="button" class="header-btn primary" id="btnPrintLink">印刷</button>
            <button type="button" class="header-btn" id="btnCloseLinkModal">閉じる</button>
          </div>
        </div>
        <div class="line-link-modal-body">
          <div class="muted" id="lineLinkModalChild">園児を選択してください。</div>
          <div class="line-link-modal-grid">
            <div class="line-qr-box" id="qrBox">
              <div class="line-qr-placeholder">QRコード準備中</div>
            </div>
            <div class="line-link-info">
            <div class="line-link-info-row">
              <span class="line-link-info-label">連携URL</span>
              <span class="line-link-info-value" id="lineIdText">---</span>
            </div>
            <div class="line-link-info-row">
              <span class="line-link-info-label">トークID</span>
              <span class="line-link-info-value" id="otpText">------</span>
            </div>
              <div class="line-link-info-row">
                <span class="line-link-info-label">有効期限</span>
                <span class="line-link-info-value" id="otpExpiresText">---</span>
              </div>
              <div class="line-link-note">QRコードを読み取って連携を進めてください。</div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
  <div class="modal-overlay" id="teacherLineLinkModal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="teacherLineLinkModalTitle">
      <section class="panel line-link-modal-card printArea">
        <div class="modal-header">
          <div class="modal-title" id="teacherLineLinkModalTitle">先生LINE連携QR</div>
          <div class="bulk-header-actions" aria-label="先生LINE連携の操作">
            <button type="button" class="header-btn" id="teacherLineLinkIssue">発行</button>
            <button type="button" class="header-btn primary" id="teacherLineLinkPrint">印刷</button>
            <button type="button" class="header-btn" id="teacherLineLinkModalClose">閉じる</button>
          </div>
        </div>
        <div class="line-link-modal-body">
          <div class="muted" id="teacherLineLinkModalLabel">先生用LINE連携を発行します。</div>
          <div class="line-link-modal-grid">
            <div class="line-qr-box" id="teacherLineLinkQrBox">
              <div class="line-qr-placeholder">QRコード準備中</div>
            </div>
            <div class="line-link-info">
              <div class="line-link-info-row">
                <span class="line-link-info-label">連携URL</span>
                <span class="line-link-info-value" id="teacherLineLinkUrl">---</span>
              </div>
              <div class="line-link-info-row">
                <span class="line-link-info-label">トークID</span>
                <span class="line-link-info-value" id="teacherLineLinkThreadId">------</span>
              </div>
              <div class="line-link-info-row">
                <span class="line-link-info-label">有効期限</span>
                <span class="line-link-info-value" id="teacherLineLinkExpires">---</span>
              </div>
              <div class="line-link-note">QRコードを読み取って先生LINEの連携を進めてください。</div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
  <div class="modal-overlay" id="usageGuideModal" aria-hidden="true">
    <div class="guide-spotlight-layer" id="usageGuideSpotlightLayer" aria-hidden="true">
      <div class="guide-spotlight-frame" id="usageGuideSpotlightFrame"></div>
      <div class="guide-callout" id="usageGuideCallout" role="note" data-direction="right">
        <div class="guide-callout-title" id="usageGuideCalloutTitle"></div>
        <div class="guide-callout-body" id="usageGuideCalloutBody"></div>
      </div>
    </div>
    <div class="modal-dialog guide-dialog" role="dialog" aria-modal="true" aria-labelledby="usageGuideTitle">
      <section class="guide-panel">
        <div class="modal-header">
          <div class="modal-title" id="usageGuideTitle">操作ガイド</div>
          <button type="button" class="modal-close" id="usageGuideClose">閉じる</button>
        </div>
        <div class="guide-step-indicator" id="usageGuideStepIndicator">1 / 3</div>
        <div class="guide-step is-active" data-usage-guide-step="0">
          <h3 class="guide-section-title">操作パネル説明</h3>
          <ol class="guide-list">
            <li><strong>データ読込み</strong>：コドモンの打刻データを読込みます。前回作業の続き、過去の履歴から、新しくCSVを読み込む、テストデータの4種類から読込みを行います。</li>
            <li><strong>区分変更</strong>：園児の標準時間、短時間、1号認定区分を園児と指定日選択で当日から月末までを一括で変更します。</li>
            <li><strong>設定</strong>：各保育・教育区分の時間、料金設定、延長料金判定基準、長期休暇期間設定、表示カラー、預り保育の呼び方などを変更できます。</li>
            <li><strong>ユーザーボタン</strong>：ログイン中の先生のアカウント、ステータス状態が表示されます。</li>
          </ol>
        </div>
        <div class="guide-step" data-usage-guide-step="1">
          <h3 class="guide-section-title">機能コントローラー</h3>
          <ol class="guide-list">
            <li><strong>グリッド部</strong>：コントローラーを移動できます。</li>
            <li><strong>日次明細表示</strong>：区分変更、打刻時間修正、休暇区分変更、料金計算結果を表示します。</li>
            <li><strong>サマリー表示</strong>：カレンダー表示で適用区分、料金を表示します。</li>
            <li><strong>区分変更表示</strong>：区分変更の内容をカレンダー表示します。</li>
            <li><strong>保存</strong>：現在の状態を保存します。</li>
            <li><strong>印刷</strong>：サマリー表示の内容をA4サイズに印刷します。</li>
            <li><strong>付箋</strong>：手書き、文字入力、画像を付箋として貼付けます。</li>
            <li><strong>ログウィンドウ</strong>：ログウィンドウを表示します。</li>
            <li><strong>編集</strong>：編集ツールを表示します。</li>
            <li><strong>設置モード</strong>：付箋の配置変更を行います。タップでモード切り替え。</li>
          </ol>
        </div>
        <div class="guide-step" data-usage-guide-step="2">
          <h3 class="guide-section-title">基本使用方法</h3>
          <ol class="guide-list">
            <li>起動すると「前回の画面をひらく」「履歴データからひらく」「CSVから新しくつくる」を選択するウィンドウが表示されます。</li>
            <li>通常は「前回の画面をひらく」から作業を開始します。</li>
            <li>前回の作業が無い場合は、コドモンからCSVファイルをダウンロードし読込みます（コドモン＞登園降園管理＞ダウンロード＞月次CSVファイル）。</li>
            <li>読込みを行うと、日次明細表示で園、クラス、園児名が表示され、該当月の打刻データから日次明細を作成されます。</li>
            <li>「日付列」は、「日付」「登園 /休園/長期休暇」をボタンタップで切り替えができます。</li>
            <li>「標準時間/短時間/1号認定」についてもタップで切り替えができます。1号認定を選択の場合は、長期休暇が1日、午前、午後の選択が可能になります。</li>
            <li>「登園」「降園」列では、登園降園時刻を入力、1分単位、5分単位で調整することができます。</li>
            <li>「免除」ボタンでは電車遅延や天候などを理由とし延長料金を徴収しないよう調整することができます。</li>
            <li>「預り/延長内訳」「合計」欄では、延長料金、預り保育料の計算結果が表示されます。</li>
          </ol>
          <div class="guide-note">「次へ」「戻る」ボタンで内容を確認できます。</div>
        </div>
        <div class="guide-actions">
          <button type="button" class="header-btn" id="usageGuidePrev">戻る</button>
          <button type="button" class="header-btn primary" id="usageGuideNext">次へ</button>
        </div>
      </section>
    </div>
  </div>
  <div class="modal-overlay" id="printPreviewModal" aria-hidden="true">
    <div class="modal-dialog print-preview-dialog" role="dialog" aria-modal="true" aria-labelledby="printPreviewTitle">
      <section class="panel slim print-preview-panel">
        <div class="modal-header">
          <div class="modal-title" id="printPreviewTitle">印刷プレビュー</div>
          <button type="button" class="modal-close" id="printPreviewClose">閉じる</button>
        </div>
        <div class="print-preview-actions">
          <button type="button" class="header-btn primary" id="printPreviewConfirm">印刷</button>
        </div>
        <div class="print-preview-area" id="printPreviewArea" aria-live="polite">
          <article class="print-preview-page" id="printPreviewPage">
            <header class="print-preview-header">
              <div>
                <h2 class="print-preview-title">延長・預かり保育 サマリーレポート</h2>
                <p class="print-preview-subtitle">保護者確認用（サマリー表示を基に作成）</p>
                <p class="print-preview-subtitle" id="printPreviewRange">対象期間：—</p>
              </div>
              <div class="print-preview-meta">
                <strong>発行日</strong>
                <div id="printPreviewIssuedAt">—</div>
              </div>
            </header>
            <section class="print-preview-info-grid" aria-label="基本情報">
              <div class="print-preview-info-item">
                <div class="print-preview-info-label">園児名</div>
                <div class="print-preview-info-value" id="printPreviewChildName">—</div>
              </div>
              <div class="print-preview-info-item">
                <div class="print-preview-info-label">園 / クラス</div>
                <div class="print-preview-info-value" id="printPreviewSchoolClass">—</div>
              </div>
              <div class="print-preview-info-item">
                <div class="print-preview-info-label">対象年月</div>
                <div class="print-preview-info-value" id="printPreviewMonth">—</div>
              </div>
              <div class="print-preview-info-item">
                <div class="print-preview-info-label">区分（前/後）</div>
                <div class="print-preview-info-value" id="printPreviewType">—</div>
              </div>
            </section>
            <table class="print-preview-summary-table" aria-label="料金サマリー">
              <tbody>
                <tr>
                  <th>延長保育料</th>
                  <td><div class="print-preview-summary-pair"><span id="printPreviewExtBefore">—</span><span class="after" id="printPreviewExtAfter">—</span></div></td>
                </tr>
                <tr>
                  <th>預かり保育料</th>
                  <td><div class="print-preview-summary-pair"><span id="printPreviewAzBefore">—</span><span class="after" id="printPreviewAzAfter">—</span></div></td>
                </tr>
                <tr>
                  <th>合計</th>
                  <td><div class="print-preview-summary-pair"><span id="printPreviewTotalBefore">—</span><span class="after" id="printPreviewTotalAfter">—</span></div></td>
                </tr>
              </tbody>
            </table>
            <table class="print-preview-detail-table" aria-label="日別明細">
              <thead>
                <tr>
                  <th>日付</th>
                  <th>状態</th>
                  <th>登園</th>
                  <th>降園</th>
                  <th>延長</th>
                  <th>預り</th>
                  <th>合計</th>
                </tr>
              </thead>
              <tbody id="printPreviewDetailRows"></tbody>
            </table>
            <div class="print-preview-note">
              <div class="print-preview-note-title">備考（延長・預かりの実施日）</div>
              <div id="printPreviewNotes">—</div>
            </div>
            <section class="print-preview-guardian" aria-label="保護者確認欄">
              <div class="guardian-check-list">
                <h3>保護者チェック欄</h3>
                <div class="guardian-check-item"><span class="guardian-check-box"></span>内容を確認しました。</div>
                <div class="guardian-check-item"><span class="guardian-check-box"></span>料金・日付に相違はありません。</div>
                <div class="guardian-check-item"><span class="guardian-check-box"></span>質問があるため連絡します。</div>
              </div>
              <div class="guardian-signature">
                <h3>保護者署名・押印欄</h3>
                <div class="line">署名：<span>　　　　　　　　　　　　</span></div>
                <div class="line">確認日：<span>　　　　　年　　月　　日</span></div>
                <div class="guardian-stamp-box" aria-label="押印欄"></div>
              </div>
            </section>
          </article>
        </div>
      </section>
    </div>
  </div>
  <div class="modal-overlay" id="typeBulkModal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="typeBulkTitle">
      <section class="panel bulk-card" id="typeBulkMenu" aria-label="区分変更メニュー">
        <div class="modal-header">
          <div class="modal-title" id="typeBulkTitle">区分変更</div>
          <div class="bulk-header-actions" aria-label="区分変更の操作">
            <button type="button" class="header-btn" id="bulkHeaderBack">戻る</button>
            <button type="button" class="header-btn primary" id="bulkHeaderConfirm">確定</button>
            <button type="button" class="header-btn" id="typeBulkMenuClose">閉じる</button>
          </div>
        </div>
        <div class="bulk-pane active" id="bulkTabBulk" data-bulk-pane="bulk" role="tabpanel" aria-labelledby="typeBulkTitle">
          <div class="bulk-head">
            <div>
              <div class="bulk-title">園児をまとめて区分変更</div>
              <div class="bulk-sub" id="bulkRangeLabel">園・クラスを選んで園児を複数選択してください</div>
            </div>
            <div class="bulk-actions">
              <span class="bulk-status" id="bulkStatus">CSVを読み込んで園児を選択してください。</span>
            </div>
          </div>
          <div class="bulk-selection-panel" id="bulkSelectionPanel">
            <div class="bulk-selector" style="margin-top:10px;">
              <label>園・クラス・園児</label>
              <div>
                <div class="bulk-field-label">園</div>
                <div class="bulk-option-list" id="bulkSchoolList" data-selector-pane="school"></div>
                <div class="bulk-field-label">クラス</div>
                <div class="bulk-option-list" id="bulkClassList" data-selector-pane="class"></div>
                <div id="bulkChildList" class="bulk-child-list"></div>
              </div>
            </div>
          </div>
          <div class="bulk-change-panel" id="bulkChangePanel" hidden>
            <div class="bulk-change-list" id="bulkChangeList"></div>
            <div class="bulk-actions" style="margin-top:10px;">
              <div class="bulk-row-actions"></div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
  <div class="modal-overlay" id="typeChangeModal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="typeChangeModalTitle">
      <section class="panel slim">
        <div class="modal-header">
          <div class="modal-title" id="typeChangeModalTitle">区分変更</div>
          <button type="button" class="modal-close" id="typeChangeModalClose">閉じる</button>
        </div>
        <div class="type-change-modal-body">
          <div class="type-change-modal-child" id="typeChangeModalChild">園児を選択してください。</div>
          <div class="type-change-field">
            <span class="type-change-label">変更日</span>
            <input type="date" class="type-change-date" id="typeChangeDateInput" />
          </div>
          <div class="type-change-field">
            <span class="type-change-label">変更前区分</span>
            <div class="type-change-buttons" id="typeChangeBeforeButtons"></div>
          </div>
          <div class="type-change-field">
            <span class="type-change-label">変更後区分</span>
            <div class="type-change-buttons" id="typeChangeAfterButtons" role="group" aria-label="変更後区分の選択"></div>
          </div>
          <div class="type-change-actions">
            <button type="button" class="header-btn primary" id="typeChangeApply">変更を確定</button>
          </div>
        </div>
      </section>
    </div>
  </div>
  <div class="modal-overlay" id="exemptReasonModal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="exemptReasonTitle">
      <section class="panel slim">
        <div class="modal-header">
          <div class="modal-title" id="exemptReasonTitle">免除理由を選択</div>
          <button type="button" class="modal-close" id="exemptReasonClose">閉じる</button>
        </div>
        <div class="exempt-modal-body">
          <div class="exempt-reason-grid" id="exemptReasonOptions" role="group" aria-label="免除理由の選択">
            <button type="button" class="exempt-reason-btn" data-reason="電車遅延">電車遅延</button>
            <button type="button" class="exempt-reason-btn" data-reason="バス遅延">バス遅延</button>
            <button type="button" class="exempt-reason-btn" data-reason="混雑">混雑</button>
            <button type="button" class="exempt-reason-btn" data-reason="天気">天気</button>
            <button type="button" class="exempt-reason-btn" data-reason="その他">その他</button>
          </div>
          <div>
            <label for="exemptReasonOtherInput" class="muted">その他の理由</label>
            <input id="exemptReasonOtherInput" class="exempt-reason-input" type="text" placeholder="理由を入力">
          </div>
          <div class="exempt-modal-actions">
            <button type="button" class="small" id="exemptReasonClear">免除を解除</button>
            <button type="button" class="small primary" id="exemptReasonSave">理由を保存</button>
          </div>
        </div>
      </section>
    </div>
  </div>
  <div class="suggestion-float" id="featureSuggestionFloat" role="dialog" aria-hidden="true" aria-label="バージョンアップ希望の操作">
    <div class="suggestion-card">
      <div class="suggestion-header">
        <div class="suggestion-title">バージョンアップ希望！</div>
        <button type="button" class="suggestion-close" id="featureSuggestionClose" aria-label="閉じる">×</button>
      </div>
      <div class="suggestion-context" id="featureSuggestionContext">対象を選択しました。</div>
      <div class="suggestion-actions">
        <button type="button" class="primary" data-suggestion-action="request">希望を出す</button>
        <button type="button" class="ghost" data-suggestion-action="range">範囲指定して出す</button>
        <button type="button" class="ghost" data-suggestion-action="view">
          ほかの人の希望を見る
          <span class="suggestion-badge" id="suggestionBadgeCount">0</span>
        </button>
      </div>
      <form class="suggestion-form" id="featureSuggestionForm">
        <label for="featureSuggestionMessage">希望内容</label>
        <textarea id="featureSuggestionMessage" placeholder="改善したいポイントを入力してください。"></textarea>
        <div class="suggestion-form-actions">
          <button type="button" class="ghost" id="featureSuggestionCancel">キャンセル</button>
          <button type="button" class="primary" id="featureSuggestionSubmit">送信</button>
        </div>
      </form>
    </div>
  </div>
  <div class="range-select-overlay" id="suggestionRangeOverlay" aria-hidden="true">
    <div class="range-select-hint">ドラッグで範囲を指定してください</div>
    <div class="range-select-box" id="suggestionRangeBox"></div>
  </div>
  <div class="modal-overlay" id="suggestionModal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="suggestionModalTitle">
      <section class="panel slim">
        <div class="modal-header">
          <div class="modal-title" id="suggestionModalTitle">バージョンアップ希望を提出</div>
          <button type="button" class="modal-close" id="suggestionModalClose">閉じる</button>
        </div>
        <div class="suggestion-modal-body">
          <div class="suggestion-preview" id="suggestionPreview">
            <img id="suggestionPreviewImg" alt="スクリーンショットプレビュー">
            <div class="placeholder" id="suggestionPreviewPlaceholder">スクリーンショットを取得中...</div>
          </div>
          <div>
            <label for="suggestionInput" class="muted">希望内容</label>
            <textarea id="suggestionInput" class="suggestion-input" placeholder="例: このボタンの位置を変更したい"></textarea>
            <div class="suggestion-meta" id="suggestionMeta">対象: 未選択</div>
          </div>
        </div>
        <div class="suggestion-actions-row">
          <button type="button" class="small" id="suggestionCancel">キャンセル</button>
          <button type="button" class="small primary" id="suggestionSubmit">管理者に提出</button>
        </div>
      </section>
    </div>
  </div>
  <div class="modal-overlay" id="suggestionInboxModal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="suggestionInboxTitle">
      <section class="panel slim">
        <div class="modal-header">
          <div class="modal-title" id="suggestionInboxTitle">バージョンアップ希望の集計</div>
          <button type="button" class="modal-close" id="suggestionInboxClose">閉じる</button>
        </div>
        <div class="suggestion-inbox-list" id="suggestionInboxList"></div>
      </section>
    </div>
  </div>
  <div class="modal-overlay" id="issueModal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="issueModalTitle">
      <section class="panel slim">
        <div class="modal-header">
          <div class="modal-title" id="issueModalTitle">不具合報告を提出</div>
          <button type="button" class="modal-close" id="issueModalClose">閉じる</button>
        </div>
        <div class="suggestion-modal-body">
          <div class="suggestion-preview" id="issuePreview">
            <img id="issuePreviewImg" alt="スクリーンショットプレビュー">
            <div class="placeholder" id="issuePreviewPlaceholder">スクリーンショットを取得中...</div>
          </div>
          <div>
            <label for="issueInput" class="muted">コメント</label>
            <textarea id="issueInput" class="suggestion-input" placeholder="例: ボタンが動作しません"></textarea>
            <div class="issue-tag-list" id="issueTagList" aria-label="タグの選択"></div>
            <div class="suggestion-meta" id="issueMeta">対象: 未選択</div>
          </div>
        </div>
        <div class="suggestion-actions-row">
          <button type="button" class="small" id="issueCancel">キャンセル</button>
          <button type="button" class="small primary" id="issueSubmit">管理者に提出</button>
        </div>
      </section>
    </div>
  </div>
  <div class="modal-overlay" id="issueInboxModal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="issueInboxTitle">
      <section class="panel slim">
        <div class="modal-header">
          <div class="modal-title" id="issueInboxTitle">不具合報告一覧</div>
          <button type="button" class="modal-close" id="issueInboxClose">閉じる</button>
        </div>
        <div class="suggestion-inbox-list" id="issueInboxList"></div>
      </section>
    </div>
  </div>
  <div class="toast-stack" id="toastStack" role="status" aria-live="polite" aria-atomic="false"></div>
<script>
const CLASS_GROUP_SUFFIX_PATTERN = /\s*(?:[\u2460-\u2473\u3251-\u325A])\s*$/;
// ログインチェック & ページ記録
const MODE = window.__MODE__ || window.MODE || "CLOUD"; // "LOCAL" | "CLOUD"
const enchoSession = window.EnchoSession;
const resolveActiveUserFromStorage = () => {
  try {
    const raw = localStorage.getItem("encho_user_profiles_v1");
    if (!raw) return null;
    const parsed = JSON.parse(raw);
    return parsed?.activeUser || null;
  } catch (error) {
    console.warn("ログイン情報の補助読み込みに失敗しました", error);
    return null;
  }
};
const resolveActiveUser = () => enchoSession?.getActiveUser?.() || null;
let activeUser = resolveActiveUser() || resolveActiveUserFromStorage();
const BROWSER_REFRESH_KEY = "encho_browser_refresh_once_v1";
const clearCacheStorageOnLoad = () => {
  if (!("caches" in window)) return;
  caches.keys()
    .then((keys) => Promise.all(keys.map((key) => caches.delete(key))))
    .catch((error) => {
      console.warn("キャッシュ削除に失敗しました", error);
    });
};
const resetBrowserOnLoad = () => {
  try {
    refreshDataWithNodeExport({ source: "ページ再読み込み" });
  } catch (error) {
    console.warn("ページ読み込み時の初期化に失敗しました", error);
  }
};
let appBootstrapped = false;
const refreshBrowserOnceOnLoad = () => {
  if (sessionStorage.getItem(BROWSER_REFRESH_KEY)) return;
  sessionStorage.setItem(BROWSER_REFRESH_KEY, "true");
  window.setTimeout(() => {
    window.location.reload();
  }, 300);
};
const bootstrapApp = () => {
  if (appBootstrapped) return;
  appBootstrapped = true;
  enchoSession?.storeLastPageIfSignedIn();
  clearCacheStorageOnLoad();
  resetBrowserOnLoad();
  refreshDataNodesOnLoad();
  refreshBrowserOnceOnLoad();
  cleanupHistoryDataNodes();
  window.setInterval(() => cleanupHistoryDataNodes(), 6 * 60 * 60 * 1000);
  openStartupChoiceModal();
};
window.addEventListener("load", bootstrapApp);
window.addEventListener("pageshow", (event) => {
  if (event?.persisted) {
    appBootstrapped = false;
  }
  bootstrapApp();
});
const userNameEl = document.getElementById("activeUserName");
const userInitialEl = document.getElementById("activeUserInitial");
const userIconEl = document.getElementById("userIcon");
const loginBtnEl = document.getElementById("loginBtn");
const userMenuButton = document.getElementById("userMenuButton");
const userMenu = document.getElementById("userMenu");
const logoutButton = document.getElementById("logoutButton");
const usageGuideReplayBtn = document.getElementById("usageGuideReplayBtn");
const usageGuideModal = document.getElementById("usageGuideModal");
const usageGuideClose = document.getElementById("usageGuideClose");
const usageGuidePrev = document.getElementById("usageGuidePrev");
const usageGuideNext = document.getElementById("usageGuideNext");
const usageGuideStepIndicator = document.getElementById("usageGuideStepIndicator");
const usageGuideSteps = Array.from(document.querySelectorAll("[data-usage-guide-step]"));
const usageGuideSpotlightLayer = document.getElementById("usageGuideSpotlightLayer");
const usageGuideSpotlightFrame = document.getElementById("usageGuideSpotlightFrame");
const usageGuideCallout = document.getElementById("usageGuideCallout");
const usageGuideCalloutTitle = document.getElementById("usageGuideCalloutTitle");
const usageGuideCalloutBody = document.getElementById("usageGuideCalloutBody");
const USAGE_GUIDE_STORAGE_KEY = "encho_usage_guide_seen_v1";
let usageGuideStepIndex = 0;
let usageGuideAutoOpen = false;
const usageGuideSpotlightSteps = [
  {
    step: 0,
    selector: ".header-actions",
    title: "ボタンパネル説明",
    body: "データ読込み・区分変更・設定・ユーザー情報などの操作はこのボタンパネルから行います。"
  },
  {
    step: 1,
    selector: "#ctrlDock",
    title: "機能コントローラー説明",
    body: "機能コントローラーでは、日次明細表示やサマリー表示などの各種ツールを切り替えて操作できます。"
  },
  {
    step: 2,
    selector: "#detailPanel",
    title: "基本操作説明",
    body: "日次明細エリアで日付・区分切替や登園/降園の入力、免除ボタンなどの基本操作を行います。"
  }
];
let usageGuideActiveSpotlight = null;
const syncActiveUser = ({ redirectIfMissing = false } = {}) => {
  const nextUser = resolveActiveUser() || resolveActiveUserFromStorage();
  if (nextUser !== activeUser) {
    activeUser = nextUser;
  }
  if (userNameEl) userNameEl.textContent = activeUser || "未ログイン";
  if (userInitialEl) userInitialEl.textContent = (activeUser || "").slice(0, 1) || "？";
  if (userIconEl) userIconEl.title = activeUser ? `ログイン中: ${activeUser}` : "未ログイン";
  if (loginBtnEl) loginBtnEl.classList.toggle("is-hidden", !!activeUser);
  if (!activeUser && redirectIfMissing) {
    const currentPage = location.pathname.split("/").pop() || "Calcu.html";
    window.location.href = `login.html?redirect=${encodeURIComponent(currentPage)}`;
    console.warn("ログイン情報が見つからないためログインページへ遷移します。");
  }
  return activeUser;
};
syncActiveUser({ redirectIfMissing: true });
window.addEventListener("storage", (event) => {
  if (event.key === "encho_user_profiles_v1") {
    syncActiveUser();
  }
});
window.addEventListener("focus", () => {
  syncActiveUser();
});
document.addEventListener("visibilitychange", () => {
  if (!document.hidden) {
    syncActiveUser();
  }
});
const setUserMenuOpen = (open) => {
  if (!userMenu || !userMenuButton) return;
  userMenu.classList.toggle("open", open);
  userMenu.setAttribute("aria-hidden", open ? "false" : "true");
  userMenuButton.setAttribute("aria-expanded", open ? "true" : "false");
};
const closeUserMenu = () => setUserMenuOpen(false);
const logUserMenuTap = () => {
  if (window.DLOG?.log) {
    window.DLOG.log("[ユーザー操作] ユーザーボタンをタップしました");
  }
};
const getUsageGuideKey = () => `${USAGE_GUIDE_STORAGE_KEY}_${activeUser || "guest"}`;
const markUsageGuideSeen = () => {
  try {
    localStorage.setItem(getUsageGuideKey(), new Date().toISOString());
  } catch (error) {
    console.warn("usage guide state save failed", error);
  }
};
const shouldAutoOpenUsageGuide = () => {
  try {
    return !localStorage.getItem(getUsageGuideKey());
  } catch (error) {
    return false;
  }
};
const updateUsageGuideStep = () => {
  if (!usageGuideSteps.length) return;
  usageGuideSteps.forEach((step, index) => {
    step.classList.toggle("is-active", index === usageGuideStepIndex);
  });
  if (usageGuidePrev) {
    usageGuidePrev.disabled = usageGuideStepIndex === 0;
  }
  if (usageGuideNext) {
    usageGuideNext.textContent = usageGuideStepIndex === usageGuideSteps.length - 1 ? "完了" : "次へ";
  }
  if (usageGuideStepIndicator) {
    usageGuideStepIndicator.textContent = `${usageGuideStepIndex + 1} / ${usageGuideSteps.length}`;
  }
  updateUsageGuideSpotlight();
};
const setUsageGuideSpotlight = (config) => {
  usageGuideActiveSpotlight = config;
  if (!usageGuideSpotlightLayer || !usageGuideSpotlightFrame || !usageGuideCallout) return;
  if (!config) {
    usageGuideSpotlightLayer.classList.remove("is-active");
    usageGuideSpotlightLayer.setAttribute("aria-hidden", "true");
    return;
  }
  if (usageGuideCalloutTitle) usageGuideCalloutTitle.textContent = config.title;
  if (usageGuideCalloutBody) usageGuideCalloutBody.textContent = config.body;
  usageGuideSpotlightLayer.classList.add("is-active");
  usageGuideSpotlightLayer.setAttribute("aria-hidden", "false");
  updateUsageGuideSpotlightPosition();
};
const updateUsageGuideSpotlight = () => {
  if (!usageGuideModal?.classList.contains("open")) {
    setUsageGuideSpotlight(null);
    return;
  }
  const config = usageGuideSpotlightSteps.find((item) => item.step === usageGuideStepIndex) || null;
  setUsageGuideSpotlight(config);
};
const updateUsageGuideSpotlightPosition = () => {
  if (!usageGuideActiveSpotlight || !usageGuideSpotlightFrame || !usageGuideCallout) return;
  const target = document.querySelector(usageGuideActiveSpotlight.selector);
  if (!target) {
    setUsageGuideSpotlight(null);
    return;
  }
  const rect = target.getBoundingClientRect();
  if (rect.width < 4 || rect.height < 4) {
    setUsageGuideSpotlight(null);
    return;
  }
  const padding = 8;
  const viewportPadding = 12;
  const frameWidth = Math.min(rect.width + padding * 2, window.innerWidth - viewportPadding * 2);
  const frameHeight = Math.min(rect.height + padding * 2, window.innerHeight - viewportPadding * 2);
  const frameLeft = Math.min(
    Math.max(rect.left - padding, viewportPadding),
    window.innerWidth - frameWidth - viewportPadding
  );
  const frameTop = Math.min(
    Math.max(rect.top - padding, viewportPadding),
    window.innerHeight - frameHeight - viewportPadding
  );
  usageGuideSpotlightFrame.style.top = `${frameTop}px`;
  usageGuideSpotlightFrame.style.left = `${frameLeft}px`;
  usageGuideSpotlightFrame.style.width = `${frameWidth}px`;
  usageGuideSpotlightFrame.style.height = `${frameHeight}px`;

  const calloutGap = 12;
  const calloutWidth = usageGuideCallout.offsetWidth || 260;
  const calloutHeight = usageGuideCallout.offsetHeight || 120;
  let calloutLeft = frameLeft + frameWidth + calloutGap;
  let calloutTop = frameTop;
  let direction = "right";
  const rightSpace = window.innerWidth - (frameLeft + frameWidth) - viewportPadding;
  const leftSpace = frameLeft - viewportPadding;
  if (rightSpace < calloutWidth && leftSpace >= calloutWidth) {
    direction = "left";
    calloutLeft = frameLeft - calloutWidth - calloutGap;
  } else if (rightSpace < calloutWidth && leftSpace < calloutWidth) {
    direction = "bottom";
    calloutLeft = Math.min(
      Math.max(frameLeft, viewportPadding),
      window.innerWidth - calloutWidth - viewportPadding
    );
    calloutTop = frameTop + frameHeight + calloutGap;
  }
  if (direction === "right" || direction === "left") {
    if (calloutTop + calloutHeight > window.innerHeight - viewportPadding) {
      calloutTop = window.innerHeight - calloutHeight - viewportPadding;
    }
  }
  if (calloutTop + calloutHeight > window.innerHeight - viewportPadding) {
    direction = "top";
    calloutTop = frameTop - calloutHeight - calloutGap;
    calloutLeft = Math.min(
      Math.max(frameLeft, viewportPadding),
      window.innerWidth - calloutWidth - viewportPadding
    );
  }
  usageGuideCallout.dataset.direction = direction;
  usageGuideCallout.style.top = `${Math.max(calloutTop, viewportPadding)}px`;
  usageGuideCallout.style.left = `${Math.max(calloutLeft, viewportPadding)}px`;
};
const openUsageGuide = (options = {}) => {
  if (!usageGuideModal) return;
  usageGuideAutoOpen = options.auto === true;
  usageGuideStepIndex = 0;
  updateUsageGuideStep();
  usageGuideModal.classList.add("open");
  usageGuideModal.setAttribute("aria-hidden", "false");
  updateUsageGuideSpotlight();
};
const closeUsageGuide = () => {
  if (!usageGuideModal) return;
  usageGuideModal.classList.remove("open");
  usageGuideModal.setAttribute("aria-hidden", "true");
  setUsageGuideSpotlight(null);
  if (usageGuideAutoOpen || shouldAutoOpenUsageGuide()) {
    markUsageGuideSeen();
  }
  usageGuideAutoOpen = false;
};
const maybeOpenUsageGuide = () => {
  if (!shouldAutoOpenUsageGuide()) return;
  openUsageGuide({ auto: true });
};
userMenuButton?.addEventListener("click", (e) => {
  e.stopPropagation();
  const isOpen = userMenu?.classList.contains("open");
  setUserMenuOpen(!isOpen);
  logUserMenuTap();
});
logoutButton?.addEventListener("click", () => {
  runAutoSave("logout");
  enchoSession?.clearActiveUser?.();
  window.location.href = "login.html";
});
usageGuideReplayBtn?.addEventListener("click", (event) => {
  event.stopPropagation();
  closeUserMenu();
  openUsageGuide({ auto: false });
});
usageGuideClose?.addEventListener("click", () => {
  closeUsageGuide();
});
usageGuidePrev?.addEventListener("click", () => {
  usageGuideStepIndex = Math.max(usageGuideStepIndex - 1, 0);
  updateUsageGuideStep();
});
usageGuideNext?.addEventListener("click", () => {
  if (usageGuideStepIndex >= usageGuideSteps.length - 1) {
    closeUsageGuide();
    return;
  }
  usageGuideStepIndex = Math.min(usageGuideStepIndex + 1, usageGuideSteps.length - 1);
  updateUsageGuideStep();
});
document.addEventListener("click", (e) => {
  if (!userMenu || !userMenuButton) return;
  const target = e.target instanceof Element ? e.target : null;
  if (target && (userMenu.contains(target) || userMenuButton.contains(target))) return;
  setUserMenuOpen(false);
});
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    closeUserMenu();
    if (usageGuideModal?.classList.contains("open")) {
      closeUsageGuide();
    }
  }
});
window.addEventListener("resize", () => {
  if (usageGuideModal?.classList.contains("open")) {
    updateUsageGuideSpotlightPosition();
  }
});
window.addEventListener(
  "scroll",
  () => {
    if (usageGuideModal?.classList.contains("open")) {
      updateUsageGuideSpotlightPosition();
    }
  },
  true
);
const lineLinkHeaderButton = document.getElementById("lineLinkHeaderButton");
if (lineLinkHeaderButton) {
  lineLinkHeaderButton.addEventListener("click", () => {
    closeUserMenu();
    window.open(
      "teacher-issue.html",
      "lineLinkIssue",
      "width=980,height=820,noopener,noreferrer"
    );
  });
}

/* =========================
   状態・設定
========================= */
const STORAGE_KEY = "enchoAzukari_app_v1";
const DATA_NODE_KEY = "encho_data_nodes_v1";
const ARCHIVE_DATA_NODE_KEY = "encho_data_nodes_archive_v1";

const DEFAULT_TIME_SETTINGS = {
  standard: { start: "07:30", end: "18:30" },
  short: { start: "08:30", end: "16:30" },
  onegou: {
    amStart: "08:30",
    amEnd: "13:00",
    pmStart: "13:00",
    pmEnd: "16:30",
    fullStart: "08:30",
    fullEnd: "16:30"
  },
  azukari: {
    amStart: "08:30",
    amEnd: "13:00",
    pmStart: "13:00",
    pmEnd: "16:30",
    fullStart: "08:30",
    fullEnd: "16:30"
  }
};

const DEFAULT_FEE_SETTINGS = {
  azukari: { am: 500, pm: 500, full: 1000 },
  extension: { standardShort: 200, onegouAzukari: 150 },
  extras: { snack: 0, lunch: 0 }
};

const DEFAULT_SETTINGS = {
  arriveBuffer: 0,
  leaveBuffer: 0,
  extBuffer: 0,
  azJudge: "15:00",
  chargeEarlyExtension: true,
  timeSettings: DEFAULT_TIME_SETTINGS,
  feeSettings: DEFAULT_FEE_SETTINGS,
  vacationPeriods: {
    summer: { start: "", end: "" },
    winter: { start: "", end: "" },
    spring: { start: "", end: "" }
  },
  activeSchool: null,
  activeClass: null,
  activeName: null,
  themeName: "violet",
  daycardSize: "small",
  summaryCollapsed: false,
  summaryActiveTab: "summary",
  summaryChildLayerOpen: false,
  summaryCalendarYear: null,
  summaryCalendarMonth: null,
  summaryCalendarTargetKey: null,
  summaryViewMode: "summary",
  detailCollapsed: false,
  detailActiveTab: "detail",
  summaryClassFilter: "ALL",
  summaryFiltersSelected: false,
  summaryLastTarget: null,
  headerStage: "expanded",
  displayMode: "detail",
  customSchools: [],
  customClasses: {}, // school -> string[]
  customChildren: {}, // `${school}__${class}` -> string[]
  lineLinkedChildren: {}, // childKey -> boolean
  lineMessageStatus: {}, // childKey -> replied | pending | unsent
  lineChatChildren: {}, // childKey -> boolean
  // 行ごとの上書き
  overridesByKey: {}, // recordKey -> { baseType?, type?, arriveMinutes?, leaveMinutes?, vacationMode?, attendStatus?, extExemptArrive?, extExemptLeave?, extExemptReasonArrive?, extExemptReasonLeave? }
  typeChangeHistory: [],
  toastColor: "#1f1b2d",
  toastDuration: 2200,
  showSaveButton: true,
  lastUpdatedAt: null,
  dataNodeSelectedId: null,
  workStartAt: null,
  workEffort: 0
};

const APP_VERSION = {
  label: "Calcu v2.0",
  updatedAt: "2026/01/15 01:55"
};
const BASE_URL = MODE === "LOCAL" ? "https://mac-gate.local" : "";
const EXAMPLE_DOMAIN_URL =
  MODE === "LOCAL" ? BASE_URL : window.location.origin || "";
const normalizeApiPath = (path) => (path.startsWith("/") ? path : `/${path}`);
const getApiUrlPair = (path) => {
  const normalizedPath = normalizeApiPath(path);
  if (MODE === "LOCAL") {
    return {
      primary: `${BASE_URL}${normalizedPath}`,
      fallback: `/api${normalizedPath}`
    };
  }
  return {
    primary: `/api${normalizedPath}`,
    fallback: normalizedPath
  };
};
const buildApiUrl = (path) => getApiUrlPair(path).primary;
const LOCAL_NOTIFY_STORAGE_KEY = "encho_notify_threads_v1";
const loadLocalNotifyThreads = () => {
  try {
    const stored = localStorage.getItem(LOCAL_NOTIFY_STORAGE_KEY);
    return stored ? JSON.parse(stored) : {};
  } catch (error) {
    return {};
  }
};
const saveLocalNotifyThreads = (threads) => {
  try {
    localStorage.setItem(LOCAL_NOTIFY_STORAGE_KEY, JSON.stringify(threads));
  } catch (error) {
    console.warn("notify thread cache save failed", error);
  }
};
const createLocalNotifyThreadId = () => `local-${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 8)}`;
const getLocalNotifyThread = (childId) => {
  if (!childId) return null;
  const threads = loadLocalNotifyThreads();
  return threads[childId] || null;
};
const ensureLocalNotifyThread = (childId) => {
  if (!childId) return null;
  const threads = loadLocalNotifyThreads();
  if (!threads[childId]) {
    threads[childId] = {
      child_id: childId,
      thread_id: createLocalNotifyThreadId(),
      created_at: new Date().toISOString()
    };
    saveLocalNotifyThreads(threads);
  }
  return threads[childId];
};
const buildLocalNotifyUrl = (threadId) => {
  if (!threadId) return "";
  const origin = window.location.origin;
  if (origin && origin !== "null") {
    return `${origin}/notify/${threadId}`;
  }
  const base = window.location.href.split("#")[0];
  return `${base}#notify-${threadId}`;
};
const mockNotifyApi = (path, options = {}) => {
  const normalizedPath = normalizeApiPath(path);
  if (normalizedPath.startsWith("/admin/children/") && normalizedPath.endsWith("/notify-state")) {
    const parts = normalizedPath.split("/");
    const childId = parts[3] ? decodeURIComponent(parts[3]) : "";
    const cached = getLocalNotifyThread(childId);
    return new Response(JSON.stringify({
      child_id: childId || null,
      thread_id: cached?.thread_id || null,
      link_status: cached ? "LINKED" : "UNLINKED"
    }), {
      status: 200,
      headers: { "Content-Type": "application/json", "X-Local-Mock": "true" }
    });
  }
  if (normalizedPath === "/admin/notify/thread/upsert") {
    let body = null;
    if (typeof options.body === "string") {
      try {
        body = JSON.parse(options.body);
      } catch (error) {
        body = null;
      }
    }
    const childId = body?.child_id || "";
    if (!childId) {
      return new Response(JSON.stringify({ detail: "child_id is required" }), {
        status: 422,
        headers: { "Content-Type": "application/json", "X-Local-Mock": "true" }
      });
    }
    const entry = ensureLocalNotifyThread(childId);
    return new Response(JSON.stringify({
      child_id: childId,
      thread_id: entry.thread_id,
      link_status: "LINKED"
    }), {
      status: 200,
      headers: { "Content-Type": "application/json", "X-Local-Mock": "true" }
    });
  }
  if (normalizedPath === "/admin/notify/qr") {
    let body = null;
    if (typeof options.body === "string") {
      try {
        body = JSON.parse(options.body);
      } catch (error) {
        body = null;
      }
    }
    const childId = body?.child_id || "";
    const threadId = body?.thread_id || ensureLocalNotifyThread(childId)?.thread_id || "";
    return new Response(JSON.stringify({
      url: buildLocalNotifyUrl(threadId),
      expires_at: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
      qr_svg: null
    }), {
      status: 200,
      headers: { "Content-Type": "application/json", "X-Local-Mock": "true" }
    });
  }
  return null;
};
const LAST_KNOWN_KEY = "encho_last_known_latest_v1";
const LEGACY_LAST_KNOWN_KEY = "encho_latest_last_known_v1";
const apiFetch = async (path, options = {}) => {
  const { primary, fallback } = getApiUrlPair(path);
  const fetchOptions = { cache: "no-store", ...options };
  let response = null;
  let fetchError = null;
  try {
    response = await fetch(primary, fetchOptions);
  } catch (error) {
    fetchError = error;
  }
  if ((!response || response.status === 404) && fallback && fallback !== primary) {
    try {
      response = await fetch(fallback, fetchOptions);
    } catch (error) {
      fetchError = fetchError || error;
    }
  }
  if (!response || response.status === 404) {
    const mockResponse = mockNotifyApi(path, fetchOptions);
    if (mockResponse) return mockResponse;
  }
  if (!response && fetchError) {
    throw fetchError;
  }
  return response;
};
const parseResponseData = async (response) => {
  const text = await response.text();
  if (!text) return null;
  try {
    return JSON.parse(text);
  } catch (error) {
    return { detail: text };
  }
};
const extractErrorMessage = (data, fallback) => {
  if (!data || typeof data !== "object") return fallback;
  const detail = typeof data.detail === "string" ? data.detail.trim() : "";
  if (!detail) return fallback;
  if (/<(html|!doctype)/i.test(detail)) return fallback;
  return detail;
};

let state = loadState();
state.themeName = window.EnchoTheme?.getActiveThemeName() || state.themeName;
state.customSchools = state.customSchools || [];
state.customClasses = state.customClasses || {};
state.customChildren = state.customChildren || {};
state.lineLinkedChildren = state.lineLinkedChildren || {};
state.lineMessageStatus = state.lineMessageStatus || {};
state.lineChatChildren = state.lineChatChildren || {};
state.detailCollapsed = typeof state.detailCollapsed === "boolean" ? state.detailCollapsed : false;
state.summaryViewMode = state.summaryViewMode === "changed" ? "changed" : "summary";
state.summaryFiltersSelected = typeof state.summaryFiltersSelected === "boolean" ? state.summaryFiltersSelected : false;
state.summaryChildLayerOpen = typeof state.summaryChildLayerOpen === "boolean"
  ? state.summaryChildLayerOpen
  : state.summaryActiveTab === "child";
state.summaryLastTarget = state.summaryLastTarget && state.summaryLastTarget.school && state.summaryLastTarget.clazz && state.summaryLastTarget.name
  ? state.summaryLastTarget
  : null;
state.summaryCollapsed = false;
state.detailCollapsed = false;
state.headerStage = "expanded";
state.displayMode = "detail";
state.vacationPeriods = normalizeVacationPeriods(state.vacationPeriods);
state.timeSettings = normalizeTimeSettings(state.timeSettings);
state.feeSettings = normalizeFeeSettings(state.feeSettings);
state.toastDuration = Number.isFinite(state.toastDuration) ? state.toastDuration : DEFAULT_SETTINGS.toastDuration;
state.showSaveButton = typeof state.showSaveButton === "boolean" ? state.showSaveButton : DEFAULT_SETTINGS.showSaveButton;
const legacyMemoNotes = {
  memoNotesA: state.memoNotesA || {},
  memoNotesB: Array.isArray(state.memoNotesB) ? state.memoNotesB : []
};
delete state.memoNotesA;
delete state.memoNotesB;

/* =========================
   複数ウィンドウ検知
========================= */
const WINDOW_STATUS_KEY = "encho_calcu_window_status_v1";
const WINDOW_STATUS_TTL_MS = 20000;
const WINDOW_STATUS_PING_MS = 5000;
const WINDOW_WARNING_COOLDOWN_MS = 60000;
const WINDOW_CONTROL_KEY = "encho_calcu_window_control_v1";
const windowControlChannel = ("BroadcastChannel" in window)
  ? new BroadcastChannel("encho_calcu_window_control")
  : null;
const windowSession = {
  id: (typeof crypto !== "undefined" && crypto.randomUUID)
    ? crypto.randomUUID()
    : `window-${Date.now()}-${Math.random().toString(16).slice(2)}`,
  startAt: Date.now(),
  workEffort: 0,
  lastWarningAt: 0
};
if (!state.workStartAt) {
  state.workStartAt = windowSession.startAt;
}
if (!Number.isFinite(state.workEffort)) {
  state.workEffort = 0;
}
windowSession.workEffort = Number(state.workEffort || 0);

const formatTimestamp = (ts) => {
  if (!ts) return "不明";
  const dt = new Date(ts);
  const pad = (v) => String(v).padStart(2, "0");
  return `${dt.getFullYear()}/${pad(dt.getMonth() + 1)}/${pad(dt.getDate())} ${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
};

const formatDuration = (ms) => {
  if (!Number.isFinite(ms) || ms < 0) return "0分";
  const totalMinutes = Math.floor(ms / 60000);
  const hours = Math.floor(totalMinutes / 60);
  const minutes = totalMinutes % 60;
  if (hours <= 0) return `${minutes}分`;
  return `${hours}時間${minutes}分`;
};

const listChangedChildNames = (history = []) => {
  if (!Array.isArray(history)) return [];
  const names = history.map(entry => entry?.name).filter(Boolean);
  return uniq(names);
};

const collectWindowStatus = () => {
  const changeHistory = Array.isArray(state.typeChangeHistory) ? state.typeChangeHistory : [];
  const changedNames = listChangedChildNames(changeHistory);
  return {
    id: windowSession.id,
    startAt: windowSession.startAt,
    lastSeenAt: Date.now(),
    workEffort: windowSession.workEffort,
    changeCount: changeHistory.length,
    changedNames
  };
};

const readWindowRegistry = () => {
  try {
    const raw = localStorage.getItem(WINDOW_STATUS_KEY);
    const parsed = raw ? JSON.parse(raw) : [];
    return Array.isArray(parsed) ? parsed : [];
  } catch (error) {
    console.warn("ウィンドウ情報の読み込みに失敗しました", error);
    return [];
  }
};

const writeWindowRegistry = (entries) => {
  try {
    localStorage.setItem(WINDOW_STATUS_KEY, JSON.stringify(entries));
  } catch (error) {
    console.warn("ウィンドウ情報の保存に失敗しました", error);
  }
};

const updateWindowRegistry = (status) => {
  const now = Date.now();
  const filtered = readWindowRegistry().filter(entry =>
    entry && entry.id && entry.id !== status.id && (now - (entry.lastSeenAt || 0) <= WINDOW_STATUS_TTL_MS)
  );
  filtered.push(status);
  writeWindowRegistry(filtered);
  return filtered;
};

const buildWindowInfoLines = (label, status, newestId) => {
  const changedNames = (status.changedNames || []).slice();
  const trimmedNames = changedNames.length > 6 ? `${changedNames.slice(0, 6).join("、")} 他${changedNames.length - 6}名` : (changedNames.join("、") || "なし");
  const isNewest = status.id === newestId;
  return [
    `${label}${isNewest ? "（新しい）" : ""}`,
    `開始時間: ${formatTimestamp(status.startAt)}`,
    `作業時間: ${formatDuration(Date.now() - (status.startAt || Date.now()))}`,
    `作業工数: ${Number(status.workEffort || 0).toLocaleString()}回`,
    `変更数: ${Number(status.changeCount || 0).toLocaleString()}回`,
    `変更園児名: ${trimmedNames}`
  ];
};

let selectedWindowId = null;

const updateMultiWindowSelectionState = (id) => {
  selectedWindowId = id;
  if (multiWindowModalSave) {
    multiWindowModalSave.disabled = !selectedWindowId;
  }
};

const renderMultiWindowModalList = (entries, newestEntry, selectedId = null) => {
  if (!multiWindowModalList) return;
  multiWindowModalList.innerHTML = entries.map((entry, index) => {
    const label = entry.id === windowSession.id ? "このウィンドウ" : `別ウィンドウ${index + 1}`;
    const [title, ...details] = buildWindowInfoLines(label, entry, newestEntry.id);
    const detailLines = details.map(line => `<div>${esc(line)}</div>`).join("");
    const isSelected = selectedId && entry.id === selectedId;
    return `
      <label class="window-warning-card">
        <div class="window-warning-title">
          <input class="window-warning-select" type="radio" name="multiWindowSelection" value="${esc(entry.id)}" ${isSelected ? "checked" : ""}>
          <span>${esc(title)}</span>
        </div>
        <div class="window-warning-meta">${detailLines}</div>
      </label>
    `;
  }).join("");
};

const openMultiWindowModal = (entries, newestEntry) => {
  if (!multiWindowModal || !multiWindowModalMessage) return;
  multiWindowModalMessage.textContent = "同じ作業画面が複数開いています。作業するウィンドウを選択してください。";
  updateMultiWindowSelectionState(null);
  renderMultiWindowModalList(entries, newestEntry, selectedWindowId);
  multiWindowModal.classList.add("open");
  multiWindowModal.setAttribute("aria-hidden", "false");
};

const closeMultiWindowModal = () => {
  if (!multiWindowModal) return;
  multiWindowModal.classList.remove("open");
  multiWindowModal.setAttribute("aria-hidden", "true");
};

const maybeWarnMultipleWindows = (entries) => {
  if (!Array.isArray(entries) || entries.length <= 1) return;
  if (multiWindowModal?.classList.contains("open")) {
    const newestEntry = entries.reduce((latest, entry) =>
      (entry.startAt || 0) > (latest.startAt || 0) ? entry : latest
    );
    renderMultiWindowModalList(entries, newestEntry, selectedWindowId);
    return;
  }
  const now = Date.now();
  if (now - windowSession.lastWarningAt < WINDOW_WARNING_COOLDOWN_MS) return;
  windowSession.lastWarningAt = now;
  const newestEntry = entries.reduce((latest, entry) =>
    (entry.startAt || 0) > (latest.startAt || 0) ? entry : latest
  );
  openMultiWindowModal(entries, newestEntry);
};

const saveNodeBeforeWindowClose = (reason) => {
  runAutoSave(reason);
  if (typeof createDataNodePayload === "function" && typeof dataNodeHasData === "function") {
    const payload = createDataNodePayload();
    if (dataNodeHasData(payload)) {
      saveConfirmedDataNode({ source: "複数ウィンドウ自動保存" });
    }
  }
};

const broadcastWindowSelection = (keepId) => {
  if (!keepId) return;
  const payload = {
    type: "selection",
    keepId,
    sourceId: windowSession.id,
    sentAt: Date.now()
  };
  windowControlChannel?.postMessage(payload);
  try {
    localStorage.setItem(WINDOW_CONTROL_KEY, JSON.stringify(payload));
  } catch (error) {
    console.warn("ウィンドウ選択の通知に失敗しました", error);
  }
};

const handleWindowSelection = (keepId, sourceId) => {
  if (!keepId || keepId === windowSession.id) {
    updateMultiWindowSelectionState(keepId || null);
    windowSession.lastWarningAt = Date.now();
    closeMultiWindowModal();
    return;
  }
  if (sourceId === windowSession.id) return;
  saveNodeBeforeWindowClose("複数ウィンドウ選択");
  window.setTimeout(() => {
    window.close();
  }, 100);
};

const AUTO_SAVE_THROTTLE_MS = 1500;
let lastAutoSaveAt = 0;
const runAutoSave = (reason) => {
  const now = Date.now();
  if (now - lastAutoSaveAt < AUTO_SAVE_THROTTLE_MS) return;
  lastAutoSaveAt = now;
  if (typeof saveMemoStore === "function") {
    saveMemoStore();
  }
  if (typeof saveState === "function") {
    saveState({ skipNodeSync: true });
  }
  if (window.DLOG?.log) {
    window.DLOG.log(`[自動保存] ${reason}`);
  }
};

const startWindowStatusTracking = () => {
  const broadcastChannel = ("BroadcastChannel" in window)
    ? new BroadcastChannel("encho_calcu_window")
    : null;
  const pushStatus = () => {
    const status = collectWindowStatus();
    const registry = updateWindowRegistry(status);
    if (broadcastChannel) {
      broadcastChannel.postMessage({ type: "status", payload: status });
    }
    maybeWarnMultipleWindows(registry);
  };
  const removeStatus = () => {
    const now = Date.now();
    const remaining = readWindowRegistry()
      .filter(entry => entry?.id && entry.id !== windowSession.id && (now - (entry.lastSeenAt || 0) <= WINDOW_STATUS_TTL_MS));
    writeWindowRegistry(remaining);
  };
  pushStatus();
  const intervalId = window.setInterval(pushStatus, WINDOW_STATUS_PING_MS);
  broadcastChannel?.addEventListener("message", (event) => {
    const payload = event?.data?.payload;
    if (!payload?.id || payload.id === windowSession.id) return;
    const registry = updateWindowRegistry(payload);
    maybeWarnMultipleWindows(registry);
  });
  windowControlChannel?.addEventListener("message", (event) => {
    const data = event?.data;
    if (data?.type === "selection") {
      handleWindowSelection(data.keepId, data.sourceId);
    }
  });
  window.addEventListener("storage", (event) => {
    if (event.key !== WINDOW_STATUS_KEY) return;
    const registry = readWindowRegistry().filter(entry => entry?.id && (Date.now() - (entry.lastSeenAt || 0) <= WINDOW_STATUS_TTL_MS));
    maybeWarnMultipleWindows(registry);
  });
  window.addEventListener("storage", (event) => {
    if (event.key !== WINDOW_CONTROL_KEY) return;
    if (!event.newValue) return;
    try {
      const data = JSON.parse(event.newValue);
      if (data?.type === "selection") {
        handleWindowSelection(data.keepId, data.sourceId);
      }
    } catch (error) {
      console.warn("ウィンドウ選択の通知解析に失敗しました", error);
    }
  });
  window.addEventListener("visibilitychange", () => {
    if (!document.hidden) pushStatus();
  });
  window.addEventListener("beforeunload", () => {
    runAutoSave("beforeunload");
    window.clearInterval(intervalId);
    broadcastChannel?.close();
    windowControlChannel?.close();
    removeStatus();
  });
};

startWindowStatusTracking();

window.addEventListener("pagehide", () => {
  runAutoSave("pagehide");
});
window.addEventListener("visibilitychange", () => {
  if (document.hidden) {
    runAutoSave("visibilitychange");
  }
});
window.addEventListener("freeze", () => {
  runAutoSave("freeze");
});

/* =========================
   定数（延長）
========================= */
const MONTHLY_CAP    = 3000;
const TYPE_OPTIONS = [
  { key: "standard", label: "標準時間" },
  { key: "short", label: "短時間" },
  { key: "1gou", label: "1号認定" }
];
const TYPE_CYCLE_ORDER = ["standard", "short", "1gou"];
const STATUS_CYCLE_1GOU = ["attend", "vacation-all", "vacation-am", "vacation-pm", "absent", "closed"];
const STATUS_CYCLE_DEFAULT = ["attend", "absent", "closed"];
const VACATION_STATUS_KEYS = ["vacation-all", "vacation-am", "vacation-pm"];
const STATUS_LABELS = {
  attend: "登園",
  absent: "欠園",
  closed: "休園",
  "vacation-all": "長期休暇（1日）",
  "vacation-am": "長期休暇（午前）",
  "vacation-pm": "長期休暇（午後）"
};
const DAYCARD_SIZE_PRESETS = {
  small: {
    key: "small",
    values: {
      "daycard-width": "104px",
      "daycard-col-width": "116px",
      "daycard-min-height": "118px",
      "daycard-gap": "6px",
      "daycard-padding": "7px 7px",
      "daycard-date-size": "16px",
      "daycard-week-size": "10px",
      "daycard-label-size": "10px",
      "daycard-chip-font-size": "10px",
      "daycard-chip-padding": "7px 7px"
    }
  },
  medium: {
    key: "medium",
    values: {
      "daycard-width": "116px",
      "daycard-col-width": "128px",
      "daycard-min-height": "132px",
      "daycard-gap": "8px",
      "daycard-padding": "9px 9px",
      "daycard-date-size": "19px",
      "daycard-week-size": "11px",
      "daycard-label-size": "11px",
      "daycard-chip-font-size": "11px",
      "daycard-chip-padding": "8px 8px"
    }
  },
  large: {
    key: "large",
    values: {
      "daycard-width": "132px",
      "daycard-col-width": "144px",
      "daycard-min-height": "152px",
      "daycard-gap": "10px",
      "daycard-padding": "10px 10px",
      "daycard-date-size": "21px",
      "daycard-week-size": "12px",
      "daycard-label-size": "11px",
      "daycard-chip-font-size": "11px",
      "daycard-chip-padding": "10px 10px"
    }
  }
};
const DAYCARD_SIZE_LABELS = {
  small: "コンパクト",
  medium: "ミディアム",
  large: "ラージ"
};

// vacationMode: null | 'ALL' | 'AM' | 'PM'

const TEST_CSV_HEADERS = ["日付", "出欠", "名前", "園", "所属", "登園時刻", "降園時刻"];

const escapeCsvValue = (value) => {
  const text = String(value ?? "");
  if (!/[",\r\n]/.test(text)) return text;
  return `"${text.replace(/"/g, '""')}"`;
};

const buildMonthDates = (year, month) => {
  const start = new Date(year, month - 1, 1);
  const end = new Date(year, month, 0);
  const result = [];
  for (const date = new Date(start); date <= end; date.setDate(date.getDate() + 1)){
    const yyyy = date.getFullYear();
    const mm = String(date.getMonth() + 1).padStart(2, "0");
    const dd = String(date.getDate()).padStart(2, "0");
    result.push(`${yyyy}/${mm}/${dd}`);
  }
  return result;
};

const buildTestRows = () => {
  const now = new Date();
  const targetMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
  const monthDates = buildMonthDates(targetMonth.getFullYear(), targetMonth.getMonth() + 1);
  const school = "テストさくら園";
  const classes = [
    { name: "テストクラスA", count: 30 },
    { name: "テストクラスB", count: 25 },
    { name: "テストクラスC", count: 4 },
    { name: "テストクラスD", count: 60 }
  ];
  const times = [
    { arrive: "08:05", leave: "16:20" },
    { arrive: "08:15", leave: "16:45" },
    { arrive: "08:30", leave: "17:05" },
    { arrive: "08:40", leave: "16:10" }
  ];

  let childIndex = 1;
  const children = classes.flatMap((clazz) =>
    Array.from({ length: clazz.count }, () => ({
      name: `テスト園児${String(childIndex++).padStart(3, "0")}`,
      school,
      clazz: clazz.name
    }))
  );

  const rows = [];
  children.forEach((child, idx) => {
    monthDates.forEach((date, dateIdx) => {
      const time = times[(idx + dateIdx) % times.length];
      const isAbsent = (idx + dateIdx) % 17 === 0;
      rows.push({
        "日付": date,
        "出欠": isAbsent ? "欠園" : "登園",
        "名前": child.name,
        "園": child.school,
        "所属": child.clazz,
        "登園時刻": isAbsent ? "" : time.arrive,
        "降園時刻": isAbsent ? "" : time.leave
      });
    });
  });
  return rows;
};

const buildTestCsv = (rows) => {
  const lines = [TEST_CSV_HEADERS.join(",")];
  rows.forEach((row) => {
    const line = TEST_CSV_HEADERS.map((key) => escapeCsvValue(row[key] ?? "")).join(",");
    lines.push(line);
  });
  return lines.join("\n");
};

const TEST_DATASETS = [
  {
    id: "default",
    label: "標準テストデータ（複数クラス）",
    description: "クラスA:30人・クラスB:25人・クラスC:4人・クラスD:60人の構成です。",
    file: "test-data/test-data-default.csv",
    fileLabel: "test-data-default.csv"
  },
  {
    id: "class100",
    label: "1クラス100人在籍",
    description: "1クラスに100人在籍するデータです。",
    file: "test-data/test-data-100-per-class.csv",
    fileLabel: "test-data-100-per-class.csv"
  },
  {
    id: "newline_terminated",
    label: "改行コードあり（最終行に改行）",
    description: "最終行に改行コードがあるCSVの読み込みを確認します。",
    file: "test-data/test-data-newline-terminated.csv",
    fileLabel: "test-data-newline-terminated.csv"
  },
  {
    id: "no_newline",
    label: "改行コードなし（最終行に改行なし）",
    description: "最終行に改行コードがないCSVの読み込みを確認します。",
    file: "test-data/test-data-no-newline.csv",
    fileLabel: "test-data-no-newline.csv"
  }
];
const TEST_DATA_CACHE_KEY = "encho_test_csv_cache_v1";

const JAPAN_PUBLIC_HOLIDAYS = {
  2024: new Set([
    "01-01","01-08","02-11","02-12","02-23","03-20","04-29","05-03","05-04","05-05","05-06","07-15","08-11","08-12","09-16","09-23","10-14","11-03","11-04","11-23"
  ]),
  2025: new Set([
    "01-01","01-13","02-11","02-23","02-24","03-20","04-29","05-03","05-04","05-05","05-06","07-21","08-11","09-15","09-23","10-13","11-03","11-23","11-24"
  ])
};

/* =========================
   DOM
========================= */
const fileInput = document.getElementById("csvFile");
const dataLoadTool = document.getElementById("dataLoadTool");
const toggleDataLoadBtn = document.getElementById("toggleDataLoad");
const dataReloadButton = document.getElementById("dataReloadButton");
const ctrlDataReloadButton = document.getElementById("ctrlDataReloadButton");
const startupChoiceModal = document.getElementById("startupChoiceModal");
const startupOpenLastBtn = document.getElementById("startupOpenLast");
const startupOpenHistoryBtn = document.getElementById("startupOpenHistory");
const startupOpenCsvBtn = document.getElementById("startupOpenCsv");
const startupOpenTestBtn = document.getElementById("startupOpenTest");
const startupLastMeta = document.getElementById("startupLastMeta");
const startupCalendarTitle = document.getElementById("startupCalendarTitle");
const startupCalendarLabel = document.getElementById("startupCalendarLabel");
const startupCalendarGrid = document.getElementById("startupCalendarGrid");
const startupCalendarStartBtn = document.getElementById("startupCalendarStart");
const startupHistoryMeta = document.getElementById("startupHistoryMeta");
const dataReloadModal = document.getElementById("dataReloadModal");
const dataReloadModalClose = document.getElementById("dataReloadModalClose");
const testDataModal = document.getElementById("testDataModal");
const testDataModalClose = document.getElementById("testDataModalClose");
const testDataList = document.getElementById("testDataList");
const testDataLoadConfirm = document.getElementById("testDataLoadConfirm");
const summaryContainer = document.getElementById("summaryContainer");
const dataNodeModal = document.getElementById("dataNodeModal");
const dataNodeModalClose = document.getElementById("dataNodeModalClose");
const dataNodeList = document.getElementById("dataNodeList");
const multiWindowModal = document.getElementById("multiWindowModal");
const multiWindowModalSave = document.getElementById("multiWindowModalSave");
const multiWindowModalMessage = document.getElementById("multiWindowModalMessage");
const multiWindowModalList = document.getElementById("multiWindowModalList");
const datasetCompareModal = document.getElementById("datasetCompareModal");
const datasetCompareClose = document.getElementById("datasetCompareClose");
const datasetCompareBody = document.getElementById("datasetCompareBody");
const datasetCompareApply = document.getElementById("datasetCompareApply");
const datasetCompareMessage = document.getElementById("datasetCompareMessage");
const copyFallbackModal = document.getElementById("copyFallbackModal");
const copyFallbackClose = document.getElementById("copyFallbackClose");
const copyFallbackTextarea = document.getElementById("copyFallbackTextarea");
const historyDetailModal = document.getElementById("historyDetailModal");
const historyDetailClose = document.getElementById("historyDetailClose");
const historyDatasetList = document.getElementById("historyDatasetList");
const historyDatasetDetailList = document.getElementById("historyDatasetDetailList");
const historyDatasetSwapList = document.getElementById("historyDatasetSwapList");
const historyDatasetDetailTitle = document.getElementById("historyDatasetDetailTitle");
const historyDatasetSwapTitle = document.getElementById("historyDatasetSwapTitle");
const filterContainerSchool = document.getElementById("filterContainerSchool");
const filterContainerClass = document.getElementById("filterContainerClass");
const filterContainerChildClass = document.getElementById("filterContainerChildClass");
const filterContainerChild = document.getElementById("filterContainerChild");
const headerChildFilterHost = document.getElementById("headerChildFilterHost");
const childNotifyBubble = document.getElementById("childNotifyBubble");
const childNotifyPendingBubble = document.getElementById("childNotifyPendingBubble");
const childNotifyLinkBadge = document.getElementById("childNotifyLinkBadge");
const childNotifyChatBadge = document.getElementById("childNotifyChatBadge");
const childNotifyLinkButton = document.getElementById("childNotifyLinkButton");
const childNotifySendButton = document.getElementById("childNotifySendButton");
const summaryChildFilterHost = document.getElementById("summaryChildFilterHost");
const lineLinkPanel = document.getElementById("lineLinkPanel");
const lineLinkStatusEl = document.getElementById("lineLinkStatus");
const lineSendStatusEl = document.getElementById("lineSendStatus");
const lineLinkButton = document.getElementById("lineLinkButton");
const lineChatButton = document.getElementById("lineChatButton");
const sendLineButton = document.getElementById("sendLineButton");
const lineLinkModal = document.getElementById("lineLinkModal");
const lineLinkModalClose = document.getElementById("btnCloseLinkModal");
const lineLinkModalPrint = document.getElementById("btnPrintLink");
const lineLinkModalIssue = document.getElementById("btnIssueLink");
const lineLinkModalChild = document.getElementById("lineLinkModalChild");
const lineLinkModalQr = document.getElementById("qrBox");
const lineLinkModalId = document.getElementById("lineIdText");
const lineLinkModalOtp = document.getElementById("otpText");
const lineLinkModalOtpExpires = document.getElementById("otpExpiresText");
const teacherLineLinkHeaderButton = document.getElementById("teacherLineLinkHeaderButton");
const teacherLineLinkBadge = document.getElementById("teacherLineLinkBadge");
const teacherLineLinkModal = document.getElementById("teacherLineLinkModal");
const teacherLineLinkModalClose = document.getElementById("teacherLineLinkModalClose");
const teacherLineLinkIssue = document.getElementById("teacherLineLinkIssue");
const teacherLineLinkPrint = document.getElementById("teacherLineLinkPrint");
const teacherLineLinkQrBox = document.getElementById("teacherLineLinkQrBox");
const teacherLineLinkUrl = document.getElementById("teacherLineLinkUrl");
const teacherLineLinkThreadId = document.getElementById("teacherLineLinkThreadId");
const teacherLineLinkExpires = document.getElementById("teacherLineLinkExpires");
const printPreviewModal = document.getElementById("printPreviewModal");
const printPreviewClose = document.getElementById("printPreviewClose");
const printPreviewConfirm = document.getElementById("printPreviewConfirm");
const printPreviewRange = document.getElementById("printPreviewRange");
const printPreviewIssuedAt = document.getElementById("printPreviewIssuedAt");
const printPreviewChildName = document.getElementById("printPreviewChildName");
const printPreviewSchoolClass = document.getElementById("printPreviewSchoolClass");
const printPreviewMonth = document.getElementById("printPreviewMonth");
const printPreviewType = document.getElementById("printPreviewType");
const printPreviewExtBefore = document.getElementById("printPreviewExtBefore");
const printPreviewExtAfter = document.getElementById("printPreviewExtAfter");
const printPreviewAzBefore = document.getElementById("printPreviewAzBefore");
const printPreviewAzAfter = document.getElementById("printPreviewAzAfter");
const printPreviewTotalBefore = document.getElementById("printPreviewTotalBefore");
const printPreviewTotalAfter = document.getElementById("printPreviewTotalAfter");
const printPreviewDetailRows = document.getElementById("printPreviewDetailRows");
const printPreviewNotes = document.getElementById("printPreviewNotes");
const ctrlPrintButton = document.getElementById("ctrlPrintButton");
const selectedChildKeyInput = document.getElementById("selectedChildKey");
const addTabContainer = document.getElementById("addTabContainer");
const detailContainer = document.getElementById("detailContainer");
const dateRangeLabel = document.getElementById("dateRangeLabel");
const detailMetaSchoolEl = document.getElementById("detailMetaSchool");
const detailMetaClassEl = document.getElementById("detailMetaClass");
const detailMetaChildEl = document.getElementById("detailMetaChild");
const summaryLayer = document.getElementById("summaryLayer");
const detailLayer = document.getElementById("detailLayer");
const summaryPanel = document.getElementById("summaryPanel");
const detailPanel = document.getElementById("detailPanel");
const detailBody = document.getElementById("detailBody");
const summaryPaneWrapper = document.querySelector(".summary-pane-wrapper");
const manualIframes = document.querySelectorAll(".manual-iframe");
const summaryToggleBtn = document.getElementById("summaryToggle");
const detailToggleBtn = document.getElementById("detailToggle");
const displayTabButtons = document.querySelectorAll("[data-display-tab]");
const summaryTabButtons = document.querySelectorAll("[data-summary-tab]");
const summaryTabPanes = document.querySelectorAll("[data-summary-pane]");
const SUMMARY_TAB_KEYS = ["summary", "school", "class", "child", "add"];
const detailTabButtons = document.querySelectorAll("[data-detail-tab]");
const detailTabPanes = document.querySelectorAll("[data-detail-pane]");
const DETAIL_TAB_KEYS = ["detail"];
const loginBtn = document.getElementById("loginBtn");
const typeBulkMenu = document.getElementById("typeBulkMenu");
const typeBulkModal = document.getElementById("typeBulkModal");
const typeBulkMenuToggle = document.getElementById("typeBulkMenuToggle");
const typeBulkMenuClose = document.getElementById("typeBulkMenuClose");
const typeChangeModal = document.getElementById("typeChangeModal");
const typeChangeModalClose = document.getElementById("typeChangeModalClose");
const typeChangeModalChild = document.getElementById("typeChangeModalChild");
const typeChangeDateInput = document.getElementById("typeChangeDateInput");
const typeChangeBeforeButtons = document.getElementById("typeChangeBeforeButtons");
const typeChangeAfterButtons = document.getElementById("typeChangeAfterButtons");
const typeChangeApply = document.getElementById("typeChangeApply");
const changeHistoryModal = document.getElementById("changeHistoryModal");
const changeHistoryModalClose = document.getElementById("changeHistoryModalClose");
const changeHistoryModalList = document.getElementById("changeHistoryList");
const changeHistoryModalStatusEl = document.getElementById("changeHistoryStatus");
const changeHistoryModalActiveChildEl = document.getElementById("changeHistoryActiveChild");
const exemptReasonModal = document.getElementById("exemptReasonModal");
const exemptReasonClose = document.getElementById("exemptReasonClose");
const exemptReasonOptions = document.getElementById("exemptReasonOptions");
const exemptReasonOtherInput = document.getElementById("exemptReasonOtherInput");
const exemptReasonSave = document.getElementById("exemptReasonSave");
const exemptReasonClear = document.getElementById("exemptReasonClear");
const bulkHeaderBack = document.getElementById("bulkHeaderBack");
const bulkHeaderConfirm = document.getElementById("bulkHeaderConfirm");
const bulkSchoolList = document.getElementById("bulkSchoolList");
const bulkClassList = document.getElementById("bulkClassList");
const bulkChildList = document.getElementById("bulkChildList");
const bulkAddRowBtn = document.getElementById("bulkAddRow");
const bulkSelectionPanel = document.getElementById("bulkSelectionPanel");
const bulkChangePanel = document.getElementById("bulkChangePanel");
const childTypeSelect = document.getElementById("childTypeSelect");
const bulkChangeList = document.getElementById("bulkChangeList");
const childTypeList = document.getElementById("childTypeList");
const changedTypeList = document.getElementById("changedTypeList");
const changedStatusEl = document.getElementById("changedStatus");
const changedRangeLabelEl = document.getElementById("changedRangeLabel");
const bulkActiveNameEl = document.getElementById("bulkActiveName");
const bulkRangeLabelEl = document.getElementById("bulkRangeLabel");
const childActiveNameEl = document.getElementById("childActiveName");
const childRangeLabelEl = document.getElementById("childRangeLabel");
const childStatusEl = document.getElementById("childStatus");
const bulkStatusEl = document.getElementById("bulkStatus");
const applyBulkTypeBtn = document.getElementById("applyBulkType");
const daycardSizeToggle = document.getElementById("daycardSizeToggle");
const azukariLabelInput = document.getElementById("azukariLabelInput");
const confirmAzukariLabelBtn = document.getElementById("confirmAzukariLabel");
const dataLoadCsvBtn = document.getElementById("dataLoadCsv");
const dataLoadHistoryBtn = document.getElementById("dataLoadHistory");
const dataHistoryDetailBtn = document.getElementById("dataHistoryDetail");
const dataLoadTestBtn = document.getElementById("dataLoadTest");
const dataRefreshButton = document.getElementById("dataRefreshButton");
const dataSourceLabelEl = document.getElementById("dataSourceLabel");
const dataUpdatedLabelEl = document.getElementById("dataUpdatedLabel");
const versionBadgeEl = document.getElementById("versionBadge");
const modeLabelEl = document.getElementById("modeLabel");
const modeVersionLabelEl = document.getElementById("modeVersionLabel");
const modeStatusNoteEl = document.getElementById("modeStatusNote");
const toastColorEl = document.getElementById("toastColor");
const toastDurationEl = document.getElementById("toastDuration");
const showSaveButtonEl = document.getElementById("showSaveButton");
const debugLogEnabledEl = document.getElementById("debugLogEnabled");
const debugClickLogEnabledEl = document.getElementById("debugClickLogEnabled");
const debugLogClearBtn = document.getElementById("debugLogClear");
const debugLogCopyBtn = document.getElementById("debugLogCopy");
const debugLogCheckOverlayBtn = document.getElementById("debugLogCheckOverlay");
const quickSaveButton = document.getElementById("quickSaveButton");
const ctrlDock = document.getElementById("ctrlDock");
const ctrlDockHandle = document.getElementById("ctrlDockHandle");
const ctrlDockExpandBtn = document.getElementById("ctrlDockExpandBtn");
const ctrlDockCollapseBtn = document.getElementById("ctrlDockCollapseBtn");
const ctrlToggle = document.getElementById("ctrlToggle");
const logWindowButton = document.getElementById("logWindowButton");
const formatUpdatedAt = (value) => {
  if (!value) return APP_VERSION.updatedAt;
  const date = new Date(value);
  if (Number.isNaN(date.getTime())) return value;
  return date.toLocaleString("ja-JP", { year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" }).replace(/\//g, "-");
};
const updateModeStatus = (note) => {
  if (modeLabelEl) modeLabelEl.textContent = MODE;
  if (modeStatusNoteEl) modeStatusNoteEl.textContent = note || "";
};
const DEBUG_LOG_KEY = "debugLogEnabled";
const DEBUG_CLICK_LOG_KEY = "debugClickLogEnabled";
const storedDebugClickLogEnabled = localStorage.getItem(DEBUG_CLICK_LOG_KEY);
const debugLogState = {
  enabled: false,
  clickEnabled: storedDebugClickLogEnabled ? storedDebugClickLogEnabled === "1" : false,
  lines: [],
  maxLines: 500,
  panelEl: null,
  bodyEl: null,
  toggleBtn: null,
  isCollapsed: false,
  activeCategory: "all"
};
const LOG_CATEGORIES = {
  network: "通信",
  browser: "ブラウザ処理",
  calculation: "計算",
  user: "ユーザー操作",
  display: "表示",
  toast: "トースト"
};
let activeHistoryTarget = null;
const LOG_CATEGORY_LIST = [
  { key: "all", label: "すべて" },
  ...Object.entries(LOG_CATEGORIES).map(([key, label]) => ({ key, label }))
];
let lastTapLogAt = 0;
const TAP_LOG_DEDUP_MS = 700;
const enableDebugPanelDragging = (panel, handle) => {
  if (!panel || !handle) return;
  let dragging = false;
  let pointerId = null;
  let startX = 0;
  let startY = 0;
  let startLeft = 0;
  let startTop = 0;
  let panelWidth = 0;
  let panelHeight = 0;
  const margin = 8;
  const clampValue = (value, min, max) => Math.min(max, Math.max(min, value));
  const setPosition = (left, top) => {
    panel.style.left = `${left}px`;
    panel.style.top = `${top}px`;
    panel.style.right = "auto";
    panel.style.bottom = "auto";
  };
  handle.addEventListener("pointerdown", (e) => {
    if (e.button !== 0) return;
    if (e.target instanceof Element && e.target.closest(".debug-log-btn")) return;
    const rect = panel.getBoundingClientRect();
    panelWidth = rect.width;
    panelHeight = rect.height;
    startLeft = rect.left;
    startTop = rect.top;
    startX = e.clientX;
    startY = e.clientY;
    dragging = true;
    pointerId = e.pointerId;
    handle.setPointerCapture(pointerId);
    panel.classList.add("is-dragging");
    setPosition(startLeft, startTop);
    e.preventDefault();
  });
  handle.addEventListener("pointermove", (e) => {
    if (!dragging || e.pointerId !== pointerId) return;
    const nextLeft = startLeft + (e.clientX - startX);
    const nextTop = startTop + (e.clientY - startY);
    const maxLeft = Math.max(margin, window.innerWidth - panelWidth - margin);
    const maxTop = Math.max(margin, window.innerHeight - panelHeight - margin);
    setPosition(clampValue(nextLeft, margin, maxLeft), clampValue(nextTop, margin, maxTop));
  });
  const stopDrag = (e) => {
    if (!dragging || (pointerId !== null && e.pointerId !== pointerId)) return;
    dragging = false;
    panel.classList.remove("is-dragging");
    if (pointerId !== null) {
      handle.releasePointerCapture(pointerId);
    }
    pointerId = null;
  };
  handle.addEventListener("pointerup", stopDrag);
  handle.addEventListener("pointercancel", stopDrag);
};
const enableCtrlDockDragging = (dock, handle) => {
  if (!dock || !handle) return;
  let dragging = false;
  let pointerId = null;
  let startX = 0;
  let startY = 0;
  let startLeft = 0;
  let startTop = 0;
  let dockWidth = 0;
  let dockHeight = 0;
  const margin = 12;
  const clampValue = (value, min, max) => Math.min(max, Math.max(min, value));
  const setPosition = (left, top) => {
    dock.style.left = `${left}px`;
    dock.style.top = `${top}px`;
    dock.style.right = "auto";
    dock.style.bottom = "auto";
  };
  handle.addEventListener("pointerdown", (e) => {
    if (e.button !== 0) return;
    const rect = dock.getBoundingClientRect();
    dockWidth = rect.width;
    dockHeight = rect.height;
    startLeft = rect.left;
    startTop = rect.top;
    startX = e.clientX;
    startY = e.clientY;
    dragging = true;
    pointerId = e.pointerId;
    handle.setPointerCapture(pointerId);
    dock.classList.add("is-dragging");
    setPosition(startLeft, startTop);
    e.preventDefault();
  });
  handle.addEventListener("pointermove", (e) => {
    if (!dragging || e.pointerId !== pointerId) return;
    const nextLeft = startLeft + (e.clientX - startX);
    const nextTop = startTop + (e.clientY - startY);
    const maxLeft = Math.max(margin, window.innerWidth - dockWidth - margin);
    const maxTop = Math.max(margin, window.innerHeight - dockHeight - margin);
    setPosition(clampValue(nextLeft, margin, maxLeft), clampValue(nextTop, margin, maxTop));
  });
  const stopDrag = (e) => {
    if (!dragging || (pointerId !== null && e.pointerId !== pointerId)) return;
    dragging = false;
    dock.classList.remove("is-dragging");
    if (pointerId !== null) {
      handle.releasePointerCapture(pointerId);
    }
    pointerId = null;
  };
  handle.addEventListener("pointerup", stopDrag);
  handle.addEventListener("pointercancel", stopDrag);
};
const setCtrlDockExpanded = (dock, expandBtn, collapseBtn, expanded) => {
  if (!dock) return;
  dock.classList.toggle("is-collapsed", !expanded);
  dock.classList.toggle("is-expanded", expanded);
  if (expandBtn) expandBtn.setAttribute("aria-expanded", expanded ? "true" : "false");
  if (collapseBtn) collapseBtn.setAttribute("aria-expanded", expanded ? "true" : "false");
};
const runAfterDomReady = (fn) => {
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", fn, { once: true });
  } else {
    fn();
  }
};
const formatDebugTimestamp = (date = new Date()) => {
  const pad2 = (value) => String(value).padStart(2, "0");
  const pad3 = (value) => String(value).padStart(3, "0");
  return `${pad2(date.getHours())}:${pad2(date.getMinutes())}:${pad2(date.getSeconds())}.${pad3(date.getMilliseconds())}`;
};
const serializeDebugObject = (obj) => {
  if (obj === undefined) return null;
  const payload = obj instanceof Error ? { message: obj.message, stack: obj.stack } : obj;
  try {
    return JSON.stringify(payload);
  } catch (error) {
    return String(obj);
  }
};
const ensureDebugPanel = () => {
  if (debugLogState.panelEl) return;
  const panel = document.createElement("div");
  panel.id = "debugLogPanel";
  panel.className = "debug-log-panel";
  panel.hidden = !debugLogState.enabled;
  panel.style.display = debugLogState.enabled ? "flex" : "none";
  panel.setAttribute("aria-hidden", (!debugLogState.enabled).toString());
  const header = document.createElement("div");
  header.className = "debug-log-header";
  const title = document.createElement("div");
  title.className = "debug-log-title";
  title.textContent = "ログウィンドウ";
  const actions = document.createElement("div");
  actions.className = "debug-log-actions";
  const copyBtn = document.createElement("button");
  copyBtn.type = "button";
  copyBtn.className = "debug-log-btn";
  copyBtn.textContent = "コピー";
  copyBtn.addEventListener("click", (event) => {
    event.stopPropagation();
    copyDebugLogToClipboard();
  });
  const toggleBtn = document.createElement("button");
  toggleBtn.type = "button";
  toggleBtn.className = "debug-log-btn";
  toggleBtn.textContent = "隠す";
  toggleBtn.addEventListener("click", () => {
    debugLogState.isCollapsed = !debugLogState.isCollapsed;
    panel.classList.toggle("is-collapsed", debugLogState.isCollapsed);
    toggleBtn.textContent = debugLogState.isCollapsed ? "表示" : "隠す";
  });
  const closeBtn = document.createElement("button");
  closeBtn.type = "button";
  closeBtn.className = "debug-log-btn debug-log-btn--close";
  closeBtn.textContent = "×";
  closeBtn.setAttribute("aria-label", "ログウィンドウを閉じる");
  closeBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    setDebugLogEnabled(false);
    if (debugLogEnabledEl) debugLogEnabledEl.checked = false;
  });
  debugLogState.toggleBtn = toggleBtn;
  actions.append(copyBtn, toggleBtn, closeBtn);
  header.appendChild(title);
  header.appendChild(actions);
  const tabs = document.createElement("div");
  tabs.className = "debug-log-tabs";
  LOG_CATEGORY_LIST.forEach((category) => {
    const tabBtn = document.createElement("button");
    tabBtn.type = "button";
    tabBtn.className = "debug-log-tab";
    tabBtn.textContent = category.label;
    tabBtn.dataset.category = category.key;
    if (category.key === debugLogState.activeCategory) {
      tabBtn.classList.add("active");
    }
    tabBtn.addEventListener("click", () => {
      debugLogState.activeCategory = category.key;
      tabs.querySelectorAll(".debug-log-tab").forEach((btn) => {
        btn.classList.toggle("active", btn === tabBtn);
      });
      renderDebugLogLines();
    });
    tabs.appendChild(tabBtn);
  });
  const body = document.createElement("div");
  body.className = "debug-log-body";
  body.setAttribute("role", "log");
  panel.appendChild(header);
  panel.appendChild(tabs);
  panel.appendChild(body);
  document.body.appendChild(panel);
  debugLogState.panelEl = panel;
  debugLogState.bodyEl = body;
  enableDebugPanelDragging(panel, header);
  renderDebugLogLines();
};
const setDebugPanelVisibility = (enabled) => {
  if (!debugLogState.panelEl) return;
  debugLogState.panelEl.hidden = !enabled;
  debugLogState.panelEl.style.display = enabled ? "flex" : "none";
  debugLogState.panelEl.setAttribute("aria-hidden", (!enabled).toString());
};
const appendDebugLine = (line) => {
  if (!debugLogState.bodyEl) return;
  const lineEl = document.createElement("div");
  lineEl.className = `debug-log-line level-${line.level}`;
  lineEl.textContent = line.text;
  debugLogState.bodyEl.appendChild(lineEl);
  debugLogState.bodyEl.scrollTop = debugLogState.bodyEl.scrollHeight;
};
const getFilteredDebugLines = () => {
  if (debugLogState.activeCategory === "all") return debugLogState.lines;
  return debugLogState.lines.filter((line) => line.category === debugLogState.activeCategory);
};
const renderDebugLogLines = () => {
  if (!debugLogState.bodyEl) return;
  debugLogState.bodyEl.innerHTML = "";
  getFilteredDebugLines().forEach((line) => appendDebugLine(line));
};
const addDebugEntry = (level, message, obj, category = null) => {
  const lines = [];
  const levelLabel = String(level || "LOG").toUpperCase();
  lines.push(`[${formatDebugTimestamp()}] ${levelLabel}: ${String(message ?? "")}`);
  const objLine = serializeDebugObject(obj);
  if (objLine) lines.push(objLine);
  lines.forEach((text) => {
    debugLogState.lines.push({ text, level: levelLabel.toLowerCase(), category });
    if (debugLogState.lines.length > debugLogState.maxLines) {
      debugLogState.lines.shift();
      renderDebugLogLines();
    }
    if (debugLogState.activeCategory === "all" || debugLogState.activeCategory === category) {
      appendDebugLine({ text, level: levelLabel.toLowerCase() });
    }
  });
};
const clearDebugLog = () => {
  debugLogState.lines = [];
  if (debugLogState.bodyEl) {
    debugLogState.bodyEl.innerHTML = "";
  }
};
const describeElement = (element) => {
  if (!element) return "null";
  const tag = element.tagName;
  const id = element.id ? `#${element.id}` : "";
  const className = element.classList?.length ? `.${Array.from(element.classList).join(".")}` : "";
  return `${tag}${id}${className}`;
};
const DLOG = {
  mark: (msg, obj, category) => addDebugEntry("MARK", msg, obj, category),
  log: (msg, obj, category) => addDebugEntry("LOG", msg, obj, category),
  warn: (msg, obj, category) => addDebugEntry("WARN", msg, obj, category),
  err: (msg, obj, category) => addDebugEntry("ERR", msg, obj, category),
  logTopElement: () => {
    const el = document.elementFromPoint(window.innerWidth / 2, window.innerHeight / 2);
    const desc = describeElement(el);
    addDebugEntry("LOG", `top element: ${desc}`);
    return desc;
  }
};
window.DLOG = DLOG;
const logWithCategory = (level, categoryKey, message, obj) => {
  const label = categoryKey ? LOG_CATEGORIES[categoryKey] : "";
  const prefix = label ? `[${label}] ` : "";
  const text = `${prefix}${message}`;
  const handler = DLOG[level] || DLOG.log;
  handler(text, obj, categoryKey);
};
const logUserInteraction = (label, target) => {
  logWithCategory("log", "user", `${label}: ${describeElement(target)}`);
};
const expandDebugPanel = () => {
  ensureDebugPanel();
  setDebugPanelVisibility(true);
  debugLogState.isCollapsed = false;
  if (debugLogState.panelEl) {
    debugLogState.panelEl.classList.remove("is-collapsed");
  }
  if (debugLogState.toggleBtn) {
    debugLogState.toggleBtn.textContent = "隠す";
  }
};
const instrumentFetchLogging = () => {
  if (!window.fetch || window.fetch.__logWrapped) return;
  const nativeFetch = window.fetch.bind(window);
  const wrappedFetch = (...args) => {
    const [input, init] = args;
    const method = init?.method || "GET";
    const url = typeof input === "string" ? input : input?.url || "";
    logWithCategory("log", "network", `request ${method} ${url}`);
    return nativeFetch(...args)
      .then((response) => {
        logWithCategory("log", "network", `response ${response.status} ${url}`);
        return response;
      })
      .catch((error) => {
        logWithCategory("err", "network", `failed ${url}`, error);
        throw error;
      });
  };
  wrappedFetch.__logWrapped = true;
  window.fetch = wrappedFetch;
};
const setDebugLogEnabled = (enabled) => {
  debugLogState.enabled = enabled;
  try {
    localStorage.setItem(DEBUG_LOG_KEY, enabled ? "1" : "0");
  } catch (error) {
    console.warn("デバッグログ設定の保存に失敗しました", error);
  }
  setDebugPanelVisibility(enabled);
};
const setDebugClickLogEnabled = (enabled) => {
  debugLogState.clickEnabled = enabled;
  try {
    localStorage.setItem(DEBUG_CLICK_LOG_KEY, enabled ? "1" : "0");
  } catch (error) {
    console.warn("クリックログ設定の保存に失敗しました", error);
  }
};
const syncDebugLogControls = () => {
  if (debugLogEnabledEl) debugLogEnabledEl.checked = debugLogState.enabled;
  if (debugClickLogEnabledEl) debugClickLogEnabledEl.checked = debugLogState.clickEnabled;
};
const copyDebugLogToClipboard = () => {
  const text = getFilteredDebugLines().map((line) => line.text).join("\n");
  if (!text) {
    DLOG.warn("ログが空です");
    return;
  }
  if (navigator.clipboard?.writeText) {
    navigator.clipboard.writeText(text)
      .then(() => DLOG.mark("ログをコピーしました"))
      .catch((error) => DLOG.err("ログのコピーに失敗しました", error));
    return;
  }
  const textArea = document.createElement("textarea");
  textArea.value = text;
  textArea.setAttribute("readonly", "true");
  textArea.style.position = "fixed";
  textArea.style.left = "-9999px";
  document.body.appendChild(textArea);
  textArea.select();
  try {
    document.execCommand("copy");
    DLOG.mark("ログをコピーしました");
  } catch (error) {
    DLOG.err("ログのコピーに失敗しました", error);
  } finally {
    document.body.removeChild(textArea);
  }
};
runAfterDomReady(() => {
  enableCtrlDockDragging(ctrlDock, ctrlDockHandle);
  setCtrlDockExpanded(ctrlDock, ctrlDockExpandBtn, ctrlDockCollapseBtn, false);
  ctrlDockExpandBtn?.addEventListener("click", () => {
    setCtrlDockExpanded(ctrlDock, ctrlDockExpandBtn, ctrlDockCollapseBtn, true);
  });
  ctrlDockCollapseBtn?.addEventListener("click", () => {
    setCtrlDockExpanded(ctrlDock, ctrlDockExpandBtn, ctrlDockCollapseBtn, false);
  });
  ensureDebugPanel();
  instrumentFetchLogging();
  setDebugLogEnabled(false);
  syncDebugLogControls();
  if (debugLogEnabledEl) {
    debugLogEnabledEl.addEventListener("change", () => {
      setDebugLogEnabled(!!debugLogEnabledEl.checked);
      if (debugLogEnabledEl.checked) {
        logWithCategory("mark", "display", "ログ表示を有効化");
      }
    });
  }
  if (debugClickLogEnabledEl) {
    debugClickLogEnabledEl.addEventListener("change", () => {
      setDebugClickLogEnabled(!!debugClickLogEnabledEl.checked);
      logWithCategory("mark", "user", debugClickLogEnabledEl.checked ? "クリックログを有効化" : "クリックログを無効化");
    });
  }
  debugLogClearBtn?.addEventListener("click", () => {
    clearDebugLog();
    logWithCategory("mark", "display", "ログをクリアしました");
  });
  debugLogCopyBtn?.addEventListener("click", () => {
    copyDebugLogToClipboard();
  });
  debugLogCheckOverlayBtn?.addEventListener("click", () => {
    DLOG.logTopElement();
  });
  logWindowButton?.addEventListener("click", () => {
    setDebugLogEnabled(true);
    if (debugLogEnabledEl) debugLogEnabledEl.checked = true;
    expandDebugPanel();
    logWithCategory("mark", "user", "ログウィンドウを表示");
  });
  document.addEventListener("pointerdown", (event) => {
    if (!debugLogState.clickEnabled) return;
    if (event.pointerType && event.pointerType !== "mouse") {
      const target = event.target instanceof Element ? event.target : null;
      lastTapLogAt = Date.now();
      logUserInteraction("tap", target);
    }
  }, true);
  document.addEventListener("click", (event) => {
    if (!debugLogState.clickEnabled) return;
    if (Date.now() - lastTapLogAt < TAP_LOG_DEDUP_MS) return;
    const target = event.target instanceof Element ? event.target : null;
    logUserInteraction("click", target);
  }, true);
});
document.addEventListener("DOMContentLoaded", () => {
  logWithCategory("mark", "browser", "DOMContentLoaded");
}, { once: true });
window.addEventListener("load", () => {
  logWithCategory("mark", "browser", "window load");
});
window.addEventListener("error", (event) => {
  logWithCategory("err", "browser", "window error", {
    message: event.message,
    filename: event.filename,
    lineno: event.lineno,
    colno: event.colno,
    error: event.error ? (event.error.stack || String(event.error)) : null
  });
});
window.addEventListener("unhandledrejection", (event) => {
  const reason = event.reason instanceof Error ? { message: event.reason.message, stack: event.reason.stack } : event.reason;
  logWithCategory("err", "browser", "unhandledrejection", { reason });
});
const loadLastKnown = () => {
  try {
    const stored = localStorage.getItem(LAST_KNOWN_KEY) ?? localStorage.getItem(LEGACY_LAST_KNOWN_KEY);
    return stored ? JSON.parse(stored) : null;
  } catch (error) {
    return null;
  }
};
const saveLastKnown = (data) => {
  if (!data) return;
  try {
    localStorage.setItem(LAST_KNOWN_KEY, JSON.stringify(data));
  } catch (error) {
    console.error("last_known の保存に失敗しました", error);
  }
};
const updateVersionBadge = (data) => {
  const versionLabel = data?.version_label || APP_VERSION.label;
  if (modeVersionLabelEl) modeVersionLabelEl.textContent = versionLabel;
  if (versionBadgeEl) {
    const textEl = versionBadgeEl.querySelector(".version-text");
    if (textEl) textEl.textContent = `${versionLabel} / 更新: ${formatUpdatedAt(data?.updated_at || APP_VERSION.updatedAt)}`;
  }
};
updateModeStatus("");
updateVersionBadge(null);
const loadLatestMeta = async () => {
  try {
    const response = await apiFetch("/latest");
    if (!response.ok) throw new Error("latest fetch failed");
    const data = await parseResponseData(response);
    updateVersionBadge(data);
    saveLastKnown(data);
    updateModeStatus("");
  } catch (error) {
    const fallback = loadLastKnown();
    if (fallback) {
      updateVersionBadge(fallback);
    }
    updateModeStatus("オフライン/取得失敗");
  }
};
loadLatestMeta();

const settingsTool = document.getElementById("settingsTool");
const toggleSettingsBtn = document.getElementById("toggleSettings");
const settingsTabs = settingsTool?.querySelectorAll(".tool-tab");
const settingsTabPanes = settingsTool?.querySelectorAll(".tab-pane");
const themeTool = document.getElementById("themeTool");
const toggleThemeBtn = document.getElementById("toggleTheme");
const themeIconGrid = document.getElementById("themeIconGrid");
const headerEl = document.querySelector("header");
const headerHandle = document.getElementById("headerHandle");
const headerHandleHit = document.getElementById("headerHandleHit");
const headerHandleLabel = headerHandle?.querySelector(".header-handle-label");
const summaryHeaderHandle = document.getElementById("summaryHeaderHandle");
const detailHeaderHandle = document.getElementById("detailHeaderHandle");
const summaryLayerEmptyBadge = document.getElementById("summaryLayerEmptyBadge");
const detailLayerEmptyBadge = document.getElementById("detailLayerEmptyBadge");
const SWIPE_RAIL_ID = "swipeRail";
let swipeRailUpdateRaf = null;
const getSwipeRail = () => document.getElementById(SWIPE_RAIL_ID);
const getHandleBarRect = (handleEl) => {
  const bar = handleEl?.querySelector(".handle-bar");
  return (bar || handleEl)?.getBoundingClientRect() || null;
};
const updateSwipeRailRange = () => {
  const rail = getSwipeRail();
  if (!rail) return;
  const headerTitle = headerEl?.querySelector(".header-title-stack h1");
  const titleRect = headerTitle?.getBoundingClientRect();
  const handles = [headerHandle, summaryHeaderHandle, detailHeaderHandle].filter(Boolean);
  const rects = handles.map(getHandleBarRect).filter(Boolean);
  if (!titleRect && rects.length === 0) return;
  const topSource = titleRect ? titleRect.top : Math.min(...rects.map(rect => rect.top));
  const top = Math.max(0, topSource);
  const bottom = 0;
  rail.style.top = `${top}px`;
  rail.style.bottom = `${bottom}px`;
  rail.classList.add("swipe-rail--linked");
};
const scheduleSwipeRailUpdate = () => {
  if (swipeRailUpdateRaf) return;
  swipeRailUpdateRaf = requestAnimationFrame(() => {
    swipeRailUpdateRaf = null;
    updateSwipeRailRange();
  });
};
let headerHandleHitUpdateRaf = null;
const updateHeaderHandleHitArea = () => {
  if (!headerHandle || !headerHandleHit) return;
  const rect = headerHandle.getBoundingClientRect();
  if (!rect.width || !rect.height) {
    headerHandleHit.style.display = "none";
    return;
  }
  if (rect.bottom <= 0 || rect.top >= window.innerHeight) {
    headerHandleHit.style.display = "none";
    return;
  }
  headerHandleHit.style.display = "block";
  headerHandleHit.style.left = `${rect.left}px`;
  headerHandleHit.style.top = `${rect.top}px`;
  headerHandleHit.style.width = `${rect.width}px`;
  headerHandleHit.style.height = `${rect.height}px`;
};
const scheduleHeaderHandleHitUpdate = () => {
  if (headerHandleHitUpdateRaf) return;
  headerHandleHitUpdateRaf = requestAnimationFrame(() => {
    headerHandleHitUpdateRaf = null;
    updateHeaderHandleHitArea();
  });
};
let summaryExpandedHeight = 0;
const getSummaryLayerContentHeight = () => {
  if (!summaryLayer) return 0;
  const inner = summaryLayer.querySelector(".summary-inner");
  const contentHost = summaryLayer.querySelector("#headerChildFilterHost");
  const handleEl = summaryHeaderHandle;
  const gapValue = inner
    ? (parseFloat(getComputedStyle(inner).rowGap || getComputedStyle(inner).gap || "0") || 0)
    : 0;
  const contentHeight = contentHost?.getBoundingClientRect().height || 0;
  const handleHeight = handleEl?.getBoundingClientRect().height || 0;
  const handleMargin = handleEl
    ? (parseFloat(getComputedStyle(handleEl).marginTop || "0") || 0)
      + (parseFloat(getComputedStyle(handleEl).marginBottom || "0") || 0)
    : 0;
  if (contentHeight && (handleHeight || handleMargin)) {
    return contentHeight + handleHeight + handleMargin + gapValue;
  }
  return contentHeight + handleHeight + handleMargin;
};
const updateSummaryExpandedHeight = () => {
  if (!summaryLayer) return;
  const currentHeight = summaryLayer.classList.contains("is-hidden")
    ? 0
    : getSummaryLayerContentHeight();
  document.documentElement.style.setProperty("--summary-layer-height", `${currentHeight}px`);
  if (summaryLayer.classList.contains("is-collapsed")) return;
  summaryExpandedHeight = currentHeight;
};
const updateSummaryLayerHeight = () => {
  if (!summaryLayer) return;
  const height = summaryLayer.classList.contains("is-hidden")
    ? 0
    : getSummaryLayerContentHeight();
  document.documentElement.style.setProperty("--summary-layer-height", `${height}px`);
};
const getStickyOffsetHeight = () => {
  const headerHeight = headerEl?.getBoundingClientRect().height || 0;
  const summaryHeight = summaryLayer
    ? (state.summaryCollapsed && summaryExpandedHeight
      ? summaryExpandedHeight
      : getSummaryLayerContentHeight())
    : 0;
  return headerHeight + summaryHeight + 12;
};

const arriveBufferEl = document.getElementById("arriveBuffer");
const leaveBufferEl  = document.getElementById("leaveBuffer");
const extBufferEl    = document.getElementById("extBuffer");
const azJudgeEl      = document.getElementById("azJudge");
const chargeEarlyExtensionEl = document.getElementById("chargeEarlyExtension");
const standardStartTimeEl = document.getElementById("standardStartTime");
const standardEndTimeEl = document.getElementById("standardEndTime");
const shortStartTimeEl = document.getElementById("shortStartTime");
const shortEndTimeEl = document.getElementById("shortEndTime");
const onegouAmStartTimeEl = document.getElementById("onegouAmStartTime");
const onegouAmEndTimeEl = document.getElementById("onegouAmEndTime");
const onegouPmStartTimeEl = document.getElementById("onegouPmStartTime");
const onegouPmEndTimeEl = document.getElementById("onegouPmEndTime");
const onegouFullStartTimeEl = document.getElementById("onegouFullStartTime");
const onegouFullEndTimeEl = document.getElementById("onegouFullEndTime");
const azukariAmStartTimeEl = document.getElementById("azukariAmStartTime");
const azukariAmEndTimeEl = document.getElementById("azukariAmEndTime");
const azukariPmStartTimeEl = document.getElementById("azukariPmStartTime");
const azukariPmEndTimeEl = document.getElementById("azukariPmEndTime");
const azukariFullStartTimeEl = document.getElementById("azukariFullStartTime");
const azukariFullEndTimeEl = document.getElementById("azukariFullEndTime");
const azukariFeeAmEl = document.getElementById("azukariFeeAm");
const azukariFeePmEl = document.getElementById("azukariFeePm");
const azukariFeeFullEl = document.getElementById("azukariFeeFull");
const extFeeStandardShortEl = document.getElementById("extFeeStandardShort");
const extFeeOnegouAzukariEl = document.getElementById("extFeeOnegouAzukari");
const extraSnackFeeEl = document.getElementById("extraSnackFee");
const extraLunchFeeEl = document.getElementById("extraLunchFee");
const vacationSummerStartEl = document.getElementById("vacationSummerStart");
const vacationSummerEndEl = document.getElementById("vacationSummerEnd");
const vacationWinterStartEl = document.getElementById("vacationWinterStart");
const vacationWinterEndEl = document.getElementById("vacationWinterEnd");
const vacationSpringStartEl = document.getElementById("vacationSpringStart");
const vacationSpringEndEl = document.getElementById("vacationSpringEnd");
const memoHandwriteBtn = document.getElementById("memoHandwriteBtn");
const memoTextBtn = document.getElementById("memoTextBtn");
const memoImageBtn = document.getElementById("memoImageBtn");
const memoPlacementBtn = document.getElementById("memoPlacementBtn");
const placementRadial = document.getElementById("placementRadial");
const placementIssueNode = document.getElementById("placementIssueNode");
const placementRequestNode = document.getElementById("placementRequestNode");
const placementIssueBtn = document.getElementById("placementIssueBtn");
const placementRequestBtn = document.getElementById("placementRequestBtn");
const placementIssueMenu = document.getElementById("placementIssueMenu");
const placementRequestMenu = document.getElementById("placementRequestMenu");
const memoQuickBtn = document.getElementById("memoQuickBtn");
const memoQuickWrap = document.getElementById("memoQuickWrap");
const editQuickBtn = document.getElementById("editQuickBtn");
const editQuickWrap = document.getElementById("editQuickWrap");
const memoLayerSummary = document.getElementById("memoLayerSummary");
const memoLayerDetail = document.getElementById("memoLayerDetail");
const saveSettingsBtn = document.getElementById("saveSettings");
const resetSettingsBtn = document.getElementById("resetSettings");
const toastStackEl = document.getElementById("toastStack");
let toastGroupKey = null;
let toastGroupEl = null;
let toastSequence = 0;

const formatChangeToast = (subject, nextValue) => `${subject}を${nextValue}に変更しました`;
const formatChildChangeToast = (name, subject, nextValue) => ({
  title: name,
  message: `${subject}を${nextValue}に変更`
});
const formatTimeAdjustToast = ({ day, weekday } = {}, whichLabel, nextTime, delta) => {
  const displayDay = Number(day) ? Number(day) : day || "";
  const deltaLabel = delta >= 0 ? `+${delta}` : `${delta}`;
  return `${displayDay}日（${weekday || ""}）の${whichLabel}時間を${nextTime}（${deltaLabel}分）に変更`;
};
const getToastDurationMs = () => {
  const duration = Number(state.toastDuration);
  return Number.isFinite(duration) ? Math.max(800, duration) : DEFAULT_SETTINGS.toastDuration;
};

const showToast = (payload, { groupKey, title } = {}) => {
  if (!toastStackEl) return;
  const resolvedPayload = typeof payload === "object" && payload !== null
    ? { title: payload.title ?? title, message: payload.message ?? payload.body ?? "" }
    : { title, message: String(payload ?? "") };
  const toastLogMessage = resolvedPayload.title
    ? `${resolvedPayload.title}: ${resolvedPayload.message}`
    : resolvedPayload.message;
  logWithCategory("log", "toast", toastLogMessage);
  const nextGroupKey = groupKey || `toast-${Date.now()}-${toastSequence++}`;
  const isSameGroup = groupKey && toastGroupKey === groupKey && toastGroupEl && toastStackEl.contains(toastGroupEl);
  const groupEl = isSameGroup ? toastGroupEl : (() => {
    const el = document.createElement("div");
    el.className = "toast-group";
    el.dataset.groupKey = nextGroupKey;
    toastStackEl.appendChild(el);
    toastGroupKey = groupKey || nextGroupKey;
    toastGroupEl = el;
    return el;
  })();
  const bubbleEl = document.createElement("div");
  bubbleEl.className = "toast-bubble";
  if (isSameGroup) bubbleEl.classList.add("is-chained");
  if (isSameGroup) {
    const linkEl = document.createElement("span");
    linkEl.className = "toast-link";
    linkEl.textContent = "└";
    bubbleEl.appendChild(linkEl);
  }
  const messageEl = document.createElement("div");
  messageEl.className = "toast-message";
  if (resolvedPayload.title) {
    const titleEl = document.createElement("span");
    titleEl.className = "toast-title";
    titleEl.textContent = resolvedPayload.title;
    messageEl.appendChild(titleEl);
  }
  const bodyEl = document.createElement("span");
  bodyEl.className = "toast-body";
  bodyEl.textContent = resolvedPayload.message;
  messageEl.appendChild(bodyEl);
  bubbleEl.appendChild(messageEl);
  groupEl.appendChild(bubbleEl);
  requestAnimationFrame(() => bubbleEl.classList.add("is-visible"));
  const durationMs = getToastDurationMs();
  window.setTimeout(() => {
    bubbleEl.classList.add("is-exiting");
    bubbleEl.classList.remove("is-visible");
    window.setTimeout(() => {
      bubbleEl.remove();
      if (!groupEl.querySelector(".toast-bubble")) {
        groupEl.remove();
        if (toastGroupEl === groupEl) {
          toastGroupEl = null;
          toastGroupKey = null;
        }
      }
    }, 220);
  }, durationMs);
  if (typeof saveState === "function") {
    saveState({ skipNodeSync: true });
  }
};

const hashString = (value = "") => {
  let hash = 2166136261;
  for (let i = 0; i < value.length; i += 1) {
    hash ^= value.charCodeAt(i);
    hash = Math.imul(hash, 16777619);
  }
  return hash >>> 0;
};

const buildLineQrSvg = (seedText = "") => {
  const cells = 21;
  const size = 126;
  const cell = size / cells;
  const seed = hashString(seedText);
  const rects = [];
  const isFinderCell = (x, y, originX, originY) => {
    const relX = x - originX;
    const relY = y - originY;
    if (relX < 0 || relY < 0 || relX > 6 || relY > 6) return false;
    const border = relX === 0 || relY === 0 || relX === 6 || relY === 6;
    const center = relX >= 2 && relX <= 4 && relY >= 2 && relY <= 4;
    return border || center;
  };
  for (let y = 0; y < cells; y += 1) {
    for (let x = 0; x < cells; x += 1) {
      const isFinder = isFinderCell(x, y, 0, 0)
        || isFinderCell(x, y, cells - 7, 0)
        || isFinderCell(x, y, 0, cells - 7);
      const mask = (seed + x * 31 + y * 17 + x * y * 3) % 7;
      const filled = isFinder || mask < 2;
      if (filled) {
        rects.push(`<rect x="${x * cell}" y="${y * cell}" width="${cell}" height="${cell}" />`);
      }
    }
  }
  return `<svg viewBox="0 0 ${size} ${size}" role="img" aria-label="保護者連携QRコード"><rect width="100%" height="100%" fill="#fff"/>${rects.join("")}</svg>`;
};

const ensureLineLinkDefaults = () => {
  return;
};

const lineLinkStatusCache = new Map();

const setLineLinkStatusCache = (key, item) => {
  if (!key || !item) return;
  lineLinkStatusCache.set(key, item);
};

const getLineLinkStatusCache = (key) => {
  if (!key) return null;
  return lineLinkStatusCache.get(key) || null;
};

const hasLineReply = (status) => {
  if (!status) return false;
  if (typeof status.reply_received === "boolean") return status.reply_received;
  if (status.replied_at || status.reply_at || status.last_reply_at) return true;
  const unreadCount = status.unread_count ?? 0;
  return unreadCount > 0;
};

const getLineLinkedDisplayState = (key, status) => {
  if (!key) return false;
  const linkedState = state.lineLinkedChildren || {};
  if (status && hasLineReply(status)) {
    if (!linkedState[key]) {
      linkedState[key] = true;
      state.lineLinkedChildren = linkedState;
      saveState();
    }
  }
  return !!linkedState[key];
};

const fetchLineLinkStatus = async (key) => {
  if (!key) return null;
  try {
    const res = await apiFetch(`/admin/children/${encodeURIComponent(key)}/notify-state`, {
      credentials: "include"
    });
    const data = await parseResponseData(res);
    if (!res.ok) return null;
    if (data?.child_id) {
      setLineLinkStatusCache(key, data);
      getLineLinkedDisplayState(key, data);
    }
    return data || null;
  } catch (error) {
    console.warn("notify status fetch failed", error);
    return null;
  }
};

const getActiveChildTarget = () => {
  if (!state.activeName) return null;
  return { school: state.activeSchool, clazz: state.activeClass, name: state.activeName };
};

const isLineLinkedChild = (target) => {
  if (!target) return false;
  return getLineLinkedDisplayState(childKey(target), getLineLinkStatusCache(childKey(target)));
};

const hashLineSeed = (seed) => {
  let hash = 0;
  Array.from(seed || "").forEach((ch) => {
    hash = (hash * 31 + ch.charCodeAt(0)) % 1000000;
  });
  return hash;
};

const buildLineLinkInfo = (target) => {
  const key = childKey(target);
  const seed = hashLineSeed(key);
  const normalized = key.replace(/[^a-zA-Z0-9]/g, "").slice(0, 6).toLowerCase() || "line";
  const id = `@${normalized}${String(seed).slice(0, 2).padStart(2, "0")}`;
  const otp = String(100000 + (seed % 900000));
  return { id, otp, key };
};

const openLineModal = () => {
  if (!lineLinkModal) return;
  lineLinkModal.classList.add("open");
  lineLinkModal.setAttribute("aria-hidden", "false");
};

const resetLineModal = () => {
  if (lineLinkModalQr) {
    lineLinkModalQr.innerHTML = `<div class="line-qr-placeholder">QRコード準備中</div>`;
  }
  if (lineLinkModalId) lineLinkModalId.textContent = "---";
  if (lineLinkModalOtp) lineLinkModalOtp.textContent = "------";
  if (lineLinkModalOtpExpires) lineLinkModalOtpExpires.textContent = "---";
  if (lineLinkModalPrint) lineLinkModalPrint.disabled = true;
};

const renderQrCode = async (linkUrl) => {
  if (!lineLinkModalQr) return;
  if (!linkUrl) {
    lineLinkModalQr.innerHTML = `<div class="line-qr-placeholder">QRコード準備中</div>`;
    return;
  }
  try {
    if (window.QRCode?.toDataURL) {
      const dataUrl = await window.QRCode.toDataURL(linkUrl, { width: 180, margin: 1 });
      lineLinkModalQr.innerHTML = `<img src="${dataUrl}" alt="保護者連携QR" />`;
    } else {
      lineLinkModalQr.innerHTML = `<div class="line-qr-placeholder">QRライブラリを読み込めませんでした</div>`;
      const linkEl = document.createElement("div");
      linkEl.className = "line-link-note";
      linkEl.textContent = linkUrl;
      lineLinkModalQr.appendChild(linkEl);
    }
  } catch (error) {
    console.warn("QR code render failed", error);
    lineLinkModalQr.innerHTML = `<div class="line-qr-placeholder">QR生成に失敗しました</div>`;
  }
};

const renderQrCodeInto = async (targetEl, linkUrl, altText = "LINE連携QR") => {
  if (!targetEl) return;
  if (!linkUrl) {
    targetEl.innerHTML = `<div class="line-qr-placeholder">QRコード準備中</div>`;
    return;
  }
  try {
    if (window.QRCode?.toDataURL) {
      const dataUrl = await window.QRCode.toDataURL(linkUrl, { width: 180, margin: 1 });
      targetEl.innerHTML = `<img src="${dataUrl}" alt="${altText}" />`;
    } else {
      targetEl.innerHTML = `<div class="line-qr-placeholder">QRライブラリを読み込めませんでした</div>`;
      const linkEl = document.createElement("div");
      linkEl.className = "line-link-note";
      linkEl.textContent = linkUrl;
      targetEl.appendChild(linkEl);
    }
  } catch (error) {
    console.warn("QR code render failed", error);
    targetEl.innerHTML = `<div class="line-qr-placeholder">QR生成に失敗しました</div>`;
  }
};

const readTeacherLineLink = () => {
  try {
    const raw = localStorage.getItem(TEACHER_LINE_LINK_KEY);
    if (!raw) return { linked: false, threadId: "", url: "", expiresAt: "" };
    const parsed = JSON.parse(raw);
    const linked = !!parsed?.linked && !!parsed?.linkedAt;
    return {
      linked,
      threadId: parsed?.threadId || "",
      url: parsed?.url || "",
      expiresAt: parsed?.expiresAt || "",
      issuedAt: parsed?.issuedAt || "",
      linkedAt: linked ? parsed?.linkedAt || "" : ""
    };
  } catch (error) {
    console.warn("先生LINE連携の読み込みに失敗しました", error);
    return { linked: false, threadId: "", url: "", expiresAt: "" };
  }
};

const writeTeacherLineLink = (data) => {
  localStorage.setItem(TEACHER_LINE_LINK_KEY, JSON.stringify(data));
};

const updateTeacherLineLinkBadge = () => {
  if (!teacherLineLinkBadge) return;
  const data = readTeacherLineLink();
  if (data.linked) {
    teacherLineLinkBadge.textContent = "連携済";
    teacherLineLinkBadge.className = "teacher-line-badge is-linked";
    return;
  }
  if (data.url) {
    teacherLineLinkBadge.textContent = "発行済";
    teacherLineLinkBadge.className = "teacher-line-badge is-issued";
    return;
  }
  teacherLineLinkBadge.textContent = "未連携";
  teacherLineLinkBadge.className = "teacher-line-badge is-unlinked";
};

const resetTeacherLineModal = () => {
  if (teacherLineLinkQrBox) {
    teacherLineLinkQrBox.innerHTML = `<div class="line-qr-placeholder">QRコード準備中</div>`;
  }
  if (teacherLineLinkUrl) teacherLineLinkUrl.textContent = "---";
  if (teacherLineLinkThreadId) teacherLineLinkThreadId.textContent = "------";
  if (teacherLineLinkExpires) teacherLineLinkExpires.textContent = "---";
};

const openTeacherLineModal = () => {
  if (!teacherLineLinkModal) return;
  resetTeacherLineModal();
  const data = readTeacherLineLink();
  if (data.url) {
    if (teacherLineLinkUrl) teacherLineLinkUrl.textContent = data.url;
    if (teacherLineLinkThreadId) teacherLineLinkThreadId.textContent = data.threadId || "------";
    if (teacherLineLinkExpires) teacherLineLinkExpires.textContent = data.expiresAt || "---";
    renderQrCodeInto(teacherLineLinkQrBox, data.url, "先生LINE連携QR");
  }
  teacherLineLinkModal.classList.add("open");
  teacherLineLinkModal.setAttribute("aria-hidden", "false");
};

const closeTeacherLineModal = () => {
  if (!teacherLineLinkModal) return;
  teacherLineLinkModal.classList.remove("open");
  teacherLineLinkModal.setAttribute("aria-hidden", "true");
};

const issueTeacherLineLink = async () => {
  if (teacherLineLinkIssue) teacherLineLinkIssue.disabled = true;
  if (teacherLineLinkPrint) teacherLineLinkPrint.disabled = true;
  try {
    const threadId = `teacher-${Date.now()}`;
    const url = buildLocalNotifyUrl(threadId);
    const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString();
    writeTeacherLineLink({
      linked: false,
      linkedAt: "",
      issuedAt: new Date().toISOString(),
      threadId,
      url,
      expiresAt
    });
    if (teacherLineLinkUrl) teacherLineLinkUrl.textContent = url;
    if (teacherLineLinkThreadId) teacherLineLinkThreadId.textContent = threadId;
    if (teacherLineLinkExpires) teacherLineLinkExpires.textContent = expiresAt;
    await renderQrCodeInto(teacherLineLinkQrBox, url, "先生LINE連携QR");
    updateTeacherLineLinkBadge();
    if (teacherLineLinkPrint) teacherLineLinkPrint.disabled = false;
  } catch (error) {
    console.error(error);
    showToast("先生LINE連携の発行に失敗しました。");
    resetTeacherLineModal();
  } finally {
    if (teacherLineLinkIssue) teacherLineLinkIssue.disabled = false;
  }
};

const closeLineModal = () => {
  if (!lineLinkModal) return;
  lineLinkModal.classList.remove("open");
  lineLinkModal.setAttribute("aria-hidden", "true");
};

function summarizeChildSummary(list, target, monthKey = null) {
  const seed = { extFeeCapped: 0, azFeeTotal: 0, total: 0 };
  if (!list?.length || !target) return seed;
  return list
    .filter(item => childKey(item) === childKey(target))
    .filter(item => !monthKey || item.month === monthKey)
    .reduce((acc, item)=>{
      acc.extFeeCapped += item.extFeeCapped || 0;
      acc.azFeeTotal += item.azFeeTotal || 0;
      acc.total += item.total || 0;
      return acc;
    }, seed);
}
function formatFee(value) {
  return `${Number(value || 0).toLocaleString()}円`;
}
function formatRangeLabel(range) {
  const start = keyToDate(range?.minKey);
  const end = keyToDate(range?.maxKey);
  if (start && end) {
    const sY = start.getFullYear();
    const sM = start.getMonth() + 1;
    const sD = start.getDate();
    const eY = end.getFullYear();
    const eM = end.getMonth() + 1;
    const eD = end.getDate();
    return `対象期間：${sY}/${sM}/${sD} ～ ${eY}/${eM}/${eD}`;
  }
  return "対象期間：—";
}

const openPrintPreviewModal = () => {
  if (!printPreviewModal) return;
  renderPrintPreview();
  printPreviewModal.classList.add("open");
  printPreviewModal.setAttribute("aria-hidden", "false");
};

const closePrintPreviewModal = () => {
  if (!printPreviewModal) return;
  printPreviewModal.classList.remove("open");
  printPreviewModal.setAttribute("aria-hidden", "true");
};

const renderPrintPreview = () => {
  const now = new Date();
  if (printPreviewIssuedAt) {
    printPreviewIssuedAt.textContent = `${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()}`;
  }

  const target = getActiveChildTarget();
  const details = lastResult?.details || [];
  const summary = lastResult?.summary || [];
  const baseSummary = lastBaseResult?.summary || summary;

  if (!target || !details.length) {
    if (printPreviewChildName) printPreviewChildName.textContent = "園児を選択してください。";
    if (printPreviewSchoolClass) printPreviewSchoolClass.textContent = "—";
    if (printPreviewMonth) printPreviewMonth.textContent = "—";
    if (printPreviewType) printPreviewType.textContent = "—";
    if (printPreviewRange) printPreviewRange.textContent = formatRangeLabel(lastResult?.range);
    if (printPreviewExtBefore) printPreviewExtBefore.textContent = "—";
    if (printPreviewExtAfter) printPreviewExtAfter.textContent = "—";
    if (printPreviewAzBefore) printPreviewAzBefore.textContent = "—";
    if (printPreviewAzAfter) printPreviewAzAfter.textContent = "—";
    if (printPreviewTotalBefore) printPreviewTotalBefore.textContent = "—";
    if (printPreviewTotalAfter) printPreviewTotalAfter.textContent = "—";
    if (printPreviewDetailRows) {
      printPreviewDetailRows.innerHTML = `<tr><td colspan="7">サマリーデータがありません。</td></tr>`;
    }
    if (printPreviewNotes) printPreviewNotes.textContent = "—";
    return;
  }

  const childDetails = details
    .filter(d => childKey(d) === childKey(target))
    .sort((a, b) => a.dateKey - b.dateKey);
  const latestDetail = childDetails[childDetails.length - 1];
  const displayYear = Number(state.summaryCalendarYear) || Number(latestDetail?.year) || now.getFullYear();
  const displayMonth = Number(state.summaryCalendarMonth) || Number(latestDetail?.month) || now.getMonth() + 1;
  const monthKey = `${displayYear}-${String(displayMonth).padStart(2, "0")}`;
  const monthDetails = childDetails.filter(d => Number(d.year) === displayYear && Number(d.month) === displayMonth);

  const baseType = getCsvTypeForTarget(target, latestDetail?.date || "");
  const currentType = getChildTypeKeyForTarget(target, latestDetail?.date || "");
  const beforeTypeLabel = baseType ? typeLabel(baseType) : "—";
  const afterTypeLabel = currentType ? typeLabel(currentType) : beforeTypeLabel;

  const beforeTotals = summarizeChildSummary(baseSummary, target, monthKey);
  const afterTotals = summarizeChildSummary(summary, target, monthKey);

  if (printPreviewChildName) printPreviewChildName.textContent = target.name;
  const targetClazz = normalizeClassGroupName(target.clazz);
  if (printPreviewSchoolClass) printPreviewSchoolClass.textContent = `${target.school} / ${targetClazz}`;
  if (printPreviewMonth) printPreviewMonth.textContent = `${displayYear}年${displayMonth}月`;
  if (printPreviewType) printPreviewType.textContent = `${beforeTypeLabel} / ${afterTypeLabel}`;
  if (printPreviewRange) {
    const range = deriveRangeFromDetails(monthDetails) || lastResult?.range;
    printPreviewRange.textContent = formatRangeLabel(range);
  }
  if (printPreviewExtBefore) printPreviewExtBefore.textContent = formatFee(beforeTotals.extFeeCapped);
  if (printPreviewExtAfter) printPreviewExtAfter.textContent = formatFee(afterTotals.extFeeCapped);
  if (printPreviewAzBefore) printPreviewAzBefore.textContent = formatFee(beforeTotals.azFeeTotal);
  if (printPreviewAzAfter) printPreviewAzAfter.textContent = formatFee(afterTotals.azFeeTotal);
  if (printPreviewTotalBefore) printPreviewTotalBefore.textContent = formatFee(beforeTotals.total);
  if (printPreviewTotalAfter) printPreviewTotalAfter.textContent = formatFee(afterTotals.total);

  if (printPreviewDetailRows) {
    if (!monthDetails.length) {
      printPreviewDetailRows.innerHTML = `<tr><td colspan="7">対象月の明細がありません。</td></tr>`;
    } else {
      printPreviewDetailRows.innerHTML = monthDetails.map(detail => {
        const statusLabel = detail.displayStatusKind === "vacation"
          ? "長期休暇"
          : (detail.attendLabel || "—");
        const extFeeLabel = formatFee(detail.extFee || 0);
        const azFeeLabel = formatFee(detail.azukariFee || 0);
        const totalLabel = formatFee(detail.totalFee || 0);
        return `
          <tr>
            <td>${esc(`${detail.month}/${detail.day}(${detail.weekday})`)}</td>
            <td>${esc(statusLabel)}</td>
            <td>${esc(detail.arrive || "—")}</td>
            <td>${esc(detail.leave || "—")}</td>
            <td>${esc(extFeeLabel)}</td>
            <td>${esc(azFeeLabel)}</td>
            <td>${esc(totalLabel)}</td>
          </tr>
        `;
      }).join("");
    }
  }

  if (printPreviewNotes) {
    const summaryEntry = summary.find(item => childKey(item) === childKey(target) && item.month === monthKey);
    const noteLines = summaryEntry?.noteEntries?.map(entry => entry.line) || [];
    if (noteLines.length) {
      printPreviewNotes.innerHTML = noteLines.map(line => esc(line)).join("<br>");
    } else {
      printPreviewNotes.textContent = "—";
    }
  }
};

const EXEMPT_REASON_PRESETS = ["電車遅延", "バス遅延", "混雑", "天気"];
let exemptModalState = { recordKey: null, field: null, selectedReason: "" };

const getExemptFlagKey = (field) => (field === "arrive" ? "extExemptArrive" : "extExemptLeave");
const getExemptReasonKey = (field) => (field === "arrive" ? "extExemptReasonArrive" : "extExemptReasonLeave");

const setExemptReasonSelection = (reason) => {
  exemptModalState.selectedReason = reason || "";
  if (!exemptReasonOptions) return;
  exemptReasonOptions.querySelectorAll(".exempt-reason-btn").forEach((btn) => {
    const isActive = btn.dataset.reason === reason;
    btn.classList.toggle("is-active", isActive);
  });
  if (reason && reason !== "その他" && exemptReasonOtherInput) {
    exemptReasonOtherInput.value = "";
  }
};

const openExemptReasonModal = ({ recordKey, field }) => {
  if (!exemptReasonModal || !recordKey || !field) return;
  exemptModalState = { recordKey, field, selectedReason: "" };
  const o = state.overridesByKey[recordKey] || {};
  const reasonKey = getExemptReasonKey(field);
  const savedReason = str(o[reasonKey] || "");
  if (savedReason) {
    if (EXEMPT_REASON_PRESETS.includes(savedReason)) {
      setExemptReasonSelection(savedReason);
    } else {
      setExemptReasonSelection("その他");
      if (exemptReasonOtherInput) exemptReasonOtherInput.value = savedReason;
    }
  } else {
    setExemptReasonSelection("");
    if (exemptReasonOtherInput) exemptReasonOtherInput.value = "";
  }
  exemptReasonModal.classList.add("open");
  exemptReasonModal.setAttribute("aria-hidden", "false");
};

const closeExemptReasonModal = () => {
  if (!exemptReasonModal) return;
  exemptReasonModal.classList.remove("open");
  exemptReasonModal.setAttribute("aria-hidden", "true");
};

const resolveExemptReason = () => {
  const selected = exemptModalState.selectedReason;
  if (selected === "その他") {
    return str(exemptReasonOtherInput?.value || "");
  }
  if (selected) return selected;
  const otherValue = str(exemptReasonOtherInput?.value || "");
  return otherValue ? otherValue : "";
};

const applyExtensionExemptReason = ({ recordKey, field, reason }) => {
  if (!recordKey || !field) return;
  const o = state.overridesByKey[recordKey] || {};
  const flagKey = getExemptFlagKey(field);
  const reasonKey = getExemptReasonKey(field);
  o[flagKey] = true;
  o[reasonKey] = reason;
  state.overridesByKey[recordKey] = o;
  saveState();
  rerun();
};

const clearExtensionExemptReason = ({ recordKey, field }) => {
  if (!recordKey || !field) return;
  const o = state.overridesByKey[recordKey] || {};
  const flagKey = getExemptFlagKey(field);
  const reasonKey = getExemptReasonKey(field);
  delete o[flagKey];
  delete o[reasonKey];
  state.overridesByKey[recordKey] = o;
  saveState();
  rerun();
};

const updateLineIntegrationPanel = (target) => {
  if (!lineLinkPanel) return;
  if (!lineLinkStatusEl || !sendLineButton || !lineSendStatusEl || !lineLinkButton || !lineChatButton) return;
  if (!target) {
    lineLinkStatusEl.textContent = "未選択";
    lineLinkStatusEl.className = "line-status-badge is-unlinked";
    lineSendStatusEl.textContent = "未選択";
    lineSendStatusEl.className = "line-status-badge is-unsent";
    sendLineButton.disabled = true;
    sendLineButton.setAttribute("aria-disabled", "true");
    lineChatButton.disabled = true;
    lineChatButton.setAttribute("aria-disabled", "true");
    lineLinkButton.disabled = true;
    return;
  }
  const key = childKey(target);
  if (selectedChildKeyInput) selectedChildKeyInput.value = key;
  const cachedStatus = getLineLinkStatusCache(key);
  const applyLinkedState = (linked, linkedCount = 0) => {
    lineLinkStatusEl.textContent = linked
      ? `連携済 (${linkedCount})`
      : "未連携";
    lineLinkStatusEl.className = `line-status-badge ${linked ? "is-linked" : "is-unlinked"}`;
    sendLineButton.disabled = false;
    sendLineButton.setAttribute("aria-disabled", "false");
  };
  if (cachedStatus) {
    const linked = getLineLinkedDisplayState(key, cachedStatus);
    applyLinkedState(linked, cachedStatus.linked_count || 0);
  } else {
    lineLinkStatusEl.textContent = "確認中";
    lineLinkStatusEl.className = "line-status-badge is-unlinked";
    sendLineButton.disabled = true;
    sendLineButton.setAttribute("aria-disabled", "true");
  }
  if (!cachedStatus) {
    lineSendStatusEl.textContent = "確認中";
    lineSendStatusEl.className = "line-status-badge is-unsent";
  } else {
    const unreadCount = cachedStatus.unread_count ?? 0;
    lineSendStatusEl.textContent = unreadCount > 0 ? `未読 ${unreadCount}` : "未読なし";
    lineSendStatusEl.className = `line-status-badge ${unreadCount > 0 ? "is-pending" : "is-replied"}`;
  }
  const threadId = cachedStatus?.thread_id;
  const chatEnabled = !!threadId;
  lineChatButton.disabled = !chatEnabled;
  lineChatButton.setAttribute("aria-disabled", chatEnabled ? "false" : "true");
  lineLinkButton.disabled = false;
  fetchLineLinkStatus(key).then((item) => {
    if (childTarget && childKey(childTarget) === key && item) {
      const linked = getLineLinkedDisplayState(key, item);
      applyLinkedState(linked, item.linked_count || 0);
    }
  });
};

const hideChildNotifyBubble = () => {
  if (!childNotifyBubble) return;
  childNotifyBubble.setAttribute("aria-hidden", "true");
  childNotifyPendingBubble?.setAttribute("aria-hidden", "true");
};

const setChildNotifyBadge = ({ linked, chatText, chatClass }) => {
  if (childNotifyLinkBadge) {
    childNotifyLinkBadge.textContent = linked ? "連携済" : "未連携";
    childNotifyLinkBadge.className = `child-notify-badge ${linked ? "is-linked" : "is-unlinked"}`;
  }
  if (childNotifyChatBadge) {
    childNotifyChatBadge.textContent = chatText;
    childNotifyChatBadge.className = `child-notify-badge ${chatClass}`;
  }
};

const updateChildNotifyBubbleStatus = (target) => {
  if (!target) return;
  const key = childKey(target);
  const cachedStatus = getLineLinkStatusCache(key);
  const linked = getLineLinkedDisplayState(key, cachedStatus);
  let chatText = "トーク未作成";
  let chatClass = "is-muted";
  if (cachedStatus?.thread_id) {
    const unreadCount = cachedStatus.unread_count ?? 0;
    if (unreadCount > 0) {
      chatText = `返信あり (${unreadCount})`;
      chatClass = "is-chat";
    } else {
      chatText = "返信なし";
      chatClass = "is-replied";
    }
  } else if (cachedStatus) {
    chatText = "トーク未作成";
    chatClass = "is-muted";
  } else {
    chatText = "確認中";
    chatClass = "is-muted";
  }
  setChildNotifyBadge({ linked, chatText, chatClass });
};

const getVisibleHandleRects = () => (
  Array.from(document.querySelectorAll(".header-handle"))
    .filter((el) => el.offsetParent !== null)
    .map((el) => el.getBoundingClientRect())
);

const adjustBubbleTopForHandles = (hostRect, bubbleEl, desiredTop, handleRects) => {
  let adjustedTop = Math.max(0, desiredTop);
  bubbleEl.style.top = `${adjustedTop}px`;
  if (!handleRects.length) {
    return { top: adjustedTop, rect: bubbleEl.getBoundingClientRect() };
  }
  let bubbleRect = bubbleEl.getBoundingClientRect();
  handleRects.forEach((handleRect) => {
    const overlaps = bubbleRect.bottom > handleRect.top - 4 && bubbleRect.top < handleRect.bottom + 4;
    if (overlaps) {
      const nextTop = handleRect.top - hostRect.top - bubbleRect.height - 8;
      adjustedTop = Math.max(0, Math.min(adjustedTop, nextTop));
      bubbleEl.style.top = `${adjustedTop}px`;
      bubbleRect = bubbleEl.getBoundingClientRect();
    }
  });
  return { top: adjustedTop, rect: bubbleRect };
};

const showChildNotifyBubble = (target, anchorBtn) => {
  if (!childNotifyBubble || !headerChildFilterHost || !target || !anchorBtn) return;
  updateChildNotifyBubbleStatus(target);
  const hostRect = headerChildFilterHost.getBoundingClientRect();
  const btnRect = anchorBtn.getBoundingClientRect();
  const rawLeft = btnRect.left - hostRect.left + btnRect.width / 2;
  const top = btnRect.bottom - hostRect.top + 10;
  childNotifyBubble.style.left = `${rawLeft}px`;
  childNotifyBubble.setAttribute("aria-hidden", "false");
  const handleRects = getVisibleHandleRects();
  const { top: adjustedTop, rect: bubbleRect } = adjustBubbleTopForHandles(hostRect, childNotifyBubble, top, handleRects);
  const bubbleWidth = bubbleRect.width || 0;
  const padding = 8;
  const hostWidth = hostRect.width || 0;
  const minLeft = bubbleWidth / 2 + padding;
  const maxLeft = hostWidth - bubbleWidth / 2 - padding;
  const clampedLeft = Math.min(Math.max(rawLeft, minLeft), Math.max(minLeft, maxLeft));
  childNotifyBubble.style.left = `${clampedLeft}px`;
  const arrowOffset = rawLeft - clampedLeft;
  const arrowLeft = bubbleWidth / 2 + arrowOffset;
  childNotifyBubble.style.setProperty("--bubble-arrow-left", `${arrowLeft}px`);
  if (childNotifyPendingBubble) {
    childNotifyPendingBubble.style.left = `${clampedLeft}px`;
    childNotifyPendingBubble.style.top = `${adjustedTop + bubbleRect.height + 8}px`;
    childNotifyPendingBubble.setAttribute("aria-hidden", "false");
    const pendingRect = childNotifyPendingBubble.getBoundingClientRect();
    const pendingWidth = pendingRect.width || bubbleWidth;
    const pendingArrowLeft = pendingWidth / 2 + arrowOffset;
    childNotifyPendingBubble.style.setProperty("--bubble-arrow-left", `${pendingArrowLeft}px`);
    const pendingOverlaps = handleRects.some((handleRect) => (
      pendingRect.bottom > handleRect.top - 4 && pendingRect.top < handleRect.bottom + 4
    ));
    if (pendingOverlaps) {
      childNotifyPendingBubble.setAttribute("aria-hidden", "true");
    }
  }
  fetchLineLinkStatus(childKey(target)).then((item) => {
    const isSameTarget = state.activeName === target.name
      && state.activeSchool === target.school
      && isSameClassGroup(state.activeClass, target.clazz);
    if (isSameTarget && item) {
      updateChildNotifyBubbleStatus(target);
    }
  });
};

/* =========================
   変数
========================= */
let originalRows = [];
let lastResult = null;
let lastBaseResult = null;
let lastDataSource = null;
let storageFallbackAttempted = false;
const bulkTargetMap = new Map();
let bulkSelectedClass = null;
let bulkSelectionConfirmed = false;
let childTarget = null;
let bulkReferenceDate = "";
let bulkSelectedSchool = null;
const bulkTypeSelections = new Map();
const bulkStartDateSelections = new Map();
let bulkDetailMap = new Map();
const historyDatasetState = { datasetKey: null, unitId: null };
let startupChoiceMode = "last";
let startupCalendarSelection = null;
let startupCalendarMonth = null;
let startupCalendarEntries = [];
const datasetCompareState = {
  groupKey: null,
  otherNodeId: null,
  mode: "node",
  nodeSelection: "local",
  childSelections: new Map(),
  recordSelections: new Map()
};
let lastChangedChildCareTexts = new Map();
let lastChangedChildAllCareText = "";
const usageGuideMessage = "";
let storageFallbackAttempted = false;
let memoHelpersReady = false;
const prefersReducedMotion = window.matchMedia?.("(prefers-reduced-motion: reduce)");
const triggerResultAnimation = (el) => {
  if (!el || prefersReducedMotion?.matches) return;
  el.classList.remove("is-animating");
  void el.offsetWidth;
  el.classList.add("is-animating");
};

/* =========================
   初期反映
========================= */
renderThemeIcons();
applyTheme(state.themeName, { shouldSave: false });
applyDaycardSize(state.daycardSize, { shouldSave: false });
applyToastColor(state.toastColor, { shouldSave: false });
applySettingsToInputs();
setDataSourceMeta();
if (!state.dataNodeSelectedId) {
  state.dataNodeSelectedId = getLocalDataNodeId();
}
syncLocalDataNode();
maybePromptDataNodeConflict();

const HEADER_STAGES = ["collapsed", "expanded"];
const HEADER_STAGE_COOLDOWN = 220;
let headerStageIndex = Math.max(0, HEADER_STAGES.indexOf(state.headerStage || "collapsed"));
let headerStageLocked = false;
const updateHeaderHeight = () => {
  if (!headerEl) return;
  const height = headerEl.getBoundingClientRect().height;
  document.documentElement.style.setProperty("--header-height", `${height}px`);
  updateSummaryLayerHeight();
  scheduleSwipeRailUpdate();
  scheduleHeaderHandleHitUpdate();
};
const scheduleHeaderHeightUpdate = () => {
  updateHeaderHeight();
  window.setTimeout(updateHeaderHeight, HEADER_STAGE_COOLDOWN + 80);
};

const bindHandleActivation = (handleEl, onActivate) => {
  if (!handleEl || !onActivate) return;
  handleEl.tabIndex = 0;
  handleEl.setAttribute("role", "button");
  let suppressClick = false;
  handleEl.addEventListener("pointerup", (e) => {
    if (e.button !== 0) return;
    suppressClick = true;
    onActivate();
  });
  handleEl.addEventListener("click", () => {
    if (suppressClick) {
      suppressClick = false;
      return;
    }
    onActivate();
  });
  handleEl.addEventListener("keydown",(e)=>{
    if (e.key === "Enter" || e.key === " "){
      e.preventDefault();
      onActivate();
    }
  });
};
const bindHandleHitActivation = (handleEl, onActivate) => {
  if (!handleEl || !onActivate) return;
  let suppressClick = false;
  handleEl.addEventListener("pointerup", (e) => {
    if (e.button !== 0) return;
    suppressClick = true;
    onActivate();
  });
  handleEl.addEventListener("click", () => {
    if (suppressClick) {
      suppressClick = false;
      return;
    }
    onActivate();
  });
};

const setHeaderStage = (stage) => {
  if (!headerEl) return;
  const next = HEADER_STAGES.includes(stage) ? stage : "collapsed";
  if (headerEl.dataset.stage === next) return;
  headerStageIndex = HEADER_STAGES.indexOf(next);
  headerEl.dataset.stage = next;
  if (headerHandleLabel) headerHandleLabel.textContent = next === "collapsed" ? "展開する" : "折りたたむ";
  state.headerStage = next;
  scheduleHeaderHeightUpdate();
  saveState();
};

const requestHeaderStage = (stage) => {
  if (headerStageLocked) return;
  setHeaderStage(stage);
  headerStageLocked = true;
  window.setTimeout(() => {
    headerStageLocked = false;
  }, HEADER_STAGE_COOLDOWN);
};

const toggleHeaderStage = () => {
  if (!headerEl) return;
  const next = headerEl.dataset.stage === "expanded" ? "collapsed" : "expanded";
  requestHeaderStage(next);
};

const initHeaderStageControls = () => {
  if (!headerEl) return;
  setHeaderStage(HEADER_STAGES[headerStageIndex] || "collapsed");
  bindHandleActivation(headerHandle, toggleHeaderStage);
  bindHandleHitActivation(headerHandleHit, toggleHeaderStage);
  scheduleHeaderHandleHitUpdate();
};
initHeaderStageControls();
const toggleSummaryCollapsed = () => {
  state.summaryCollapsed = !state.summaryCollapsed;
  if (state.summaryCollapsed && state.detailCollapsed) {
    state.detailCollapsed = false;
  }
  applyCollapseState();
  saveState();
};
const toggleDetailCollapsed = ({ skipNodeSync = false } = {}) => {
  state.detailCollapsed = !state.detailCollapsed;
  if (state.detailCollapsed && state.summaryCollapsed) {
    state.summaryCollapsed = false;
  }
  applyCollapseState();
  saveState({ skipNodeSync });
};
const initSummaryHandleControls = () => {
  if (!summaryHeaderHandle) return;
  bindHandleActivation(summaryHeaderHandle, toggleSummaryCollapsed);
};
initSummaryHandleControls();
const initDetailHandleControls = () => {
  if (!detailHeaderHandle) return;
  bindHandleActivation(detailHeaderHandle, () => toggleDetailCollapsed({ skipNodeSync: true }));
};
initDetailHandleControls();
if (headerEl && "ResizeObserver" in window){
  const headerObserver = new ResizeObserver(() => updateHeaderHeight());
  headerObserver.observe(headerEl);
  updateHeaderHeight();
} else {
  window.addEventListener("resize", updateHeaderHeight);
  updateHeaderHeight();
}
if (summaryLayer && "ResizeObserver" in window){
  const summaryObserver = new ResizeObserver(() => updateSummaryLayerHeight());
  summaryObserver.observe(summaryLayer);
  updateSummaryLayerHeight();
} else if (summaryLayer){
  window.addEventListener("resize", updateSummaryLayerHeight);
  updateSummaryLayerHeight();
}
window.addEventListener("scroll", scheduleSwipeRailUpdate, { passive: true });
window.addEventListener("resize", scheduleSwipeRailUpdate, { passive: true });
window.addEventListener("scroll", scheduleHeaderHandleHitUpdate, { passive: true });
window.addEventListener("resize", scheduleHeaderHandleHitUpdate, { passive: true });
if ("MutationObserver" in window){
  const swipeRailObserver = new MutationObserver(() => {
    if (getSwipeRail()){
      scheduleSwipeRailUpdate();
      swipeRailObserver.disconnect();
    }
  });
  swipeRailObserver.observe(document.body, { childList: true });
}

const triggerCsvSelection = ()=>{
  if (!fileInput) return;
  fileInput.value = "";
  fileInput.click();
};

function activateChildSummaryTab(){
  if (!summaryTabButtons?.length) return;
  if (state.summaryCollapsed){
    state.summaryCollapsed = false;
    applyCollapseState();
  }
  activateSummaryTab("child");
}

const applyTestRows = (rows, label) => {
  const typeCycle = ["standard", "short", "1gou"];
  const childTypeMap = new Map();
  const overrides = {};

  rows.forEach((row) => {
    const name = row["名前"];
    const school = row["園"];
    const clazz = row["所属"];
    const childKey = `${name}__${school}__${clazz}`;
    if (!childTypeMap.has(childKey)) {
      const typeKey = typeCycle[childTypeMap.size % typeCycle.length];
      childTypeMap.set(childKey, typeKey);
    }
    const typeKey = childTypeMap.get(childKey);
    const recKey = makeRecordKey({ rawDate: row["日付"], school, clazz, name });
    overrides[recKey] = { baseType: typeKey };
  });

  originalRows = rows;
  state.overridesByKey = overrides;
  const result = calculate(rows);
  lastBaseResult = calculate(rows, stripTypeOverrides(overrides));
  lastResult = result;
  saveState();
  renderDetails(result.details);
  setDataSourceMeta(label, new Date());
  expandPanelsForInitialView();
  selectDetailDisplayAfterLoad();
  activateChildSummaryTab();
  updateLayerEmptyBadges();
  maybePromptDatasetCompareForCurrentData();
};

const renderTestDataOptions = () => {
  if (!testDataList) return;
  testDataList.innerHTML = "";
  TEST_DATASETS.forEach((dataset, index) => {
    const label = document.createElement("label");
    label.className = "test-data-item";
    label.innerHTML = `
      <input type="radio" name="testDataOption" value="${dataset.id}" ${index === 0 ? "checked" : ""} />
      <div class="test-data-copy">
        <div class="test-data-title">${dataset.label}</div>
        <div class="test-data-meta">${dataset.description}</div>
        <div class="test-data-meta">CSV: ${dataset.fileLabel}</div>
        <a class="test-data-download" href="${dataset.file}" download>CSVを保存</a>
      </div>
    `;
    testDataList.appendChild(label);
  });
};

const loadTestDatasetCache = (datasetId) => {
  try {
    const raw = localStorage.getItem(TEST_DATA_CACHE_KEY);
    if (!raw) return null;
    const payload = JSON.parse(raw);
    if (!payload || typeof payload !== "object") return null;
    return payload[datasetId] || null;
  } catch (error) {
    console.warn("test dataset cache load failed", error);
    return null;
  }
};

const saveTestDatasetCache = (datasetId, entry) => {
  try {
    const raw = localStorage.getItem(TEST_DATA_CACHE_KEY);
    const payload = raw ? JSON.parse(raw) : {};
    const next = {
      ...(payload && typeof payload === "object" ? payload : {}),
      [datasetId]: entry
    };
    localStorage.setItem(TEST_DATA_CACHE_KEY, JSON.stringify(next));
  } catch (error) {
    console.warn("test dataset cache save failed", error);
  }
};

const getSelectedTestDataset = () => {
  if (!testDataList) return TEST_DATASETS[0];
  const selected = testDataList.querySelector("input[name='testDataOption']:checked");
  const selectedId = selected?.value;
  return TEST_DATASETS.find((dataset) => dataset.id === selectedId) || TEST_DATASETS[0];
};

const loadTestDataset = async (dataset) => {
  try {
    storageFallbackAttempted = false;
    const cached = loadTestDatasetCache(dataset.id);
    if (cached?.text) {
      const testRows = parseCSV(cached.text);
      applyTestRows(testRows, `テストデータ: ${dataset.label}`);
      closeTestDataModal();
      return;
    }
    const response = await fetch(dataset.file, { cache: "no-store" });
    if (!response.ok) throw new Error(`Failed to fetch ${dataset.file}`);
    const text = await response.text();
    saveTestDatasetCache(dataset.id, {
      text,
      fileLabel: dataset.fileLabel,
      cachedAt: Date.now()
    });
    const testRows = parseCSV(text);
    applyTestRows(testRows, `テストデータ: ${dataset.label}`);
    closeTestDataModal();
  } catch (error) {
    console.error(error);
    showToast("テストデータの読み込みに失敗しました。");
  }
};

const handleCsvImportAction = () => {
  settingsTool?.classList.remove("open");
  dataLoadTool?.classList.remove("open");
  closeDataReloadModal();
  triggerCsvSelection();
  showToast("CSVから読み込みを開きました");
};

const loadCsvAndCalculate = async (file)=>{
  if (!file) return alert("CSVファイルを選択してください。");
  try {
    storageFallbackAttempted = false;
    const text = await readFileWithFallbackEncoding(file);
    const rows = parseCSV(text);
    originalRows = rows;
    const result = calculate(rows);
    lastBaseResult = calculate(rows, stripTypeOverrides(state.overridesByKey));
    lastResult = result;
    renderDetails(result.details);
    const sourceLabel = file?.name ? `CSV: ${file.name}` : "CSV読込";
    setDataSourceMeta(sourceLabel, new Date());
    expandPanelsForInitialView();
    selectDetailDisplayAfterLoad();
    activateChildSummaryTab();
    saveState();
    updateLayerEmptyBadges();
    maybePromptDatasetCompareForCurrentData();
  } catch (e) {
    console.error(e);
    alert("CSVの読み込みまたは計算中にエラーが発生しました。Consoleを確認してください。");
  } finally {
    if (fileInput) fileInput.value = "";
  }
};

fileInput?.addEventListener("change", ()=>{
  const file = fileInput.files && fileInput.files[0];
  if (!file) return;
  loadCsvAndCalculate(file);
});

dataLoadCsvBtn?.addEventListener("click", () => {
  handleCsvImportAction();
});
dataLoadHistoryBtn?.addEventListener("click", () => {
  settingsTool?.classList.remove("open");
  dataLoadTool?.classList.remove("open");
  closeDataReloadModal();
  loadHistoryData();
});
dataHistoryDetailBtn?.addEventListener("click", () => {
  settingsTool?.classList.remove("open");
  dataLoadTool?.classList.remove("open");
  openHistoryDetailModal();
});
dataLoadTestBtn?.addEventListener("click", () => {
  settingsTool?.classList.remove("open");
  dataLoadTool?.classList.remove("open");
  closeDataReloadModal();
  openTestDataModal();
});
testDataLoadConfirm?.addEventListener("click", () => {
  const dataset = getSelectedTestDataset();
  loadTestDataset(dataset);
});
startupOpenLastBtn?.addEventListener("click", () => {
  setStartupChoiceMode("last");
});
startupOpenHistoryBtn?.addEventListener("click", () => {
  setStartupChoiceMode("history");
});
startupOpenCsvBtn?.addEventListener("click", () => {
  closeStartupChoiceModal();
  handleCsvImportAction();
});
startupOpenTestBtn?.addEventListener("click", () => {
  closeStartupChoiceModal();
  openTestDataModal();
});
startupChoiceModal?.addEventListener("click", (event) => {
  const target = event.target instanceof Element ? event.target.closest("[data-startup-calendar-nav]") : null;
  if (target) {
    const direction = target.getAttribute("data-startup-calendar-nav");
    if (direction === "prev") {
      shiftStartupCalendarMonth(-1);
    } else if (direction === "next") {
      shiftStartupCalendarMonth(1);
    }
    return;
  }
  const dayTarget = event.target instanceof Element ? event.target.closest("[data-startup-calendar-day]") : null;
  if (!dayTarget) return;
  const dateKey = dayTarget.getAttribute("data-startup-calendar-day");
  if (!dateKey) return;
  const entry = startupCalendarEntries.find(item => item.key === dateKey);
  if (!entry) return;
  startupCalendarSelection = entry.key;
  renderStartupCalendar();
});
startupCalendarStartBtn?.addEventListener("click", () => {
  if (startupChoiceMode === "last") {
    closeStartupChoiceModal();
    const restored = restoreHistoryDataOnLoad();
    if (!restored) {
      showToast("前回のデータがありません。");
    }
    return;
  }
  const entry = startupCalendarEntries.find(item => item.key === startupCalendarSelection);
  if (!entry?.node) {
    showToast("履歴データがありません。");
    return;
  }
  closeStartupChoiceModal();
  applyHistoryNode(entry.node, { restoreDisplayMode: false });
  expandPanelsForInitialView();
  selectDetailDisplayAfterLoad();
});
dataRefreshButton?.addEventListener("click", () => {
  settingsTool?.classList.remove("open");
  dataLoadTool?.classList.remove("open");
  closeDataReloadModal();
  refreshDataWithNodeExport({ source: "手動リフレッシュ" });
  showToast({ title: "リフレッシュ", message: "現在のデータを履歴ノードに保存して初期化しました。" });
});

const activateSettingsTab = (key) => {
  if (!settingsTabs || !settingsTabPanes) return;
  settingsTabs.forEach((btn) => {
    const isActive = btn.dataset.tab === key;
    btn.classList.toggle("active", isActive);
    btn.setAttribute("aria-selected", isActive ? "true" : "false");
    btn.tabIndex = isActive ? 0 : -1;
  });
  settingsTabPanes.forEach((pane) => {
    const isActive = pane.dataset.tabPane === key;
    pane.classList.toggle("active", isActive);
    pane.hidden = !isActive;
  });
};
const initSettingsTabs = () => {
  if (!settingsTabs || settingsTabs.length === 0) return;
  const defaultKey = settingsTabs[0].dataset.tab || "input";
  activateSettingsTab(defaultKey);
  settingsTabs.forEach((btn, idx) => {
    btn.addEventListener("click", () => {
      activateSettingsTab(btn.dataset.tab || defaultKey);
    });
    btn.addEventListener("keydown", (e) => {
      if (e.key !== "ArrowRight" && e.key !== "ArrowLeft") return;
      e.preventDefault();
      const delta = e.key === "ArrowRight" ? 1 : -1;
      const nextIdx = (settingsTabs.length + idx + delta) % settingsTabs.length;
      const nextBtn = settingsTabs[nextIdx];
      nextBtn?.focus();
      activateSettingsTab(nextBtn?.dataset.tab || defaultKey);
    });
  });
};
initSettingsTabs();

toggleSettingsBtn?.addEventListener("click", (e) => {
  e.stopPropagation();
  logWithCategory("log", "user", "設定ボタンをタップ");
  closeUserMenu();
  logWithCategory("log", "user", "設定ボタンをタップしました");
  themeTool?.classList.remove("open");
  dataLoadTool?.classList.remove("open");
  settingsTool?.classList.toggle("open");
});
toggleThemeBtn?.addEventListener("click", (e) => {
  e.stopPropagation();
  closeUserMenu();
  settingsTool?.classList.remove("open");
  dataLoadTool?.classList.remove("open");
  themeTool?.classList.toggle("open");
});
const handleDataReloadOpen = (event, logLabel) => {
  if (dataReloadModal?.classList.contains("open")) return;
  event?.stopPropagation?.();
  logWithCategory("log", "user", logLabel);
  closeUserMenu();
  settingsTool?.classList.remove("open");
  themeTool?.classList.remove("open");
  dataLoadTool?.classList.remove("open");
  openDataReloadModal();
};
dataReloadButton?.addEventListener("pointerdown", (event) => {
  handleDataReloadOpen(event, "データ読込みボタンをタップ");
});
dataReloadButton?.addEventListener("click", (event) => {
  handleDataReloadOpen(event, "データ読込みボタンをタップ");
});
ctrlDataReloadButton?.addEventListener("pointerdown", (event) => {
  handleDataReloadOpen(event, "機能コントローラーのデータ読込みボタンをタップ");
});
ctrlDataReloadButton?.addEventListener("click", (event) => {
  handleDataReloadOpen(event, "機能コントローラーのデータ読込みボタンをタップ");
});
toggleDataLoadBtn?.addEventListener("click", (e) => {
  e.stopPropagation();
  logWithCategory("log", "user", "データ読込みボタンをタップ");
  closeUserMenu();
  logWithCategory("log", "user", "データ読込みボタンをタップしました");
  settingsTool?.classList.remove("open");
  themeTool?.classList.remove("open");
  dataLoadTool?.classList.toggle("open");
});
document.addEventListener("click", (e) => {
  const target = e.target;
  if (settingsTool && !settingsTool.contains(target)) settingsTool.classList.remove("open");
  if (themeTool && !themeTool.contains(target)) themeTool.classList.remove("open");
  if (dataLoadTool && !dataLoadTool.contains(target)) dataLoadTool.classList.remove("open");
});
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    settingsTool?.classList.remove("open");
    themeTool?.classList.remove("open");
    dataLoadTool?.classList.remove("open");
    closeLineModal();
    closePrintPreviewModal();
    closeExemptReasonModal();
    closeDataReloadModal();
    closeTestDataModal();
    closeStartupChoiceModal();
    closeDataNodeModal();
    closeMultiWindowModal();
    closeDatasetCompareModal();
    closeHistoryDetailModal();
    closeCopyFallbackModal();
  }
});

daycardSizeToggle?.querySelectorAll(".size-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const next = btn.dataset.size || "medium";
    applyDaycardSize(next);
  });
});
toastColorEl?.addEventListener("change", ()=>{
  applyToastColor(toastColorEl.value || DEFAULT_SETTINGS.toastColor);
});
chargeEarlyExtensionEl?.addEventListener("change", ()=>{
  state.chargeEarlyExtension = !!chargeEarlyExtensionEl.checked;
  saveState();
  if (lastResult) rerun();
});
quickSaveButton?.addEventListener("click", ()=>{
  saveState();
  showToast({ title: "保存", message: "データを保存しました。" });
});
ctrlPrintButton?.addEventListener("click", () => {
  openPrintPreviewModal();
});

loginBtn?.addEventListener("click", ()=>{
  enchoSession?.clearActiveUser?.();
  window.location.href = "login.html";
});
const openLineLinkModal = () => {
  const target = getActiveChildTarget();
  if (!target) {
    showToast("園児を選択してください。");
    return;
  }
  const key = childKey(target);
  if (selectedChildKeyInput) selectedChildKeyInput.value = key;
  if (lineLinkModalChild) lineLinkModalChild.textContent = `${formatChildLabel(target)} の連携情報`;
  resetLineModal();
  openLineModal();
  fetchLineLinkStatus(key).then((item) => {
    if (lineLinkModalId) lineLinkModalId.textContent = item?.thread_id || "---";
  });
};
lineLinkButton?.addEventListener("click", () => {
  openLineLinkModal();
});
teacherLineLinkHeaderButton?.addEventListener("click", () => {
  openTeacherLineModal();
});
childNotifyLinkButton?.addEventListener("click", (event) => {
  event.stopPropagation();
  openLineLinkModal();
});
childNotifySendButton?.addEventListener("click", (event) => {
  event.stopPropagation();
  const target = getActiveChildTarget();
  if (!target) {
    showToast("園児を選択してください。");
    return;
  }
  openNotifyThread({ target, forceUpsert: true });
});
headerChildFilterHost?.addEventListener("scroll", hideChildNotifyBubble);
window.addEventListener("resize", hideChildNotifyBubble);
document.addEventListener("click", (event) => {
  const target = event.target instanceof Element ? event.target : null;
  if (!target || !childNotifyBubble) return;
  if (childNotifyBubble.getAttribute("aria-hidden") === "true") return;
  if (childNotifyBubble.contains(target)) return;
  if (childNotifyPendingBubble?.contains(target)) return;
  if (target.closest("#filterContainerChild .filter-chip")) return;
  hideChildNotifyBubble();
});
lineLinkModalClose?.addEventListener("click", closeLineModal);
teacherLineLinkModalClose?.addEventListener("click", closeTeacherLineModal);
printPreviewClose?.addEventListener("click", closePrintPreviewModal);
printPreviewConfirm?.addEventListener("click", () => {
  const shouldSave = window.confirm("印刷内容を確定ノードとして共有保存しますか？");
  if (shouldSave) {
    const saved = saveConfirmedDataNode({ source: "印刷" });
    if (saved) {
      showToast({ title: "出力確定", message: "出力内容を確定ノードとして共有保存しました。" });
    }
  }
  window.print();
});
printPreviewModal?.addEventListener("click", (event) => {
  if (event.target === printPreviewModal) closePrintPreviewModal();
});
lineLinkModalPrint?.addEventListener("click", () => {
  window.print();
});
teacherLineLinkPrint?.addEventListener("click", () => {
  window.print();
});
lineLinkModalIssue?.addEventListener("click", async () => {
  const childKeyValue = selectedChildKeyInput?.value?.trim();
  if (!childKeyValue) {
    showToast("園児を選択してください。");
    return;
  }
  if (lineLinkModalIssue) lineLinkModalIssue.disabled = true;
  if (lineLinkModalPrint) lineLinkModalPrint.disabled = true;
  try {
    const threadRes = await apiFetch("/admin/notify/thread/upsert", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ child_id: childKeyValue })
    });
    let threadData = await parseResponseData(threadRes);
    if (!threadData || typeof threadData !== "object") {
      threadData = {};
    }
    if (!threadRes.ok) {
      throw new Error(extractErrorMessage(threadData, "スレッド作成に失敗しました。"));
    }
    if (!threadData?.thread_id) {
      const fallback = ensureLocalNotifyThread(childKeyValue);
      threadData.thread_id = fallback?.thread_id;
    }
    if (!threadData?.thread_id) {
      throw new Error("スレッド情報を取得できませんでした。");
    }
    const res = await apiFetch("/admin/notify/qr", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ child_id: childKeyValue, thread_id: threadData.thread_id })
    });
    let data = await parseResponseData(res);
    if (!data || typeof data !== "object") {
      data = {};
    }
    if (!res.ok) {
      throw new Error(extractErrorMessage(data, "発行に失敗しました。"));
    }
    if (!data?.url) {
      data.url = buildLocalNotifyUrl(threadData.thread_id);
      data.expires_at = data.expires_at || new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString();
      data.qr_svg = data.qr_svg || null;
    }
    if (!data?.url) {
      throw new Error("発行に失敗しました。");
    }
    if (lineLinkModalId) lineLinkModalId.textContent = data.url || "---";
    if (lineLinkModalOtp) lineLinkModalOtp.textContent = threadData.thread_id || "------";
    if (lineLinkModalOtpExpires) lineLinkModalOtpExpires.textContent = data.expires_at || "---";
    if (lineLinkModalQr) {
      if (data.qr_svg) {
        lineLinkModalQr.innerHTML = data.qr_svg;
      } else {
        await renderQrCode(data.url);
      }
    } else {
      await renderQrCode(data.url);
    }
    if (lineLinkModalPrint) lineLinkModalPrint.disabled = false;
  } catch (error) {
    console.error(error);
    showToast(error.message || "発行に失敗しました。");
    resetLineModal();
  } finally {
    if (lineLinkModalIssue) lineLinkModalIssue.disabled = false;
  }
});
lineLinkModal?.addEventListener("click", (e) => {
  if (e.target === lineLinkModal) closeLineModal();
});
teacherLineLinkModal?.addEventListener("click", (e) => {
  if (e.target === teacherLineLinkModal) closeTeacherLineModal();
});
teacherLineLinkIssue?.addEventListener("click", () => {
  issueTeacherLineLink();
});
dataReloadModalClose?.addEventListener("click", closeDataReloadModal);
dataReloadModal?.addEventListener("click", (e) => {
  if (e.target === dataReloadModal) closeDataReloadModal();
});
testDataModalClose?.addEventListener("click", closeTestDataModal);
testDataModal?.addEventListener("click", (e) => {
  if (e.target === testDataModal) closeTestDataModal();
});
dataNodeModalClose?.addEventListener("click", closeDataNodeModal);
dataNodeModal?.addEventListener("click", (e) => {
  if (e.target === dataNodeModal) closeDataNodeModal();
});
multiWindowModalSave?.addEventListener("click", () => {
  if (!selectedWindowId) return;
  broadcastWindowSelection(selectedWindowId);
  if (selectedWindowId === windowSession.id) {
    windowSession.lastWarningAt = Date.now();
    closeMultiWindowModal();
    return;
  }
  saveNodeBeforeWindowClose("複数ウィンドウ選択");
  window.setTimeout(() => {
    window.close();
  }, 100);
});
multiWindowModalList?.addEventListener("change", (e) => {
  const target = e.target instanceof HTMLInputElement ? e.target : null;
  if (!target || target.name !== "multiWindowSelection") return;
  updateMultiWindowSelectionState(target.value || null);
});
datasetCompareClose?.addEventListener("click", closeDatasetCompareModal);
datasetCompareModal?.addEventListener("click", (e) => {
  if (e.target === datasetCompareModal) closeDatasetCompareModal();
});
copyFallbackClose?.addEventListener("click", closeCopyFallbackModal);
copyFallbackModal?.addEventListener("click", (e) => {
  if (e.target === copyFallbackModal) closeCopyFallbackModal();
});
dataNodeList?.addEventListener("click", (e) => {
  const target = e.target instanceof HTMLElement ? e.target : null;
  if (!target) return;
  const selectButton = target.closest("[data-node-select]");
  if (selectButton) {
    const nodeId = selectButton.getAttribute("data-node-select");
    const nodes = loadDataNodes();
    const node = nodes.find(item => item.id === nodeId);
    if (node?.payload) {
      applyHistoryNode(node);
      expandPanelsForInitialView();
      syncLocalDataNode();
      closeDataNodeModal();
    }
    return;
  }
  const deleteButton = target.closest("[data-node-delete]");
  if (deleteButton) {
    const nodeId = deleteButton.getAttribute("data-node-delete");
    const localId = getLocalDataNodeId();
    if (!nodeId || nodeId === localId) return;
    const nodes = loadDataNodes().filter(node => node.id !== nodeId);
    saveDataNodes(nodes);
    openDataNodeModal();
  }
});
datasetCompareBody?.addEventListener("click", (e) => {
  const target = e.target instanceof HTMLElement ? e.target : null;
  if (!target) return;
  const otherButton = target.closest("[data-compare-other]");
  if (otherButton) {
    datasetCompareState.otherNodeId = otherButton.getAttribute("data-compare-other");
    const group = getHistoryDatasetGroups().find(item => item.key === datasetCompareState.groupKey);
    const localId = getLocalDataNodeId();
    const localNode = group?.nodes.find(node => node.id === localId);
    const otherNode = group?.nodes.find(node => node.id === datasetCompareState.otherNodeId);
    if (group && localNode && otherNode) {
      datasetCompareState.mode = "node";
      renderDatasetCompareModal({ group, localNode, otherNode });
    }
    return;
  }
  const modeButton = target.closest("[data-compare-mode]");
  if (modeButton) {
    datasetCompareState.mode = modeButton.getAttribute("data-compare-mode") || "node";
    datasetCompareBody.querySelectorAll("[data-compare-mode]").forEach(btn => {
      btn.classList.toggle("active", btn === modeButton);
    });
    datasetCompareBody.querySelectorAll("[data-compare-panel]").forEach(panel => {
      const key = panel.getAttribute("data-compare-panel");
      panel.toggleAttribute("hidden", key !== datasetCompareState.mode);
    });
    return;
  }
  const nodeButton = target.closest("[data-compare-node]");
  if (nodeButton) {
    datasetCompareState.nodeSelection = nodeButton.getAttribute("data-compare-node");
    datasetCompareBody.querySelectorAll("[data-compare-node]").forEach(btn => {
      btn.classList.toggle("active", btn === nodeButton);
    });
    return;
  }
  const childButton = target.closest("[data-compare-child]");
  if (childButton) {
    const childKeyValue = childButton.getAttribute("data-compare-child");
    const selection = childButton.getAttribute("data-compare-select") || "local";
    if (childKeyValue) {
      datasetCompareState.childSelections.set(childKeyValue, selection);
      const row = childButton.closest("[data-compare-child-row]");
      row?.querySelectorAll("[data-compare-child]").forEach(btn => {
        btn.classList.toggle("active", btn === childButton);
      });
    }
    return;
  }
  const recordButton = target.closest("[data-compare-record]");
  if (recordButton) {
    const recordKey = recordButton.getAttribute("data-compare-record");
    const selection = recordButton.getAttribute("data-compare-select") || "local";
    if (recordKey) {
      datasetCompareState.recordSelections.set(recordKey, selection);
      recordButton.parentElement?.querySelectorAll("[data-compare-record]").forEach(btn => {
        btn.classList.toggle("active", btn === recordButton);
      });
    }
  }
});
datasetCompareApply?.addEventListener("click", applyDatasetCompareSelection);
historyDetailClose?.addEventListener("click", closeHistoryDetailModal);
historyDetailModal?.addEventListener("click", (e) => {
  if (e.target === historyDetailModal) closeHistoryDetailModal();
});
historyDatasetList?.addEventListener("click", (e) => {
  const target = e.target instanceof HTMLElement ? e.target : null;
  if (!target) return;
  const compareButton = target.closest("[data-history-dataset-compare]");
  if (compareButton) {
    const datasetKey = compareButton.getAttribute("data-history-dataset-compare");
    if (datasetKey) {
      selectHistoryDataset(datasetKey);
      openDatasetCompareModal(datasetKey);
    }
    return;
  }
  const detailButton = target.closest("[data-history-dataset-detail]");
  if (detailButton) {
    const datasetKey = detailButton.getAttribute("data-history-dataset-detail");
    if (datasetKey) {
      selectHistoryDataset(datasetKey);
    }
    return;
  }
  const deleteButton = target.closest("[data-history-dataset-delete]");
  if (deleteButton) {
    const datasetKey = deleteButton.getAttribute("data-history-dataset-delete");
    if (datasetKey) {
      deleteHistoryDataset(datasetKey);
    }
    return;
  }
  const row = target.closest("[data-history-dataset-row]");
  if (row) {
    const datasetKey = row.getAttribute("data-history-dataset-row");
    if (datasetKey) {
      selectHistoryDataset(datasetKey);
    }
  }
});
historyDatasetDetailList?.addEventListener("click", (e) => {
  const target = e.target instanceof HTMLElement ? e.target : null;
  if (!target) return;
  const changeButton = target.closest("[data-history-type-change]");
  if (changeButton) {
    const nodeId = changeButton.getAttribute("data-history-type-change");
    if (nodeId && nodeId === state.dataNodeSelectedId) {
      openTypeBulkModal({ shouldCloseHistoryDetail: true });
    } else {
      showToast("表示中のノードのみ区分変更できます。");
    }
    return;
  }
  const unitButton = target.closest("[data-history-unit]");
  if (unitButton) {
    const unitId = unitButton.getAttribute("data-history-unit");
    if (unitId) {
      selectHistoryDatasetUnit(unitId);
    }
  }
});
historyDatasetSwapList?.addEventListener("click", (e) => {
  const target = e.target instanceof HTMLElement ? e.target : null;
  if (!target) return;
  const swapButton = target.closest("[data-history-swap]");
  if (swapButton) {
    const nodeId = swapButton.getAttribute("data-history-swap");
    const node = loadDataNodes().find(item => item.id === nodeId);
    if (node?.payload) {
      applyHistoryNode(node);
      selectDetailDisplayAfterLoad();
      syncLocalDataNode();
      renderHistoryDatasetPanels();
    }
  }
});
exemptReasonClose?.addEventListener("click", closeExemptReasonModal);
exemptReasonModal?.addEventListener("click", (e) => {
  if (e.target === exemptReasonModal) closeExemptReasonModal();
});
exemptReasonOptions?.querySelectorAll(".exempt-reason-btn").forEach((btn) => {
  btn.addEventListener("click", () => {
    const reason = btn.dataset.reason || "";
    setExemptReasonSelection(reason);
    if (reason === "その他") {
      exemptReasonOtherInput?.focus();
    }
  });
});
exemptReasonOtherInput?.addEventListener("input", () => {
  if (!exemptReasonOtherInput) return;
  const val = str(exemptReasonOtherInput.value || "");
  if (val && exemptModalState.selectedReason !== "その他") {
    setExemptReasonSelection("その他");
  }
});
exemptReasonSave?.addEventListener("click", () => {
  const { recordKey, field } = exemptModalState;
  const reason = resolveExemptReason();
  if (!recordKey || !field) return;
  if (!reason) {
    showToast("免除理由を選択してください。");
    return;
  }
  applyExtensionExemptReason({ recordKey, field, reason });
  closeExemptReasonModal();
});
exemptReasonClear?.addEventListener("click", () => {
  const { recordKey, field } = exemptModalState;
  if (!recordKey || !field) return;
  clearExtensionExemptReason({ recordKey, field });
  closeExemptReasonModal();
});
const openNotifyThread = async ({ target, forceUpsert }) => {
  const key = childKey(target);
  const cached = getLineLinkStatusCache(key);
  if (!forceUpsert && cached?.thread_id) {
    window.location.href = buildApiUrl(`/admin/notify/threads/${cached.thread_id}`);
    return;
  }
  try {
    const res = await apiFetch("/admin/notify/thread/upsert", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ child_id: key })
    });
    let data = await parseResponseData(res);
    if (!data || typeof data !== "object") {
      data = {};
    }
    if (!res.ok) throw new Error(extractErrorMessage(data, "スレッド作成に失敗しました。"));
    if (!data?.thread_id) {
      const fallback = ensureLocalNotifyThread(key);
      data.thread_id = fallback?.thread_id;
    }
    if (!data?.thread_id) throw new Error("スレッド情報を取得できませんでした。");
    setLineLinkStatusCache(key, { ...(cached || {}), thread_id: data.thread_id });
    window.location.href = buildApiUrl(`/admin/notify/threads/${data.thread_id}`);
  } catch (error) {
    console.error(error);
    showToast("通知スレッドを開けませんでした。");
  }
};
lineChatButton?.addEventListener("click", () => {
  const target = getActiveChildTarget();
  if (!target) {
    showToast("園児を選択してください。");
    return;
  }
  openNotifyThread({ target, forceUpsert: false });
});
sendLineButton?.addEventListener("click", () => {
  const target = getActiveChildTarget();
  if (!target) {
    showToast("園児を選択してください。");
    return;
  }
  openNotifyThread({ target, forceUpsert: true });
});

// ヘッダーの空白タップでトップページへ遷移しないようにする

const updateManualIframeHeights = () => {
  if (!manualIframes?.length) return;
  manualIframes.forEach((iframe) => {
    if (iframe.closest(".manual-layer")) {
      iframe.style.removeProperty("height");
      return;
    }
    const pane = iframe.closest("[data-summary-pane], [data-detail-pane]");
    if (pane?.hidden) {
      iframe.style.removeProperty("height");
      return;
    }
    const panel = iframe.closest(".panel");
    if (panel?.classList.contains("is-collapsed")) {
      iframe.style.removeProperty("height");
      return;
    }
    const doc = iframe.contentDocument;
    if (!doc) return;
    const body = doc.body;
    const html = doc.documentElement;
    const nextHeight = Math.max(body?.scrollHeight || 0, html?.scrollHeight || 0);
    if (nextHeight) {
      iframe.style.height = `${nextHeight}px`;
    }
  });
};
manualIframes?.forEach((iframe) => {
  iframe.addEventListener("load", updateManualIframeHeights);
});

function expandPanelsForInitialView({ shouldApply = true } = {}) {
  state.summaryCollapsed = false;
  state.detailCollapsed = false;
  state.headerStage = "expanded";
  if (!shouldApply) return;
  setHeaderStage("expanded");
  applyCollapseState();
}

const selectDetailDisplayAfterLoad = () => {
  setDisplayMode("detail", { shouldSave: false });
  activateDetailTab("detail", { shouldSave: false });
};


const setCollapsed = (panelEl, btnEl, collapsed)=>{
  if (panelEl) panelEl.classList.toggle("is-collapsed", collapsed);
  if (btnEl) {
    const labelEl = btnEl.querySelector(".summary-handle-label");
    const nextLabel = collapsed ? "展開する" : "折りたたむ";
    if (labelEl) {
      labelEl.textContent = nextLabel;
    } else {
      btnEl.textContent = nextLabel;
    }
  }
};
const clearSummaryTabs = () => {
  summaryTabButtons.forEach(btn => {
    btn.classList.remove("active");
    btn.classList.remove("is-persistent-active");
    btn.setAttribute("aria-selected", "false");
    btn.tabIndex = -1;
  });
  summaryTabPanes.forEach(pane => {
    pane.hidden = true;
    pane.classList.remove("active");
  });
};
const syncChildFilterPlacement = () => {
  if (!filterContainerChild || !headerChildFilterHost) return;
  if (!headerChildFilterHost.contains(filterContainerChild)) {
    headerChildFilterHost.appendChild(filterContainerChild);
  }
};
let lastSummaryTab = state.summaryActiveTab || "summary";
let lastNonSummaryTab = state.summaryActiveTab && state.summaryActiveTab !== "summary"
  ? state.summaryActiveTab
  : "school";
const refreshSummaryFiltersFromDataSource = () => {
  renderDetails(lastResult?.details || []);
};
function activateSummaryTab(tabKey = "summary", { shouldSave = true, shouldTrack = true } = {}) {
  if (!tabKey){
    clearSummaryTabs();
    if (shouldSave) saveState();
    return;
  }
  const target = SUMMARY_TAB_KEYS.includes(tabKey) ? tabKey : "summary";
  const headerTarget = target === "summary"
    ? (lastNonSummaryTab || "school")
    : target;
  const layerTarget = state.displayMode === "summary" ? "summary" : target;
  const nextChildLayerOpen = shouldTrack
    ? (headerTarget === "child" ? true : (headerTarget === "add" ? false : state.summaryChildLayerOpen))
    : state.summaryChildLayerOpen;
  summaryTabButtons.forEach(btn => {
    const isActive = btn.dataset.summaryTab === headerTarget;
    const isPersistentChild = nextChildLayerOpen
      && headerTarget !== "child"
      && btn.dataset.summaryTab === "child";
    btn.classList.toggle("active", isActive);
    btn.classList.toggle("is-persistent-active", isPersistentChild);
    btn.setAttribute("aria-selected", isActive ? "true" : "false");
    btn.tabIndex = isActive ? 0 : -1;
  });
  summaryTabPanes.forEach(pane => {
    const paneKey = pane.dataset.summaryPane;
    const scope = pane.dataset.summaryScope || "layer";
    let isActive = false;
    if (scope === "header") {
      isActive = paneKey === headerTarget;
    } else {
      isActive = paneKey === layerTarget;
    }
    pane.hidden = !isActive;
    pane.classList.toggle("active", isActive);
  });
  syncChildFilterPlacement();
  if (summaryLayer) {
    const showChildLayer = !!nextChildLayerOpen;
    summaryLayer.classList.toggle("is-hidden", !showChildLayer);
    summaryLayer.setAttribute("aria-hidden", (!showChildLayer).toString());
    requestAnimationFrame(updateSummaryExpandedHeight);
  }
  if (summaryPaneWrapper) {
    summaryPaneWrapper.classList.toggle("is-manual-full", target === "summary" && !state.summaryCollapsed);
  }
  updateManualIframeHeights();
  if (["school", "class", "child"].includes(target)) {
    refreshSummaryFiltersFromDataSource();
  }
  if (shouldTrack) {
    state.summaryActiveTab = headerTarget;
    lastSummaryTab = headerTarget;
    if (headerTarget !== "summary") lastNonSummaryTab = headerTarget;
    state.summaryChildLayerOpen = nextChildLayerOpen;
    if (shouldSave) saveState();
  }
}
const activateDetailTab = (tabKey = "detail", { shouldSave = true } = {}) => {
  const target = DETAIL_TAB_KEYS.includes(tabKey) ? tabKey : "detail";
  detailTabButtons.forEach(btn => {
    const isActive = btn.dataset.detailTab === target;
    btn.classList.toggle("active", isActive);
    btn.setAttribute("aria-selected", isActive ? "true" : "false");
    btn.tabIndex = isActive ? 0 : -1;
  });
  detailTabPanes.forEach(pane => {
    const isActive = pane.dataset.detailPane === target;
    pane.hidden = !isActive;
  });
  state.detailActiveTab = target;
  if (target === "history"){
    renderTypeChangeHistory();
  }
  updateManualIframeHeights();
  if (shouldSave) saveState();
};
let summaryRecalcToken = 0;
const recalcSummaryForDisplay = () => {
  if (!summaryContainer) return;
  const payload = createDataNodePayload();
  const rows = Array.isArray(payload.originalRows) ? payload.originalRows : [];
  if (!rows.length) {
    if (lastResult?.summary?.length) {
      renderSummary(lastResult.summary, lastResult.details || []);
    } else {
      renderSummary([], []);
    }
    return;
  }
  summaryContainer.innerHTML = `<p class="muted">${SUMMARY_LOADING_TEXT}</p>`;
  triggerResultAnimation(summaryContainer);
  const token = ++summaryRecalcToken;
  requestAnimationFrame(() => {
    if (token !== summaryRecalcToken) return;
    const result = calculate(rows);
    const baseResult = calculate(rows, stripTypeOverrides(state.overridesByKey));
    lastResult = result;
    lastBaseResult = baseResult;
    if (token !== summaryRecalcToken) return;
    renderSummary(result.summary, result.details || []);
    const localId = getLocalDataNodeId();
    const activeId = state.dataNodeSelectedId || localId;
    if (activeId === localId) {
      syncLocalDataNode();
    }
  });
};
function setDisplayMode(mode = "detail", { shouldSave = true } = {}) {
  const nextMode = mode === "detail" ? "detail" : "summary";
  const nextSummaryView = mode === "changed" ? "changed" : "summary";
  const wasSummary = state.displayMode === "summary";
  state.displayMode = nextMode;
  state.summaryViewMode = nextMode === "summary" ? nextSummaryView : "summary";
  document.body.classList.toggle("display-summary", nextMode === "summary");
  const activeDisplayKey = nextMode === "summary" && state.summaryViewMode === "changed"
    ? "changed"
    : nextMode;
  displayTabButtons.forEach(btn => {
    const isActive = btn.dataset.displayTab === activeDisplayKey;
    btn.classList.toggle("active", isActive);
    btn.setAttribute("aria-selected", isActive ? "true" : "false");
    btn.tabIndex = isActive ? 0 : -1;
  });
  if (nextMode === "summary") {
    if (state.summaryCollapsed) {
      state.summaryCollapsed = false;
      applyCollapseState();
    }
    if (!wasSummary) {
      const preferredTab = state.summaryActiveTab && state.summaryActiveTab !== "summary"
        ? state.summaryActiveTab
        : (lastNonSummaryTab || "school");
      activateSummaryTab(preferredTab, { shouldSave: false });
    }
  } else if (state.summaryActiveTab === "summary") {
    activateSummaryTab(lastNonSummaryTab || "child", { shouldSave: false });
  }
  if (nextMode === "summary") {
    recalcSummaryForDisplay();
  } else if (lastResult?.summary?.length) {
    renderSummary(lastResult.summary, lastResult.details || []);
  }
  renderMemoNotes();
  if (shouldSave) saveState();
}
const applyCollapseState = ()=>{
  setCollapsed(summaryPanel, summaryToggleBtn || summaryHeaderHandle, !!state.summaryCollapsed);
  setCollapsed(detailPanel, detailHeaderHandle || detailToggleBtn, !!state.detailCollapsed);
  if (summaryLayer) summaryLayer.classList.toggle("is-collapsed", !!state.summaryCollapsed);
  if (detailLayer) detailLayer.classList.toggle("is-collapsed", !!state.detailCollapsed);
  if (summaryHeaderHandle) summaryHeaderHandle.setAttribute("aria-expanded", state.summaryCollapsed ? "false" : "true");
  if (detailHeaderHandle) detailHeaderHandle.setAttribute("aria-expanded", state.detailCollapsed ? "false" : "true");
  if (state.summaryCollapsed){
    const preferredTab = state.summaryActiveTab || lastSummaryTab || "summary";
    activateSummaryTab(preferredTab, { shouldSave: false, shouldTrack: false });
  } else {
    activateSummaryTab(state.summaryActiveTab || lastSummaryTab || "summary", { shouldSave: false });
    requestAnimationFrame(updateSummaryExpandedHeight);
  }
  requestAnimationFrame(updateSummaryLayerHeight);
  updateManualIframeHeights();
  scheduleSwipeRailUpdate();
};
const collapseSummaryAndDetail = () => {
  let needsSave = false;
  if (!state.summaryCollapsed) {
    state.summaryCollapsed = true;
    needsSave = true;
  }
  if (needsSave) {
    applyCollapseState();
    saveState();
  }
};

const collapseSummaryLayer = () => {
  if (state.summaryCollapsed) return;
  state.summaryCollapsed = true;
  applyCollapseState();
  saveState();
};

const expandSummaryLayer = () => {
  if (!state.summaryCollapsed) return;
  state.summaryCollapsed = false;
  applyCollapseState();
  saveState();
};

const collapseDetailLayer = () => {
  if (state.detailCollapsed) return;
  state.detailCollapsed = true;
  applyCollapseState();
  saveState();
};

const expandDetailLayer = () => {
  if (!state.detailCollapsed) return;
  state.detailCollapsed = false;
  applyCollapseState();
  saveState();
};

// Swipe rail interactions rely on native scrolling (no expand/collapse bindings).

/* =========================
   メモ機能
========================= */
const MEMO_STORAGE_KEY = "encho_memo_notes_v1";
const MEMO_STORAGE_VERSION = 2;
const MEMO_MIN_SIZES = {
  text: { width: 140, height: 96 },
  handwrite: { width: 260, height: 200 },
  image: { width: 200, height: 160 }
};
const MEMO_MAX_WIDTH = 320;
const MEMO_PADDING_X = 28;
const MEMO_PADDING_Y = 58;
const MEMO_COLOR_PRESETS = {
  sunny: {
    label: "サニー",
    background: "linear-gradient(135deg, #fff6b7, #ffef9b)",
    border: "rgba(245,204,73,.7)",
    swatch: "#facc15"
  },
  peach: {
    label: "ピーチ",
    background: "linear-gradient(135deg, #ffe4d6, #ffd2c3)",
    border: "rgba(248,167,129,.7)",
    swatch: "#fb7185"
  },
  mint: {
    label: "ミント",
    background: "linear-gradient(135deg, #d9fbe6, #c3f6d8)",
    border: "rgba(116,200,158,.7)",
    swatch: "#34d399"
  },
  sky: {
    label: "スカイ",
    background: "linear-gradient(135deg, #dbe9ff, #c6ddff)",
    border: "rgba(120,167,255,.7)",
    swatch: "#60a5fa"
  }
};
const MEMO_DEFAULT_COLOR = "sunny";
let memoPlacementMode = false;
let memoStore = null;
const memoContentCache = new Map();

const createMemoId = () => `memo-${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 8)}`;
const getMemoUserKey = () => activeUser || "ゲスト";
const getActiveMemoDisplayKey = () => {
  if (state.displayMode === "summary") {
    return state.summaryViewMode === "changed" ? "changed" : "summary";
  }
  return "detail";
};
const getActiveMemoDataNodeId = () => state.dataNodeSelectedId || getLocalDataNodeId() || "no-node";
const getDefaultMemoTitle = (type) => {
  if (type === "handwrite") return "手書きメモ";
  if (type === "image") return "画像メモ";
  return "文字メモ";
};
const getMemoColorPreset = (key) => MEMO_COLOR_PRESETS[key] || MEMO_COLOR_PRESETS[MEMO_DEFAULT_COLOR];
const applyMemoColor = (noteEl, colorKey) => {
  if (!noteEl) return;
  const preset = getMemoColorPreset(colorKey);
  const nextKey = MEMO_COLOR_PRESETS[colorKey] ? colorKey : MEMO_DEFAULT_COLOR;
  noteEl.dataset.memoColor = nextKey;
  noteEl.style.setProperty("--memo-bg", preset.background);
  noteEl.style.setProperty("--memo-border", preset.border);
};
const isMemoFixedSize = (noteEl) => noteEl?.dataset?.memoFixedSize === "true";
const loadMemoStore = () => {
  try {
    const raw = localStorage.getItem(MEMO_STORAGE_KEY);
    if (!raw) return { version: MEMO_STORAGE_VERSION, users: {} };
    const parsed = JSON.parse(raw);
    if (!parsed || typeof parsed !== "object") {
      return { version: MEMO_STORAGE_VERSION, users: {} };
    }
    return {
      version: parsed.version || MEMO_STORAGE_VERSION,
      users: parsed.users || {}
    };
  } catch (error) {
    console.warn("付箋ローカル保存の読み込みに失敗しました", error);
    return { version: MEMO_STORAGE_VERSION, users: {} };
  }
};
const saveMemoStore = () => {
  if (!memoStore) return;
  try {
    localStorage.setItem(MEMO_STORAGE_KEY, JSON.stringify(memoStore));
  } catch (error) {
    console.error("付箋ローカル保存に失敗しました", error);
    recoverStorageFromOverflow({ reason: "付箋保存" });
  }
};
const getMemoUserStore = () => {
  if (!memoStore) memoStore = loadMemoStore();
  const key = getMemoUserKey();
  if (!memoStore.users[key]) {
    memoStore.users[key] = { summary: {}, detail: {} };
  }
  return memoStore.users[key];
};
const setMemoContentCache = (id, content) => {
  if (!id) return;
  memoContentCache.set(id, { ...(memoContentCache.get(id) || {}), ...content });
};
const getMemoContentCache = (id) => memoContentCache.get(id) || {};
function getActiveMemoMonthKey() {
  const year = Number(state.summaryCalendarYear) || new Date().getFullYear();
  const month = Number(state.summaryCalendarMonth) || new Date().getMonth() + 1;
  return `${year}-${String(month).padStart(2, "0")}`;
}
const getActiveMemoChildKey = () => {
  const key = childKey({
    school: state.activeSchool || "",
    clazz: state.activeClass || "",
    name: state.activeName || ""
  });
  return key || "no-child";
};
const getActiveMemoDatasetKey = () => {
  if (!lastResult?.details?.length && !originalRows.length) return "no-data";
  const datasetKey = deriveDatasetMetaFromNode({
    payload: {
      lastResult: { details: lastResult?.details || [] },
      originalRows: Array.isArray(originalRows) ? originalRows : []
    }
  }).key;
  return datasetKey || "unknown";
};
const getMemoLayerForAnchor = (anchor) => {
  if (anchor === "summary") return memoLayerSummary;
  return memoLayerDetail;
};
const getMemoSpawnPosition = (anchor, baseSize) => {
  const layer = getMemoLayerForAnchor(anchor);
  const layerOffset = getMemoLayerOffset(anchor);
  let spawnX = window.scrollX + window.innerWidth / 2;
  let spawnY = window.scrollY + window.innerHeight / 3;
  if (ctrlDock) {
    const rect = ctrlDock.getBoundingClientRect();
    spawnX = rect.left + rect.width / 2 + window.scrollX;
    spawnY = rect.top + rect.height / 2 + window.scrollY;
  }
  let x = Math.round(spawnX - baseSize.width / 2 - layerOffset.left);
  let y = Math.round(spawnY - baseSize.height / 2 - layerOffset.top);
  const layerRect = layer?.getBoundingClientRect();
  if (layerRect) {
    const maxX = Math.max(0, layerRect.width - baseSize.width);
    const maxY = Math.max(0, layerRect.height - baseSize.height);
    x = clamp(x, 0, maxX);
    y = clamp(y, 0, maxY);
  }
  return { x, y };
};
const getMemoLayerOffset = (anchor) => {
  const layer = getMemoLayerForAnchor(anchor);
  if (!layer) {
    return { left: window.scrollX, top: window.scrollY };
  }
  const rect = layer.getBoundingClientRect();
  return { left: rect.left + window.scrollX, top: rect.top + window.scrollY };
};
const getMemoSummaryKey = ({ monthKey, childKey, displayKey, dataNodeId }) => {
  const resolvedMonth = monthKey || getActiveMemoMonthKey();
  const resolvedChild = childKey || getActiveMemoChildKey();
  const resolvedDisplay = displayKey || getActiveMemoDisplayKey();
  const resolvedNode = dataNodeId || getActiveMemoDataNodeId();
  return `${resolvedMonth}::${resolvedChild}::${resolvedDisplay}::${resolvedNode}`;
};
const getMemoDetailKey = ({ datasetKey, childKey, displayKey, dataNodeId }) => {
  const resolvedDataset = datasetKey || getActiveMemoDatasetKey();
  const resolvedChild = childKey || getActiveMemoChildKey();
  const resolvedDisplay = displayKey || getActiveMemoDisplayKey();
  const resolvedNode = dataNodeId || getActiveMemoDataNodeId();
  return `${resolvedDataset}::${resolvedChild}::${resolvedDisplay}::${resolvedNode}`;
};
const ensureMemoMeta = (note, meta) => ({
  ...note,
  displayKey: note.displayKey || meta.displayKey,
  childKey: note.childKey || meta.childKey,
  dataNodeId: note.dataNodeId || meta.dataNodeId,
  datasetKey: note.datasetKey || meta.datasetKey,
  monthKey: note.monthKey || meta.monthKey
});
const getMemoSummaryList = ({ monthKey, childKey, displayKey, dataNodeId } = {}) => {
  const store = getMemoUserStore();
  const summaryKey = getMemoSummaryKey({ monthKey, childKey, displayKey, dataNodeId });
  if (!store.summary[summaryKey]) {
    const legacyKey = monthKey || getActiveMemoMonthKey();
    const meta = {
      displayKey: displayKey || getActiveMemoDisplayKey(),
      childKey: childKey || getActiveMemoChildKey(),
      dataNodeId: dataNodeId || getActiveMemoDataNodeId(),
      monthKey: monthKey || getActiveMemoMonthKey()
    };
    if (store.summary[legacyKey]?.length) {
      store.summary[summaryKey] = store.summary[legacyKey].map(note => ensureMemoMeta(note, meta));
      saveMemoStore();
    } else {
      store.summary[summaryKey] = [];
    }
  }
  return store.summary[summaryKey];
};
const getMemoDetailList = ({ datasetKey, childKey, displayKey, dataNodeId } = {}) => {
  const store = getMemoUserStore();
  const detailKey = getMemoDetailKey({ datasetKey, childKey, displayKey, dataNodeId });
  if (!store.detail[detailKey]) {
    const resolvedDataset = datasetKey || getActiveMemoDatasetKey();
    const resolvedChild = childKey || getActiveMemoChildKey();
    const legacyKey = `${resolvedDataset}::${resolvedChild}`;
    const legacyBaseKey = resolvedDataset;
    const meta = {
      displayKey: displayKey || getActiveMemoDisplayKey(),
      childKey: resolvedChild,
      dataNodeId: dataNodeId || getActiveMemoDataNodeId(),
      datasetKey: resolvedDataset
    };
    if (store.detail[legacyKey]?.length) {
      store.detail[detailKey] = store.detail[legacyKey].map(item => ensureMemoMeta(item, meta));
      delete store.detail[legacyKey];
      saveMemoStore();
    } else if (legacyBaseKey && store.detail[legacyBaseKey]?.length) {
      store.detail[detailKey] = store.detail[legacyBaseKey].map(item => ensureMemoMeta(item, meta));
      delete store.detail[legacyBaseKey];
      saveMemoStore();
    } else {
      store.detail[detailKey] = [];
    }
  }
  return store.detail[detailKey];
};
const purgeMemoId = (id) => {
  const store = getMemoUserStore();
  Object.keys(store.summary || {}).forEach((key) => {
    store.summary[key] = (store.summary[key] || []).filter(note => note.id !== id);
  });
  Object.keys(store.detail || {}).forEach((key) => {
    store.detail[key] = (store.detail[key] || []).filter(note => note.id !== id);
  });
  memoContentCache.delete(id);
};
const migrateLegacyMemoNotes = () => {
  const legacyA = legacyMemoNotes.memoNotesA || {};
  const legacyB = Array.isArray(legacyMemoNotes.memoNotesB) ? legacyMemoNotes.memoNotesB : [];
  if (!Object.keys(legacyA).length && !legacyB.length) return;
  const store = getMemoUserStore();
  const normalizeLegacy = (note, fallbackAnchor = "summary") => {
    const type = note?.type || "text";
    return {
      id: note?.id || createMemoId(),
      type,
      anchor: fallbackAnchor,
      x: Math.round(note?.x || 0),
      y: Math.round(note?.y || 0),
      width: Math.round(note?.width || (MEMO_MIN_SIZES[type]?.width || MEMO_MIN_SIZES.text.width)),
      height: Math.round(note?.height || (MEMO_MIN_SIZES[type]?.height || MEMO_MIN_SIZES.text.height)),
      title: note?.title?.trim() || note?.id || getDefaultMemoTitle(type),
      color: note?.color || MEMO_DEFAULT_COLOR,
      fixedSize: Boolean(note?.fixedSize)
    };
  };
  Object.entries(legacyA).forEach(([monthKey, notes]) => {
    if (!Array.isArray(notes)) return;
    const list = store.summary[monthKey] || [];
    notes.forEach((note) => list.push(normalizeLegacy(note, "summary")));
    store.summary[monthKey] = list;
  });
  if (legacyB.length) {
    const monthKey = getActiveMemoMonthKey();
    const list = store.summary[monthKey] || [];
    legacyB.forEach((note) => list.push(normalizeLegacy(note, "summary")));
    store.summary[monthKey] = list;
  }
  saveMemoStore();
  saveState({ skipNodeSync: true });
};
memoStore = loadMemoStore();
migrateLegacyMemoNotes();
const clamp = (value, min, max) => Math.min(max, Math.max(min, value));
const resolveMemoZone = (noteEl) => {
  const rect = noteEl.getBoundingClientRect();
  const centerX = rect.left + rect.width / 2;
  const centerY = rect.top + rect.height / 2;
  const contains = (target) => {
    if (!target) return false;
    const r = target.getBoundingClientRect();
    return centerX >= r.left && centerX <= r.right && centerY >= r.top && centerY <= r.bottom;
  };
  if (contains(summaryPanel)) {
    return { anchor: "summary" };
  }
  if (contains(detailPanel)) {
    return { anchor: "detail" };
  }
  return null;
};
const buildMemoDataFromElement = (noteEl, anchor, memoMeta) => {
  const id = noteEl.dataset.memoId || createMemoId();
  const type = noteEl.dataset.memoType || "text";
  const rect = noteEl.getBoundingClientRect();
  const layerOffset = getMemoLayerOffset(anchor);
  const x = rect.left + window.scrollX - layerOffset.left;
  const y = rect.top + window.scrollY - layerOffset.top;
  const title = noteEl.dataset.memoTitle || id || getDefaultMemoTitle(type);
  const note = {
    id,
    type,
    anchor,
    x: Math.round(x),
    y: Math.round(y),
    width: Math.round(rect.width),
    height: Math.round(rect.height),
    title,
    color: noteEl.dataset.memoColor || MEMO_DEFAULT_COLOR,
    fixedSize: noteEl.dataset.memoFixedSize === "true",
    displayKey: memoMeta?.displayKey || getActiveMemoDisplayKey(),
    childKey: memoMeta?.childKey || getActiveMemoChildKey(),
    dataNodeId: memoMeta?.dataNodeId || getActiveMemoDataNodeId(),
    datasetKey: memoMeta?.datasetKey || getActiveMemoDatasetKey(),
    monthKey: memoMeta?.monthKey || getActiveMemoMonthKey()
  };
  return note;
};
const syncMemoContentCache = (noteEl) => {
  const id = noteEl.dataset.memoId;
  if (!id) return;
  const type = noteEl.dataset.memoType || "text";
  if (type === "text") {
    const textarea = noteEl.querySelector("textarea");
    setMemoContentCache(id, { text: textarea?.value || "" });
    return;
  }
  if (type === "image") {
    setMemoContentCache(id, { image: noteEl.dataset.memoContent || "" });
    return;
  }
  const canvas = noteEl.querySelector("canvas");
  if (canvas) {
    setMemoContentCache(id, { handwrite: canvas.toDataURL("image/png") });
  }
};
const persistMemoNote = (noteEl, { shouldSave = true } = {}) => {
  const id = noteEl.dataset.memoId;
  if (!id) return;
  const zoneInfo = resolveMemoZone(noteEl);
  purgeMemoId(id);
  if (!zoneInfo) {
    if (shouldSave) saveMemoStore();
    return;
  }
  const memoMeta = {
    displayKey: noteEl.dataset.memoDisplay || getActiveMemoDisplayKey(),
    childKey: noteEl.dataset.memoChildKey || getActiveMemoChildKey(),
    dataNodeId: noteEl.dataset.memoDataNodeId || getActiveMemoDataNodeId(),
    datasetKey: noteEl.dataset.memoDatasetKey || getActiveMemoDatasetKey(),
    monthKey: noteEl.dataset.memoMonthKey || getActiveMemoMonthKey()
  };
  syncMemoContentCache(noteEl);
  const noteData = buildMemoDataFromElement(noteEl, zoneInfo.anchor, memoMeta);
  if (zoneInfo.anchor === "summary") {
    getMemoSummaryList(memoMeta).push(noteData);
  } else {
    getMemoDetailList(memoMeta).push(noteData);
  }
  if (shouldSave) saveMemoStore();
};
const fitTextMemoToContainer = (noteEl) => {
  const textarea = noteEl.querySelector("textarea");
  if (!textarea) return;
  const width = Math.max(0, noteEl.clientWidth - MEMO_PADDING_X);
  const height = Math.max(0, noteEl.clientHeight - MEMO_PADDING_Y);
  textarea.style.width = `${width}px`;
  textarea.style.height = `${height}px`;
};
const resizeTextMemo = (noteEl) => {
  if (isMemoFixedSize(noteEl)) {
    fitTextMemoToContainer(noteEl);
    return;
  }
  const textarea = noteEl.querySelector("textarea");
  if (!textarea) return;
  textarea.style.height = "auto";
  textarea.style.width = "auto";
  const minSize = MEMO_MIN_SIZES.text;
  const desiredWidth = clamp(textarea.scrollWidth + MEMO_PADDING_X, minSize.width, MEMO_MAX_WIDTH);
  textarea.style.width = `${desiredWidth - MEMO_PADDING_X}px`;
  textarea.style.height = "auto";
  const desiredHeight = Math.max(minSize.height, textarea.scrollHeight + MEMO_PADDING_Y);
  noteEl.style.width = `${desiredWidth}px`;
  noteEl.style.height = `${desiredHeight}px`;
  textarea.style.height = `${desiredHeight - MEMO_PADDING_Y}px`;
};
const setupMemoDragging = (noteEl) => {
  let dragging = false;
  let pointerId = null;
  let offsetX = 0;
  let offsetY = 0;
  const getAnchor = () => noteEl.dataset.memoAnchor || "detail";
  noteEl.addEventListener("pointerdown", (e) => {
    if (!memoPlacementMode) return;
    dragging = true;
    pointerId = e.pointerId;
    noteEl.classList.add("is-dragging");
    noteEl.setPointerCapture(pointerId);
    const rect = noteEl.getBoundingClientRect();
    offsetX = e.clientX - rect.left;
    offsetY = e.clientY - rect.top;
    e.preventDefault();
  });
  noteEl.addEventListener("pointermove", (e) => {
    if (!dragging || e.pointerId !== pointerId) return;
    const anchor = getAnchor();
    const layerOffset = getMemoLayerOffset(anchor);
    const nextX = e.clientX + window.scrollX - offsetX - layerOffset.left;
    const nextY = e.clientY + window.scrollY - offsetY - layerOffset.top;
    noteEl.style.left = `${nextX}px`;
    noteEl.style.top = `${nextY}px`;
  });
  const stopDrag = (e) => {
    if (!dragging || (pointerId !== null && e.pointerId !== pointerId)) return;
    dragging = false;
    noteEl.classList.remove("is-dragging");
    noteEl.releasePointerCapture(pointerId);
    pointerId = null;
    persistMemoNote(noteEl);
    renderMemoNotes();
  };
  noteEl.addEventListener("pointerup", stopDrag);
  noteEl.addEventListener("pointercancel", stopDrag);
};
const setupMemoHandwrite = (noteEl) => {
  const canvas = noteEl.querySelector("canvas");
  if (!canvas) return;
  const ctx = canvas.getContext("2d");
  if (!ctx) return;
  ctx.lineWidth = 2;
  ctx.lineCap = "round";
  ctx.strokeStyle = "#3d335c";
  let drawing = false;
  const getPoint = (e) => {
    const rect = canvas.getBoundingClientRect();
    return { x: e.clientX - rect.left, y: e.clientY - rect.top };
  };
  canvas.addEventListener("pointerdown", (e) => {
    if (memoPlacementMode) return;
    drawing = true;
    noteEl.dataset.memoDrawing = "true";
    canvas.setPointerCapture(e.pointerId);
    const point = getPoint(e);
    ctx.beginPath();
    ctx.moveTo(point.x, point.y);
  });
  canvas.addEventListener("pointermove", (e) => {
    if (!drawing || memoPlacementMode) return;
    const point = getPoint(e);
    ctx.lineTo(point.x, point.y);
    ctx.stroke();
  });
  const endDrawing = (e) => {
    if (!drawing) return;
    drawing = false;
    noteEl.dataset.memoDrawing = "false";
    canvas.releasePointerCapture(e.pointerId);
    persistMemoNote(noteEl);
  };
  canvas.addEventListener("pointerup", endDrawing);
  canvas.addEventListener("pointercancel", endDrawing);
};
const setupMemoText = (noteEl) => {
  const textarea = noteEl.querySelector("textarea");
  if (!textarea) return;
  const scheduleSave = () => {
    if (isMemoFixedSize(noteEl)) {
      fitTextMemoToContainer(noteEl);
    } else {
      resizeTextMemo(noteEl);
    }
    persistMemoNote(noteEl);
  };
  textarea.addEventListener("input", scheduleSave);
  textarea.addEventListener("blur", scheduleSave);
  resizeTextMemo(noteEl);
};
const resizeHandwriteCanvas = (noteEl) => {
  const canvas = noteEl.querySelector("canvas");
  if (!canvas) return;
  const id = noteEl.dataset.memoId;
  const current = canvas.toDataURL("image/png");
  if (id) setMemoContentCache(id, { handwrite: current });
  const width = Math.max(140, noteEl.clientWidth - MEMO_PADDING_X);
  const height = Math.max(120, noteEl.clientHeight - MEMO_PADDING_Y);
  canvas.width = width;
  canvas.height = height;
  const cachedContent = getMemoContentCache(id).handwrite || current;
  if (!cachedContent) return;
  const img = new Image();
  img.onload = () => {
    const ctx = canvas.getContext("2d");
    if (ctx) ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  };
  img.src = cachedContent;
};
const setupMemoResizeObserver = (noteEl) => {
  if (!("ResizeObserver" in window)) return;
  let rafId = null;
  const observer = new ResizeObserver(() => {
    if (!memoPlacementMode) return;
    if (noteEl.dataset.memoDrawing === "true") return;
    if (rafId) cancelAnimationFrame(rafId);
    rafId = requestAnimationFrame(() => {
      noteEl.dataset.memoFixedSize = "true";
      const type = noteEl.dataset.memoType || "text";
      if (type === "handwrite") {
        resizeHandwriteCanvas(noteEl);
      } else if (type === "text") {
        fitTextMemoToContainer(noteEl);
      }
      persistMemoNote(noteEl);
    });
  });
  observer.observe(noteEl);
};
const createMemoColorBar = (noteEl, currentColor) => {
  const bar = document.createElement("div");
  bar.className = "memo-note__color-bar";
  Object.entries(MEMO_COLOR_PRESETS).forEach(([key, preset]) => {
    const chip = document.createElement("button");
    chip.type = "button";
    chip.className = "memo-note__color-chip";
    chip.style.background = preset.swatch;
    chip.setAttribute("aria-label", `付箋色: ${preset.label}`);
    if (key === currentColor) chip.classList.add("is-active");
    chip.addEventListener("pointerdown", (event) => event.stopPropagation());
    chip.addEventListener("click", (event) => {
      event.preventDefault();
      event.stopPropagation();
      bar.querySelectorAll(".memo-note__color-chip").forEach(btn => btn.classList.remove("is-active"));
      chip.classList.add("is-active");
      applyMemoColor(noteEl, key);
      persistMemoNote(noteEl);
    });
    bar.appendChild(chip);
  });
  return bar;
};
const createMemoActionButton = ({ label, icon, onClick }) => {
  const button = document.createElement("button");
  button.type = "button";
  button.className = "memo-note__action";
  button.setAttribute("aria-label", label);
  button.textContent = icon;
  button.addEventListener("pointerdown", (e) => e.stopPropagation());
  button.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();
    onClick();
  });
  return button;
};
const createMemoNoteElement = (note) => {
  const noteEl = document.createElement("div");
  noteEl.className = "memo-note";
  noteEl.dataset.memoId = note.id;
  noteEl.dataset.memoType = note.type;
  noteEl.dataset.memoAnchor = note.anchor || "page";
  noteEl.dataset.memoFixedSize = note.fixedSize ? "true" : "false";
  noteEl.dataset.memoDrawing = "false";
  noteEl.dataset.memoDisplay = note.displayKey || getActiveMemoDisplayKey();
  noteEl.dataset.memoChildKey = note.childKey || getActiveMemoChildKey();
  noteEl.dataset.memoDataNodeId = note.dataNodeId || getActiveMemoDataNodeId();
  noteEl.dataset.memoDatasetKey = note.datasetKey || getActiveMemoDatasetKey();
  noteEl.dataset.memoMonthKey = note.monthKey || getActiveMemoMonthKey();
  noteEl.style.left = `${note.x}px`;
  noteEl.style.top = `${note.y}px`;
  const minSize = MEMO_MIN_SIZES[note.type] || MEMO_MIN_SIZES.text;
  noteEl.style.width = `${note.width || minSize.width}px`;
  noteEl.style.height = `${note.height || minSize.height}px`;
  applyMemoColor(noteEl, note.color || MEMO_DEFAULT_COLOR);
  const headerEl = document.createElement("div");
  headerEl.className = "memo-note__header";
  const actionsEl = document.createElement("div");
  actionsEl.className = "memo-note__actions";
  noteEl.dataset.memoTitle = note.title?.trim() || note.id || getDefaultMemoTitle(note.type);
  const colorBar = createMemoColorBar(noteEl, note.color || MEMO_DEFAULT_COLOR);
  const handleDelete = () => {
    purgeMemoId(note.id);
    saveMemoStore();
    renderMemoNotes();
  };
  const deleteButton = createMemoActionButton({
    label: "削除",
    icon: "🗑️",
    onClick: handleDelete
  });
  const bodyEl = document.createElement("div");
  bodyEl.className = "memo-note__body";
  if (note.type === "handwrite") {
    noteEl.dataset.memoType = "handwrite";
    const canvas = document.createElement("canvas");
    canvas.className = "memo-note__canvas";
    const width = Math.max(140, (note.width || MEMO_MIN_SIZES.handwrite.width) - MEMO_PADDING_X);
    const height = Math.max(120, (note.height || MEMO_MIN_SIZES.handwrite.height) - MEMO_PADDING_Y);
    canvas.width = width;
    canvas.height = height;
    const cachedContent = getMemoContentCache(note.id).handwrite || note.content;
    if (cachedContent) {
      const img = new Image();
      img.onload = () => {
        const ctx = canvas.getContext("2d");
        if (ctx) ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      };
      img.src = cachedContent;
    }
    const eraseButton = createMemoActionButton({
      label: "消去",
      icon: "🧽",
      onClick: () => {
        const ctx = canvas.getContext("2d");
        if (ctx) {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          persistMemoNote(noteEl);
        }
      }
    });
    actionsEl.append(eraseButton, deleteButton);
    headerEl.append(colorBar, actionsEl);
    bodyEl.appendChild(canvas);
    noteEl.appendChild(headerEl);
    noteEl.appendChild(bodyEl);
    setupMemoHandwrite(noteEl);
  } else if (note.type === "image") {
    noteEl.dataset.memoType = "image";
    const cachedImage = getMemoContentCache(note.id).image || note.content || "";
    noteEl.dataset.memoContent = cachedImage;
    actionsEl.appendChild(deleteButton);
    headerEl.append(colorBar, actionsEl);
    const img = document.createElement("img");
    img.className = "memo-note__image";
    img.alt = "付箋画像";
    if (cachedImage) {
      img.src = cachedImage;
    }
    bodyEl.appendChild(img);
    noteEl.appendChild(headerEl);
    noteEl.appendChild(bodyEl);
  } else {
    actionsEl.appendChild(deleteButton);
    headerEl.append(colorBar, actionsEl);
    const textarea = document.createElement("textarea");
    textarea.className = "memo-note__text";
    textarea.value = getMemoContentCache(note.id).text || note.content || "";
    bodyEl.appendChild(textarea);
    noteEl.appendChild(headerEl);
    noteEl.appendChild(bodyEl);
    setupMemoText(noteEl);
    if (note.fixedSize) {
      fitTextMemoToContainer(noteEl);
    }
  }
  setupMemoDragging(noteEl);
  setupMemoResizeObserver(noteEl);
  return noteEl;
};
function renderMemoNotes() {
  if (!memoHelpersReady) return;
  if (!memoLayerSummary || !memoLayerDetail) return;
  memoLayerSummary.querySelectorAll(".memo-note").forEach(el => el.remove());
  memoLayerDetail.querySelectorAll(".memo-note").forEach(el => el.remove());
  const displayKey = getActiveMemoDisplayKey();
  const monthKey = getActiveMemoMonthKey();
  const childKey = getActiveMemoChildKey();
  const dataNodeId = getActiveMemoDataNodeId();
  const summaryNotes = getMemoSummaryList({ monthKey, childKey, displayKey, dataNodeId });
  summaryNotes.forEach((note) => {
    const noteEl = createMemoNoteElement({ ...note, anchor: "summary" });
    memoLayerSummary.appendChild(noteEl);
  });
  const datasetKey = getActiveMemoDatasetKey();
  const detailNotes = getMemoDetailList({ datasetKey, childKey, displayKey, dataNodeId });
  detailNotes.forEach((note) => {
    const noteEl = createMemoNoteElement({ ...note, anchor: "detail" });
    memoLayerDetail.appendChild(noteEl);
  });
  if (memoPlacementMode) {
    document.querySelectorAll(".memo-note").forEach(el => el.classList.add("is-placement"));
  }
}
const setMemoPlacementMode = (enabled) => {
  memoPlacementMode = enabled;
  document.body.classList.toggle("is-memo-placement", enabled);
  if (placementRadial) {
    placementRadial.setAttribute("aria-hidden", enabled ? "false" : "true");
  }
  if (!enabled) {
    placementIssueNode?.classList.remove("is-open");
    placementRequestNode?.classList.remove("is-open");
    resetPlacementSelection();
  }
  if (memoPlacementBtn) {
    memoPlacementBtn.classList.toggle("is-active", enabled);
    memoPlacementBtn.setAttribute("aria-pressed", enabled ? "true" : "false");
    memoPlacementBtn.title = enabled ? "設置モード解除" : "設置モード";
    memoPlacementBtn.setAttribute("aria-label", enabled ? "設置モード解除" : "設置モード");
  }
  document.querySelectorAll(".memo-note").forEach(el => {
    el.classList.toggle("is-placement", enabled);
  });
  if (!enabled) {
    document.querySelectorAll(".memo-note").forEach(el => persistMemoNote(el, { shouldSave: false }));
    saveMemoStore();
    renderMemoNotes();
  }
  updateEditQuickAvailability();
};
const createMemoNote = (type, content = "") => {
  const displayKey = getActiveMemoDisplayKey();
  const anchor = displayKey === "summary" || displayKey === "changed" ? "summary" : "detail";
  const layer = getMemoLayerForAnchor(anchor);
  if (!layer) return;
  const baseSize = MEMO_MIN_SIZES[type] || MEMO_MIN_SIZES.text;
  const id = createMemoId();
  const position = getMemoSpawnPosition(anchor, baseSize);
  const memoMeta = {
    displayKey,
    childKey: getActiveMemoChildKey(),
    dataNodeId: getActiveMemoDataNodeId(),
    datasetKey: getActiveMemoDatasetKey(),
    monthKey: getActiveMemoMonthKey()
  };
  if (content) {
    if (type === "image") {
      setMemoContentCache(id, { image: content });
    } else if (type === "handwrite") {
      setMemoContentCache(id, { handwrite: content });
    } else {
      setMemoContentCache(id, { text: content });
    }
  }
  const note = {
    id,
    type,
    anchor,
    x: position.x,
    y: position.y,
    width: baseSize.width,
    height: baseSize.height,
    title: id,
    color: MEMO_DEFAULT_COLOR,
    fixedSize: false,
    ...memoMeta
  };
  if (anchor === "summary") {
    getMemoSummaryList(memoMeta).push(note);
  } else {
    getMemoDetailList(memoMeta).push(note);
  }
  saveMemoStore();
  renderMemoNotes();
  const noteEl = layer.querySelector(`[data-memo-id="${id}"]`);
  if (!noteEl) return;
  if (type === "text") {
    noteEl.querySelector("textarea")?.focus();
  }
};
const createMemoImage = () => {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.addEventListener("change", () => {
    const file = input.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      const result = typeof reader.result === "string" ? reader.result : "";
      if (result) createMemoNote("image", result);
    };
    reader.readAsDataURL(file);
  });
  input.click();
};
const closeMemoQuickMenu = () => {
  if (!memoQuickWrap) return;
  memoQuickWrap.classList.remove("is-open");
  memoQuickBtn?.setAttribute("aria-expanded", "false");
};
const closeEditQuickMenu = () => {
  if (!editQuickWrap) return;
  editQuickWrap.classList.remove("is-open");
  editQuickBtn?.setAttribute("aria-expanded", "false");
};
const openMemoQuickMenu = () => {
  if (!memoQuickWrap) return;
  memoQuickWrap.classList.add("is-open");
  memoQuickBtn?.setAttribute("aria-expanded", "true");
};
const openEditQuickMenu = () => {
  if (!editQuickWrap) return;
  editQuickWrap.classList.add("is-open");
  editQuickBtn?.setAttribute("aria-expanded", "true");
};
const toggleMemoQuickMenu = () => {
  if (!memoQuickWrap) return;
  const isOpen = memoQuickWrap.classList.contains("is-open");
  if (isOpen) {
    closeMemoQuickMenu();
  } else {
    openMemoQuickMenu();
  }
};
const toggleEditQuickMenu = () => {
  if (!editQuickWrap || editQuickBtn?.disabled) return;
  const isOpen = editQuickWrap.classList.contains("is-open");
  if (isOpen) {
    closeEditQuickMenu();
  } else {
    openEditQuickMenu();
  }
};
const updateEditQuickAvailability = () => {
  const isEditable = memoPlacementMode;
  if (!editQuickBtn) return;
  editQuickBtn.disabled = !isEditable;
  editQuickBtn.setAttribute("aria-disabled", isEditable ? "false" : "true");
  if (!isEditable) closeEditQuickMenu();
};
const closePlacementMenus = () => {
  placementIssueNode?.classList.remove("is-open");
  placementRequestNode?.classList.remove("is-open");
};
const togglePlacementMenu = (node) => {
  if (!node) return;
  const isOpen = node.classList.contains("is-open");
  closePlacementMenus();
  if (!isOpen) node.classList.add("is-open");
};
let placementSelection = null;
const resetPlacementSelection = () => {
  placementSelection = null;
  document.body.classList.remove("is-target-selecting");
};
const startPlacementTargetSelection = (type) => {
  if (!memoPlacementMode) return;
  placementSelection = { type, mode: "select" };
  document.body.classList.add("is-target-selecting");
  closePlacementMenus();
  showToast("対象パーツをクリックしてください。");
};
const startPlacementRangeSelection = (type) => {
  if (!memoPlacementMode) return;
  placementSelection = null;
  closePlacementMenus();
  openRangeSelection(type);
};
memoHandwriteBtn?.addEventListener("click", () => createMemoNote("handwrite"));
memoTextBtn?.addEventListener("click", () => createMemoNote("text"));
memoPlacementBtn?.addEventListener("click", () => setMemoPlacementMode(!memoPlacementMode));
memoImageBtn?.addEventListener("click", () => createMemoImage());
placementIssueBtn?.addEventListener("click", (event) => {
  event.stopPropagation();
  togglePlacementMenu(placementIssueNode);
});
placementRequestBtn?.addEventListener("click", (event) => {
  event.stopPropagation();
  togglePlacementMenu(placementRequestNode);
});
placementIssueMenu?.addEventListener("click", (event) => {
  const target = event.target instanceof HTMLElement ? event.target : null;
  const button = target?.closest("[data-issue-action]");
  if (!button) return;
  const action = button.getAttribute("data-issue-action");
  if (action === "select") {
    startPlacementTargetSelection("issue");
  } else if (action === "range") {
    startPlacementRangeSelection("issue");
  }
});
placementRequestMenu?.addEventListener("click", (event) => {
  const target = event.target instanceof HTMLElement ? event.target : null;
  const button = target?.closest("[data-request-action]");
  if (!button) return;
  const action = button.getAttribute("data-request-action");
  if (action === "select") {
    startPlacementTargetSelection("suggestion");
  } else if (action === "range") {
    startPlacementRangeSelection("suggestion");
  }
});
document.addEventListener("click", (event) => {
  if (!placementSelection) return;
  if (!(event.target instanceof HTMLElement)) return;
  const target = event.target;
  if (target.closest(".placement-radial, .ctrl-dock, .modal-overlay, #featureSuggestionFloat, .suggestion-float")) {
    return;
  }
  event.preventDefault();
  event.stopPropagation();
  const selectionText = getSelectionText();
  const targetLabel = selectionText ? "選択範囲" : getSuggestionLabelFromTarget(target);
  const rect = selectionText ? getSelectionRect() : getTargetRectFromElement(target);
  if (!rect) {
    showToast("対象が取得できませんでした。");
    resetPlacementSelection();
    return;
  }
  const label = placementSelection.type === "issue"
    ? formatIssueContext({ selectionText, targetLabel })
    : formatSuggestionContext({ selectionText, targetLabel });
  if (placementSelection.type === "issue") {
    openIssueModal({ mode: "select", label, rect });
  } else {
    openSuggestionModal({ mode: "around", label, rect });
  }
  resetPlacementSelection();
}, true);
let memoPlacementTapAt = 0;
const exitMemoPlacementMode = () => {
  if (!memoPlacementMode) return;
  setMemoPlacementMode(false);
};
document.addEventListener("dblclick", () => exitMemoPlacementMode());
document.addEventListener("pointerdown", (event) => {
  if (!memoPlacementMode) return;
  if (event.pointerType !== "touch" && event.pointerType !== "pen") return;
  const now = Date.now();
  if (now - memoPlacementTapAt < 360) {
    memoPlacementTapAt = 0;
    exitMemoPlacementMode();
  } else {
    memoPlacementTapAt = now;
  }
});
memoQuickBtn?.addEventListener("click", (event) => {
  event.stopPropagation();
  toggleMemoQuickMenu();
});
memoQuickWrap?.addEventListener("click", (event) => {
  event.stopPropagation();
});
editQuickBtn?.addEventListener("click", (event) => {
  event.stopPropagation();
  toggleEditQuickMenu();
});
editQuickWrap?.addEventListener("click", (event) => {
  event.stopPropagation();
});
document.addEventListener("click", () => {
  closeMemoQuickMenu();
  closeEditQuickMenu();
  closePlacementMenus();
});
memoHandwriteBtn?.addEventListener("click", () => closeMemoQuickMenu());
memoTextBtn?.addEventListener("click", () => closeMemoQuickMenu());
memoImageBtn?.addEventListener("click", () => closeMemoQuickMenu());
memoHelpersReady = true;
renderMemoNotes();
updateEditQuickAvailability();

summaryToggleBtn?.addEventListener("click", ()=>{
  toggleSummaryCollapsed();
});
detailToggleBtn?.addEventListener("click", ()=>{
  toggleDetailCollapsed();
});
applyCollapseState();
setDisplayMode(state.displayMode, { shouldSave: false });
displayTabButtons.forEach((btn, idx) => {
  btn.addEventListener("click", () => {
    setDisplayMode(btn.dataset.displayTab || "detail");
  });
  btn.addEventListener("keydown",(e)=>{
    if (e.key !== "ArrowRight" && e.key !== "ArrowLeft") return;
    e.preventDefault();
    const delta = e.key === "ArrowRight" ? 1 : -1;
    const nextIdx = (displayTabButtons.length + idx + delta) % displayTabButtons.length;
    const nextBtn = displayTabButtons[nextIdx];
    nextBtn?.focus();
    setDisplayMode(nextBtn?.dataset.displayTab || "detail");
  });
});
summaryTabButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    closeUserMenu();
    if (state.summaryCollapsed) {
      state.summaryCollapsed = false;
      applyCollapseState();
      saveState();
    }
    activateSummaryTab(btn.dataset.summaryTab);
    if (btn.dataset.summaryTab === "summary") {
      state.summaryViewMode = "summary";
    }
    const isSummaryTab = btn.dataset.summaryTab === "summary";
    const keepSummaryView = state.displayMode === "summary" && !isSummaryTab;
    setDisplayMode(isSummaryTab || keepSummaryView ? "summary" : "detail");
  });
  btn.addEventListener("keydown",(e)=>{
    if (e.key !== "ArrowRight" && e.key !== "ArrowLeft") return;
    e.preventDefault();
    closeUserMenu();
    const currentIdx = Math.max(0, SUMMARY_TAB_KEYS.indexOf(btn.dataset.summaryTab));
    const delta = e.key === "ArrowRight" ? 1 : -1;
    const nextKey = SUMMARY_TAB_KEYS[(SUMMARY_TAB_KEYS.length + currentIdx + delta) % SUMMARY_TAB_KEYS.length];
    const nextBtn = Array.from(summaryTabButtons).find(b => b.dataset.summaryTab === nextKey);
    nextBtn?.focus();
    if (state.summaryCollapsed){
      state.summaryCollapsed = false;
      applyCollapseState();
      saveState();
    }
    activateSummaryTab(nextKey);
    if (nextKey === "summary") {
      state.summaryViewMode = "summary";
    }
    const keepSummaryView = state.displayMode === "summary" && nextKey !== "summary";
    setDisplayMode(nextKey === "summary" || keepSummaryView ? "summary" : "detail");
  });
});
summaryContainer?.addEventListener("click", (e) => {
  const target = e.target instanceof HTMLElement ? e.target : null;
  if (!target) return;
  const navButton = target.closest("[data-summary-calendar-nav]");
  if (navButton) {
    const delta = Number(navButton.getAttribute("data-summary-calendar-nav"));
    updateSummaryCalendarMonth(delta);
    return;
  }
  const copyAllButton = target.closest("[data-copy-changed-all]");
  if (copyAllButton) {
    handleCopyButtonClick(copyAllButton, lastChangedChildAllCareText);
    return;
  }
  const typeChangeButton = target.closest("[data-type-change-child-key]");
  if (typeChangeButton) {
    const name = typeChangeButton.getAttribute("data-type-change-name") || "";
    const school = typeChangeButton.getAttribute("data-type-change-school") || "";
    const clazz = typeChangeButton.getAttribute("data-type-change-clazz") || "";
    if (name && school && clazz) {
      openTypeChangeModal({ name, school, clazz });
    }
    return;
  }
  const copyButton = target.closest("[data-copy-child-key]");
  if (copyButton) {
    const key = copyButton.getAttribute("data-copy-child-key") || "";
    handleCopyButtonClick(copyButton, lastChangedChildCareTexts.get(key) || "");
    return;
  }
  const dateCard = target.closest("[data-summary-date-key]");
  if (dateCard) {
    const dateKey = dateCard.getAttribute("data-summary-date-key");
    jumpToDetailDate(dateKey);
    return;
  }
  const nodeAction = target.closest("[data-node-action]");
  if (nodeAction) {
    openDataNodeModal();
  }
});
summaryContainer?.addEventListener("keydown", (e) => {
  const target = e.target instanceof HTMLElement ? e.target : null;
  if (!target) return;
  if (e.key !== "Enter" && e.key !== " ") return;
  const dateCard = target.closest("[data-summary-date-key]");
  if (!dateCard) return;
  e.preventDefault();
  const dateKey = dateCard.getAttribute("data-summary-date-key");
  jumpToDetailDate(dateKey);
});
if (!state.summaryCollapsed){
  activateSummaryTab(state.summaryActiveTab || lastSummaryTab || "summary", { shouldSave: false });
}
detailTabButtons.forEach((btn, idx) => {
  btn.addEventListener("click", () => {
    activateDetailTab(btn.dataset.detailTab || "detail");
  });
  btn.addEventListener("keydown",(e)=>{
    if (e.key !== "ArrowRight" && e.key !== "ArrowLeft") return;
    e.preventDefault();
    const delta = e.key === "ArrowRight" ? 1 : -1;
    const nextIdx = (detailTabButtons.length + idx + delta) % detailTabButtons.length;
    const nextBtn = detailTabButtons[nextIdx];
    nextBtn?.focus();
    activateDetailTab(nextBtn?.dataset.detailTab || "detail");
  });
});
activateDetailTab(state.detailActiveTab || "detail", { shouldSave: false });

saveSettingsBtn.addEventListener("click", () => {
  state.arriveBuffer = clampInt(arriveBufferEl.value, 0, 999);
  state.leaveBuffer  = clampInt(leaveBufferEl.value, 0, 999);
  state.extBuffer    = clampInt(extBufferEl.value, 0, 999);
  state.azJudge      = sanitizeHHMM(azJudgeEl.value) || "15:00";
  state.chargeEarlyExtension = !!chargeEarlyExtensionEl?.checked;
  state.timeSettings = normalizeTimeSettings({
    standard: {
      start: standardStartTimeEl?.value,
      end: standardEndTimeEl?.value
    },
    short: {
      start: shortStartTimeEl?.value,
      end: shortEndTimeEl?.value
    },
    onegou: {
      amStart: onegouAmStartTimeEl?.value,
      amEnd: onegouAmEndTimeEl?.value,
      pmStart: onegouPmStartTimeEl?.value,
      pmEnd: onegouPmEndTimeEl?.value,
      fullStart: onegouFullStartTimeEl?.value,
      fullEnd: onegouFullEndTimeEl?.value
    },
    azukari: {
      amStart: azukariAmStartTimeEl?.value,
      amEnd: azukariAmEndTimeEl?.value,
      pmStart: azukariPmStartTimeEl?.value,
      pmEnd: azukariPmEndTimeEl?.value,
      fullStart: azukariFullStartTimeEl?.value,
      fullEnd: azukariFullEndTimeEl?.value
    }
  });
  state.feeSettings = normalizeFeeSettings({
    azukari: {
      am: azukariFeeAmEl?.value,
      pm: azukariFeePmEl?.value,
      full: azukariFeeFullEl?.value
    },
    extension: {
      standardShort: extFeeStandardShortEl?.value,
      onegouAzukari: extFeeOnegouAzukariEl?.value
    },
    extras: {
      snack: extraSnackFeeEl?.value,
      lunch: extraLunchFeeEl?.value
    }
  });
  state.toastColor = toastColorEl?.value || state.toastColor || DEFAULT_SETTINGS.toastColor;
  const toastSeconds = clampNumber(toastDurationEl?.value, 1, 10, DEFAULT_SETTINGS.toastDuration / 1000);
  state.toastDuration = Math.round(toastSeconds * 1000);
  state.showSaveButton = showSaveButtonEl?.checked ?? state.showSaveButton;
  state.vacationPeriods = normalizeVacationPeriods({
    summer: { start: vacationSummerStartEl?.value || "", end: vacationSummerEndEl?.value || "" },
    winter: { start: vacationWinterStartEl?.value || "", end: vacationWinterEndEl?.value || "" },
    spring: { start: vacationSpringStartEl?.value || "", end: vacationSpringEndEl?.value || "" }
  });
  saveState();
  applyToastColor(state.toastColor, { shouldSave: false });
  applySaveButtonVisibility();
  settingsTool?.classList.remove("open");
  showToast(formatChangeToast("設定", "保存済み"));
  if (lastResult) rerun();
  showToast("設定を保存しました");
});

resetSettingsBtn.addEventListener("click", () => {
  state.arriveBuffer = 0;
  state.leaveBuffer = 0;
  state.extBuffer = 0;
  state.azJudge = "15:00";
  state.chargeEarlyExtension = DEFAULT_SETTINGS.chargeEarlyExtension;
  state.timeSettings = normalizeTimeSettings();
  state.feeSettings = normalizeFeeSettings();
  state.vacationPeriods = normalizeVacationPeriods();
  state.daycardSize = "small";
  state.toastColor = DEFAULT_SETTINGS.toastColor;
  state.toastDuration = DEFAULT_SETTINGS.toastDuration;
  state.showSaveButton = DEFAULT_SETTINGS.showSaveButton;
  saveState();
  applySettingsToInputs();
  applyDaycardSize("small", { shouldSave: false });
  applyToastColor(state.toastColor, { shouldSave: false });
  applySaveButtonVisibility();
  showToast(formatChangeToast("設定", "初期値"));
  if (lastResult) rerun();
  showToast("設定をリセットしました");
});

const applyAzukariLabelSetting = () => {
  state.azukariLabel = (azukariLabelInput?.value || "").trim() || DEFAULT_SETTINGS.azukariLabel;
  saveState();
  if (lastResult) rerun();
  showToast("預かり保育の名称を更新しました");
};
confirmAzukariLabelBtn?.addEventListener("click", () => {
  applyAzukariLabelSetting();
});

/* =========================
   計算コア
========================= */
function isDateInVacationPeriods(dateKey){
  const periods = normalizeVacationPeriods(state.vacationPeriods);
  return Object.values(periods).some(({ start, end }) => {
    const startKey = parseDateInput(start)?.key;
    const endKey = parseDateInput(end)?.key;
    if (!startKey || !endKey) return false;
    const minKey = Math.min(startKey, endKey);
    const maxKey = Math.max(startKey, endKey);
    return dateKey >= minKey && dateKey <= maxKey;
  });
}

function stripTypeOverrides(overrides){
  if (!overrides) return {};
  return Object.fromEntries(Object.entries(overrides).map(([key, value])=>{
    if (!value || typeof value !== "object") return [key, value];
    const { type, ...rest } = value;
    return [key, rest];
  }));
}

function calculate(rows, overridesByKey = state.overridesByKey){
  const calcStart = performance.now();
  logWithCategory("mark", "calculation", `start rows=${rows.length}`);
  const arriveBuf = Number(state.arriveBuffer || 0);
  const leaveBuf  = Number(state.leaveBuffer  || 0);
  const extBuf    = Number(state.extBuffer    || 0);
  const chargeEarlyExtension = state.chargeEarlyExtension !== false;
  const azJudgeMin = parseTimeToMinutes(state.azJudge) ?? (15*60);
  const timeSettings = normalizeTimeSettings(state.timeSettings);
  const feeSettings = normalizeFeeSettings(state.feeSettings);
  const overrides = overridesByKey || {};

  const standardStart = parseTimeToMinutes(timeSettings.standard.start) ?? parseTimeToMinutes(DEFAULT_TIME_SETTINGS.standard.start) ?? 0;
  const standardEnd = parseTimeToMinutes(timeSettings.standard.end) ?? parseTimeToMinutes(DEFAULT_TIME_SETTINGS.standard.end) ?? 0;
  const shortStart = parseTimeToMinutes(timeSettings.short.start) ?? parseTimeToMinutes(DEFAULT_TIME_SETTINGS.short.start) ?? 0;
  const shortEnd = parseTimeToMinutes(timeSettings.short.end) ?? parseTimeToMinutes(DEFAULT_TIME_SETTINGS.short.end) ?? 0;
  const onegouFullStart = parseTimeToMinutes(timeSettings.onegou.fullStart) ?? parseTimeToMinutes(DEFAULT_TIME_SETTINGS.onegou.fullStart) ?? 0;
  const onegouFullEnd = parseTimeToMinutes(timeSettings.onegou.fullEnd) ?? parseTimeToMinutes(DEFAULT_TIME_SETTINGS.onegou.fullEnd) ?? 0;
  const onegouAmStart = parseTimeToMinutes(timeSettings.onegou.amStart) ?? parseTimeToMinutes(DEFAULT_TIME_SETTINGS.onegou.amStart) ?? 0;
  const onegouAmEnd = parseTimeToMinutes(timeSettings.onegou.amEnd) ?? parseTimeToMinutes(DEFAULT_TIME_SETTINGS.onegou.amEnd) ?? 0;
  const onegouPmStart = parseTimeToMinutes(timeSettings.onegou.pmStart) ?? parseTimeToMinutes(DEFAULT_TIME_SETTINGS.onegou.pmStart) ?? 0;
  const onegouPmEnd = parseTimeToMinutes(timeSettings.onegou.pmEnd) ?? parseTimeToMinutes(DEFAULT_TIME_SETTINGS.onegou.pmEnd) ?? 0;
  const azMorningStart = parseTimeToMinutes(timeSettings.azukari.amStart) ?? parseTimeToMinutes(DEFAULT_TIME_SETTINGS.azukari.amStart) ?? 0;
  const azMorningEnd = parseTimeToMinutes(timeSettings.azukari.amEnd) ?? parseTimeToMinutes(DEFAULT_TIME_SETTINGS.azukari.amEnd) ?? 0;
  const azAfternoonStart = parseTimeToMinutes(timeSettings.azukari.pmStart) ?? parseTimeToMinutes(DEFAULT_TIME_SETTINGS.azukari.pmStart) ?? 0;
  const azAfternoonEnd = parseTimeToMinutes(timeSettings.azukari.pmEnd) ?? parseTimeToMinutes(DEFAULT_TIME_SETTINGS.azukari.pmEnd) ?? 0;
  const azFullStart = parseTimeToMinutes(timeSettings.azukari.fullStart) ?? parseTimeToMinutes(DEFAULT_TIME_SETTINGS.azukari.fullStart) ?? 0;
  const azFullEnd = parseTimeToMinutes(timeSettings.azukari.fullEnd) ?? parseTimeToMinutes(DEFAULT_TIME_SETTINGS.azukari.fullEnd) ?? 0;
  const extUnitFeeStandardShort = feeSettings.extension.standardShort;
  const extUnitFeeOnegouAzukari = feeSettings.extension.onegouAzukari;
  const azFees = feeSettings.azukari;

  const details = [];
  const summaryMap = new Map();
  const personMonthMap = new Map();

  let minKey=null, maxKey=null;

  const resolveOnegouPlan = (arrive, leave) => {
    if (arrive == null || leave == null) return "full";
    if (arrive <= onegouFullStart && leave >= onegouFullEnd) return "full";
    if (leave <= onegouAmEnd) return "am";
    if (arrive >= onegouPmStart) return "pm";
    return "full";
  };

  rows.forEach((row, idx) => {
    const rawDate = str(row["日付"]);
    if (!rawDate) return;

    const {year,month,day} = splitYMD(rawDate);
    if (!year || !month || !day) return;
    const monthNum = Number(month);
    const dayNum = Number(day);
    const dateKey = Number(year)*10000 + Number(month)*100 + Number(day);
    minKey = (minKey==null || dateKey<minKey) ? dateKey : minKey;
    maxKey = (maxKey==null || dateKey>maxKey) ? dateKey : maxKey;

    const name   = str(row["名前"]) || `不明(${idx})`;
    const school = str(row["園"]) || "園未設定";
    const clazz  = str(row["所属"]) || "クラス未設定";
    const statusRaw = str(row["出欠"]);
    const dateObj = toDateFromParts(year, month, day);

    // キー（保存用）
    const recKey = makeRecordKey({rawDate, school, clazz, name});
    const o = overrides[recKey] || {};

    // 時刻（CSV→分）
    const baseArrive = parseTimeToMinutes(str(row["登園時刻"]));
    const baseLeave  = parseTimeToMinutes(str(row["降園時刻"]));

    // override時刻
    const effArrive = (o.arriveMinutes!=null) ? o.arriveMinutes : baseArrive;
    const effLeave  = (o.leaveMinutes !=null) ? o.leaveMinutes  : baseLeave;
    const isZeroToZero = (effArrive === 0 && effLeave === 0);

    // バッファ適用（判定用）
    const arriveAdj = (!isZeroToZero && effArrive!=null) ? effArrive + arriveBuf : null;
    const leaveAdj  = (!isZeroToZero && effLeave !=null) ? effLeave  - leaveBuf  : null;
    const hasClockData = (arriveAdj!=null || leaveAdj!=null);
    const closedByCalendar = isWeekend(dateObj) || isJapaneseHoliday(dateObj);

    // 出欠ラベル（表示用）
    let baseAttendStatus = "closed";
    if (statusRaw && /欠/.test(statusRaw)) baseAttendStatus = "absent";
    else if (statusRaw && /登|出|○/.test(statusRaw)) baseAttendStatus = "attend";
    else if (!hasClockData) baseAttendStatus = closedByCalendar ? "closed" : "absent";
    else baseAttendStatus = "attend";

    // 基本区分（デフォは標準、必要ならここを拡張）
    const baseType = o.baseType || "standard";
    const hasManualType = o.type != null;
    let typeKey = hasManualType ? o.type : baseType; // 'standard' | 'short' | '1gou'

    // 1号認定のフル範囲をカバーしているか（自動判定用）
    const coverFullRange = (arriveAdj!=null && leaveAdj!=null && arriveAdj <= azFullStart && leaveAdj >= azFullEnd);
    const autoOnegou = (!hasManualType && baseType === "1gou" && coverFullRange);
    if (autoOnegou) typeKey = "1gou";

    // 休日/欠席/休園でも、長期休暇ONなら登園扱い（1号のみ）
    const allowVacation = typeKey === "1gou";
    const autoVacationMode = (allowVacation && isDateInVacationPeriods(dateKey)) ? "ALL" : null;
    let attendStatus = o.attendStatus || null;
    if (!attendStatus && allowVacation && o.vacationMode){
      attendStatus = vacationModeToStatusKey(o.vacationMode) || null;
    }
    if (!attendStatus && autoVacationMode){
      attendStatus = vacationModeToStatusKey(autoVacationMode) || null;
    }
    if (!attendStatus) attendStatus = baseAttendStatus;
    if (!allowVacation && VACATION_STATUS_KEYS.includes(attendStatus)){
      attendStatus = "attend";
    }
    const vacationMode = allowVacation ? (statusToVacationMode(attendStatus) || null) : null; // null|'ALL'|'AM'|'PM'
    const isVacation = !!vacationMode;
    const statusKind = attendStatus === "absent" ? "absent" : (attendStatus === "closed" ? "closed" : "attend");
    const displayStatusKind = isVacation ? "vacation" : statusKind;
    const attendLabel = STATUS_LABELS[attendStatus] || STATUS_LABELS.attend;

    // 区分ごとの延長基準（今まで通り）
    let baseStart, baseEnd;
    if (typeKey === "short") {
      baseStart=shortStart; baseEnd=shortEnd;
    } else if (typeKey === "1gou") {
      const plan = resolveOnegouPlan(arriveAdj, leaveAdj);
      if (plan === "am") { baseStart = onegouAmStart; baseEnd = onegouAmEnd; }
      else if (plan === "pm") { baseStart = onegouPmStart; baseEnd = onegouPmEnd; }
      else { baseStart = onegouFullStart; baseEnd = onegouFullEnd; }
    } else {
      baseStart=standardStart; baseEnd=standardEnd;
    }

    const extExemptArrive = !!o.extExemptArrive;
    const extExemptLeave = !!o.extExemptLeave;
    const extExemptReasonArrive = str(o.extExemptReasonArrive || "");
    const extExemptReasonLeave = str(o.extExemptReasonLeave || "");
    const computeExtension = (targetStart, targetEnd) => {
      let extMinutes = 0;
      let extEarlyMinutes = 0;
      let extLateMinutes = 0;
      if (statusKind === "attend") {
        const tStart = targetStart - extBuf;
        const tEnd = targetEnd + extBuf;
        const earlyMinutesRaw = (arriveAdj!=null && arriveAdj < tStart) ? (tStart - arriveAdj) : 0;
        const lateMinutesRaw = (leaveAdj!=null && leaveAdj > tEnd) ? (leaveAdj - tEnd) : 0;
        extEarlyMinutes = chargeEarlyExtension ? earlyMinutesRaw : 0;
        extLateMinutes = lateMinutesRaw;
        extMinutes = extEarlyMinutes + extLateMinutes;
      }
      if (extExemptArrive) extEarlyMinutes = 0;
      if (extExemptLeave) extLateMinutes = 0;
      extMinutes = extEarlyMinutes + extLateMinutes;
      const extEarlyUnits = extEarlyMinutes>0 ? Math.ceil(extEarlyMinutes/30) : 0;
      const extLateUnits = extLateMinutes>0 ? Math.ceil(extLateMinutes/30) : 0;
      const extEarlyUnitFee = typeKey === "1gou" ? extUnitFeeOnegouAzukari : extUnitFeeStandardShort;
      const extLateUnitFee = typeKey === "1gou" ? extUnitFeeOnegouAzukari : extUnitFeeStandardShort;
      const extUnits = extEarlyUnits + extLateUnits;
      const extFeeRaw = extEarlyUnits * extEarlyUnitFee + extLateUnits * extLateUnitFee;
      return {
        extMinutes,
        extEarlyMinutes,
        extLateMinutes,
        extEarlyUnits,
        extLateUnits,
        extUnits,
        extEarlyUnitFee,
        extLateUnitFee,
        extFeeRaw
      };
    };
    let {
      extMinutes,
      extEarlyMinutes,
      extLateMinutes,
      extEarlyUnits,
      extLateUnits,
      extUnits,
      extEarlyUnitFee,
      extLateUnitFee,
      extFeeRaw
    } = computeExtension(baseStart, baseEnd);

    // 預り（ここが今回の要件）
    // ただし、長期休暇モード優先
    let azFee = 0;
    let azLabel = "";
    let azMinutes = 0;
    let azAuto = false;
    let azPlanKey = null;
    let displayBaseStart = baseStart;
    let displayBaseEnd = baseEnd;

    if (statusKind === "attend") {
      if (isVacation) {
        if (vacationMode === "ALL") { azFee = azFees.full; azLabel="長期休暇(1日)"; }
        if (vacationMode === "AM")  { azFee = azFees.am; azLabel="長期休暇(午前)"; }
        if (vacationMode === "PM")  { azFee = azFees.pm; azLabel="長期休暇(午後)"; }
        // 分は表示用（なくてもOK）
        if (arriveAdj!=null && leaveAdj!=null) azMinutes = Math.max(0, leaveAdj - arriveAdj);
      } else if (typeKey !== "1gou") {
        // 標準・短時間の日は預かり保育を付与しない
        azFee = 0;
        azLabel = "";
        azMinutes = 0;
        azAuto = false;
      } else if (leaveAdj!=null) {
        // 1号認定のときのみ
        const judgeOn = (leaveAdj >= azJudgeMin);
        const hasMorningRange = arriveAdj!=null && arriveAdj <= azMorningStart && leaveAdj >= azMorningEnd && leaveAdj < azAfternoonStart;
        const hasAfternoonRange = leaveAdj >= azAfternoonStart;
        if (coverFullRange) {
          azFee = azFees.full;
          azLabel = "預り保育（1日/自動）";
          azMinutes = Math.max(0, Math.min(leaveAdj, azFullEnd) - azFullStart);
          azAuto = true;
          azPlanKey = "full";
        } else if (hasAfternoonRange && (judgeOn || leaveAdj >= azAfternoonStart)) {
          azFee = azFees.pm;
          azLabel = "預り保育（午後）";
          azMinutes = Math.max(0, Math.min(leaveAdj, azAfternoonEnd) - azAfternoonStart);
          azPlanKey = "pm";
        } else if (hasMorningRange) {
          azFee = azFees.am;
          azLabel = "預り保育（午前）";
          azMinutes = Math.max(0, Math.min(leaveAdj, azMorningEnd) - azMorningStart);
          azPlanKey = "am";
        }
      }
    }

    if (!isVacation && typeKey === "1gou" && azFee>0 && azPlanKey) {
      let azStart = azFullStart;
      let azEnd = azFullEnd;
      if (azPlanKey === "am") {
        azStart = azMorningStart;
        azEnd = azMorningEnd;
      } else if (azPlanKey === "pm") {
        azStart = azAfternoonStart;
        azEnd = azAfternoonEnd;
      }
      ({
        extMinutes,
        extEarlyMinutes,
        extLateMinutes,
        extEarlyUnits,
        extLateUnits,
        extUnits,
        extEarlyUnitFee,
        extLateUnitFee,
        extFeeRaw
      } = computeExtension(azStart, azEnd));
      displayBaseStart = azStart;
      displayBaseEnd = azEnd;
    }

    const hasExtension = extMinutes > 0;
    let azSuppressedByExt = false;
    let extSuppressedByAz = false;

    // 長期休暇の日は30分200円区分のみ延長料金を加算しない
    const suppressVacationExtension = isVacation && extLateUnitFee === 200;
    if (suppressVacationExtension){
      if (hasExtension || extFeeRaw>0){
        extSuppressedByAz = true;
      }
      extMinutes = 0;
      extEarlyMinutes = 0;
      extLateMinutes = 0;
      extEarlyUnits = 0;
      extLateUnits = 0;
      extUnits = 0;
      extFeeRaw = 0;
    }

    // 合計
    const totalFee = extFeeRaw + azFee;

    // 明細
    const weekday = getWeekdayLabel(`${year}/${month}/${day}`);
    const detail = {
      recordIndex: idx,
      recordKey: recKey,

      name, school, clazz,

      date: `${year}/${month}/${day}`,
      year, month, day, dateKey, weekday,

      attendStatus,
      statusKind,
      displayStatusKind,
      attendLabel,
      typeKey,
      baseType,
      typeLabel: typeKey==="1gou" ? "1号認定" : (typeKey==="short" ? "短時間" : "標準時間"),
      autoOnegou,
      coverFullRange,

      arrive: effArrive!=null ? minutesToTime(effArrive) : "",
      leave:  effLeave !=null ? minutesToTime(effLeave)  : "",
      baseStartTime: minutesToTime(displayBaseStart),
      baseEndTime: minutesToTime(displayBaseEnd),

      // 差分（表示用）
      deltaArrive: (baseArrive!=null && effArrive!=null) ? (effArrive-baseArrive) : 0,
      deltaLeave:  (baseLeave !=null && effLeave !=null) ? (effLeave-baseLeave)   : 0,

      extMinutes,
      extEarlyMinutes,
      extLateMinutes,
      extUnits,
      extEarlyUnits,
      extLateUnits,
      extEarlyUnitFee,
      extLateUnitFee,
      extFee: extFeeRaw,
      extExemptArrive,
      extExemptLeave,
      extExemptReasonArrive,
      extExemptReasonLeave,

      vacationMode,

      azukariMinutes: azMinutes,
      azukariFee: azFee,
      azukariLabel: azLabel,
      azAuto,
      azSuppressedByExt,
      extSuppressedByAz,

      totalFee,

      missingClockData: !hasClockData,
      isSynthesized: false
    };

    details.push(detail);

    // 人×月ごとの日付を記録（欠損日を補うため）
    const pmKey = `${name}__${school}__${clazz}__${year}-${month}`;
    if (!personMonthMap.has(pmKey)) {
      personMonthMap.set(pmKey, {
        name, school, clazz,
        year: Number(year),
        month: monthNum,
        monthLabel: month,
        minDay: dayNum,
        maxDay: dayNum,
        days: new Set()
      });
    }
    const pm = personMonthMap.get(pmKey);
    pm.minDay = Math.min(pm.minDay, dayNum);
    pm.maxDay = Math.max(pm.maxDay, dayNum);
    pm.days.add(dayNum);

    // サマリー（名前×月×園）
    const monthKey = `${year}-${month}`;
    const sumKey = `${name}__${school}__${clazz}__${monthKey}`;
    if (!summaryMap.has(sumKey)){
      summaryMap.set(sumKey, {
        name, school, clazz, month: monthKey,
        extUnitsTotal: 0,
        extFeeRaw: 0,
        extFeeCapped: 0,
        azFeeTotal: 0,
        total: 0,
        noteEntries: [],
        noteRange: null
      });
    }
    const s = summaryMap.get(sumKey);
    s.extUnitsTotal += extUnits;
    s.extFeeRaw += extFeeRaw;
    s.azFeeTotal += azFee;
    // cappedは後で

    if (extMinutes > 0 || azMinutes > 0) {
      const noteTime = (effArrive!=null && effLeave!=null)
        ? `${minutesToTime(effArrive)}〜${minutesToTime(effLeave)}`
        : "";
      const noteLine = `${month}/${day}(${weekday})${noteTime ? ` ${noteTime}` : ""}`;
      s.noteEntries.push({ line: noteLine, dateKey });
      if (!s.noteRange) {
        s.noteRange = { minKey: dateKey, maxKey: dateKey };
      } else {
        s.noteRange.minKey = Math.min(s.noteRange.minKey, dateKey);
        s.noteRange.maxKey = Math.max(s.noteRange.maxKey, dateKey);
      }
    }
  });

  // CSVにない日を月末まで補完
  personMonthMap.forEach(pm=>{
    const daysInMonth = getDaysInMonth(pm.year, pm.month);
    const startDay = pm.minDay ?? 1;
    for(let d=startDay; d<=daysInMonth; d++){
      if(pm.days.has(d)) continue;
      const dayStr = String(d).padStart(2,"0");
      const monthStr = pm.monthLabel || String(pm.month).padStart(2,"0");
      const rawDate = `${pm.year}/${monthStr}/${dayStr}`;
      const dateObj = toDateFromParts(pm.year, monthStr, dayStr);
      const closedByCalendar = isWeekend(dateObj) || isJapaneseHoliday(dateObj);
      const dateKey = pm.year*10000 + pm.month*100 + d;
      const missingStatus = closedByCalendar ? "closed" : "absent";
      const recKey = makeRecordKey({rawDate, school: pm.school, clazz: pm.clazz, name: pm.name});
      const o = overrides[recKey] || {};
      const baseType = o.baseType || "standard";
      const hasManualType = o.type != null;
      const typeKey = hasManualType ? o.type : baseType;
      const allowVacation = typeKey === "1gou";
      let attendStatus = o.attendStatus || missingStatus;
      if (!allowVacation && VACATION_STATUS_KEYS.includes(attendStatus)){
        attendStatus = "attend";
      }
      const statusKind = attendStatus === "absent" ? "absent" : (attendStatus === "closed" ? "closed" : "attend");
      const isVacation = allowVacation && VACATION_STATUS_KEYS.includes(attendStatus);
      const displayStatusKind = isVacation ? "vacation" : statusKind;
      const vacationMode = isVacation ? statusToVacationMode(attendStatus) : null;
      let baseStart, baseEnd;
      if (typeKey === "short") { baseStart=shortStart; baseEnd=shortEnd; }
      else if (typeKey === "1gou") { baseStart=onegouFullStart; baseEnd=onegouFullEnd; }
      else { baseStart=standardStart; baseEnd=standardEnd; }

      const missingDetail = {
        recordIndex: -1,
        recordKey: recKey,

        name: pm.name, school: pm.school, clazz: pm.clazz,

        date: rawDate,
        year: String(pm.year),
        month: monthStr,
        day: dayStr,
        dateKey,
        weekday: getWeekdayLabel(rawDate),

        attendStatus,
        statusKind,
        displayStatusKind,
        attendLabel: STATUS_LABELS[attendStatus] || STATUS_LABELS.attend,
        typeKey,
        baseType,
        typeLabel: typeKey==="1gou" ? "1号認定" : (typeKey==="short" ? "短時間" : "標準時間"),
        autoOnegou: false,
        coverFullRange: false,

        arrive: "",
        leave:  "",
        baseStartTime: minutesToTime(baseStart),
        baseEndTime: minutesToTime(baseEnd),

        // 差分（表示用）
        deltaArrive: 0,
        deltaLeave:  0,

        extMinutes: 0,
        extEarlyMinutes: 0,
        extLateMinutes: 0,
        extUnits: 0,
        extEarlyUnits: 0,
        extLateUnits: 0,
        extEarlyUnitFee: typeKey === "1gou" ? extUnitFeeOnegouAzukari : extUnitFeeStandardShort,
        extLateUnitFee: typeKey === "1gou" ? extUnitFeeOnegouAzukari : extUnitFeeStandardShort,
        extFee: 0,
        extExemptArrive: !!o.extExemptArrive,
        extExemptLeave: !!o.extExemptLeave,
        extExemptReasonArrive: str(o.extExemptReasonArrive || ""),
        extExemptReasonLeave: str(o.extExemptReasonLeave || ""),

        vacationMode,

        azukariMinutes: 0,
        azukariFee: 0,
        azukariLabel: "",
        azAuto: false,
        azSuppressedByExt: false,
        extSuppressedByAz: false,

        totalFee: 0,

        missingClockData: true,
        isSynthesized: true
      };
      details.push(missingDetail);
    }
  });

  // サマリー確定（延長の上限適用）
  const summary = Array.from(summaryMap.values()).map(s=>{
    const capped = Math.min(s.extFeeRaw, MONTHLY_CAP);
    s.extFeeCapped = capped;
    s.total = capped + s.azFeeTotal;
    return s;
  }).sort((a,b)=>
    a.school.localeCompare(b.school,'ja') ||
    a.clazz.localeCompare(b.clazz,'ja') ||
    a.name.localeCompare(b.name,'ja') ||
    a.month.localeCompare(b.month)
  );

  // 詳細ソート（園/クラス/名前/日）
  details.sort((a,b)=>
    a.school.localeCompare(b.school,'ja') ||
    a.clazz.localeCompare(b.clazz,'ja') ||
    a.name.localeCompare(b.name,'ja') ||
    a.dateKey - b.dateKey
  );

  const range = deriveRangeFromDetails(details, { minKey, maxKey });
  updateDateRangeLabel(range);

  const calcDuration = Math.round(performance.now() - calcStart);
  logWithCategory("mark", "calculation", `done details=${details.length} (${calcDuration}ms)`);
  return {summary, details, range};
}

/* =========================
   描画
========================= */
const jumpToDetailDate = (dateKey) => {
  if (!dateKey || !detailContainer) return;
  setDisplayMode("detail", { shouldSave: true });
  activateDetailTab("detail", { shouldSave: false });
  requestAnimationFrame(() => {
    const rowSelector = `tr.detail-row[data-date-key="${cssEscape(String(dateKey))}"]`;
    const rowEl = detailContainer.querySelector(rowSelector);
    if (!rowEl) return;
    rowEl.scrollIntoView({ behavior: "smooth", block: "start", inline: "nearest" });
    const offset = getStickyOffsetHeight();
    if (offset > 0) {
      window.scrollBy({ top: -offset, behavior: "smooth" });
    }
  });
};
const SUMMARY_LOADING_TEXT = "ローディング中…";
let summaryDatasetRenderToken = 0;
let summaryChangedRenderToken = 0;
const buildClassGroupOrder = (details = []) => {
  const groups = [];
  const seen = new Set();
  const addGroup = (schoolValue, classValue) => {
    const school = str(schoolValue) || "園未設定";
    const clazzRaw = str(classValue);
    const clazz = normalizeClassGroupName(clazzRaw) || "クラス未設定";
    const key = `${school}__${clazz}`;
    if (!school && !clazz) return;
    if (seen.has(key)) return;
    seen.add(key);
    groups.push({ school, clazz, key });
  };
  if (Array.isArray(originalRows) && originalRows.length) {
    originalRows.forEach(row => {
      addGroup(row?.["園"], row?.["所属"]);
    });
  }
  if (!groups.length && details?.length) {
    details.forEach(detail => addGroup(detail?.school, detail?.clazz));
  }
  return groups;
};
const getChildOrderForGroup = (school, clazz, details = []) => {
  const csvOrder = getClassChildOrder(school, clazz);
  if (csvOrder.length) return csvOrder;
  const names = uniq(details.filter(d => d.school === school && isSameClassGroup(d.clazz, clazz)).map(d => d.name));
  return names.sort((a, b) => a.localeCompare(b, "ja"));
};
const buildDatasetSummaryRows = (summaryList, details = []) => {
  const groups = buildClassGroupOrder(details);
  const rows = [];
  groups.forEach(group => {
    const childNames = getChildOrderForGroup(group.school, group.clazz, details);
    childNames.forEach(name => {
      rows.push({
        key: childKey({ name, school: group.school, clazz: group.clazz }),
        name,
        school: group.school,
        clazz: group.clazz,
        groupKey: group.key
      });
    });
  });
  return { groups, rows };
};
const updateSummaryDatasetRows = (summaryList, rows, renderToken) => {
  if (!summaryContainer || renderToken !== summaryDatasetRenderToken) return;
  const queue = rows.slice();
  const batchSize = 8;
  const runBatch = () => {
    if (renderToken !== summaryDatasetRenderToken) return;
    const batch = queue.splice(0, batchSize);
    batch.forEach(row => {
      const rowEl = summaryContainer.querySelector(`[data-summary-child-key="${cssEscape(row.key)}"]`);
      if (!rowEl) return;
      const totals = summarizeChildSummary(summaryList, row);
      rowEl.querySelector(".summary-dataset-values").innerHTML = `
        <div class="summary-dataset-value">
          <span class="label">延長</span>
          <span class="value">${esc(formatFee(totals.extFeeCapped))}</span>
        </div>
        <div class="summary-dataset-value">
          <span class="label">預り</span>
          <span class="value">${esc(formatFee(totals.azFeeTotal))}</span>
        </div>
        <div class="summary-dataset-value total">
          <span class="label">合計</span>
          <span class="value">${esc(formatFee(totals.total))}</span>
        </div>
      `;
    });
    if (queue.length) {
      requestAnimationFrame(runBatch);
    }
  };
  requestAnimationFrame(runBatch);
};
const buildChangedChildCalendar = (child, childDetails = [], displayYear, displayMonth) => {
  const detailMap = new Map(childDetails.map(detail => [detail.dateKey, detail]));
  const firstDay = new Date(displayYear, displayMonth - 1, 1);
  const startOffset = firstDay.getDay();
  const gridStart = new Date(displayYear, displayMonth - 1, 1 - startOffset);
  const weekdayLabels = ["日", "月", "火", "水", "木", "金", "土"];
  const cells = Array.from({ length: 35 }).map((_, idx) => {
    const dateObj = new Date(gridStart.getFullYear(), gridStart.getMonth(), gridStart.getDate() + idx);
    const cellYear = dateObj.getFullYear();
    const cellMonth = dateObj.getMonth() + 1;
    const cellDay = dateObj.getDate();
    const dateKey = cellYear * 10000 + cellMonth * 100 + cellDay;
    const detail = detailMap.get(dateKey);
    const isOutside = cellMonth !== displayMonth;
    const typeKey = detail?.typeKey || detail?.baseType || "standard";
    const typeLabelText = detail ? typeLabel(typeKey) : "データなし";
    const typeClass = detail ? `type-${typeKey}` : "is-empty";
    return `
      <div class="summary-changed-calendar-cell ${typeClass} ${isOutside ? "is-outside" : ""}" aria-label="${esc(`${cellMonth}/${cellDay} ${typeLabelText}`)}">
        ${cellDay}
      </div>
    `;
  }).join("");
  return `
    <div class="summary-changed-calendar" aria-label="${esc(child.child_name)}の区分カレンダー">
      <div class="summary-changed-calendar-header">
        <div class="summary-changed-calendar-title">${esc(`${displayYear}年${displayMonth}月`)}</div>
        <div class="summary-changed-calendar-legend">
          <div class="summary-changed-legend-item">
            <span class="summary-changed-legend-chip standard"></span>
            <span>標準時間</span>
          </div>
          <div class="summary-changed-legend-item">
            <span class="summary-changed-legend-chip short"></span>
            <span>短時間</span>
          </div>
          <div class="summary-changed-legend-item">
            <span class="summary-changed-legend-chip onegou"></span>
            <span>1号認定</span>
          </div>
        </div>
      </div>
      <div class="summary-changed-calendar-weekdays">
        ${weekdayLabels.map(label => `<div>${esc(label)}</div>`).join("")}
      </div>
      <div class="summary-changed-calendar-grid">
        ${cells}
      </div>
    </div>
  `;
};
const buildChangedChildCardContent = ({
  child,
  displayYear,
  displayMonth,
  latestChangedTypeEntries,
  isLoading = false
}) => {
  const childTarget = { name: child.child_name, school: child.school, clazz: child.clazz };
  const changeEntry = latestChangedTypeEntries.get(child.child_id);
  const latestDetail = child.details?.[child.details.length - 1];
  const referenceDate = changeEntry?.date || latestDetail?.date || "";
  const isPending = isLoading || child.isPending;
  const currentTypeKey = isPending ? "" : getCsvTypeForTarget(childTarget, referenceDate);
  const nextTypeKey = isPending ? "" : (changeEntry?.toType || getChildTypeKeyForTarget(childTarget, referenceDate));
  const typeBadges = isPending
    ? `
      <div class="summary-changed-type-badges">
        <span class="summary-type-badge is-loading"><span class="label">現在</span>${SUMMARY_LOADING_TEXT}</span>
        <span class="summary-type-badge is-loading"><span class="label">変更後</span>${SUMMARY_LOADING_TEXT}</span>
      </div>
    `
    : `
      <div class="summary-changed-type-badges">
        <span class="summary-type-badge type-${esc(currentTypeKey)}"><span class="label">現在</span>${esc(typeLabel(currentTypeKey))}</span>
        <span class="summary-type-badge type-${esc(nextTypeKey)}"><span class="label">変更後</span>${esc(typeLabel(nextTypeKey))}</span>
      </div>
    `;
  const text = isPending ? "" : formatExtendedCareLines(child.details || []);
  const preview = isPending
    ? SUMMARY_LOADING_TEXT
    : (text || "区分変更の記録がありません。");
  const disabled = isPending || !text;
  const loadingBadge = isPending
    ? `<span class="summary-changed-badge is-loading">${SUMMARY_LOADING_TEXT}</span>`
    : "";
  return {
    text,
    isPending,
    disabled,
    html: `
      <div class="summary-changed-card-body">
        <div class="summary-changed-card-info">
          <div class="summary-changed-card-header">
            <div>
              <div class="summary-changed-card-name">${esc(child.child_name)}</div>
              <div class="summary-changed-card-meta">${esc(child.school)} / ${esc(child.clazz)}</div>
              ${loadingBadge}
              ${typeBadges}
            </div>
            <div class="summary-changed-card-actions">
              <button type="button" class="summary-type-change-btn" data-type-change-child-key="${esc(child.child_id)}" data-type-change-name="${esc(child.child_name)}" data-type-change-school="${esc(child.school)}" data-type-change-clazz="${esc(child.clazz)}"${isPending ? " disabled" : ""}>区分変更</button>
              <button type="button" class="summary-copy-btn primary" data-copy-child-key="${esc(child.child_id)}"${disabled ? " disabled" : ""}>コピー</button>
            </div>
          </div>
          <div class="summary-copy-preview">${esc(preview)}</div>
        </div>
        ${buildChangedChildCalendar(child, child.details || [], displayYear, displayMonth)}
      </div>
    `
  };
};
const updateChangedSummaryCards = ({
  orderedChildren,
  displayYear,
  displayMonth,
  latestChangedTypeEntries,
  renderToken
}) => {
  if (!summaryContainer || renderToken !== summaryChangedRenderToken) return;
  const queue = orderedChildren.slice();
  const batchSize = 3;
  const copyAllButton = summaryContainer.querySelector("[data-copy-changed-all]");
  const updateCopyAllButton = () => {
    const allCopyBlocks = orderedChildren.map(child => {
      const text = lastChangedChildCareTexts.get(child.child_id) || "";
      if (!text) return "";
      return `${child.child_name}\n${text}`;
    }).filter(Boolean);
    lastChangedChildAllCareText = allCopyBlocks.join("\n\n");
    if (copyAllButton) {
      copyAllButton.toggleAttribute("disabled", !lastChangedChildAllCareText);
    }
  };
  const runBatch = () => {
    if (renderToken !== summaryChangedRenderToken) return;
    const batch = queue.splice(0, batchSize);
    batch.forEach(child => {
      const cardEl = summaryContainer.querySelector(`[data-changed-child-key="${cssEscape(child.child_id)}"]`);
      if (!cardEl) return;
      const content = buildChangedChildCardContent({
        child,
        displayYear,
        displayMonth,
        latestChangedTypeEntries,
        isLoading: false
      });
      cardEl.classList.toggle("is-pending", content.isPending);
      cardEl.innerHTML = content.html;
      lastChangedChildCareTexts.set(child.child_id, content.text || "");
    });
    updateCopyAllButton();
    if (queue.length) {
      requestAnimationFrame(runBatch);
    }
  };
  requestAnimationFrame(runBatch);
};
const renderSummaryDataset = (summaryList, details = []) => {
  if (!details?.length) {
    summaryContainer.innerHTML = `<p class="muted">CSVを読み込んでください。</p>`;
    triggerResultAnimation(summaryContainer);
    return;
  }
  const { groups, rows } = buildDatasetSummaryRows(summaryList, details);
  if (!rows.length) {
    summaryContainer.innerHTML = `<p class="muted">該当する園児が見つかりません。</p>`;
    triggerResultAnimation(summaryContainer);
    return;
  }
  const range = deriveRangeFromDetails(details, lastResult?.range || {});
  const rangeLabel = range ? formatRangeLabel(range) : "対象期間：—";
  const groupHtml = groups.map(group => {
    const groupRows = rows.filter(row => row.groupKey === group.key);
    if (!groupRows.length) return "";
    const listHtml = groupRows.map(row => `
      <div class="summary-dataset-row" data-summary-child-key="${esc(row.key)}">
        <div class="summary-dataset-name">${esc(row.name)}</div>
        <div class="summary-dataset-values">
          <span class="summary-dataset-loading">${SUMMARY_LOADING_TEXT}</span>
        </div>
      </div>
    `).join("");
    return `
      <section class="summary-dataset-group">
        <div class="summary-dataset-group-head">
          <span>${esc(group.school)} / ${esc(group.clazz)}</span>
          <span class="summary-dataset-group-meta">${groupRows.length}名</span>
        </div>
        <div class="summary-dataset-list">
          ${listHtml}
        </div>
      </section>
    `;
  }).join("");
  summaryContainer.innerHTML = `
    <div class="summary-dataset">
      <div class="summary-dataset-head">
        <h3 class="summary-dataset-title">サマリー表示（全園児）</h3>
        <div class="summary-dataset-sub">${esc(rangeLabel)}</div>
      </div>
      <div class="summary-dataset-groups">
        ${groupHtml}
      </div>
    </div>
  `;
  triggerResultAnimation(summaryContainer);
  summaryDatasetRenderToken += 1;
  updateSummaryDatasetRows(summaryList, rows, summaryDatasetRenderToken);
  if (!state.summaryCollapsed) {
    requestAnimationFrame(updateSummaryExpandedHeight);
  }
  if (memoHelpersReady) {
    renderMemoNotes();
  }
};
function renderSummary(summary, details = lastResult?.details || []){
  if (!summary?.length){
    summaryContainer.innerHTML = `<p class="muted">データがありません。</p>`;
    triggerResultAnimation(summaryContainer);
    return;
  }
  const isChangedView = state.summaryViewMode === "changed";
  if (isChangedView) {
    if (!details?.length) {
      summaryContainer.innerHTML = `<p class="muted">CSVを読み込んでください。</p>`;
      triggerResultAnimation(summaryContainer);
      return;
    }
    const activeSchool = state.activeSchool || "";
    const activeClass = state.activeClass || "";
    if (!activeSchool || !activeClass) {
      summaryContainer.innerHTML = `<p class="muted">園・クラスを選択してください。</p>`;
      triggerResultAnimation(summaryContainer);
      return;
    }
    const childNames = getClassChildOrder(activeSchool, activeClass);
    if (!childNames.length) {
      summaryContainer.innerHTML = `<p class="muted">該当する園児が見つかりません。</p>`;
      triggerResultAnimation(summaryContainer);
      return;
    }
    const fallbackDetail = details[details.length - 1];
    const displayYear = Number(state.summaryCalendarYear) || Number(fallbackDetail?.year) || new Date().getFullYear();
    const displayMonth = Number(state.summaryCalendarMonth) || Number(fallbackDetail?.month) || new Date().getMonth() + 1;
    const targets = childNames.map(name => ({ name, school: activeSchool, clazz: activeClass }));
    const classChildren = buildClassChildSummaries(details, targets);
    const orderedChildren = classChildren;
    const renderToken = ++summaryChangedRenderToken;
    lastChangedChildCareTexts = new Map();
    lastChangedChildAllCareText = "";
    const latestChangedTypeEntries = getLatestChangedTypeEntriesByChild();
    const changedChildKeys = getChangedChildKeySet();
    const changedCount = orderedChildren.filter(child => changedChildKeys.has(child.child_id)).length;
    const changedCards = orderedChildren.map(child => {
      const content = buildChangedChildCardContent({
        child,
        displayYear,
        displayMonth,
        latestChangedTypeEntries,
        isLoading: true
      });
      return `
        <div class="summary-changed-card is-pending" data-changed-child-key="${esc(child.child_id)}">
          ${content.html}
        </div>
      `;
    }).join("");
    const changedSection = `
      <section class="summary-changed-section">
        <div class="summary-changed-header">
          <div>
            <div class="summary-changed-title">区分変更表示（${esc(activeSchool)} / ${esc(activeClass)}）</div>
            <div class="summary-changed-sub">未変更者も含め、${orderedChildren.length}名を表示中（区分変更あり ${changedCount}名）。</div>
          </div>
          <div class="summary-changed-actions">
            <button type="button" class="primary" data-copy-changed-all disabled>全員分をまとめてコピー</button>
          </div>
        </div>
        <div class="summary-changed-list">
          ${changedCards}
        </div>
      </section>
    `;
    summaryContainer.innerHTML = `
      <div class="summary-changed-only">
        ${changedSection}
      </div>
    `;
    triggerResultAnimation(summaryContainer);
    updateChangedSummaryCards({
      orderedChildren,
      displayYear,
      displayMonth,
      latestChangedTypeEntries,
      renderToken
    });
    return;
  }
  renderSummaryDataset(summary, details);
}

function updateSummaryCalendarMonth(delta){
  if(!Number.isFinite(delta)) return;
  const baseYear = Number(state.summaryCalendarYear);
  const baseMonth = Number(state.summaryCalendarMonth);
  if(!baseYear || !baseMonth) return;
  const next = new Date(baseYear, baseMonth - 1 + delta, 1);
  state.summaryCalendarYear = next.getFullYear();
  state.summaryCalendarMonth = next.getMonth() + 1;
  saveState({ skipNodeSync: true });
  if (lastResult?.summary?.length){
    renderSummary(lastResult.summary, lastResult.details || []);
  } else {
    if (memoHelpersReady) {
      renderMemoNotes();
    }
  }
}

function renderDetails(details){
  const emptyFiltersMessage = `<p class="muted">CSVを読み込んで計算すると、園・クラス・園児の一覧が表示されます。</p>`;
  const feeSettings = normalizeFeeSettings(state.feeSettings);
  const defaultExtensionFee = (typeKey) => typeKey === "1gou"
    ? feeSettings.extension.onegouAzukari
    : feeSettings.extension.standardShort;
  const prevWrapper = detailContainer.querySelector(".detail-table-wrapper");
  const prevScroll = prevWrapper ? { top: prevWrapper.scrollTop, left: prevWrapper.scrollLeft } : null;
  const prevChildScroll = {};
  ["nameButtons", "nameButtonsSchool", "nameButtonsClass"].forEach(id=>{
    const el = document.getElementById(id);
    if (el) prevChildScroll[id] = { top: el.scrollTop, left: el.scrollLeft };
  });

  const getClassesForSchool = (school)=>{
    if(!school) return [];
    const base = uniq(details.filter(d=>d.school===school).map(d=>normalizeClassGroupName(d.clazz)));
    const custom = state.customClasses?.[school] || [];
    return uniq([...base, ...custom]).sort((a,b)=>a.localeCompare(b,'ja'));
  };

  const schools = uniq([
    ...details.map(d=>d.school),
    ...(state.customSchools || [])
  ].filter(Boolean)).sort((a,b)=>a.localeCompare(b,'ja'));

  let activeSchool = state.activeSchool && schools.includes(state.activeSchool) ? state.activeSchool : (schools[0] || "");
  const inSchool = activeSchool ? details.filter(d=>d.school===activeSchool) : [];
  const classes = activeSchool ? getClassesForSchool(activeSchool) : [];
  const normalizedActiveClass = normalizeClassGroupName(state.activeClass);
  let activeClass = normalizedActiveClass && classes.includes(normalizedActiveClass) ? normalizedActiveClass : (classes[0] || "");
  const filtered = activeClass ? inSchool.filter(d=>isSameClassGroup(d.clazz, activeClass)) : [];

  let stateChanged = false;
  if (state.activeSchool !== activeSchool){ state.activeSchool = activeSchool; stateChanged = true; }
  if (state.activeClass !== activeClass){ state.activeClass = activeClass; stateChanged = true; }

  const byName = new Map();
  filtered.forEach(d=>{
    if(!byName.has(d.name)) byName.set(d.name, []);
    byName.get(d.name).push(d);
  });
  const customNames = activeSchool && activeClass
    ? getCustomChildrenForClass(activeSchool, activeClass)
    : [];
  customNames.forEach(n=>{
    if(!byName.has(n)) byName.set(n, []);
  });
  const names = Array.from(byName.keys()).sort((a,b)=>a.localeCompare(b,'ja'));
  ensureLineLinkDefaults(names.map(name => ({ school: activeSchool, clazz: activeClass, name })));
  const defaultName = names[0] || "";
  let activeName = state.activeName && names.includes(state.activeName) ? state.activeName : defaultName;
  const displayActiveName = activeName || "園児未選択";
  if (state.activeName !== activeName){ state.activeName = activeName; stateChanged = true; }
  if (activeName && activeSchool && activeClass) {
    const nextSummaryTarget = { school: activeSchool, clazz: activeClass, name: activeName };
    const prevSummaryTarget = state.summaryLastTarget;
    if (!prevSummaryTarget
      || prevSummaryTarget.school !== nextSummaryTarget.school
      || prevSummaryTarget.clazz !== nextSummaryTarget.clazz
      || prevSummaryTarget.name !== nextSummaryTarget.name) {
      state.summaryLastTarget = nextSummaryTarget;
      stateChanged = true;
    }
  }
  if (stateChanged) saveState();

  const renderAddTab = ()=>{
    if (!addTabContainer) return;
    const customSchools = state.customSchools || [];
    const schoolOptions = schools.length
      ? schools.map(s=>`<option value="${esc(s)}"${s===activeSchool?' selected':''}>${esc(s)}</option>`).join("")
      : `<option value="">園を追加してください</option>`;
    const classOptions = getClassesForSchool(activeSchool);
    const classOptionsHtml = classOptions.length
      ? classOptions.map(c=>`<option value="${esc(c)}"${c===activeClass?' selected':''}>${esc(c)}</option>`).join("")
      : `<option value="">クラスを追加してください</option>`;
    const defaultCustomSchool = customSchools.includes(activeSchool) ? activeSchool : (customSchools[0] || "");
    const customSchoolOptions = customSchools.length
      ? customSchools.map(s=>`<option value="${esc(s)}"${s===defaultCustomSchool?' selected':''}>${esc(s)}</option>`).join("")
      : `<option value="">削除できる園がありません</option>`;
    const deleteClassSchoolOptions = customSchoolOptions;
    const deleteChildSchoolOptions = customSchoolOptions;
    const customClassList = defaultCustomSchool ? (state.customClasses[defaultCustomSchool] || []) : [];
    const customClassOptions = customClassList.length
      ? customClassList.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join("")
      : `<option value="">クラスがありません</option>`;
    const defaultCustomClass = customClassList[0] || "";
    const customChildKey = defaultCustomSchool && defaultCustomClass ? `${defaultCustomSchool}__${defaultCustomClass}` : "";
    const customChildrenList = customChildKey ? (state.customChildren[customChildKey] || []) : [];
    const customChildOptions = customChildrenList.length
      ? customChildrenList.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join("")
      : `<option value="">園児がありません</option>`;

    addTabContainer.innerHTML = `
      <div class="manual-card">
        <label for="manualSchoolName">園を追加</label>
        <div class="manual-row">
          <input id="manualSchoolName" type="text" placeholder="例：おひさま園" aria-label="追加する園名">
          <button type="button" class="small primary" id="addSchoolBtn">追加</button>
        </div>
        <p class="manual-help">新しい園はフィルターとクラス・園児の選択に反映されます。</p>
      </div>
      <div class="manual-card">
        <label for="manualClassName">クラスを追加・削除</label>
        <div class="manual-row">
          <select id="manualClassSchool" aria-label="クラスを追加する園">${schoolOptions}</select>
          <input id="manualClassName" type="text" placeholder="例：さくら組" aria-label="追加するクラス名">
          <button type="button" class="small primary" id="addClassBtn">追加</button>
        </div>
        <div class="manual-row">
          <select id="deleteClassSchool" aria-label="削除する園">${deleteClassSchoolOptions}</select>
          <select id="deleteClassSelect" aria-label="削除するクラス">${customClassOptions}</select>
          <button type="button" class="small danger" id="deleteClassBtn">削除</button>
        </div>
        <p class="manual-help">選択した園にクラスを増やすと、フィルターに表示されます。</p>
      </div>
      <div class="manual-card">
        <label for="manualChildName">園児を追加・削除</label>
        <div class="manual-row">
          <select id="manualChildSchool" aria-label="園児を追加する園">${schoolOptions}</select>
          <select id="manualChildClass" aria-label="園児を追加するクラス">${classOptionsHtml}</select>
          <input id="manualChildName" type="text" placeholder="園児名を入力" aria-label="追加する園児名">
          <button type="button" class="small primary" id="addChildBtn">追加</button>
        </div>
        <div class="manual-row">
          <select id="deleteChildSchool" aria-label="削除する園">${deleteChildSchoolOptions}</select>
          <select id="deleteChildClass" aria-label="削除するクラス"></select>
          <select id="deleteChildSelect" aria-label="削除する園児">${customChildOptions}</select>
          <button type="button" class="small danger" id="deleteChildBtn">削除</button>
        </div>
        <p class="manual-help">新規園児は選択リストに追加されます。</p>
      </div>
    `;

    const manualSchoolInput = addTabContainer.querySelector("#manualSchoolName");
    const addSchoolBtn = addTabContainer.querySelector("#addSchoolBtn");
    const classSchoolSelect = addTabContainer.querySelector("#manualClassSchool");
    const classInput = addTabContainer.querySelector("#manualClassName");
    const addClassBtn = addTabContainer.querySelector("#addClassBtn");
    const childSchoolSelect = addTabContainer.querySelector("#manualChildSchool");
    const childClassSelect = addTabContainer.querySelector("#manualChildClass");
    const childNameInput = addTabContainer.querySelector("#manualChildName");
    const deleteClassBtn = addTabContainer.querySelector("#deleteClassBtn");
    const deleteChildBtn = addTabContainer.querySelector("#deleteChildBtn");
    const deleteClassSchoolSelect = addTabContainer.querySelector("#deleteClassSchool");
    const deleteClassSelect = addTabContainer.querySelector("#deleteClassSelect");
    const deleteChildSchoolSelect = addTabContainer.querySelector("#deleteChildSchool");
    const deleteChildClassSelect = addTabContainer.querySelector("#deleteChildClass");
    const deleteChildSelect = addTabContainer.querySelector("#deleteChildSelect");
    const refreshChildClasses = ()=>{
      const school = childSchoolSelect?.value || activeSchool;
      const options = getClassesForSchool(school);
      if (childClassSelect) {
        if (options.length) {
          childClassSelect.innerHTML = options.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join("");
          if (options.includes(activeClass)) childClassSelect.value = activeClass;
        } else {
          childClassSelect.innerHTML = `<option value="">クラスを追加してください</option>`;
        }
      }
    };

    const refreshDeleteClassOptions = () => {
      const school = deleteClassSchoolSelect?.value || "";
      const classes = (state.customClasses?.[school] || []).slice().sort((a,b)=>a.localeCompare(b,"ja"));
      if(deleteClassSelect){
        deleteClassSelect.innerHTML = classes.length
          ? classes.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join("")
          : `<option value="">削除できるクラスがありません</option>`;
      }
    };
    const refreshDeleteChildOptions = () => {
      const school = deleteChildSchoolSelect?.value || "";
      const classes = (state.customClasses?.[school] || []).slice().sort((a,b)=>a.localeCompare(b,"ja"));
      if(deleteChildClassSelect){
        deleteChildClassSelect.innerHTML = classes.length
          ? classes.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join("")
          : `<option value="">削除できるクラスがありません</option>`;
      }
      const clazz = deleteChildClassSelect?.value || classes[0] || "";
      const key = school && clazz ? `${school}__${clazz}` : "";
      const children = key ? (state.customChildren?.[key] || []).slice().sort((a,b)=>a.localeCompare(b,"ja")) : [];
      if(deleteChildSelect){
        deleteChildSelect.innerHTML = children.length
          ? children.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join("")
          : `<option value="">削除できる園児がありません</option>`;
      }
    };

    deleteClassSchoolSelect?.addEventListener("change", refreshDeleteClassOptions);
    deleteChildSchoolSelect?.addEventListener("change", () => {
      refreshDeleteChildOptions();
    });
    deleteChildClassSelect?.addEventListener("change", refreshDeleteChildOptions);

    addSchoolBtn?.addEventListener("click", ()=>{
      const schoolName = (manualSchoolInput?.value || "").trim();
      if (!schoolName) return;
      const current = state.customSchools || [];
      if (!current.includes(schoolName)) {
        state.customSchools = uniq([...current, schoolName]).sort((a,b)=>a.localeCompare(b,"ja"));
        state.customClasses[schoolName] = state.customClasses[schoolName] || [];
        state.activeSchool = schoolName;
        state.activeClass = state.customClasses[schoolName][0] || "";
        state.activeName = null;
        state.summaryFiltersSelected = true;
        saveState();
      }
      if (manualSchoolInput) manualSchoolInput.value = "";
      renderDetails(details);
      showToast("園を追加しました");
    });

    addClassBtn?.addEventListener("click", ()=>{
      const school = (classSchoolSelect?.value || activeSchool || "").trim();
      const className = (classInput?.value || "").trim();
      if (!school || !className) return;
      const current = state.customClasses[school] || [];
      if (!current.includes(className)) {
        state.customClasses[school] = uniq([...current, className]).sort((a,b)=>a.localeCompare(b,"ja"));
        if (!state.customSchools.includes(school)) {
          state.customSchools = uniq([...(state.customSchools || []), school]).sort((a,b)=>a.localeCompare(b,"ja"));
        }
        state.activeSchool = school;
        state.activeClass = className;
        state.activeName = null;
        state.summaryFiltersSelected = true;
        saveState();
      }
      if (classInput) classInput.value = "";
      renderDetails(details);
      showToast("クラスを追加しました");
    });

    addChildBtn?.addEventListener("click", ()=>{
      const school = (childSchoolSelect?.value || activeSchool || "").trim();
      const clazz = (childClassSelect?.value || activeClass || "").trim();
      const name = (childNameInput?.value || "").trim();
      if (!school || !clazz || !name) return;
      const key = `${school}__${clazz}`;
      const current = state.customChildren[key] || [];
      if (!current.includes(name)) {
        state.customChildren[key] = uniq([...current, name]).sort((a,b)=>a.localeCompare(b,"ja"));
        if (!state.customSchools.includes(school)) {
          state.customSchools = uniq([...(state.customSchools || []), school]).sort((a,b)=>a.localeCompare(b,"ja"));
        }
        state.activeSchool = school;
        state.activeClass = clazz;
        state.activeName = name;
        state.summaryFiltersSelected = true;
        saveState();
      }
      if (childNameInput) childNameInput.value = "";
      renderDetails(details);
      showToast("園児を追加しました");
    });

    deleteClassBtn?.addEventListener("click", ()=>{
      const school = (deleteClassSchoolSelect?.value || "").trim();
      const clazz = (deleteClassSelect?.value || "").trim();
      if (!school || !clazz) return;
      const current = state.customClasses?.[school] || [];
      if (!current.includes(clazz)){
        alert("追加データのクラスが見つかりませんでした。");
        return;
      }
      if (!confirm(`${school} / ${clazz} を削除しますか？`)) return;
      const key = `${school}__${clazz}`;
      state.customClasses[school] = current.filter(c=>c !== clazz);
      delete state.customChildren[key];
      if (state.activeClass === clazz && state.activeSchool === school){
        state.activeClass = null;
        state.activeName = null;
      }
      renderDetails(details);
      showToast("クラスを削除しました");
    });

    deleteChildBtn?.addEventListener("click", ()=>{
      const school = (deleteChildSchoolSelect?.value || "").trim();
      const clazz = (deleteChildClassSelect?.value || "").trim();
      const name = (deleteChildSelect?.value || "").trim();
      if (!school || !clazz || !name) return;
      const key = `${school}__${clazz}`;
      const current = state.customChildren?.[key] || [];
      if (!current.includes(name)){
        alert("追加データの園児が見つかりませんでした。");
        return;
      }
      if (!confirm(`${school} / ${clazz} / ${name} を削除しますか？`)) return;
      state.customChildren[key] = current.filter(n=>n !== name);
      if (state.activeName === name && state.activeSchool === school && state.activeClass === clazz){
        state.activeName = null;
      }
      renderDetails(details);
      showToast("園児を削除しました");
    });

    childSchoolSelect?.addEventListener("change", refreshChildClasses);
    refreshChildClasses();
    refreshDeleteClassOptions();
    refreshDeleteChildOptions();
  };

  renderAddTab();

  if (!details.length){
    detailContainer.innerHTML = `<p class="muted">データがありません。</p>`;
    triggerResultAnimation(detailContainer);
    if (filterContainerSchool) filterContainerSchool.innerHTML = emptyFiltersMessage;
    if (filterContainerClass) filterContainerClass.innerHTML = emptyFiltersMessage;
    if (filterContainerChildClass) filterContainerChildClass.innerHTML = emptyFiltersMessage;
    if (filterContainerChild) filterContainerChild.innerHTML = emptyFiltersMessage;
    updateLineIntegrationPanel(null);
    updateBulkMenuContext({});
    return;
  }

  const schoolButtons = schools.map(s=>{
    const isActive = s===activeSchool;
    return `<button type="button" class="filter-chip ${isActive?'active':''}" data-school="${esc(s)}">${esc(s)}</button>`;
  }).join("");
  const classButtons = classes.map(c=>{
    const isActive = c===activeClass;
    return `<button type="button" class="filter-chip ${isActive?'active':''}" data-class="${esc(c)}">${esc(c)}</button>`;
  }).join("");
  const changedChildKeys = getChangedChildKeySet();
  const nameButtons = names.map(n=>{
    const isActive = n===activeName;
    const childTarget = { school: activeSchool, clazz: activeClass, name: n };
    const typeKey = getChildTypeKeyForTarget(childTarget);
    const changed = changedChildKeys.has(childKey(childTarget));
    const notifyState = getLineLinkStatusCache(childKey(childTarget));
    const lineLinked = getLineLinkedDisplayState(childKey(childTarget), notifyState);
    const unreadCount = notifyState?.unread_count ?? 0;
    const hasReply = lineLinked && !!notifyState?.thread_id && unreadCount === 0;
    const chatEnabled = !!notifyState?.thread_id;
    const lineIcon = lineLinked ? `<span class="child-chip-icon line" aria-hidden="true">OK</span><span class="sr-only">連携済み</span>` : "";
    const chatIcon = chatEnabled ? `<span class="child-chip-icon chat" aria-hidden="true">🗨️</span><span class="sr-only">通知スレッドあり</span>` : "";
    const okIcon = hasReply ? `<span class="child-chip-icon ok" aria-hidden="true">OK</span><span class="sr-only">既読済み</span>` : "";
    const indicator = changed ? `<span class="change-indicator" aria-hidden="true">有</span><span class="sr-only">区分変更済み</span>` : "";
    const statusIcons = [lineIcon, chatIcon, okIcon, indicator].filter(Boolean).join("");
    return `
      <button type="button" class="filter-chip child-chip type-${esc(typeKey)} ${isActive ? "active" : ""}" data-name="${esc(n)}">
        <span>${esc(n)}</span>
        ${statusIcons ? `<span class="child-chip-icons">${statusIcons}</span>` : ""}
      </button>
    `;
  }).join("");

  const selectedList = activeName ? (byName.get(activeName) || []) : [];
  updateBulkMenuContext({
    name: activeName,
    referenceDate: selectedList[0]?.date || "",
    school: activeSchool,
    clazz: activeClass
  });

  const rowHtml = selectedList.map(item=>{
    const hasClockData = !item.missingClockData;
    const statusCls = item.displayStatusKind || item.statusKind || (item.attendLabel==="登園" ? "attend" : (item.attendLabel==="欠園" ? "absent" : "closed"));
    const missingCls = item.missingClockData ? "missing" : "";
    const cardMissingCls = item.missingClockData ? "missing-clock" : "";
    const rowMissingCls = item.missingClockData ? "missing-clock" : "";
    const cardType = item.azukariFee>0 ? "type-1gou" : (item.typeKey==="1gou" ? "type-1gou" : (item.typeKey==="short" ? "type-short" : "type-standard"));
    const displayType = item.azukariFee>0 ? "1号認定" : (item.typeKey==="1gou" ? "1号認定" : (item.typeKey==="short" ? "短時間" : "標準時間"));
    const statusChipClass = `day-chip status-chip ${statusCls} ${missingCls}`;
    const typeChipClass = `day-chip type-chip ${cardType}`;
    const typeChipAttrs = `data-rk="${esc(item.recordKey)}" data-type="${esc(item.typeKey)}" role="button" tabindex="0" aria-label="${esc(displayType)}（タップで切替）"`;
    const statusCycle = getStatusCycleForRecord({ typeKey: item.typeKey, hasClockData });
    const statusCycleText = describeStatusCycle(statusCycle, { hasClockData });
    const isStatusLocked = statusCycle.length <= 1;
    const statusChipAttrs = `data-rk="${esc(item.recordKey)}" data-type="${esc(item.typeKey)}" data-status="${esc(item.attendStatus)}" ${isStatusLocked ? `aria-disabled="true"` : ""} role="button" tabindex="0" aria-label="${esc(item.attendLabel)}（${esc(statusCycleText)}）" title="${esc(statusCycleText)}"`;
    const buildExemptReasonText = (target) => {
      const parts = [];
      if (target.extExemptArrive) {
        const reason = target.extExemptReasonArrive || "未設定";
        parts.push(`登園 ${reason}`);
      }
      if (target.extExemptLeave) {
        const reason = target.extExemptReasonLeave || "未設定";
        parts.push(`降園 ${reason}`);
      }
      return parts.join(" / ");
    };
    const extUnitParts = [];
    if (item.extEarlyUnits > 0) {
      const earlyRate = item.extEarlyUnitFee || defaultExtensionFee(item.typeKey);
      extUnitParts.push(`早朝 ${earlyRate.toLocaleString()}円×${item.extEarlyUnits}単位 (${item.extEarlyMinutes}分)`);
    }
    if (item.extLateUnits > 0) {
      const lateRate = item.extLateUnitFee || defaultExtensionFee(item.typeKey);
      extUnitParts.push(`延長 ${lateRate.toLocaleString()}円×${item.extLateUnits}単位 (${item.extLateMinutes}分)`);
    }
    const hasExempt = item.extExemptArrive || item.extExemptLeave;
    const exemptReasonText = buildExemptReasonText(item);
    const exemptReasonInline = exemptReasonText ? `（${esc(exemptReasonText)}）` : "";
    const extUnitText = extUnitParts.length ? extUnitParts.join(" / ") : (hasExempt && item.extMinutes===0 ? "免除" : "延長なし");
    const extValueText = (hasExempt && item.extMinutes===0)
      ? `免除${exemptReasonInline}`
      : (item.extMinutes>0 ? `${item.extMinutes}分 → ${item.extFee.toLocaleString()}円` : "延長なし");
    const canExemptArrive = item.extEarlyUnits > 0 || item.extExemptArrive;
    const canExemptLeave = item.extLateUnits > 0 || item.extExemptLeave;
    const isNoClockStatus = item.statusKind === "absent" || item.statusKind === "closed";
    const arriveBadgeTime = isNoClockStatus ? "--:--" : (item.arrive ? item.arrive : "--:--");
    const leaveBadgeTime = isNoClockStatus ? "--:--" : (item.leave ? item.leave : "--:--");
    const arriveInputValue = isNoClockStatus ? "--:--" : (item.arrive || "");
    const leaveInputValue = isNoClockStatus ? "--:--" : (item.leave || "");
    const baseStartTime = item.baseStartTime || "--:--";
    const baseEndTime = item.baseEndTime || "--:--";
    const arriveBadgesHtml = `
      <div class="time-badges">
        <span class="time-badge strong">登園 ${esc(arriveBadgeTime)}</span>
        <span class="time-badge">開始 ${esc(baseStartTime)}</span>
      </div>
    `;
    const leaveBadgesHtml = `
      <div class="time-badges">
        <span class="time-badge strong">降園 ${esc(leaveBadgeTime)}</span>
        <span class="time-badge">終了 ${esc(baseEndTime)}</span>
      </div>
    `;
    const extNoteInline = item.extSuppressedByAz && !hasExempt ? `<span class="note note-inline">預かり・長期休暇のため未加算</span>` : ``;
    const azNoteInline = item.azSuppressedByExt ? `<span class="note note-inline">延長ありのため未加算</span>` : ``;
    const azMeta = item.azukariFee>0 ? `${item.azukariMinutes || 0}分` : "0分";
    const extBaseStart = item.extBaseStartTime || "";
    const extBaseEnd = item.extBaseEndTime || "";
    const arriveMinutes = parseTimeToMinutes(item.arrive);
    const leaveMinutes = parseTimeToMinutes(item.leave);
    const extStartMinutes = parseTimeToMinutes(extBaseStart);
    const extEndMinutes = parseTimeToMinutes(extBaseEnd);
    const extBadges = [];
    if (item.extFee > 0){
      if (extBaseStart && arriveMinutes!=null && extStartMinutes!=null && arriveMinutes < extStartMinutes){
        extBadges.push(`<span class="bubble">${esc(item.arrive)}〜${esc(extBaseStart)}</span>`);
      }
      if (extBaseEnd && leaveMinutes!=null && extEndMinutes!=null && leaveMinutes > extEndMinutes){
        extBadges.push(`<span class="bubble">${esc(extBaseEnd)}〜${esc(item.leave)}</span>`);
      }
    }
    const extMetaBadges = item.extFee>0
      ? `<span class="bubble">${extUnitText}</span>${extBadges.length ? extBadges.join("") : ""}`
      : `<span class="muted">延長なし</span>`;
    const calcStack = `
      <div class="calc-stack">
        <div class="calc-chip ${item.azukariFee>0 ? '' : 'off'}" data-float="azukari">
          <div class="title">預かり保育</div>
          <div class="value">${item.azukariFee>0 ? `${esc(item.azukariLabel || azukariName)} / ${item.azukariFee.toLocaleString()}円` : "預かりなし"}</div>
          <div class="meta">
            <span class="bubble">${azMeta}</span>
            ${item.azAuto ? `<span class="bubble">自動判定</span>` : ``}
            ${azNoteInline}
          </div>
        </div>
        <div class="calc-chip ${item.extMinutes>0 ? '' : 'off'}" data-float="ext">
          <div class="title">延長保育</div>
          <div class="value">${extValueText}${extNoteInline ? ` ${extNoteInline}` : ""}</div>
          <div class="meta">
            <span class="bubble">${extUnitText}</span>
            ${exemptReasonText ? `<span class="bubble">免除理由: ${esc(exemptReasonText)}</span>` : ""}
          </div>
        </div>
      </div>
    `;

    return `
      <tr class="detail-row ${rowMissingCls}" data-index="${item.recordIndex}" data-date-key="${esc(item.dateKey ?? "")}" data-rk="${esc(item.recordKey)}" data-type="${esc(item.typeKey)}" data-status="${esc(item.attendStatus)}" data-has-clock="${hasClockData ? "1" : "0"}">
        <td class="col-day">
          <div class="daycard ${cardType} status-${statusCls} ${cardMissingCls}">
            <div class="dc-head">
              <div class="dc-date-wrap">
                <div class="dc-week">${esc(item.weekday)}</div>
                <div class="dc-date">${esc(item.day)}</div>
              </div>
              <button type="button" class="row-reset-btn" data-rk="${esc(item.recordKey)}" aria-label="この行の入力をリセット">↺</button>
            </div>
            <div class="day-actions">
              <div class="day-status-line">
                <div class="${statusChipClass} ${isStatusLocked ? "locked" : ""}" ${statusChipAttrs}>${esc(item.attendLabel)}</div>
              </div>
              <div class="day-action-row">
                <button type="button" class="${typeChipClass}" ${typeChipAttrs}>${esc(displayType)}</button>
              </div>
            </div>
          </div>
        </td>
        <td class="col-time">
          <div class="time-cell" data-rk="${esc(item.recordKey)}" data-field="arrive">
            <div class="time-input-row">
              <input class="time-input arriveInput" data-rk="${esc(item.recordKey)}" data-original="${esc(arriveInputValue)}" value="${esc(arriveInputValue)}" placeholder="HH:MM">
              <div class="diff">${formatDiff(item.deltaArrive)}</div>
              <button type="button" class="time-btn exempt-btn ${item.extExemptArrive ? "is-active" : ""}" data-exempt="1" aria-pressed="${item.extExemptArrive ? "true" : "false"}" aria-disabled="${canExemptArrive ? "false" : "true"}" ${canExemptArrive ? "" : "disabled"}>免除</button>
            </div>
            <div class="time-buttons" data-rk="${esc(item.recordKey)}" data-field="arrive">
              <button type="button" class="time-btn minus5 time-adjust-btn" data-delta="-5">-5</button>
              <button type="button" class="time-btn plus5 time-adjust-btn" data-delta="5">+5</button>
              <button type="button" class="time-btn minus1 time-adjust-btn" data-delta="-1">-1</button>
              <button type="button" class="time-btn plus1 time-adjust-btn" data-delta="1">+1</button>
            </div>
            ${arriveBadgesHtml}
          </div>
        </td>
        <td class="col-time">
          <div class="time-cell" data-rk="${esc(item.recordKey)}" data-field="leave">
            <div class="time-input-row">
              <input class="time-input leaveInput" data-rk="${esc(item.recordKey)}" data-original="${esc(leaveInputValue)}" value="${esc(leaveInputValue)}" placeholder="HH:MM">
              <div class="diff">${formatDiff(item.deltaLeave)}</div>
              <button type="button" class="time-btn exempt-btn ${item.extExemptLeave ? "is-active" : ""}" data-exempt="1" aria-pressed="${item.extExemptLeave ? "true" : "false"}" aria-disabled="${canExemptLeave ? "false" : "true"}" ${canExemptLeave ? "" : "disabled"}>免除</button>
            </div>
            <div class="time-buttons" data-rk="${esc(item.recordKey)}" data-field="leave">
              <button type="button" class="time-btn minus5 time-adjust-btn" data-delta="-5">-5</button>
              <button type="button" class="time-btn plus5 time-adjust-btn" data-delta="5">+5</button>
              <button type="button" class="time-btn minus1 time-adjust-btn" data-delta="-1">-1</button>
              <button type="button" class="time-btn plus1 time-adjust-btn" data-delta="1">+1</button>
            </div>
            ${leaveBadgesHtml}
          </div>
        </td>
        <td class="calc-col">
          <div class="calc-stack-wrapper is-open" data-rk="${esc(item.recordKey)}">
            ${calcStack}
          </div>
        </td>
        <td class="col-total"><b>${item.totalFee.toLocaleString()}円</b></td>
      </tr>
    `;
  }).join("");
  const canCreateBlankRecords = !!(activeName && activeSchool && activeClass && details.length);
  const emptyActionHtml = canCreateBlankRecords ? `
          <div class="empty-actions">
            <button type="button" class="small primary" id="createBlankRecordsBtn">新規作成</button>
            <div class="muted">読み込んだ期間の打刻を空で追加します。</div>
          </div>
  ` : "";
  const displayActiveSchool = activeSchool || "園未選択";
  const displayActiveClass = activeClass || "クラス未選択";
  if (detailMetaSchoolEl) detailMetaSchoolEl.textContent = displayActiveSchool;
  if (detailMetaClassEl) detailMetaClassEl.textContent = displayActiveClass;
  if (detailMetaChildEl) detailMetaChildEl.textContent = displayActiveName;
  updateLineIntegrationPanel(activeName ? { school: activeSchool, clazz: activeClass, name: activeName } : null);
  const emptyRowHtml = `
      <tr class="detail-row">
        <td colspan="5" style="text-align:center; background:var(--panel-sub);" class="muted">
          ${esc(displayActiveClass)} / ${esc(displayActiveName)} の記録がまだありません。
          ${emptyActionHtml}
        </td>
      </tr>
    `;

  const schoolHtml = schools.length ? `
    <div class="filter-buttons grid" id="schoolButtons">${schoolButtons}</div>
  ` : ``;
  const buildClassHtml = (id) => classes.length ? `
    <div class="filter-buttons grid" id="${id}">${classButtons}</div>
  ` : ``;
  const buildChildHtml = (id) => names.length ? `
    <div class="filter-buttons scrollable grid" id="${id}">${nameButtons}</div>
  ` : ``;
  const childHtml = buildChildHtml("nameButtons");
  const fallbackChildHtml = childHtml || emptyFiltersMessage;
  const schoolPaneHtml = schoolHtml || emptyFiltersMessage;
  const classPaneHtml = buildClassHtml("classButtons") || emptyFiltersMessage;
  const childClassPaneHtml = buildClassHtml("childClassButtons") || emptyFiltersMessage;

  if (filterContainerSchool) filterContainerSchool.innerHTML = schoolPaneHtml;
  if (filterContainerClass) filterContainerClass.innerHTML = classPaneHtml;
  if (filterContainerChildClass) filterContainerChildClass.innerHTML = childClassPaneHtml;
  if (filterContainerChild) filterContainerChild.innerHTML = childHtml;

  detailContainer.innerHTML = `
    <div class="table-scroll detail-table-wrapper">
      <table class="detail-table">
        <thead>
          <tr>
            <th class="col-day">日 / 区分</th>
            <th class="col-time">登園</th>
            <th class="col-time">降園</th>
            <th class="calc-col">預かり/延長 内訳</th>
            <th class="col-total">合計</th>
          </tr>
        </thead>
        <tbody>${selectedList.length ? rowHtml : emptyRowHtml}</tbody>
      </table>
    </div>
  `;
  triggerResultAnimation(detailContainer);
  const nextWrapper = detailContainer.querySelector(".detail-table-wrapper");
  if (prevScroll && nextWrapper){
    nextWrapper.scrollTop = prevScroll.top;
    nextWrapper.scrollLeft = prevScroll.left;
  }
  Object.entries(prevChildScroll).forEach(([id, pos])=>{
    const el = document.getElementById(id);
    if (!el) return;
    el.scrollTop = pos.top;
    el.scrollLeft = pos.left;
  });

  const createBlankBtn = detailContainer.querySelector("#createBlankRecordsBtn");
  createBlankBtn?.addEventListener("click", ()=>{
    createBlankRecordsForActiveSelection();
  });

  const schoolButtonsEl = filterContainerSchool?.querySelector("#schoolButtons");
  schoolButtonsEl?.querySelectorAll(".filter-chip").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const nextSchool = btn.dataset.school;
      if(!nextSchool) return;
      if (state.activeSchool === nextSchool) return;
      state.activeSchool = nextSchool;
      const nextClasses = getClassesForSchool(nextSchool);
      state.activeClass = nextClasses.includes(state.activeClass) ? state.activeClass : nextClasses[0] || null;
      state.activeName = null;
      state.summaryFiltersSelected = true;
      saveState();
      showToast(formatChangeToast("園", nextSchool));
      renderDetails(details);
    });
  });
  const attachClassButtonHandlers = (container) => {
    container?.querySelectorAll(".filter-chip").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const nextClass = btn.dataset.class || null;
        if (state.activeClass === nextClass) return;
        state.activeClass = nextClass;
        state.activeName = null;
        state.summaryFiltersSelected = true;
        saveState();
        showToast(formatChangeToast("クラス", nextClass));
        renderDetails(details);
      });
    });
  };
  const classButtonsEl = filterContainerClass?.querySelector("#classButtons");
  attachClassButtonHandlers(classButtonsEl);
  const childClassButtonsEl = filterContainerChildClass?.querySelector("#childClassButtons");
  attachClassButtonHandlers(childClassButtonsEl);
  const attachNameButtonHandlers = (container)=>{
    container?.querySelectorAll(".filter-chip").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const nextName = btn.dataset.name || null;
        if(!nextName) return;
        const isSame = state.activeName === nextName;
        const childTarget = { school: state.activeSchool, clazz: state.activeClass, name: nextName };
        if (!isSame) {
          state.activeName = nextName;
          state.summaryFiltersSelected = true;
          saveState();
          showToast(formatChildChangeToast(nextName, "表示", "選択中"), { groupKey: childKey(childTarget) });
          renderDetails(details);
          requestAnimationFrame(() => {
            const selector = `#nameButtons .filter-chip[data-name="${CSS.escape(nextName)}"]`;
            const nextBtn = filterContainerChild?.querySelector(selector) || btn;
            showChildNotifyBubble(childTarget, nextBtn);
          });
          return;
        }
        showChildNotifyBubble(childTarget, btn);
      });
    });
  };
  attachNameButtonHandlers(filterContainerChild?.querySelector("#nameButtons"));

  // フワフワ演出
  detailContainer.querySelectorAll(".calc-chip").forEach(chip=>{
    chip.addEventListener("click", ()=>{
      chip.classList.remove("is-floating");
      // reflow for restart animation
      void chip.offsetWidth;
      chip.classList.add("is-floating");
    });
  });

  detailContainer.querySelectorAll(".status-chip").forEach(chip=>{
    const rk = chip.dataset.rk;
    const handleToggle = ()=>{
      const isLocked = chip.classList.contains("locked") || chip.getAttribute("aria-disabled")==="true";
      if (isLocked) return;
      cycleAttendStatus(rk);
    };
    chip.addEventListener("click", handleToggle);
    chip.addEventListener("keydown",(e)=>{
      if(e.key==="Enter" || e.key===" "){
        e.preventDefault();
        handleToggle();
      }
    });
  });

  // 日カードの区分チップでサイクル切替（標準 → 短時間 → 1号認定）
  detailContainer.querySelectorAll(".day-chip.type-chip").forEach(chip=>{
    chip.addEventListener("click", ()=>{
      const rk = chip.dataset.rk;
      const current = chip.dataset.type || chip.closest("tr")?.dataset.type || "standard";
      applyTypeSelection(rk, getNextTypeKey(current));
    });
    chip.addEventListener("keydown",(e)=>{
      if(e.key==="Enter" || e.key===" "){
        e.preventDefault();
        chip.click();
      }
    });
  });

  // 時刻入力（enter/blurで反映）
  detailContainer.querySelectorAll(".arriveInput").forEach(inp=>{
    inp.addEventListener("change", ()=>applyTimeEdit(inp, "arrive"));
    inp.addEventListener("blur", ()=>applyTimeEdit(inp, "arrive"));
  });
  detailContainer.querySelectorAll(".leaveInput").forEach(inp=>{
    inp.addEventListener("change", ()=>applyTimeEdit(inp, "leave"));
    inp.addEventListener("blur", ()=>applyTimeEdit(inp, "leave"));
  });

  // 行選択の見た目
  const rowEls = detailContainer.querySelectorAll("tr.detail-row");
  const selectRowByKey = (rk)=>{
    rowEls.forEach(r=>{
      if(r.dataset.rk===rk) r.classList.add("row-selected");
      else r.classList.remove("row-selected");
    });
  };

  // 時刻調整ボタン
  detailContainer.querySelectorAll(".time-adjust-btn").forEach(btn=>{
    btn.addEventListener("click",(e)=>{
      e.stopPropagation();
      const wrap = btn.closest(".time-buttons");
      if(!wrap) return;
      const rk = wrap.dataset.rk;
      const field = wrap.dataset.field;
      adjustTime(rk, field, Number(btn.dataset.delta||0));
      selectRowByKey(rk);
    });
  });

  detailContainer.querySelectorAll(".exempt-btn").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      e.stopPropagation();
      const cell = btn.closest(".time-cell");
      if (!cell) return;
      const rk = cell.dataset.rk;
      const field = cell.dataset.field;
      openExemptReasonModal({ recordKey: rk, field });
      selectRowByKey(rk);
    });
  });

  // 行リセット
  detailContainer.querySelectorAll(".row-reset-btn").forEach(btn=>{
    btn.addEventListener("click",(e)=>{
      e.stopPropagation();
      const rk = btn.dataset.rk;
      if(!rk) return;
      delete state.overridesByKey[rk];
      saveState();
      rerun();
    });
  });

  if (lastResult?.summary?.length) {
    renderSummary(lastResult.summary, lastResult.details || details);
  }
  if (memoHelpersReady) {
    renderMemoNotes();
  }
  renderTypeChangeHistory();

}

function renderUsageGuide(){
  if (detailContainer) detailContainer.textContent = usageGuideMessage;
  renderTypeChangeHistory();
}

/* =========================
   便利関数
========================= */
function getNextTypeKey(currentType = "standard"){
  const order = TYPE_CYCLE_ORDER;
  const idx = order.indexOf(currentType);
  if(idx === -1) return order[0];
  return order[(idx + 1) % order.length];
}

function setTypeOverride(recordKey, type){
  if(!recordKey || !type) return;
  const o = state.overridesByKey[recordKey] || {};
  o.type = type;
  if (type !== "1gou") {
    delete o.vacationMode;
    if (o.attendStatus && VACATION_STATUS_KEYS.includes(o.attendStatus)){
      o.attendStatus = "attend";
    }
  }
  state.overridesByKey[recordKey] = o;
}

function applyTypeSelection(recordKey, type){
  const detail = getDetailByRecordKey(recordKey);
  const currentType = detail?.typeKey || detail?.baseType || "standard";
  if (currentType !== type){
    const info = parseRecordKey(recordKey);
    const target = {
      name: detail?.name || info.name,
      school: detail?.school || info.school,
      clazz: detail?.clazz || info.clazz
    };
    const startDateKey = detail?.dateKey || getReferenceDateKey(detail?.date || info.rawDate);
    recordTypeChangeHistory({ target, startDateKey, toType: type });
    showToast(formatChildChangeToast(target.name || "園児", "区分", typeLabel(type)), { groupKey: childKey(target) });
  }
  setTypeOverride(recordKey, type);
  saveState();
  rerun();
}

function getStatusCycle(typeKey = "standard"){
  return typeKey === "1gou" ? STATUS_CYCLE_1GOU : STATUS_CYCLE_DEFAULT;
}

function getStatusCycleForRecord({ typeKey = "standard", hasClockData = false } = {}){
  const baseCycle = getStatusCycle(typeKey);
  if (!hasClockData) return baseCycle.filter(key => key === "absent" || key === "closed");
  if (typeKey === "1gou") {
    return STATUS_CYCLE_1GOU.filter(key => key === "attend" || key.startsWith("vacation-"));
  }
  return ["attend"];
}

function describeStatusCycle(cycle = [], { hasClockData = false } = {}){
  if (!cycle || !cycle.length) return "";
  if (cycle.length === 1){
    if (hasClockData && cycle[0] === "attend") return "打刻データあり: 登園固定";
    return STATUS_LABELS[cycle[0]] || cycle[0];
  }
  return cycle.map(k=>STATUS_LABELS[k] || k).join(" → ");
}

function getDetailByRecordKey(recordKey){
  if(!recordKey || !lastResult?.details?.length) return null;
  return lastResult.details.find(d=>d.recordKey===recordKey) || null;
}

function statusToVacationMode(statusKey){
  if (statusKey === "vacation-all") return "ALL";
  if (statusKey === "vacation-am") return "AM";
  if (statusKey === "vacation-pm") return "PM";
  return null;
}

function vacationModeToStatusKey(mode){
  if (mode === "ALL") return "vacation-all";
  if (mode === "AM") return "vacation-am";
  if (mode === "PM") return "vacation-pm";
  return null;
}

function applyAttendStatus(recordKey, statusKey, typeKey = "standard"){
  if(!recordKey || !statusKey) return;
  const o = state.overridesByKey[recordKey] || {};
  const allowVacation = typeKey === "1gou";
  const sanitizedStatus = (!allowVacation && VACATION_STATUS_KEYS.includes(statusKey)) ? "attend" : statusKey;
  o.attendStatus = sanitizedStatus;
  if (allowVacation){
    const vm = statusToVacationMode(sanitizedStatus);
    if (vm) o.vacationMode = vm; else delete o.vacationMode;
  } else {
    delete o.vacationMode;
  }
  state.overridesByKey[recordKey] = o;
  saveState();
  rerun();
}

function cycleAttendStatus(recordKey){
  if(!recordKey) return;
  const rowSelector = `tr.detail-row[data-rk="${cssEscape(recordKey)}"]`;
  const rowEl = detailContainer.querySelector(rowSelector);
  const typeKey = rowEl?.dataset.type || "standard";
  const detail = getDetailByRecordKey(recordKey);
  const hasClockData = detail ? !detail.missingClockData : rowEl?.dataset.hasClock === "1";
  const cycle = getStatusCycleForRecord({ typeKey, hasClockData });
  if (!cycle.length) return;
  const current = rowEl?.dataset.status && cycle.includes(rowEl.dataset.status)
    ? rowEl.dataset.status
    : cycle[cycle.length - 1];
  if (cycle.length === 1) return;
  const next = cycle[(cycle.indexOf(current) + 1) % cycle.length];
  if (next === current) return;
  applyAttendStatus(recordKey, next, typeKey);
}

function setDataSourceMeta(source = null, updatedAt = null){
  lastDataSource = source;
  if(dataSourceLabelEl){
    dataSourceLabelEl.textContent = source ? source : "未読み込み";
  }
  if(dataUpdatedLabelEl){
    dataUpdatedLabelEl.textContent = updatedAt ? `更新: ${formatDateTime(updatedAt)}` : "";
  }
  if (!source && !lastResult?.details?.length && !originalRows.length){
    renderUsageGuide();
  }
}

function encodeChildSelection(target){
  if(!target) return "";
  const clazz = normalizeClassGroupName(target.clazz);
  return encodeURIComponent(JSON.stringify({ school: target.school, clazz, name: target.name }));
}

function parseRecordKey(recordKey){
  const [rawDate = "", school = "", clazz = "", name = ""] = String(recordKey || "").split("|");
  return { rawDate, school, clazz, name };
}

function decodeChildSelection(value){
  if(!value) return null;
  try{
    return JSON.parse(decodeURIComponent(value));
  }catch{
    return null;
  }
}

function childKey(target){
  if(!target) return "";
  const clazz = normalizeClassGroupName(target.clazz);
  return `${target.school}||${clazz}||${target.name}`;
}

function formatChildLabel(target){
  if(!target) return "園児を選択してください";
  const clazz = normalizeClassGroupName(target.clazz);
  return `${target.name}${target.school ? `（${target.school}${clazz ? ` / ${clazz}` : ""}）` : ""}`;
}

function formatBulkChildLabel(target){
  if(!target) return "園児を選択してください";
  const name = target.name || "園児名未設定";
  const clazz = normalizeClassGroupName(target.clazz) || "クラス未設定";
  return `${name}／${clazz}`;
}

function getChildOptions(){
  if(!lastResult?.details?.length) return [];
  const map = new Map();
  lastResult.details.forEach(d=>{
    const clazz = normalizeClassGroupName(d.clazz);
    const key = `${d.school}||${clazz}||${d.name}`;
    if(map.has(key)) return;
    map.set(key, { school: d.school, clazz, name: d.name });
  });
  return Array.from(map.values()).sort((a,b)=>{
    const school = a.school.localeCompare(b.school, "ja");
    if (school !== 0) return school;
    const clazz = a.clazz.localeCompare(b.clazz, "ja");
    if (clazz !== 0) return clazz;
    return a.name.localeCompare(b.name, "ja");
  });
}

function updateChildSelectOptions(selectEl){
  if(!selectEl) return;
  const options = getChildOptions();
  const currentValue = selectEl.value;
  const optionHtml = options.map(opt=>{
    const value = encodeChildSelection(opt);
    const label = `${opt.name}（${opt.school}${opt.clazz ? ` / ${opt.clazz}` : ""}）`;
    return `<option value="${esc(value)}">${esc(label)}</option>`;
  }).join("");
  selectEl.innerHTML = `<option value="">園児を選択</option>${optionHtml}`;
  if (currentValue){
    const hasValue = Array.from(selectEl.options).some(opt=>opt.value === currentValue);
    if (hasValue) selectEl.value = currentValue;
  }
}

function getReferenceDateKey(value){
  if(!value) return null;
  const { year, month, day } = splitYMD(value);
  if(!year || !month || !day) return null;
  return Number(year) * 10000 + Number(month) * 100 + Number(day);
}

function getChildTypeKeyForTarget(target, referenceDate){
  if(!target || !lastResult?.details?.length) return "standard";
  const rows = lastResult.details.filter(d=>childKey(d) === childKey(target));
  if(!rows.length) return "standard";
  const referenceKey = getReferenceDateKey(referenceDate);
  if(referenceKey){
    const match = rows.find(d=>d.dateKey === referenceKey);
    if(match) return match.typeKey || "standard";
  }
  const latest = rows.reduce((acc, cur)=> cur.dateKey > acc.dateKey ? cur : acc, rows[0]);
  return latest?.typeKey || "standard";
}

function getChangedChildKeySet(){
  const set = new Set();
  Object.entries(state.overridesByKey || {}).forEach(([rk, o])=>{
    if(!o?.type) return;
    const info = parseRecordKey(rk);
    if(!info.name) return;
    set.add(childKey(info));
  });
  return set;
}

function getChangedTypeEntries(){
  const entries = Object.entries(state.overridesByKey || {})
    .filter(([, o])=>o?.type)
    .map(([rk, o])=>{
      const info = parseRecordKey(rk);
      const detail = getDetailByRecordKey(rk);
      const baseType = o.baseType || detail?.baseType || "standard";
      const dateValue = detail?.date || info.rawDate || "";
      return {
        recordKey: rk,
        name: detail?.name || info.name,
        school: detail?.school || info.school,
        clazz: detail?.clazz || info.clazz,
        date: dateValue,
        dateKey: detail?.dateKey || getReferenceDateKey(dateValue) || 0,
        fromType: baseType,
        toType: o.type
      };
    });
  return entries.sort((a,b)=>
    a.school.localeCompare(b.school, "ja") ||
    a.clazz.localeCompare(b.clazz, "ja") ||
    a.name.localeCompare(b.name, "ja") ||
    (a.dateKey - b.dateKey)
  );
}

function getChangedTypeSummaries(){
  const entries = getChangedTypeEntries();
  const grouped = new Map();
  entries.forEach(entry=>{
    const key = `${childKey(entry)}||${entry.toType}`;
    const current = grouped.get(key);
    if(!current || entry.dateKey < current.dateKey){
      grouped.set(key, {
        name: entry.name,
        school: entry.school,
        clazz: entry.clazz,
        date: entry.date,
        dateKey: entry.dateKey,
        fromType: entry.fromType,
        toType: entry.toType
      });
    }
  });
  return Array.from(grouped.values()).sort((a,b)=>
    a.school.localeCompare(b.school, "ja") ||
    a.clazz.localeCompare(b.clazz, "ja") ||
    a.name.localeCompare(b.name, "ja") ||
    (a.dateKey - b.dateKey)
  );
}

function getLatestChangedTypeEntriesByChild(){
  const entries = getChangedTypeEntries();
  const latestMap = new Map();
  entries.forEach(entry=>{
    const key = childKey(entry);
    const current = latestMap.get(key);
    if(!current || entry.dateKey > current.dateKey){
      latestMap.set(key, entry);
    }
  });
  return latestMap;
}

function ensureTypeChangeHistory(){
  if (!Array.isArray(state.typeChangeHistory)) {
    state.typeChangeHistory = [];
  }
}

function createHistoryId(){
  if (typeof crypto !== "undefined" && crypto.randomUUID) {
    return crypto.randomUUID();
  }
  return `history-${Date.now()}-${Math.random().toString(16).slice(2)}`;
}

function getDetailForChildAtDate(target, dateKey){
  if(!target || !lastResult?.details?.length) return null;
  if(dateKey == null) return null;
  return lastResult.details.find(d=>childKey(d) === childKey(target) && d.dateKey === dateKey) || null;
}

function getCsvTypeForTarget(target, dateKey){
  const detail = getDetailForChildAtDate(target, dateKey);
  if (detail?.baseType) return detail.baseType;
  if (!target || !lastResult?.details?.length) return "standard";
  const fallback = lastResult.details.find(d=>childKey(d) === childKey(target));
  return fallback?.baseType || fallback?.typeKey || "standard";
}

function formatDateLabelFromKey(key){
  const dt = keyToDate(key);
  if(!dt) return "";
  return formatYMD(dt.getFullYear(), dt.getMonth() + 1, dt.getDate());
}

function recordTypeChangeHistory({ target, startDateKey, toType } = {}){
  if(!target?.name || !target?.school || !target?.clazz || !toType) return;
  ensureTypeChangeHistory();
  const csvType = getCsvTypeForTarget(target, startDateKey);
  const entry = {
    id: createHistoryId(),
    name: target.name,
    school: target.school,
    clazz: normalizeClassGroupName(target.clazz),
    startDateKey: startDateKey || 0,
    startDate: startDateKey ? formatDateLabelFromKey(startDateKey) : "",
    csvType,
    toType,
    changedAt: Date.now()
  };
  state.typeChangeHistory.push(entry);
  refreshChangeHistoryModal();
}

const setChangeHistoryModalOpen = (isOpen) => {
  if (!changeHistoryModal) return;
  changeHistoryModal.classList.toggle("open", isOpen);
  changeHistoryModal.setAttribute("aria-hidden", isOpen ? "false" : "true");
};
const openChangeHistoryModal = (target) => {
  activeHistoryTarget = target;
  renderTypeChangeHistory(target);
  setChangeHistoryModalOpen(true);
};
const closeChangeHistoryModal = () => {
  setChangeHistoryModalOpen(false);
};
function refreshChangeHistoryModal() {
  if (!changeHistoryModal?.classList.contains("open")) return;
  renderTypeChangeHistory(activeHistoryTarget);
}

function renderTypeChangeHistory(target = activeHistoryTarget){
  if(!changeHistoryModalList || !changeHistoryModalStatusEl || !changeHistoryModalActiveChildEl) return;
  const activeTarget = target;
  if(!activeTarget){
    changeHistoryModalActiveChildEl.textContent = "園児を選択してください。";
    changeHistoryModalStatusEl.textContent = "区分変更はまだありません。";
    changeHistoryModalList.innerHTML = `<p class="muted">園・クラス・園児を選択してください。</p>`;
    return;
  }
  const activeClazz = normalizeClassGroupName(activeTarget.clazz);
  changeHistoryModalActiveChildEl.textContent = `${activeTarget.school} / ${activeClazz} / ${activeTarget.name}`;
  ensureTypeChangeHistory();
  const entries = state.typeChangeHistory
    .filter(entry => entry.name === activeTarget.name && entry.school === activeTarget.school && isSameClassGroup(entry.clazz, activeTarget.clazz))
    .sort((a,b)=> (a.changedAt || 0) - (b.changedAt || 0));
  if(!entries.length){
    changeHistoryModalStatusEl.textContent = "区分変更はまだありません。";
    changeHistoryModalList.innerHTML = `<p class="muted">区分変更履歴はまだありません。</p>`;
    return;
  }
  changeHistoryModalStatusEl.textContent = `区分変更履歴: ${entries.length}件`;
  let previousType = null;
  const rows = entries.map(entry=>{
    const beforeLabel = typeLabel(entry.csvType || "standard");
    const afterLabel = previousType ? typeLabel(previousType) : "変更なし";
    const currentLabel = typeLabel(entry.toType || "standard");
    previousType = entry.toType || previousType;
    const dateLabel = entry.startDate || (entry.startDateKey ? formatDateLabelFromKey(entry.startDateKey) : "");
    return `
      <tr>
        <td>${esc(dateLabel)}</td>
        <td>${esc(beforeLabel)}</td>
        <td>${esc(afterLabel)}</td>
        <td>${esc(currentLabel)}</td>
      </tr>
    `;
  }).join("");
  changeHistoryModalList.innerHTML = `
    <table class="changed-type-table">
      <thead>
        <tr>
          <th>変更日</th>
          <th>変更前（CSV）</th>
          <th>変更後（前回変更）</th>
          <th>今回の変更</th>
        </tr>
      </thead>
      <tbody>
        ${rows}
      </tbody>
    </table>
  `;
}

let typeChangeModalState = {
  target: null,
  startKey: null,
  selectedType: null,
  baseType: null,
  minKey: null,
  maxKey: null
};

const setTypeChangeModalOpen = (isOpen) => {
  if (!typeChangeModal) return;
  typeChangeModal.classList.toggle("open", isOpen);
  typeChangeModal.setAttribute("aria-hidden", isOpen ? "false" : "true");
};

const closeTypeChangeModal = () => {
  setTypeChangeModalOpen(false);
};

function renderTypeChangeModalButtons(){
  if(!typeChangeBeforeButtons || !typeChangeAfterButtons) return;
  const baseTypeKey = typeChangeModalState.baseType || "standard";
  const selectedTypeKey = typeChangeModalState.selectedType || baseTypeKey;
  typeChangeBeforeButtons.innerHTML = `
    <button type="button" class="day-chip type-chip type-${esc(baseTypeKey)} type-change-btn" disabled aria-disabled="true">
      ${esc(typeLabel(baseTypeKey))}
    </button>
  `;
  typeChangeAfterButtons.innerHTML = TYPE_OPTIONS.map(opt=>`
    <button type="button" class="day-chip type-chip type-${esc(opt.key)} type-change-btn${opt.key === selectedTypeKey ? " is-selected" : ""}" data-type-change-to="${esc(opt.key)}" aria-pressed="${opt.key === selectedTypeKey ? "true" : "false"}">
      ${esc(opt.label)}
    </button>
  `).join("");
}

function updateTypeChangeModalFromDate(){
  if(!typeChangeDateInput || !typeChangeModalState.target) return;
  const parsed = parseDateInput(typeChangeDateInput.value || "");
  if(!parsed) return;
  const dateValue = formatInputDateFromKey(parsed.key);
  typeChangeModalState.startKey = parsed.key;
  typeChangeModalState.baseType = getCsvTypeForTarget(typeChangeModalState.target, dateValue);
  if(!typeChangeModalState.selectedType){
    typeChangeModalState.selectedType = getChildTypeKeyForTarget(typeChangeModalState.target, dateValue);
  }
  renderTypeChangeModalButtons();
}

function renderTypeChangeModal(target){
  if(!typeChangeModalChild || !typeChangeDateInput || !typeChangeApply || !typeChangeBeforeButtons || !typeChangeAfterButtons) return;
  if(!target){
    typeChangeModalChild.textContent = "園児を選択してください。";
    typeChangeDateInput.value = "";
    typeChangeDateInput.min = "";
    typeChangeDateInput.max = "";
    typeChangeApply.disabled = true;
    typeChangeModalState = { target: null, startKey: null, selectedType: null, baseType: null, minKey: null, maxKey: null };
    typeChangeBeforeButtons.innerHTML = "";
    typeChangeAfterButtons.innerHTML = "";
    return;
  }
  const range = getBulkSelectionRange([target]);
  if(!range){
    const targetClazz = normalizeClassGroupName(target.clazz);
    typeChangeModalChild.textContent = `${target.school} / ${targetClazz} / ${target.name}`;
    typeChangeDateInput.value = "";
    typeChangeDateInput.min = "";
    typeChangeDateInput.max = "";
    typeChangeApply.disabled = true;
    typeChangeModalState = { target, startKey: null, selectedType: null, baseType: null, minKey: null, maxKey: null };
    typeChangeBeforeButtons.innerHTML = "";
    typeChangeAfterButtons.innerHTML = "";
    return;
  }
  const latestEntry = getLatestChangedTypeEntriesByChild().get(childKey(target));
  const startKey = latestEntry?.dateKey || range.minKey;
  const dateValue = formatInputDateFromKey(startKey);
  typeChangeModalState = {
    target,
    startKey,
    selectedType: latestEntry?.toType || getChildTypeKeyForTarget(target, dateValue),
    baseType: getCsvTypeForTarget(target, dateValue),
    minKey: range.minKey,
    maxKey: range.maxKey
  };
  const targetClazz = normalizeClassGroupName(target.clazz);
  typeChangeModalChild.textContent = `${target.school} / ${targetClazz} / ${target.name}`;
  typeChangeDateInput.value = dateValue;
  typeChangeDateInput.min = formatInputDateFromKey(range.minKey);
  typeChangeDateInput.max = formatInputDateFromKey(range.maxKey);
  typeChangeApply.disabled = false;
  renderTypeChangeModalButtons();
}

function openTypeChangeModal(target){
  if(!typeChangeModal) return;
  renderTypeChangeModal(target);
  setTypeChangeModalOpen(true);
}

function applyTypeChangeFromModal(){
  if(!typeChangeModalState.target || !lastResult?.details?.length || !typeChangeModalState.startKey) return;
  const toType = typeChangeModalState.selectedType;
  if(!toType) return;
  const dateValue = formatInputDateFromKey(typeChangeModalState.startKey);
  const currentType = getChildTypeKeyForTarget(typeChangeModalState.target, dateValue);
  if(currentType !== toType){
    recordTypeChangeHistory({ target: typeChangeModalState.target, startDateKey: typeChangeModalState.startKey, toType });
  }
  const endKey = getMonthEndKey(typeChangeModalState.startKey);
  let changed = 0;
  lastResult.details.forEach(d=>{
    if(childKey(d) !== childKey(typeChangeModalState.target)) return;
    if(d.dateKey == null) return;
    if(d.dateKey < typeChangeModalState.startKey) return;
    if(endKey != null && d.dateKey > endKey) return;
    setTypeOverride(d.recordKey, toType);
    changed++;
  });
  if(changed > 0){
    saveState();
    rerun();
    showToast(formatChangeToast("区分", typeLabel(toType)), { groupKey: childKey(typeChangeModalState.target) });
  }
  closeTypeChangeModal();
}

function classKey(target){
  if(!target) return "";
  const clazz = normalizeClassGroupName(target.clazz);
  return `${target.school}||${clazz}`;
}

function formatClassLabel(target){
  if(!target) return "クラス未選択";
  const clazz = normalizeClassGroupName(target.clazz);
  return `${target.school}${clazz ? ` / ${clazz}` : ""}`;
}

function getBulkClassOptions(){
  const classMap = new Map();
  if(lastResult?.details?.length){
    lastResult.details.forEach(d=>{
      const clazz = normalizeClassGroupName(d.clazz);
      const key = `${d.school}||${clazz}`;
      if(classMap.has(key)) return;
      classMap.set(key, { school: d.school, clazz });
    });
  }
  const customSchools = state.customSchools || [];
  customSchools.forEach(school=>{
    const classes = state.customClasses?.[school] || [];
    classes.forEach(clazz=>{
      const normalizedClass = normalizeClassGroupName(clazz);
      const key = `${school}||${normalizedClass}`;
      if(classMap.has(key)) return;
      classMap.set(key, { school, clazz: normalizedClass });
    });
  });
  return Array.from(classMap.values()).sort((a,b)=>{
    const school = a.school.localeCompare(b.school, "ja");
    if (school !== 0) return school;
    return a.clazz.localeCompare(b.clazz, "ja");
  });
}

function getBulkSchoolOptions(){
  const schools = new Set();
  getBulkClassOptions().forEach(opt=>schools.add(opt.school));
  (state.customSchools || []).forEach(school=>schools.add(school));
  return Array.from(schools).sort((a,b)=>a.localeCompare(b,"ja"));
}

function getBulkClassesForSchool(school){
  if(!school) return [];
  return getBulkClassOptions()
    .filter(opt=>opt.school === school)
    .map(opt=>opt.clazz)
    .sort((a,b)=>a.localeCompare(b,"ja"));
}

function getBulkTargets(){
  return Array.from(bulkTargetMap.values()).sort((a,b)=>
    a.school.localeCompare(b.school, "ja") ||
    a.clazz.localeCompare(b.clazz, "ja") ||
    a.name.localeCompare(b.name, "ja")
  );
}

function getBulkTargetCount(){
  return bulkTargetMap.size;
}

function pruneBulkSelections(){
  const validKeys = new Set(bulkTargetMap.keys());
  Array.from(bulkTypeSelections.keys()).forEach(key=>{
    if(!validKeys.has(key)) bulkTypeSelections.delete(key);
  });
  Array.from(bulkStartDateSelections.keys()).forEach(key=>{
    if(!validKeys.has(key)) bulkStartDateSelections.delete(key);
  });
}

function renderBulkSchoolList(selectedSchool){
  if(!bulkSchoolList) return;
  const schools = getBulkSchoolOptions();
  if(!schools.length){
    bulkSchoolList.innerHTML = `<p class="muted">園がありません。</p>`;
    return;
  }
  const isSingleSchool = schools.length === 1;
  bulkSchoolList.innerHTML = schools.map(school=>`
    <button type="button" class="bulk-option-btn${school === selectedSchool ? " active" : ""}" data-school="${esc(school)}"${isSingleSchool ? " disabled" : ""}>
      ${esc(school)}
    </button>
  `).join("");
}

function renderBulkClassList(selectedSchool, selectedClass){
  if(!bulkClassList) return;
  if(!selectedSchool){
    bulkClassList.innerHTML = `<p class="muted">園を選択してください。</p>`;
    return;
  }
  const classes = getBulkClassesForSchool(selectedSchool);
  if(!classes.length){
    bulkClassList.innerHTML = `<p class="muted">クラスがありません。</p>`;
    return;
  }
  bulkClassList.innerHTML = classes.map(clazz=>`
    <button type="button" class="bulk-option-btn${clazz === selectedClass ? " active" : ""}" data-class="${esc(clazz)}">
      ${esc(clazz)}
    </button>
  `).join("");
}

function getChildrenForClass(target){
  if(!target) return [];
  const names = new Set();
  if(lastResult?.details?.length){
    lastResult.details.forEach(d=>{
      if(d.school === target.school && isSameClassGroup(d.clazz, target.clazz)){
        names.add(d.name);
      }
    });
  }
  const customNames = getCustomChildrenForClass(target.school, target.clazz);
  customNames.forEach(name=>names.add(name));
  return Array.from(names).sort((a,b)=>a.localeCompare(b,"ja"));
}

function renderBulkChildList(target, selectedNames = []){
  if(!bulkChildList) return;
  if(!target){
    bulkChildList.innerHTML = `<p class="muted">園・クラスを選択してください。</p>`;
    return;
  }
  const names = getChildrenForClass(target);
  if(!names.length){
    bulkChildList.innerHTML = `<p class="muted">該当する園児が見つかりません。</p>`;
    return;
  }
  const changedChildKeys = getChangedChildKeySet();
  bulkChildList.innerHTML = names.map(name=>{
    const selected = selectedNames.includes(name);
    const childTarget = { ...target, name };
    const typeKey = getChildTypeKeyForTarget(childTarget, bulkReferenceDate);
    const changed = changedChildKeys.has(childKey(childTarget));
    const indicator = changed ? `<span class="change-indicator" aria-hidden="true">有</span><span class="sr-only">区分変更済み</span>` : "";
    return `
      <button type="button" class="bulk-child-btn${selected ? " is-selected" : ""} type-${esc(typeKey)}${changed ? " is-changed" : ""}" data-name="${esc(name)}" aria-pressed="${selected ? "true" : "false"}">
        <span>${esc(name)}</span>
        ${indicator}
      </button>
    `;
  }).join("");
}

function renderChangedTypeList(){
  if(!changedTypeList) return;
  if(!lastResult?.details?.length){
    changedTypeList.innerHTML = `<p class="muted">CSVを読み込んでください。</p>`;
    if(changedStatusEl) changedStatusEl.textContent = "CSVを読み込んでください。";
    return;
  }
  const summaries = getChangedTypeSummaries();
  if(!summaries.length){
    changedTypeList.innerHTML = `<p class="muted">区分変更はまだありません。</p>`;
    if(changedStatusEl) changedStatusEl.textContent = "区分変更はまだありません。";
    return;
  }
  const changedChildren = new Set(summaries.map(entry=>childKey(entry)));
  if(changedStatusEl) changedStatusEl.textContent = `区分変更済み: ${changedChildren.size}名 / ${summaries.length}件`;
  const rows = summaries.map(entry=>`
    <tr>
      <td>${esc(entry.name)}</td>
      <td>${esc(entry.school)}</td>
      <td>${esc(entry.clazz)}</td>
      <td>${esc(entry.date)}</td>
      <td>${esc(typeLabel(entry.fromType))}</td>
      <td>${esc(typeLabel(entry.toType))}</td>
    </tr>
  `).join("");
  changedTypeList.innerHTML = `
    <table class="changed-type-table">
      <thead>
        <tr>
          <th>園児</th>
          <th>園</th>
          <th>クラス</th>
          <th>変更開始日</th>
          <th>変更前区分</th>
          <th>変更後区分</th>
        </tr>
      </thead>
      <tbody>
        ${rows}
      </tbody>
    </table>
  `;
  if(changedRangeLabelEl) changedRangeLabelEl.textContent = "区分変更した園児の明細を一覧表示しています";
}

function renderChildTypeList(target){
  if(!childTypeList) return;
  if(!target){
    childTypeList.innerHTML = `<p class="muted">園児を選択すると一覧が表示されます。</p>`;
    return;
  }
  if(!lastResult?.details?.length){
    childTypeList.innerHTML = `<p class="muted">CSVを読み込んでください。</p>`;
    return;
  }
  const rows = lastResult.details
    .filter(d=>childKey(d) === childKey(target))
    .sort((a,b)=>a.dateKey - b.dateKey);
  if(!rows.length){
    childTypeList.innerHTML = `<p class="muted">該当する園児のデータがありません。</p>`;
    return;
  }
  const tableRows = rows.map(item=>{
    const typeLabelText = typeLabel(item.typeKey);
    return `<tr>
      <td>${esc(item.date || "")} (${esc(getWeekdayLabel(item.date || ""))})</td>
      <td>${esc(typeLabelText)}</td>
      <td>
        <select class="child-type-select" data-rk="${esc(item.recordKey)}">
          ${TYPE_OPTIONS.map(opt=>`<option value="${esc(opt.key)}"${opt.key===item.typeKey ? " selected" : ""}>${esc(opt.label)}</option>`).join("")}
        </select>
      </td>
    </tr>`;
  }).join("");
  childTypeList.innerHTML = `
    <table class="child-type-table">
      <thead>
        <tr>
          <th>日付</th>
          <th>現在区分</th>
          <th>変更</th>
        </tr>
      </thead>
      <tbody>
        ${tableRows}
      </tbody>
    </table>
  `;
}

function getBulkSelectionRange(targets){
  if(!targets?.length || !lastResult?.details?.length) return null;
  const targetKeys = new Set(targets.map(t=>childKey(t)));
  const keys = lastResult.details
    .filter(d=>targetKeys.has(childKey(d)))
    .map(d=>d.dateKey)
    .filter(k=>k!=null);
  if(!keys.length) return null;
  return { minKey: Math.min(...keys), maxKey: Math.max(...keys) };
}

function formatInputDateFromKey(key){
  const dt = keyToDate(key);
  if(!dt) return "";
  const y = dt.getFullYear();
  const m = String(dt.getMonth() + 1).padStart(2, "0");
  const d = String(dt.getDate()).padStart(2, "0");
  return `${y}-${m}-${d}`;
}

function getMonthEndKey(dateKey){
  if(dateKey == null) return null;
  const y = Math.floor(dateKey / 10000);
  const m = Math.floor((dateKey % 10000) / 100);
  if(!y || !m) return null;
  const lastDay = getDaysInMonth(y, m);
  return y * 10000 + m * 100 + lastDay;
}

function buildBulkDetailMap(){
  const map = new Map();
  (lastResult?.details || []).forEach(detail => {
    if(detail?.dateKey == null) return;
    map.set(`${childKey(detail)}__${detail.dateKey}`, detail);
  });
  bulkDetailMap = map;
}

function getBulkDetailFor(target, dateKey){
  if(!dateKey) return null;
  return bulkDetailMap.get(`${childKey(target)}__${dateKey}`) || null;
}

function getBulkCalendarDisplay(target, dateKey){
  const dateObj = keyToDate(dateKey);
  const dateLabel = dateObj ? formatYMD(dateObj.getFullYear(), dateObj.getMonth() + 1, dateObj.getDate()) : "--";
  const detail = getBulkDetailFor(target, dateKey);
  const weekday = detail?.weekday || (dateObj ? getWeekdayLabel(dateLabel) : "");
  const arrive = detail?.arrive || "--:--";
  const leave = detail?.leave || "--:--";
  const isMissing = !detail || detail.missingClockData || (!detail.arrive && !detail.leave);
  return { dateLabel, weekday, arrive, leave, isMissing };
}

function renderBulkChangeList(targets){
  if(!bulkChangeList) return;
  if(!targets?.length){
    bulkChangeList.innerHTML = `<p class="muted">園児を確定すると区分ボタンが表示されます。</p>`;
    return;
  }
  if(!lastResult?.details?.length){
    bulkChangeList.innerHTML = `<p class="muted">CSVを読み込んでください。</p>`;
    return;
  }
  buildBulkDetailMap();
  const range = getBulkSelectionRange(targets);
  if(!range){
    bulkChangeList.innerHTML = `<p class="muted">該当する園児のデータがありません。</p>`;
    return;
  }
  bulkChangeList.innerHTML = targets.map((target, index)=>{
    const childRange = getBulkSelectionRange([target]);
    if(!childRange){
      return `
        <div class="bulk-change-row" data-row="${index + 1}" data-child-key="${esc(childKey(target))}" data-child-name="${esc(target.name)}" data-school="${esc(target.school)}" data-clazz="${esc(normalizeClassGroupName(target.clazz))}">
          <div class="month-label">${esc(formatBulkChildLabel(target))}</div>
          <div class="bulk-change-controls">
            <span class="muted">データがありません。</span>
          </div>
          <div class="bulk-change-actions">
            <button type="button" class="bulk-history-btn" data-history-child="${esc(target.name)}" disabled>履歴を見る</button>
          </div>
        </div>
      `;
    }
    const baseType = getChildTypeKeyForTarget(target, bulkReferenceDate);
    const keyValue = childKey(target);
    const selectedType = bulkTypeSelections.get(keyValue) || baseType;
    bulkTypeSelections.set(keyValue, selectedType);
    const startKey = bulkStartDateSelections.get(keyValue) || childRange.minKey;
    bulkStartDateSelections.set(keyValue, startKey);
    const startValue = formatInputDateFromKey(startKey);
    const minValue = formatInputDateFromKey(childRange.minKey);
    const maxValue = formatInputDateFromKey(childRange.maxKey);
    const calendar = getBulkCalendarDisplay(target, startKey);
    return `
      <div class="bulk-change-row" data-row="${index + 1}" data-child-key="${esc(keyValue)}" data-child-name="${esc(target.name)}" data-base-type="${esc(baseType)}" data-min-key="${esc(childRange.minKey)}" data-max-key="${esc(childRange.maxKey)}">
        <div class="bulk-change-main">
          <div class="month-label">${esc(formatBulkChildLabel(target))}</div>
          <div class="bulk-change-controls">
            <div class="bulk-change-meta">
              <div class="bulk-change-period">
                <label class="bulk-change-field">
                  <span>変更日</span>
                  <input type="date" class="bulk-change-start" value="${esc(startValue)}" min="${esc(minValue)}" max="${esc(maxValue)}">
                </label>
              </div>
              <div class="bulk-change-range">
                <span>対象期間</span>
                <span class="bulk-change-range-value">${esc(minValue)} 〜 ${esc(maxValue)}</span>
              </div>
              <div class="bulk-change-type-summary">
                <span class="bulk-change-type-label">元の区分: <strong class="bulk-change-base">${esc(typeLabel(baseType))}</strong></span>
                <span class="bulk-change-type-label">変更後: <strong class="bulk-change-selected">${esc(typeLabel(selectedType))}</strong></span>
              </div>
            </div>
            <div class="bulk-type-buttons" role="group" aria-label="${esc(target.name)}の変更区分">
              ${TYPE_OPTIONS.map(opt=>`
                <button type="button" class="bulk-type-btn${opt.key===baseType ? " is-original" : ""}${opt.key===selectedType ? " is-selected" : ""}" data-type="${esc(opt.key)}">
                  ${esc(opt.label)}
                </button>
              `).join("")}
            </div>
          </div>
        </div>
        <div class="bulk-change-calendar" aria-label="${esc(target.name)}の打刻データ">
          <div class="bulk-calendar-card${calendar.isMissing ? " is-missing" : ""}">
            <div class="bulk-calendar-line bulk-calendar-date">${esc(calendar.dateLabel)}${calendar.weekday ? ` (${esc(calendar.weekday)})` : ""}</div>
            <div class="bulk-calendar-line">
              <span class="bulk-calendar-label">登園</span>
              <span>${esc(calendar.arrive)}</span>
            </div>
            <div class="bulk-calendar-line">
              <span class="bulk-calendar-label">降園</span>
              <span>${esc(calendar.leave)}</span>
            </div>
          </div>
        </div>
        <div class="bulk-change-actions">
          <button type="button" class="bulk-history-btn" data-history-child="${esc(target.name)}">履歴を見る</button>
        </div>
      </div>
    `;
  }).join("");
}

function updateBulkChangeRowMeta(row){
  if(!row) return;
  const baseType = row.dataset.baseType || "";
  const baseLabelEl = row.querySelector(".bulk-change-base");
  if(baseLabelEl) baseLabelEl.textContent = typeLabel(baseType);
  const selectedBtn = row.querySelector(".bulk-type-btn.is-selected") || row.querySelector(".bulk-type-btn.is-original");
  const selectedType = selectedBtn?.dataset.type || baseType;
  const selectedLabelEl = row.querySelector(".bulk-change-selected");
  if(selectedLabelEl) selectedLabelEl.textContent = typeLabel(selectedType);
}

function updateBulkChangeRowCalendar(row){
  if(!row) return;
  const calendarEl = row.querySelector(".bulk-calendar-card");
  if(!calendarEl) return;
  const input = row.querySelector(".bulk-change-start");
  const childKeyValue = row.dataset.childKey;
  if(!input || !childKeyValue) return;
  const parsed = parseDateInput(input.value || "");
  if(!parsed) return;
  const [school = "", clazz = "", name = ""] = childKeyValue.split("||");
  const target = bulkTargetMap.get(childKeyValue) || { school, clazz, name };
  if(!target) return;
  const calendar = getBulkCalendarDisplay(target, parsed.key);
  calendarEl.classList.toggle("is-missing", calendar.isMissing);
  const lines = calendarEl.querySelectorAll(".bulk-calendar-line");
  if(lines[0]) lines[0].innerHTML = `${esc(calendar.dateLabel)}${calendar.weekday ? ` (${esc(calendar.weekday)})` : ""}`;
  if(lines[1]) {
    const valueEl = lines[1].querySelector("span:last-child");
    if(valueEl) valueEl.textContent = calendar.arrive;
  }
  if(lines[2]) {
    const valueEl = lines[2].querySelector("span:last-child");
    if(valueEl) valueEl.textContent = calendar.leave;
  }
}

function syncBulkTargetsFromUI(){
  if(!bulkSelectedClass || !bulkChildList){
    return;
  }
  const selectedNames = new Set(
    Array.from(bulkChildList.querySelectorAll(".bulk-child-btn.is-selected"))
      .map(button=>button.dataset.name)
      .filter(Boolean)
  );
  const activeClassKey = classKey(bulkSelectedClass);
  Array.from(bulkTargetMap.entries()).forEach(([key, target])=>{
    if(classKey(target) !== activeClassKey) return;
    if(!selectedNames.has(target.name)){
      bulkTargetMap.delete(key);
      bulkTypeSelections.delete(key);
      bulkStartDateSelections.delete(key);
    }
  });
  selectedNames.forEach(name=>{
    const target = { ...bulkSelectedClass, name };
    bulkTargetMap.set(childKey(target), target);
  });
}

function renumberBulkChangeRows(){
  if(!bulkChangeList) return;
  const rows = Array.from(bulkChangeList.querySelectorAll(".bulk-change-row"));
  rows.forEach((row, index)=>{
    const label = row.querySelector(".month-label");
    const input = row.querySelector(".bulk-change-start");
    const labelEl = row.querySelector("label.sr-only");
    const rowNumber = index + 1;
    row.dataset.row = String(rowNumber);
    if(label) label.textContent = `変更${rowNumber}`;
    if(input){
      const id = `bulkChangeStart-${rowNumber}`;
      input.id = id;
      if(labelEl) labelEl.setAttribute("for", id);
    }
  });
}

function updateChildTarget(target){
  childTarget = target;
  if (selectedChildKeyInput) selectedChildKeyInput.value = target ? childKey(target) : "";
  if(childActiveNameEl) childActiveNameEl.textContent = formatChildLabel(target);
  if(childStatusEl){
    if(!lastResult?.details?.length) childStatusEl.textContent = "CSVを読み込んで園児を選択してください。";
    else if(!target) childStatusEl.textContent = "園児を選択してください。";
    else childStatusEl.textContent = "一覧から園児の区分を変更できます。";
  }
  if(childRangeLabelEl){
    childRangeLabelEl.textContent = target ? "園児ごとの日次一覧を表示中です" : "園児を選ぶと一覧が表示されます";
  }
  renderChildTypeList(target);
}

function updateBulkSelectionSummary(){
  if(!bulkActiveNameEl) return;
  const targets = getBulkTargets();
  const count = targets.length;
  if(!bulkSelectedClass){
    bulkActiveNameEl.textContent = count ? `選択済み: ${count}名` : "園児を選択してください";
    return;
  }
  const classLabel = formatClassLabel(bulkSelectedClass);
  const classCount = new Set(targets.map(t=>classKey(t))).size;
  const schoolCount = new Set(targets.map(t=>t.school)).size;
  const selectionLabel = classCount > 1
    ? (schoolCount > 1 ? `複数園から${count}名` : `${targets[0]?.school || "複数園"}から${count}名`)
    : `${classLabel}（${count}名）`;
  if(!bulkSelectionConfirmed){
    bulkActiveNameEl.textContent = count ? `${selectionLabel}選択中` : `${classLabel}（園児を選択してください）`;
    return;
  }
  bulkActiveNameEl.textContent = count ? `${selectionLabel}確定` : `${classLabel}（園児未選択）`;
}

function updateBulkPanels(){
  if(!bulkSelectionPanel || !bulkChangePanel) return;
  bulkSelectionPanel.hidden = bulkSelectionConfirmed;
  bulkChangePanel.hidden = !bulkSelectionConfirmed;
  updateBulkHeaderButtons();
}

function updateBulkHeaderButtons(){
  const isChangeStep = bulkSelectionConfirmed;
  if(bulkHeaderBack) bulkHeaderBack.hidden = !isChangeStep;
  if(bulkHeaderConfirm) bulkHeaderConfirm.disabled = !isChangeStep && !getBulkTargetCount();
}

function updateBulkStatus(){
  if(!bulkStatusEl) return;
  if(!lastResult?.details?.length){
    bulkStatusEl.textContent = "CSVを読み込んで園児を選択してください。";
    return;
  }
  if(!bulkSelectedClass){
    bulkStatusEl.textContent = "園・クラスを選択してください。";
    return;
  }
  if(!bulkSelectionConfirmed){
    bulkStatusEl.textContent = "園児を複数選択して確定してください。";
    return;
  }
  if(!getBulkTargetCount()){
    bulkStatusEl.textContent = "園児が選択されていません。";
    return;
  }
  bulkStatusEl.textContent = "園児ごとに変更する区分を選択してください。";
}

function updateBulkRangeLabel(){
  if(!bulkRangeLabelEl) return;
  bulkRangeLabelEl.textContent = bulkSelectionConfirmed
    ? "園児ごとに変更する区分を指定してください"
    : "園・クラスを選んで園児を複数選択してください";
  updateBulkPanels();
}

function moveBulkToSelectionStep(){
  bulkSelectionConfirmed = false;
  renderBulkChangeList([]);
  updateBulkSelectionSummary();
  updateBulkRangeLabel();
  updateBulkStatus();
}

function moveBulkToChangeStep(){
  syncBulkTargetsFromUI();
  pruneBulkSelections();
  const targets = getBulkTargets();
  if(targets.length){
    bulkSelectionConfirmed = true;
    renderBulkChangeList(targets);
  } else {
    bulkSelectionConfirmed = false;
    renderBulkChangeList([]);
  }
  updateBulkSelectionSummary();
  updateBulkRangeLabel();
  updateBulkStatus();
}

function resetBulkSelection({keepClass = false} = {}){
  bulkTargetMap.clear();
  bulkSelectionConfirmed = false;
  if(!keepClass){
    bulkSelectedClass = null;
    bulkSelectedSchool = null;
  }
  bulkTypeSelections.clear();
  bulkStartDateSelections.clear();
  renderBulkChangeList([]);
  updateBulkSelectionSummary();
  updateBulkRangeLabel();
  updateBulkStatus();
}

function updateBulkMenuContext({name, referenceDate, school, clazz} = {}){
  updateChildSelectOptions(childTypeSelect);
  bulkReferenceDate = referenceDate || "";
  const schoolOptions = getBulkSchoolOptions();
  const defaultSchool = schoolOptions.includes(school) ? school : bulkSelectedSchool;
  bulkSelectedSchool = defaultSchool || schoolOptions[0] || null;
  const classOptions = getBulkClassesForSchool(bulkSelectedSchool);
  const existingClass = bulkSelectedClass?.clazz;
  const defaultClass = classOptions.includes(clazz) ? clazz : existingClass;
  const selectedClassName = defaultClass || classOptions[0] || null;
  bulkSelectedClass = selectedClassName && bulkSelectedSchool ? { school: bulkSelectedSchool, clazz: selectedClassName } : null;
  renderBulkSchoolList(bulkSelectedSchool);
  renderBulkClassList(bulkSelectedSchool, bulkSelectedClass?.clazz);
  const selectedNames = getBulkTargets()
    .filter(t=>classKey(t) === classKey(bulkSelectedClass))
    .map(t=>t.name);
  renderBulkChildList(bulkSelectedClass, selectedNames);
  if(bulkSelectionConfirmed){
    renderBulkChangeList(getBulkTargets());
  } else {
    renderBulkChangeList([]);
  }
  updateBulkSelectionSummary();
  updateBulkRangeLabel();
  updateBulkStatus();
  const childTargetCandidate = decodeChildSelection(childTypeSelect?.value);
  if (!childTarget || childKey(childTarget) !== childKey(childTargetCandidate)){
    updateChildTarget(childTargetCandidate);
  }
}

function applyBulkTypeChange(){
  if(!bulkStatusEl) return false;
  if(!lastResult?.details?.length){
    bulkStatusEl.textContent = "先にCSVを読み込んでください。";
    return false;
  }
  const targets = getBulkTargets();
  if(!bulkSelectionConfirmed || !targets.length){
    bulkStatusEl.textContent = "園児を選択して確定してください。";
    return false;
  }
  const changeRows = bulkChangeList?.querySelectorAll(".bulk-change-row") || [];
  if(!changeRows.length){
    bulkStatusEl.textContent = "園児を選択して確定してください。";
    return false;
  }
  let changed = 0;
  const changedTypes = new Set();
  const errors = [];
  const targetMap = new Map(targets.map(t=>[childKey(t), t]));
  changeRows.forEach((row, idx)=>{
    const childKeyValue = row.dataset.childKey;
    if(!childKeyValue) return;
    const childName = row.dataset.childName || `${idx + 1}行目`;
    const startInput = row.querySelector(".bulk-change-start");
    const startDate = parseDateInput(startInput?.value || "");
    if(!startDate){
      errors.push(`${childName}の変更日を入力してください。`);
      return;
    }
    const minKey = Number(row.dataset.minKey);
    const maxKey = Number(row.dataset.maxKey);
    if(!Number.isNaN(minKey) && !Number.isNaN(maxKey)){
      if(startDate.key < minKey || startDate.key > maxKey){
        errors.push(`${childName}の変更日は${formatInputDateFromKey(minKey)}〜${formatInputDateFromKey(maxKey)}の範囲で指定してください。`);
        return;
      }
    }
    const selectedBtn = row.querySelector(".bulk-type-btn.is-selected") || row.querySelector(".bulk-type-btn.is-original");
    const toType = selectedBtn?.dataset.type;
    if(!toType){
      errors.push(`${childName}の区分を選択してください。`);
      return;
    }
    changedTypes.add(toType);
    if(!targetMap.has(childKeyValue)) return;
    const target = targetMap.get(childKeyValue);
    const currentType = getChildTypeKeyForTarget(target, formatInputDateFromKey(startDate.key));
    if (currentType !== toType){
      recordTypeChangeHistory({ target, startDateKey: startDate.key, toType });
    }
    const startKey = startDate.key;
    const endKey = getMonthEndKey(startKey);
    lastResult.details.forEach(d=>{
      if(childKey(d) !== childKeyValue) return;
      if(d.dateKey == null) return;
      if(d.dateKey < startKey) return;
      if(endKey != null && d.dateKey > endKey) return;
      setTypeOverride(d.recordKey, toType);
      changed++;
    });
    bulkStartDateSelections.set(childKeyValue, startKey);
  });
  if(errors.length){
    bulkStatusEl.textContent = errors[0];
    return false;
  }
  if(changed>0){
    saveState();
    rerun();
    bulkStatusEl.textContent = `選択した園児${targets.length}名の合計${changed}日を変更しました。`;
    const typeSummary = changedTypes.size === 1 ? typeLabel(Array.from(changedTypes)[0]) : "複数の区分";
    showToast(formatChangeToast("区分（まとめて）", typeSummary));
    return true;
  } else {
    bulkStatusEl.textContent = "変更対象が見つかりませんでした。変更日を確認してください。";
  }
  return false;
}

function createBlankRecordsForActiveSelection(){
  if(!originalRows.length || !lastResult?.details?.length){
    alert("先にCSVを読み込んでください。");
    return;
  }
  const activeName = state.activeName;
  const activeSchool = state.activeSchool;
  const activeClass = state.activeClass;
  if(!activeName || !activeSchool || !activeClass){
    alert("園・クラス・園児を選択してください。");
    return;
  }
  const resolvedClass = lastResult.details.find(d=>
    d.name === activeName && d.school === activeSchool && isSameClassGroup(d.clazz, activeClass)
  )?.clazz || activeClass;
  const range = deriveRangeFromDetails(lastResult.details, lastResult.range);
  if(!range){
    alert("日付範囲を取得できませんでした。");
    return;
  }
  const existingKeys = new Set(
    lastResult.details
      .filter(d=>d.name===activeName && d.school===activeSchool && isSameClassGroup(d.clazz, activeClass))
      .map(d=>d.recordKey)
  );
  const newRows = [];
  walkDateRange(range, (y,m,d)=>{
    const rawDate = formatYMD(y,m,d);
    const rk = makeRecordKey({rawDate, school: activeSchool, clazz: resolvedClass, name: activeName});
    if(existingKeys.has(rk)) return;
    newRows.push({
      "日付": rawDate,
      "出欠": "",
      "名前": activeName,
      "園": activeSchool,
      "所属": resolvedClass,
      "登園時刻": "",
      "降園時刻": ""
    });
  });
  if(!newRows.length){
    alert("追加できる日付がありません。");
    return;
  }
  originalRows = originalRows.concat(newRows);
  rerun();
  alert(`${activeClass} / ${activeName} の打刻データを ${newRows.length} 日分、空の状態で追加しました。`);
}

function rerun(){
  if (!originalRows.length) return;
  const result = calculate(originalRows);
  lastBaseResult = calculate(originalRows, stripTypeOverrides(state.overridesByKey));
  lastResult = result;
  renderDetails(result.details);
  syncLocalDataNode();
}

async function readFileWithFallbackEncoding(file){
  // UTF-8 を優先し、読めない場合は Shift_JIS 系で再デコード
  const stripBom = (text) => text.replace(/^\uFEFF/, "");
  const encodingCandidates = ["utf-8", "shift-jis", "shift_jis", "windows-31j", "cp932"];
  const getSupportedEncodings = () => {
    if (typeof TextDecoder === "undefined") return [];
    return encodingCandidates.filter((encoding) => {
      try {
        new TextDecoder(encoding);
        return true;
      } catch (_) {
        return false;
      }
    });
  };
  const readAsText = (encoding) =>
    new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onerror = () => reject(new Error("ファイルの読み込みに失敗しました"));
      reader.onload = () => {
        if (typeof reader.result === "string") resolve(reader.result);
        else reject(new Error("ファイルを読み込めませんでした"));
      };
      try {
        if (encoding) reader.readAsText(file, encoding);
        else reader.readAsText(file);
      } catch (error) {
        reject(error);
      }
    });

  const tryFileReaderEncodings = async (encodings) => {
    for (const encoding of encodings) {
      try {
        return stripBom(await readAsText(encoding));
      } catch (_) {
        continue;
      }
    }
    return null;
  };

  if (typeof TextDecoder === "undefined") {
    const fallback = await tryFileReaderEncodings(encodingCandidates);
    if (fallback !== null) return fallback;
    throw new Error("対応していない文字コードのため読み込めませんでした");
  }

  try {
    const buffer = await new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onerror = () => reject(new Error("ファイルの読み込みに失敗しました"));
      reader.onload = () => {
        if (reader.result instanceof ArrayBuffer) resolve(reader.result);
        else reject(new Error("ファイルを読み込めませんでした"));
      };
      reader.readAsArrayBuffer(file);
    });

    const tryDecode = (encoding, fatal = true) => {
      try {
        const decoder = new TextDecoder(encoding, { fatal });
        return decoder.decode(buffer);
      } catch (_) {
        return null;
      }
    };

    const utf8Text = tryDecode("utf-8", true);
    if (utf8Text !== null) {
      return stripBom(utf8Text);
    }

    const supportedEncodings = getSupportedEncodings();
    for (const encoding of supportedEncodings) {
      if (encoding === "utf-8") continue;
      const decoded = tryDecode(encoding, false);
      if (decoded !== null) {
        return stripBom(decoded);
      }
    }

    const fallback = await tryFileReaderEncodings(["shift-jis", "shift_jis", "windows-31j", "cp932", "utf-8"]);
    if (fallback !== null) return fallback;
    throw new Error("対応していない文字コードのため読み込めませんでした");
  } catch (error) {
    const fallback = await tryFileReaderEncodings(["shift-jis", "shift_jis", "windows-31j", "cp932", "utf-8"]);
    if (fallback !== null) return fallback;
    throw error;
  }
}

function adjustTime(rk, which, delta){
  if(!rk || !which) return;
  const selector = which==="arrive"
    ? `.arriveInput[data-rk="${cssEscape(rk)}"]`
    : `.leaveInput[data-rk="${cssEscape(rk)}"]`;
  const input = detailContainer.querySelector(selector);
  if(!input) return;
  const base = sanitizeHHMM(input.value) || sanitizeHHMM(input.dataset.original) || "";
  const baseMinutes = parseTimeToMinutes(base);
  if(baseMinutes==null) return;
  const next = Math.max(0, Math.min(23*60+59, baseMinutes + delta));
  input.value = minutesToTime(next);
  applyTimeEdit(input, which);
  const detail = getDetailByRecordKey(rk);
  const whichLabel = which === "arrive" ? "登園" : "降園";
  const groupKey = detail ? childKey(detail) : null;
  if (detail) {
    showToast(
      formatTimeAdjustToast(detail, whichLabel, minutesToTime(next), delta),
      { groupKey }
    );
  }
}

function applyTimeEdit(inputEl, which){
  const rk = inputEl.dataset.rk;
  const t = sanitizeHHMM(inputEl.value);
  const m = parseTimeToMinutes(t);
  const o = state.overridesByKey[rk] || {};
  if (m==null){
    // 空 or 不正 → 解除
    if (which==="arrive") delete o.arriveMinutes;
    if (which==="leave")  delete o.leaveMinutes;
  }else{
    if (which==="arrive") o.arriveMinutes = m;
    if (which==="leave")  o.leaveMinutes  = m;
  }
  state.overridesByKey[rk] = o;
  saveState();
  rerun();
}

function parseCSV(text){
  // ざっくりCSV（カンマ、ダブルクォート対応）
  let inputText = String(text ?? "");
  if (/(?:\r\n|\r|\n)$/.test(inputText)) {
    inputText = inputText.replace(/(?:\r\n|\r|\n)$/, "");
  }
  const lines=[]; let cur=''; let row=[]; let inside=false;
  for(let i=0;i<inputText.length;i++){
    const ch=inputText[i], next=inputText[i+1];
    if(ch==='\"'){
      if(inside && next==='\"'){cur+='\"'; i++; continue;}
      inside=!inside; continue;
    }
    if(ch===',' && !inside){row.push(cur); cur=''; continue;}
    if((ch==='\n' || ch==='\r') && !inside){
      if(ch==='\r' && next==='\n') i++;
      row.push(cur); lines.push(row); row=[]; cur=''; continue;
    }
    cur+=ch;
  }
  if(cur || row.length){row.push(cur); lines.push(row);}

  if(!lines.length) return [];
  // ヘッダ行探し
  let headerIndex=0;
  for(let i=0;i<lines.length;i++){
    const joined = lines[i].join("");
    if(joined.includes("日付") && joined.includes("出欠") && joined.includes("名前")){
      headerIndex=i; break;
    }
  }
  let header = lines[headerIndex];
  if(header[0] && header[0].charCodeAt(0)===0xFEFF) header[0]=header[0].slice(1);

  const rows=[];
  for(let i=headerIndex+1;i<lines.length;i++){
    const line=lines[i];
    if(line.length===1 && String(line[0]||"").trim()==="") continue;
    const obj={};
    for(let c=0;c<header.length;c++){
      const key=String(header[c]||"").trim();
      if(!key) continue;
      obj[key]=line[c]??"";
    }
    rows.push(obj);
  }
  return rows;
}

function splitYMD(rawDate){
  const m = String(rawDate).match(/^(\d{4})[-/](\d{1,2})[-/](\d{1,2})/);
  if(!m) return {year:"",month:"",day:""};
  return {year:m[1],month:String(m[2]).padStart(2,"0"),day:String(m[3]).padStart(2,"0")};
}

function toDateFromParts(year, month, day){
  const d=new Date(`${year}/${month}/${day}`);
  if(Number.isNaN(d.getTime())) return null;
  return d;
}

function isWeekend(dateObj){
  if(!dateObj) return false;
  const dow = dateObj.getDay();
  return dow===0 || dow===6;
}

function isJapaneseHoliday(dateObj){
  if(!dateObj) return false;
  const y=dateObj.getFullYear();
  const key=`${String(dateObj.getMonth()+1).padStart(2,"0")}-${String(dateObj.getDate()).padStart(2,"0")}`;
  const list = JAPAN_PUBLIC_HOLIDAYS[y];
  return !!list && list.has(key);
}

function getDaysInMonth(year, month){
  const y = Number(year);
  const m = Number(month);
  if(Number.isNaN(y) || Number.isNaN(m)) return 31;
  return new Date(y, m, 0).getDate();
}

function getWeekdayLabel(ymd){
  const d=new Date(String(ymd).replace(/-/g,'/'));
  if(Number.isNaN(d.getTime())) return "";
  return ["日","月","火","水","木","金","土"][d.getDay()];
}

function formatMonthDay(dateISO){
  const d = new Date(String(dateISO).replace(/-/g, "/"));
  if (Number.isNaN(d.getTime())) return "";
  return `${d.getMonth() + 1}/${d.getDate()}`;
}

function weekdayJa(dateISO){
  return getWeekdayLabel(dateISO);
}

function fmtMoney(yen){
  const value = Number(yen);
  if (!Number.isFinite(value)) return "0円";
  return `${Math.round(value).toLocaleString()}円`;
}

function formatExtendedCareLines(details){
  if (!Array.isArray(details) || !details.length) return "";
  const sorted = [...details].sort((a, b) => (a.dateKey ?? 0) - (b.dateKey ?? 0));
  const range = deriveRangeFromDetails(sorted);
  const formatRange = (targetRange) => {
    const start = keyToDate(targetRange?.minKey);
    const end = keyToDate(targetRange?.maxKey);
    if (!start || !end) return "";
    return `【${formatYMD(start.getFullYear(), start.getMonth() + 1, start.getDate())}〜${formatYMD(end.getFullYear(), end.getMonth() + 1, end.getDate())}】月初め〜月末`;
  };
  const formatBackslashYen = (value) => {
    const num = Number(value) || 0;
    return `\\${Math.round(num).toLocaleString()}`;
  };
  const formatUsageLine = ({ date, weekday, timeLabel, amount }) => {
    const dayLabel = formatMonthDay(date);
    const weekdayLabel = weekday || weekdayJa(date);
    const timeText = timeLabel ? `${timeLabel}` : "";
    return `利用日(${dayLabel}(${weekdayLabel}))${timeText}（${formatBackslashYen(amount)}）`;
  };
  const buildExtensionTimeLabel = (detail) => {
    const ranges = [];
    if (detail.extEarlyMinutes > 0 && detail.arrive && detail.baseStartTime) {
      ranges.push(`${detail.arrive}〜${detail.baseStartTime}`);
    }
    if (detail.extLateMinutes > 0 && detail.baseEndTime && detail.leave) {
      ranges.push(`${detail.baseEndTime}〜${detail.leave}`);
    }
    return ranges.join("／");
  };
  const buildAzukariTimeLabel = (detail) => {
    if (detail.arrive && detail.leave) return `${detail.arrive}〜${detail.leave}`;
    if (detail.baseStartTime && detail.baseEndTime) return `${detail.baseStartTime}〜${detail.baseEndTime}`;
    return "";
  };
  const categories = [
    {
      key: "standard",
      label: "延長保育（標準時間）",
      entries: [],
      total: 0
    },
    {
      key: "short",
      label: "延長保育（スポット）※短時間",
      entries: [],
      total: 0
    },
    {
      key: "onegou-ext",
      label: "1号認定（時間延長）",
      entries: [],
      total: 0
    },
    {
      key: "onegou-azukari",
      label: "1号認定（預り保育）",
      entries: [],
      total: 0
    },
    {
      key: "onegou-extras",
      label: "1号認定（おやつ代、昼食代）",
      entries: [],
      total: 0
    }
  ];
  sorted.forEach(detail => {
    if (detail.extFee > 0) {
      const categoryKey = detail.typeKey === "1gou" ? "onegou-ext" : (detail.typeKey === "short" ? "short" : "standard");
      const target = categories.find(item => item.key === categoryKey);
      if (target) {
        target.entries.push({
          date: detail.date,
          weekday: detail.weekday,
          timeLabel: buildExtensionTimeLabel(detail),
          amount: detail.extFee
        });
        target.total += detail.extFee;
      }
    }
    if (detail.azukariFee > 0) {
      const target = categories.find(item => item.key === "onegou-azukari");
      if (target) {
        target.entries.push({
          date: detail.date,
          weekday: detail.weekday,
          timeLabel: buildAzukariTimeLabel(detail),
          amount: detail.azukariFee
        });
        target.total += detail.azukariFee;
      }
    }
  });
  const hasAnyEntries = categories.some(item => item.entries.length > 0);
  if (!hasAnyEntries) return "";
  const rangeLabel = formatRange(range);
  return categories.map(category => {
    const lines = category.entries.map(entry => formatUsageLine(entry)).join("\n");
    return [
      `▪️${category.label}　${fmtMoney(category.total)}（テキストコピー可）`,
      "備考欄（テキストコピー可）：",
      rangeLabel,
      lines,
      "※各利用日について表示"
    ].filter(Boolean).join("\n");
  }).join("\n\n");
}

function parseDateInput(value){
  if(!value) return null;
  const parts = String(value).split("-");
  if(parts.length!==3) return null;
  const [yStr,mStr,dStr] = parts;
  const y = Number(yStr), m = Number(mStr), d = Number(dStr);
  if([y,m,d].some(v=>Number.isNaN(v))) return null;
  const dt = new Date(y, m-1, d);
  if(dt.getFullYear()!==y || dt.getMonth()+1!==m || dt.getDate()!==d) return null;
  return { y, m, d, key: y*10000 + m*100 + d };
}

function formatYMD(year, month, day){
  return `${String(year).padStart(4,"0")}/${String(month).padStart(2,"0")}/${String(day).padStart(2,"0")}`;
}

function formatDateTime(dt){
  if(!dt) return "";
  const d = dt instanceof Date ? dt : new Date(dt);
  if(Number.isNaN(d.getTime())) return "";
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const da = String(d.getDate()).padStart(2,"0");
  const hh = String(d.getHours()).padStart(2,"0");
  const mi = String(d.getMinutes()).padStart(2,"0");
  return `${y}/${m}/${da} ${hh}:${mi}`;
}

function keyToDate(key){
  if(key==null) return null;
  const y=Math.floor(key/10000);
  const m=Math.floor((key%10000)/100);
  const d=key%100;
  const dt=new Date(y, m-1, d);
  if(Number.isNaN(dt.getTime())) return null;
  return dt;
}

function deriveRangeFromDetails(details, hintRange = {}){
  if(hintRange?.minKey!=null && hintRange?.maxKey!=null){
    return { minKey: hintRange.minKey, maxKey: hintRange.maxKey };
  }
  if(!details?.length) return null;
  const keys = details.map(d=>d.dateKey).filter(k=>k!=null);
  if(!keys.length) return null;
  return { minKey: Math.min(...keys), maxKey: Math.max(...keys) };
}

function updateDateRangeLabel(range){
  if (!dateRangeLabel) return;
  const start = keyToDate(range?.minKey);
  const end = keyToDate(range?.maxKey);
  if(start && end){
    const sY=start.getFullYear(), sM=start.getMonth()+1, sD=start.getDate();
    const eY=end.getFullYear(), eM=end.getMonth()+1, eD=end.getDate();
    dateRangeLabel.textContent = `【${sY}/${sM}/${sD} ～ ${eY}/${eM}/${eD}】`;
    return;
  }
  dateRangeLabel.textContent = "";
}

async function copyTextToClipboard(text){
  if(!text) return false;
  if(navigator.clipboard?.writeText){
    try{
      await navigator.clipboard.writeText(text);
      showToast({ title: "コピー", message: "クリップボードにコピーしました。" });
      return true;
    }catch(err){
      // fallback below
    }
  }
  const textarea = document.createElement("textarea");
  textarea.value = text;
  textarea.setAttribute("readonly", "");
  textarea.style.position = "absolute";
  textarea.style.left = "-9999px";
  document.body.appendChild(textarea);
  const selection = document.getSelection();
  const range = selection?.rangeCount ? selection.getRangeAt(0) : null;
  textarea.select();
  let success = false;
  try{
    success = document.execCommand("copy");
  }catch(err){
    success = false;
  }
  document.body.removeChild(textarea);
  if(range && selection){
    selection.removeAllRanges();
    selection.addRange(range);
  }
  if (success) {
    showToast({ title: "コピー", message: "クリップボードにコピーしました。" });
  } else {
    showToast({ title: "コピー", message: "コピーに失敗しました。" });
  }
  return success;
}

function attemptLegacyCopy(text){
  const textarea = document.createElement("textarea");
  textarea.value = text;
  textarea.setAttribute("readonly", "");
  textarea.style.position = "absolute";
  textarea.style.left = "-9999px";
  document.body.appendChild(textarea);
  const selection = document.getSelection();
  const range = selection?.rangeCount ? selection.getRangeAt(0) : null;
  textarea.select();
  let success = false;
  try{
    success = document.execCommand("copy");
  }catch(err){
    success = false;
  }
  document.body.removeChild(textarea);
  if(range && selection){
    selection.removeAllRanges();
    selection.addRange(range);
  }
  return success;
}

function openCopyFallbackModal(text){
  if (!copyFallbackModal || !copyFallbackTextarea) return;
  copyFallbackTextarea.value = text || "";
  copyFallbackModal.classList.add("open");
  copyFallbackModal.setAttribute("aria-hidden", "false");
  copyFallbackTextarea.focus();
  copyFallbackTextarea.select();
}

function closeCopyFallbackModal(){
  if (!copyFallbackModal) return;
  copyFallbackModal.classList.remove("open");
  copyFallbackModal.setAttribute("aria-hidden", "true");
}

async function copyExtendedCareText(text){
  if (!text) return false;
  if (navigator.clipboard?.writeText) {
    try{
      await navigator.clipboard.writeText(text);
      showToast({ title: "コピー", message: "コピーしました" });
      return true;
    }catch(err){
      // fallback below
    }
  }
  const success = attemptLegacyCopy(text);
  if (success) {
    showToast({ title: "コピー", message: "コピーしました" });
    return true;
  }
  openCopyFallbackModal(text);
  showToast({ title: "コピー", message: "コピーに失敗しました。" });
  return false;
}

function markCopyButtonSuccess(button){
  if (!button) return;
  const original = button.dataset.copyLabel || button.textContent || "コピー";
  if (!button.dataset.copyLabel) button.dataset.copyLabel = original;
  button.textContent = "コピー済み";
  button.classList.add("is-copied");
  setTimeout(() => {
    button.textContent = button.dataset.copyLabel || original;
    button.classList.remove("is-copied");
  }, 1500);
}

async function handleCopyButtonClick(button, text){
  if (!button || button.disabled) return;
  if (!text) {
    showToast({ title: "コピー", message: "コピーできる内容がありません。" });
    return;
  }
  button.disabled = true;
  const success = await copyExtendedCareText(text);
  button.disabled = false;
  if (success) markCopyButtonSuccess(button);
}

function walkDateRange(range, cb){
  const start = keyToDate(range?.minKey);
  const end = keyToDate(range?.maxKey);
  if(!start || !end) return;
  for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
    cb(d.getFullYear(), d.getMonth()+1, d.getDate());
  }
}

function parseTimeToMinutes(t){
  if(!t) return null;
  const m = String(t).trim().match(/^(\d{1,2}):(\d{2})$/);
  if(!m) return null;
  const h=Number(m[1]), mi=Number(m[2]);
  if(Number.isNaN(h)||Number.isNaN(mi) || mi<0||mi>59) return null;
  return h*60+mi;
}

function buildExtendedCareChange(detail){
  if (!detail) return null;
  const arrive = detail.arrive || "";
  const leave = detail.leave || "";
  const baseStart = detail.baseStartTime || "";
  const baseEnd = detail.baseEndTime || "";
  const arriveMin = parseTimeToMinutes(arrive);
  const leaveMin = parseTimeToMinutes(leave);
  const baseStartMin = parseTimeToMinutes(baseStart);
  const baseEndMin = parseTimeToMinutes(baseEnd);
  const earlyIn = (arriveMin != null && baseStartMin != null && arriveMin < baseStartMin) ? arrive : null;
  const lateOut = (leaveMin != null && baseEndMin != null && leaveMin > baseEndMin) ? leave : null;
  if (!earlyIn && !lateOut) return null;
  return {
    date: detail.date || "",
    dateKey: detail.dateKey,
    weekday_ja: getWeekdayLabel(detail.date || ""),
    early_in: earlyIn,
    care_start: baseStart,
    care_end: baseEnd,
    late_out: lateOut,
    price_yen: Number.isFinite(detail.extFee) ? detail.extFee : 0,
    typeKey: detail.typeKey || detail.baseType || "standard",
    baseStartTime: baseStart,
    baseEndTime: baseEnd,
    arrive,
    leave,
    extEarlyMinutes: detail.extEarlyMinutes || 0,
    extLateMinutes: detail.extLateMinutes || 0,
    azukariFee: Number.isFinite(detail.azukariFee) ? detail.azukariFee : 0
  };
}

function buildChangedChildExtendedCareSummaries(details){
  if (!details?.length) return [];
  const summaries = getChangedTypeSummaries();
  if (!summaries.length) return [];
  const seen = new Set();
  const childSummaries = [];
  summaries.forEach(entry => {
    const key = childKey(entry);
    if (!key || seen.has(key)) return;
    seen.add(key);
    childSummaries.push(entry);
  });
  const changedKeys = new Set(childSummaries.map(entry => childKey(entry)));
  const map = new Map();
  details.forEach(detail => {
    const key = childKey(detail);
    if (!changedKeys.has(key)) return;
    const change = buildExtendedCareChange(detail);
    if (!change) return;
    if (!map.has(key)) {
      map.set(key, {
        child_id: key,
        child_name: detail.name,
        school: detail.school,
        clazz: detail.clazz,
        changes: []
      });
    }
    map.get(key).changes.push(change);
  });
  return childSummaries.map(entry => {
    const key = childKey(entry);
    const existing = map.get(key);
    if (existing) return existing;
    return {
      child_id: key,
      child_name: entry.name,
      school: entry.school,
      clazz: entry.clazz,
      changes: []
    };
  }).sort((a, b) =>
    a.school.localeCompare(b.school, "ja") ||
    a.clazz.localeCompare(b.clazz, "ja") ||
    a.child_name.localeCompare(b.child_name, "ja")
  );
}

function getClassChildOrder(school, clazz){
  if(!school || !clazz) return [];
  const names = [];
  const seen = new Set();
  const normalizedClass = normalizeClassGroupName(clazz);
  (Array.isArray(originalRows) ? originalRows : []).forEach(row=>{
    if(str(row?.["園"]) !== school) return;
    const rowClass = normalizeClassGroupName(str(row?.["所属"]));
    if(rowClass !== normalizedClass) return;
    const name = str(row?.["名前"]);
    if(!name || seen.has(name)) return;
    seen.add(name);
    names.push(name);
  });
  const customNames = getCustomChildrenForClass(school, clazz);
  customNames.forEach(name=>{
    const trimmed = str(name);
    if(!trimmed || seen.has(trimmed)) return;
    seen.add(trimmed);
    names.push(trimmed);
  });
  return names;
}

function buildClassChildSummaries(details, targets){
  if(!targets?.length) return [];
  const targetKeys = new Set(targets.map(t=>childKey(t)));
  const detailMap = new Map();
  (details || []).forEach(detail=>{
    const key = childKey(detail);
    if(!targetKeys.has(key)) return;
    if(!detailMap.has(key)) detailMap.set(key, []);
    detailMap.get(key).push(detail);
  });
  detailMap.forEach(list=>list.sort((a,b)=>a.dateKey - b.dateKey));
  return targets.map(target=>{
    const key = childKey(target);
    const childDetails = detailMap.get(key) || [];
    const changes = [];
    childDetails.forEach(detail=>{
      const change = buildExtendedCareChange(detail);
      if(change) changes.push(change);
    });
    return {
      child_id: key,
      child_name: target.name,
      school: target.school,
      clazz: normalizeClassGroupName(target.clazz),
      changes,
      details: childDetails,
      isPending: childDetails.length === 0
    };
  });
}

function minutesToTime(mins){
  if(mins==null) return "";
  const h=String(Math.floor(mins/60)).padStart(2,"0");
  const m=String(mins%60).padStart(2,"0");
  return `${h}:${m}`;
}

function sanitizeHHMM(v){
  const s = String(v||"").trim();
  if(s==="") return "";
  const m = s.match(/^(\d{1,2})[:：](\d{2})$/);
  if(!m) return "";
  const hh = String(Math.min(23, Math.max(0, Number(m[1])))).padStart(2,"0");
  const mmN = Number(m[2]);
  if(Number.isNaN(mmN) || mmN<0 || mmN>59) return "";
  const mm = String(mmN).padStart(2,"0");
  return `${hh}:${mm}`;
}

function formatDiff(v){
  const n = Number(v||0);
  if(!n) return "±0分";
  return (n>0?`+${n}`:`-${Math.abs(n)}`)+"分";
}

function updateThemeIconState(activeName){
  if(!themeIconGrid) return;
  const activeKey = activeName || state.themeName || "violet";
  themeIconGrid.querySelectorAll(".theme-icon").forEach(btn=>{
    const isActive = btn.dataset.theme === activeKey;
    btn.classList.toggle("active", isActive);
    btn.setAttribute("aria-selected", isActive ? "true" : "false");
  });
}

function renderThemeIcons(){
  if(!themeIconGrid || !window.EnchoTheme?.THEMES) return;
  const entries = Object.entries(window.EnchoTheme.THEMES);
  themeIconGrid.innerHTML = entries.map(([key, value])=>{
    const label = value?.label || key;
    const swatch = `linear-gradient(135deg, ${value?.accent || "#8b5cf6"}, ${value?.accent2 || "#f59e0b"}, ${value?.accent3 || "#22d3ee"})`;
    return `<button type="button" class="theme-icon" data-theme="${esc(key)}" role="option" aria-label="${esc(label)}" tabindex="0">
      <span class="swatch" style="background:${swatch};" aria-hidden="true"></span>
      <span class="label">${esc(label)}</span>
    </button>`;
  }).join("");
  themeIconGrid.querySelectorAll(".theme-icon").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const themeKey = btn.dataset.theme || "violet";
      applyTheme(themeKey);
    });
  });
  updateThemeIconState(state.themeName);
}

function applyTheme(themeName, { shouldSave = true } = {}){
  const target = window.EnchoTheme?.THEMES?.[themeName] ? themeName : "violet";
  window.EnchoTheme?.applyTheme(target);
  window.EnchoTheme?.saveActiveThemeName(target);
  state.themeName = target;
  if (shouldSave) {
    saveState();
    const themeLabel = window.EnchoTheme?.THEMES?.[target]?.label || target;
    showToast(formatChangeToast("テーマ", themeLabel));
  }
  updateThemeIconState(target);
}

function applyDaycardSize(sizeKey, {shouldSave = true} = {}){
  const preset = DAYCARD_SIZE_PRESETS[sizeKey] || DAYCARD_SIZE_PRESETS.medium;
  Object.entries(preset.values).forEach(([k,v])=>{
    document.documentElement.style.setProperty(`--${k}`, v);
  });
  state.daycardSize = preset.key;
  if (shouldSave) {
    saveState();
    const sizeLabel = DAYCARD_SIZE_LABELS[preset.key] || preset.key;
    showToast(formatChangeToast("表示サイズ", sizeLabel));
  }
  if(daycardSizeToggle){
    daycardSizeToggle.querySelectorAll(".size-btn").forEach(btn=>{
      btn.classList.toggle("active", btn.dataset.size === preset.key);
    });
  }
}

function applyToastColor(colorValue, { shouldSave = true } = {}){
  const color = colorValue || DEFAULT_SETTINGS.toastColor;
  document.documentElement.style.setProperty("--toast-bg", color);
  state.toastColor = color;
  if (toastColorEl) toastColorEl.value = color;
  if (shouldSave) {
    saveState();
    showToast(formatChangeToast("トーストカラー", color.toUpperCase()));
  }
}

function applySaveButtonVisibility(){
  if (!quickSaveButton) return;
  quickSaveButton.classList.toggle("is-hidden", !state.showSaveButton);
}

function typeLabel(key){
  if(key === "all") return "すべての区分";
  const found = TYPE_OPTIONS.find(t=>t.key===key);
  return found?.label || key;
}

function uniq(arr){ return Array.from(new Set(arr)); }
function str(v){ return String(v??"").trim(); }
function esc(v){ return String(v??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"); }
function normalizeClassGroupName(value){
  const raw = str(value);
  if (!raw) return "";
  const trimmed = raw.replace(CLASS_GROUP_SUFFIX_PATTERN, "").trim();
  return trimmed || raw;
}
function isSameClassGroup(a, b){
  if (!a && !b) return true;
  return normalizeClassGroupName(a) === normalizeClassGroupName(b);
}
function getCustomChildrenForClass(school, clazz){
  if(!school || !clazz) return [];
  const normalizedClass = normalizeClassGroupName(clazz);
  const directKey = `${school}__${normalizedClass}`;
  const direct = state.customChildren?.[directKey];
  if (Array.isArray(direct) && direct.length) return direct;
  const legacyKey = `${school}__${clazz}`;
  const legacy = state.customChildren?.[legacyKey];
  return Array.isArray(legacy) ? legacy : [];
}
function clampInt(v,min,max){
  const n = Number(v);
  if(Number.isNaN(n)) return min;
  return Math.max(min, Math.min(max, Math.floor(n)));
}
function clampNumber(v, min, max, fallback = min){
  const n = Number(v);
  if (Number.isNaN(n)) return fallback;
  return Math.max(min, Math.min(max, n));
}

function cloneDefaults(){
  if (typeof structuredClone === "function") {
    return structuredClone(DEFAULT_SETTINGS);
  }
  return JSON.parse(JSON.stringify(DEFAULT_SETTINGS));
}

function cssEscape(v){
  if(typeof CSS !== "undefined" && CSS.escape){
    return CSS.escape(v);
  }
  return String(v??"").replace(/"/g,'\\"');
}

function makeRecordKey({rawDate, school, clazz, name}){
  return [rawDate||"", school||"", clazz||"", name||""].join("|");
}

/* =========================
   データノード管理
========================= */
function getLocalDataNodeId(){
  const user = activeUser || "ゲスト";
  return `local:${user}`;
}

function loadDataNodes(){
  try{
    const raw = localStorage.getItem(DATA_NODE_KEY);
    const parsed = raw ? JSON.parse(raw) : [];
    return Array.isArray(parsed) ? parsed : [];
  }catch{
    return [];
  }
}

function loadArchivedDataNodes(){
  try{
    const raw = localStorage.getItem(ARCHIVE_DATA_NODE_KEY);
    const parsed = raw ? JSON.parse(raw) : [];
    return Array.isArray(parsed) ? parsed : [];
  }catch{
    return [];
  }
}

function saveDataNodes(nodes){
  try{
    localStorage.setItem(DATA_NODE_KEY, JSON.stringify(nodes || []));
  }catch(error){
    console.error(error);
    recoverStorageFromOverflow({ reason: "履歴データ保存" });
  }
}

function saveArchivedDataNodes(nodes){
  try{
    localStorage.setItem(ARCHIVE_DATA_NODE_KEY, JSON.stringify(nodes || []));
  }catch(error){
    console.error("履歴ノードの退避保存に失敗しました", error);
  }
}

function buildArchiveNodeKey(node){
  const meta = normalizeNodeMeta(node);
  const stamp = meta.updatedAt || meta.confirmedAt || meta.createdAt || 0;
  return `${node?.id || ""}|${stamp}`;
}

function archiveDataNodes(nodes, { reason = "cleanup", maxArchivedNodes = 500 } = {}){
  if (!Array.isArray(nodes) || nodes.length === 0) return;
  const now = Date.now();
  const archived = nodes.map((node) => ({
    ...node,
    archivedAt: now,
    archivedReason: reason
  }));
  const existing = loadArchivedDataNodes();
  const merged = archived.concat(existing);
  if (merged.length > maxArchivedNodes) {
    merged.sort((a, b) => (b.archivedAt || 0) - (a.archivedAt || 0));
  }
  saveArchivedDataNodes(merged.slice(0, Math.max(maxArchivedNodes, 0)));
}

function cleanupHistoryDataNodes({
  maxAgeDays = 120,
  maxHistoryNodes = 150
} = {}){
  const nodes = loadDataNodes();
  if (!nodes.length) return;
  const now = Date.now();
  const maxAgeMs = maxAgeDays * 24 * 60 * 60 * 1000;
  const localId = getLocalDataNodeId();
  const isLocalNode = (node) => node?.id === localId;
  const historyNodes = nodes.filter(node => node && !isLocalNode(node));
  const keepNodes = nodes.filter(node => node && isLocalNode(node));
  const freshNodes = historyNodes.filter(node => {
    const updatedAt = node.updatedAt || node.confirmedAt || 0;
    return updatedAt && now - updatedAt <= maxAgeMs;
  });
  const trimmedNodes = freshNodes
    .sort((a, b) => (b.updatedAt || b.confirmedAt || 0) - (a.updatedAt || a.confirmedAt || 0))
    .slice(0, Math.max(maxHistoryNodes, 0));
  const keptKeys = new Set(trimmedNodes.map(buildArchiveNodeKey));
  const archivedNodes = historyNodes.filter((node) => !keptKeys.has(buildArchiveNodeKey(node)));
  if (archivedNodes.length) {
    archiveDataNodes(archivedNodes, { reason: "cleanup" });
  }
  const nextNodes = keepNodes.concat(trimmedNodes);
  if (nextNodes.length !== nodes.length) {
    saveDataNodes(nextNodes);
  }
}

function formatNodeUpdatedAt(ts){
  if(!ts) return "更新日時不明";
  const dt = new Date(ts);
  const pad = (v)=>String(v).padStart(2,"0");
  return `${dt.getFullYear()}/${pad(dt.getMonth() + 1)}/${pad(dt.getDate())} ${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
}

function formatWorkDate(ts){
  if (!ts) return "—";
  const dt = new Date(ts);
  const pad = (v)=>String(v).padStart(2,"0");
  return `${dt.getFullYear()}/${pad(dt.getMonth() + 1)}/${pad(dt.getDate())}`;
}

function formatWorkTime(ts){
  if (!ts) return "—";
  const dt = new Date(ts);
  const pad = (v)=>String(v).padStart(2,"0");
  return `${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
}

function formatWorkDateKey(ts){
  if (!ts) return "";
  const dt = new Date(ts);
  const pad = (v) => String(v).padStart(2, "0");
  return `${dt.getFullYear()}-${pad(dt.getMonth() + 1)}-${pad(dt.getDate())}`;
}

function parseWorkDateKey(key){
  if (!key) return null;
  const parts = key.split("-").map(Number);
  if (parts.length !== 3) return null;
  const [year, month, day] = parts;
  if (!year || !month || !day) return null;
  return new Date(year, month - 1, day);
}

function getNodeWorkMeta(node){
  if (!node) return { startAt: null, endAt: null, workEffort: 0, workDateKey: "" };
  const payloadState = node?.payload?.state || {};
  const meta = normalizeNodeMeta(node);
  const startAt = payloadState.workStartAt || meta.createdAt || meta.updatedAt;
  const endAt = payloadState.lastUpdatedAt || meta.updatedAt || meta.createdAt;
  const workEffort = Number(payloadState.workEffort || 0);
  const workDateKey = formatWorkDateKey(startAt || endAt);
  return { startAt, endAt, workEffort, workDateKey };
}

function createDataNodePayload(){
  const { memoNotesA, memoNotesB, ...statePayload } = state;
  return {
    state: statePayload,
    lastResult,
    lastBaseResult,
    originalRows
  };
}

function dataNodeHasData(payload){
  if(!payload) return false;
  const rows = Array.isArray(payload.originalRows) ? payload.originalRows.length : 0;
  const details = payload.lastResult?.details?.length || 0;
  return rows > 0 || details > 0;
}

function updateLayerEmptyBadges(){
  const hasData = dataNodeHasData(createDataNodePayload());
  [summaryLayerEmptyBadge, detailLayerEmptyBadge].forEach((badge) => {
    if (!badge) return;
    badge.hidden = hasData;
    badge.setAttribute("aria-hidden", hasData ? "true" : "false");
  });
}

function listifyUsers(value){
  if (!value) return [];
  return Array.isArray(value) ? value.filter(Boolean) : [value].filter(Boolean);
}

function getKnownUserProfiles(){
  try {
    const raw = localStorage.getItem("encho_user_profiles_v1");
    if (!raw) return [];
    const parsed = JSON.parse(raw);
    return Object.keys(parsed?.profiles || {}).filter(Boolean);
  } catch (error) {
    console.warn("ユーザープロファイルの読み込みに失敗しました", error);
    return [];
  }
}

function isNodeOwnedByActiveUser(node){
  const currentUser = activeUser || "ゲスト";
  const owners = listifyUsers(node?.owners);
  const users = listifyUsers(node?.user);
  return owners.includes(currentUser) || users.includes(currentUser);
}

function buildConfirmedNode(payload, { source = "出力" } = {}){
  const now = Date.now();
  const baseUser = activeUser || "ゲスト";
  const sharedOwners = uniq([...getKnownUserProfiles(), baseUser]);
  return {
    id: `confirmed:${baseUser}:${now}`,
    user: baseUser,
    updatedAt: now,
    payload,
    createdAt: now,
    createdBy: baseUser,
    updatedBy: [baseUser],
    owners: sharedOwners,
    versionName: `${APP_VERSION.label}（確定）`,
    confirmedAt: now,
    confirmedBy: baseUser,
    confirmedSource: source
  };
}

function formatHistoryNodeLabel(node){
  const userLabel = node?.user || activeUser || "ゲスト";
  return `履歴データ: ${userLabel}`;
}

function areDataNodePayloadsEqual(a, b){
  if(!a || !b) return false;
  try{
    return JSON.stringify(a) === JSON.stringify(b);
  }catch{
    return false;
  }
}

function getDataNodePayloadSignature(node){
  if (!node?.payload) return null;
  try {
    return JSON.stringify(node.payload);
  } catch {
    return null;
  }
}

function getUniqueDataNodes(nodes = [], { activeId = null } = {}){
  const uniqueNodes = new Map();
  nodes.forEach((node) => {
    if (!node) return;
    const signature = getDataNodePayloadSignature(node);
    const key = signature || `id:${node.id}`;
    if (!uniqueNodes.has(key)) {
      uniqueNodes.set(key, node);
      return;
    }
    const existing = uniqueNodes.get(key);
    if (!existing) {
      uniqueNodes.set(key, node);
      return;
    }
    const isActive = activeId && node.id === activeId;
    const existingIsActive = activeId && existing.id === activeId;
    if (isActive && !existingIsActive) {
      uniqueNodes.set(key, node);
      return;
    }
    if (existingIsActive && !isActive) return;
    const existingUpdatedAt = existing.updatedAt || existing.confirmedAt || existing.createdAt || 0;
    const nodeUpdatedAt = node.updatedAt || node.confirmedAt || node.createdAt || 0;
    if (nodeUpdatedAt > existingUpdatedAt) {
      uniqueNodes.set(key, node);
    }
  });
  return Array.from(uniqueNodes.values());
}

function syncLocalDataNode(){
  const nodes = loadDataNodes();
  const localId = getLocalDataNodeId();
  const updatedAt = state.lastUpdatedAt || Date.now();
  const payload = createDataNodePayload();
  const existing = nodes.find(node => node.id === localId);
  const baseUser = activeUser || "ゲスト";
  const createdAt = existing?.createdAt || existing?.updatedAt || updatedAt;
  const createdBy = existing?.createdBy || listifyUsers(existing?.user)[0] || baseUser;
  const updatedBy = uniq([...listifyUsers(existing?.updatedBy), ...listifyUsers(existing?.user), baseUser]);
  const owners = uniq([...listifyUsers(existing?.owners), ...listifyUsers(existing?.user), baseUser]);
  const versionName = existing?.versionName || APP_VERSION.label;
  const baseNode = {
    id: localId,
    user: activeUser || "ゲスト",
    updatedAt,
    payload,
    createdAt,
    createdBy,
    updatedBy,
    owners,
    versionName
  };
  const idx = nodes.findIndex(node => node.id === localId);
  if(idx >= 0){
    nodes[idx] = { ...nodes[idx], ...baseNode };
  } else {
    nodes.push(baseNode);
  }
  saveDataNodes(nodes);
  return nodes;
}

function saveConfirmedDataNode({ source = "出力" } = {}){
  const payload = createDataNodePayload();
  if (!dataNodeHasData(payload)) {
    showToast("先にCSVを読み込んでください。");
    return false;
  }
  const nodes = loadDataNodes();
  const confirmedNode = buildConfirmedNode(payload, { source });
  nodes.push(confirmedNode);
  saveDataNodes(nodes);
  return true;
}

function refreshDataWithNodeExport({ source = "リフレッシュ" } = {}){
  storageFallbackAttempted = false;
  const payload = createDataNodePayload();
  const hasData = dataNodeHasData(payload);
  const confirmedNode = hasData ? buildConfirmedNode(payload, { source }) : null;
  try {
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(DATA_NODE_KEY);
    if (confirmedNode) {
      localStorage.setItem(DATA_NODE_KEY, JSON.stringify([confirmedNode]));
    }
  } catch (error) {
    console.error("データリフレッシュに失敗しました", error);
  }
  const emptyPayload = {
    state: cloneDefaults(),
    lastResult: null,
    lastBaseResult: null,
    originalRows: []
  };
  applyDataNodePayload(emptyPayload, getLocalDataNodeId());
  setDataSourceMeta("未読み込み", null);
  renderDetails([]);
  renderSummary([], []);
  updateLayerEmptyBadges();
}

function reloadDataByClassOnOverflow({ reason = "容量不足" } = {}){
  if (storageFallbackAttempted) return false;
  if (!Array.isArray(originalRows) || originalRows.length === 0) return false;
  const classes = uniq(originalRows.map(row => normalizeClassGroupName(str(row?.["所属"]))).filter(Boolean));
  if (!classes.length) return false;
  const targetClass = state.activeClass && classes.includes(state.activeClass) ? state.activeClass : classes[0];
  const filteredRows = originalRows.filter(row => normalizeClassGroupName(str(row?.["所属"])) === targetClass);
  if (!filteredRows.length) return false;
  storageFallbackAttempted = true;
  originalRows = filteredRows;
  const result = calculate(filteredRows);
  lastBaseResult = calculate(filteredRows, stripTypeOverrides(state.overridesByKey));
  lastResult = result;
  renderDetails(result.details);
  setDataSourceMeta(`クラス読込: ${targetClass}`, new Date());
  expandPanelsForInitialView();
  selectDetailDisplayAfterLoad();
  activateChildSummaryTab();
  saveState({ skipNodeSync: true, skipPersist: true });
  showToast(`容量不足のため、クラス単位で読み込み直しました。(${targetClass})`);
  return true;
}

function recoverStorageFromOverflow({ reason = "保存" } = {}){
  if (reloadDataByClassOnOverflow({ reason })) return;
  refreshDataWithNodeExport({ source: `容量不足:${reason}` });
  showToast("容量不足のため、現在のデータを退避してリフレッシュしました。");
}

function applyDataNodePayload(payload, nodeId, { restoreDisplayMode = true } = {}){
  if(!payload?.state) return;
  const previousDisplayMode = state.displayMode;
  const previousSummaryViewMode = state.summaryViewMode;
  const { memoNotesA, memoNotesB, ...payloadState } = payload.state;
  state = {
    ...cloneDefaults(),
    ...payloadState
  };
  if (!state.activeName && state.summaryLastTarget?.name) {
    state.activeSchool = state.summaryLastTarget.school;
    state.activeClass = state.summaryLastTarget.clazz;
    state.activeName = state.summaryLastTarget.name;
  }
  const shouldRestoreDisplayMode = restoreDisplayMode && document.readyState !== "loading";
  if (!shouldRestoreDisplayMode) {
    state.displayMode = "detail";
    state.summaryViewMode = "summary";
  }
  expandPanelsForInitialView({ shouldApply: false });
  state.dataNodeSelectedId = nodeId || state.dataNodeSelectedId;
  saveState({ skipNodeSync: true });
  originalRows = Array.isArray(payload.originalRows) ? payload.originalRows : [];
  lastResult = payload.lastResult || null;
  lastBaseResult = payload.lastBaseResult || null;
  state.vacationPeriods = normalizeVacationPeriods(state.vacationPeriods);
  state.timeSettings = normalizeTimeSettings(state.timeSettings);
  state.feeSettings = normalizeFeeSettings(state.feeSettings);
  state.toastDuration = Number.isFinite(state.toastDuration) ? state.toastDuration : DEFAULT_SETTINGS.toastDuration;
  applyTheme(state.themeName, { shouldSave: false });
  applyDaycardSize(state.daycardSize, { shouldSave: false });
  applyToastColor(state.toastColor || DEFAULT_SETTINGS.toastColor, { shouldSave: false });
  applySettingsToInputs();
  renderDetails(lastResult?.details || []);
  if (lastResult?.summary?.length){
    renderSummary(lastResult.summary, lastResult.details || []);
  } else {
    summaryContainer.innerHTML = "";
  }
  if (shouldRestoreDisplayMode) {
    const displayModeKey = previousDisplayMode === "summary"
      ? (previousSummaryViewMode === "changed" ? "changed" : "summary")
      : "detail";
    setDisplayMode(displayModeKey, { shouldSave: false });
  }
  renderMemoNotes();
  updateChildSelectOptions(childTypeSelect);
  updateBulkMenuContext({ school: state.activeSchool, clazz: state.activeClass });
  updateLayerEmptyBadges();
}

function applyHistoryNode(node, { restoreDisplayMode = true } = {}){
  if(!node?.payload) return false;
  state.dataNodeSelectedId = node.id || state.dataNodeSelectedId;
  applyDataNodePayload(node.payload, node.id, { restoreDisplayMode });
  setDataSourceMeta(formatHistoryNodeLabel(node), node.updatedAt ? new Date(node.updatedAt) : null);
  return true;
}

function loadHistoryData(){
  const nodes = loadDataNodes().filter(node => dataNodeHasData(node.payload));
  if(!nodes.length){
    showToast("履歴データがありません。");
    return;
  }
  if(nodes.length === 1){
    applyHistoryNode(nodes[0]);
    expandPanelsForInitialView();
    selectDetailDisplayAfterLoad();
    return;
  }
  openHistoryDetailModal();
}

function restoreHistoryDataOnLoad(){
  const nodes = loadDataNodes();
  const localId = getLocalDataNodeId();
  const activeId = state.dataNodeSelectedId || localId;
  const activeNode = nodes.find(node => node.id === activeId);
  if(activeNode?.payload && dataNodeHasData(activeNode.payload)){
    applyHistoryNode(activeNode, { restoreDisplayMode: false });
    return true;
  }
  return false;
}

function refreshDataNodesOnLoad(){
  const nodes = loadDataNodes();
  const localId = getLocalDataNodeId();
  if (!state.dataNodeSelectedId) {
    state.dataNodeSelectedId = localId;
  }
  const activeId = state.dataNodeSelectedId || localId;
  const activeNode = nodes.find(node => node.id === activeId);
  if (!activeNode) {
    state.dataNodeSelectedId = localId;
    saveState({ skipNodeSync: true });
  }
  syncLocalDataNode();
}

function getDataNodeSummaryInfo(){
  const activeId = state.dataNodeSelectedId || getLocalDataNodeId();
  const nodes = getUniqueDataNodes(loadDataNodes(), { activeId });
  const localId = getLocalDataNodeId();
  const activeNode = nodes.find(node => node.id === activeId);
  const multiNodes = nodes.filter(node => dataNodeHasData(node.payload));
  if(multiNodes.length <= 1) return { show: false, label: "" };
  const activeLabel = activeNode?.user || activeUser || "ゲスト";
  return { show: true, label: `${activeLabel}のデータ表示中` };
}

function openDataNodeModal(){
  if(!dataNodeModal || !dataNodeList) return;
  const activeId = state.dataNodeSelectedId || getLocalDataNodeId();
  const nodes = getUniqueDataNodes(loadDataNodes(), { activeId });
  const localId = getLocalDataNodeId();
  dataNodeList.innerHTML = nodes.map(node => {
    const isActive = node.id === activeId;
    const deleteDisabled = node.id === localId;
    return `
      <div class="data-node-row ${isActive ? "is-active" : ""}">
        <div class="data-node-info">
          <div class="data-node-user">${esc(node.user || "ゲスト")}${isActive ? "（表示中）" : ""}</div>
          <div class="data-node-meta">最終更新: ${esc(formatNodeUpdatedAt(node.updatedAt))}</div>
        </div>
        <div class="data-node-actions">
          <button type="button" class="primary" data-node-select="${esc(node.id)}">表示</button>
          <button type="button" data-node-delete="${esc(node.id)}" ${deleteDisabled ? "disabled" : ""}>削除</button>
        </div>
      </div>
    `;
  }).join("");
  dataNodeModal.classList.add("open");
  dataNodeModal.setAttribute("aria-hidden", "false");
}

function getRecordKeyFromRow(row){
  if(!row) return "";
  return makeRecordKey({
    rawDate: row["日付"],
    school: row["園"],
    clazz: row["所属"],
    name: row["名前"]
  });
}

function buildDetailMap(details = []){
  const map = new Map();
  details.forEach(detail => {
    if (!detail?.recordKey) return;
    map.set(detail.recordKey, detail);
  });
  return map;
}

function buildChildDetailMap(details = []){
  const map = new Map();
  details.forEach(detail => {
    const key = childKey(detail);
    if (!key) return;
    const list = map.get(key) || [];
    list.push(detail);
    map.set(key, list);
  });
  return map;
}

function normalizeDetailList(list = []){
  return list.slice().sort((a, b) => (a.recordKey || "").localeCompare(b.recordKey || ""));
}

function getDetailLabel(detail, fallback){
  if (detail?.name && detail?.school && detail?.clazz) {
    return formatChildLabel({ name: detail.name, school: detail.school, clazz: detail.clazz });
  }
  if (fallback?.name && fallback?.school && fallback?.clazz) {
    return formatChildLabel(fallback);
  }
  return "園児未設定";
}

function buildDatasetCompareInfo(localNode, otherNode){
  const localDetails = localNode?.payload?.lastResult?.details || [];
  const otherDetails = otherNode?.payload?.lastResult?.details || [];
  const localSummary = localNode?.payload?.lastResult?.summary || [];
  const otherSummary = otherNode?.payload?.lastResult?.summary || [];
  const localDetailMap = buildDetailMap(localDetails);
  const otherDetailMap = buildDetailMap(otherDetails);
  const recordKeys = new Set([...localDetailMap.keys(), ...otherDetailMap.keys()]);
  const recordDiffs = [];
  recordKeys.forEach((recordKey) => {
    const localDetail = localDetailMap.get(recordKey);
    const otherDetail = otherDetailMap.get(recordKey);
    if (!localDetail || !otherDetail || JSON.stringify(localDetail) !== JSON.stringify(otherDetail)) {
      const info = parseRecordKey(recordKey);
      const dateLabel = localDetail?.date || otherDetail?.date || info.rawDate || "";
      const childLabel = getDetailLabel(localDetail || otherDetail, info);
      recordDiffs.push({
        recordKey,
        childKey: childKey(localDetail || info),
        childLabel,
        dateLabel
      });
    }
  });
  const localChildMap = buildChildDetailMap(localDetails);
  const otherChildMap = buildChildDetailMap(otherDetails);
  const childKeys = new Set([...localChildMap.keys(), ...otherChildMap.keys()]);
  const summaryMap = (summaryList = []) => {
    const map = new Map();
    summaryList.forEach(item => {
      map.set(childKey(item), item);
    });
    return map;
  };
  const localSummaryMap = summaryMap(localSummary);
  const otherSummaryMap = summaryMap(otherSummary);
  const childDiffs = [];
  childKeys.forEach((key) => {
    const localList = normalizeDetailList(localChildMap.get(key) || []);
    const otherList = normalizeDetailList(otherChildMap.get(key) || []);
    const localSummaryItem = localSummaryMap.get(key);
    const otherSummaryItem = otherSummaryMap.get(key);
    const diffByDetails = JSON.stringify(localList) !== JSON.stringify(otherList);
    const diffBySummary = JSON.stringify(localSummaryItem || {}) !== JSON.stringify(otherSummaryItem || {});
    if (diffByDetails || diffBySummary) {
      const sample = localList[0] || otherList[0];
      const label = sample
        ? formatChildLabel({ name: sample.name, school: sample.school, clazz: sample.clazz })
        : key || "園児未設定";
      const recordCount = recordDiffs.filter(diff => diff.childKey === key).length;
      childDiffs.push({
        childKey: key,
        label,
        recordCount
      });
    }
  });
  return {
    childDiffs,
    recordDiffs
  };
}

function closeDatasetCompareModal(){
  if(!datasetCompareModal) return;
  datasetCompareModal.classList.remove("open");
  datasetCompareModal.setAttribute("aria-hidden", "true");
}

function renderDatasetCompareModal({ group, localNode, otherNode }){
  if (!datasetCompareBody || !datasetCompareModal || !group || !localNode || !otherNode) return;
  const compareInfo = buildDatasetCompareInfo(localNode, otherNode);
  datasetCompareState.childSelections = new Map();
  datasetCompareState.recordSelections = new Map();
  datasetCompareState.nodeSelection = "local";
  compareInfo.childDiffs.forEach(diff => datasetCompareState.childSelections.set(diff.childKey, "local"));
  compareInfo.recordDiffs.forEach(diff => datasetCompareState.recordSelections.set(diff.recordKey, "local"));
  datasetCompareState.compareInfo = compareInfo;
  const otherCandidates = group.nodes.filter(node => node.id !== localNode.id);
  const localMetaRows = buildDatasetCompareMetaRows(localNode);
  const otherMetaRows = buildDatasetCompareMetaRows(otherNode);
  const otherOptions = otherCandidates.map(node => {
    const isActive = node.id === otherNode.id;
    return `
      <button type="button" class="dataset-compare-tab ${isActive ? "active" : ""}" data-compare-other="${esc(node.id)}">
        ${esc(formatNodeUsers(node))}
      </button>
    `;
  }).join("");
  const childRows = compareInfo.childDiffs.length
    ? compareInfo.childDiffs.map(diff => {
      const selected = datasetCompareState.childSelections.get(diff.childKey) || "local";
      return `
        <div class="dataset-compare-row" data-compare-child-row="${esc(diff.childKey)}">
          <div>
            <div class="dataset-compare-title">${esc(diff.label)}</div>
            <div class="dataset-compare-sub">差分: ${diff.recordCount}件</div>
          </div>
          <div class="dataset-compare-actions">
            <button type="button" class="${selected === "local" ? "active" : ""}" data-compare-child="${esc(diff.childKey)}" data-compare-select="local">自分</button>
            <button type="button" class="${selected === "other" ? "active" : ""}" data-compare-child="${esc(diff.childKey)}" data-compare-select="other">相手</button>
          </div>
        </div>
      `;
    }).join("")
    : `<p class="muted">園児単位の差分はありません。</p>`;
  const recordRows = compareInfo.recordDiffs.length
    ? compareInfo.recordDiffs.map(diff => {
      const selected = datasetCompareState.recordSelections.get(diff.recordKey) || "local";
      return `
        <div class="dataset-compare-row">
          <div>
            <div class="dataset-compare-title">${esc(diff.childLabel)} / ${esc(diff.dateLabel || "日付未設定")}</div>
            <div class="dataset-compare-sub">記録キー: ${esc(diff.recordKey)}</div>
          </div>
          <div class="dataset-compare-actions">
            <button type="button" class="${selected === "local" ? "active" : ""}" data-compare-record="${esc(diff.recordKey)}" data-compare-select="local">自分</button>
            <button type="button" class="${selected === "other" ? "active" : ""}" data-compare-record="${esc(diff.recordKey)}" data-compare-select="other">相手</button>
          </div>
        </div>
      `;
    }).join("")
    : `<p class="muted">基礎値単位の差分はありません。</p>`;
  datasetCompareBody.innerHTML = `
    <div class="dataset-compare-section">
      <div class="dataset-compare-title">比較相手の選択</div>
      <div class="dataset-compare-sub">対象のユーザーを選ぶと差分リストが更新されます。</div>
      <div class="dataset-compare-tabs">${otherOptions}</div>
    </div>
    <div class="dataset-compare-tabs" id="datasetCompareTabs">
      <button type="button" class="dataset-compare-tab ${datasetCompareState.mode === "node" ? "active" : ""}" data-compare-mode="node">ノード全体</button>
      <button type="button" class="dataset-compare-tab ${datasetCompareState.mode === "child" ? "active" : ""}" data-compare-mode="child">園児単位</button>
      <button type="button" class="dataset-compare-tab ${datasetCompareState.mode === "record" ? "active" : ""}" data-compare-mode="record">基礎値単位</button>
    </div>
    <div class="dataset-compare-panel" data-compare-panel="node" ${datasetCompareState.mode === "node" ? "" : "hidden"}>
      <div class="dataset-compare-section">
        <div class="dataset-compare-row">
          <div>
            <div class="dataset-compare-title">自分のデータ</div>
            <div class="dataset-compare-sub">${esc(formatNodeUsers(localNode))}</div>
            <div class="dataset-compare-meta">${localMetaRows}</div>
          </div>
          <div class="dataset-compare-actions">
            <button type="button" class="${datasetCompareState.nodeSelection === "local" ? "active" : ""}" data-compare-node="local">自分を優先</button>
          </div>
        </div>
        <div class="dataset-compare-row">
          <div>
            <div class="dataset-compare-title">相手のデータ</div>
            <div class="dataset-compare-sub">${esc(formatNodeUsers(otherNode))}</div>
            <div class="dataset-compare-meta">${otherMetaRows}</div>
          </div>
          <div class="dataset-compare-actions">
            <button type="button" class="${datasetCompareState.nodeSelection === "other" ? "active" : ""}" data-compare-node="other">相手を優先</button>
          </div>
        </div>
      </div>
    </div>
    <div class="dataset-compare-panel" data-compare-panel="child" ${datasetCompareState.mode === "child" ? "" : "hidden"}>
      <div class="dataset-compare-section">${childRows}</div>
    </div>
    <div class="dataset-compare-panel" data-compare-panel="record" ${datasetCompareState.mode === "record" ? "" : "hidden"}>
      <div class="dataset-compare-section">${recordRows}</div>
    </div>
  `;
  datasetCompareModal.classList.add("open");
  datasetCompareModal.setAttribute("aria-hidden", "false");
}

function openDatasetCompareModal(groupKey){
  const groups = getHistoryDatasetGroups();
  const group = groups.find(item => item.key === groupKey);
  if (!group || group.nodes.length < 2) return;
  const localId = getLocalDataNodeId();
  const localNode = group.nodes.find(node => node.id === localId) || group.nodes[0];
  const otherNodes = group.nodes.filter(node => node.id !== localNode.id);
  if (!otherNodes.length) return;
  const otherNode = otherNodes.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0))[0];
  datasetCompareState.groupKey = group.key;
  datasetCompareState.otherNodeId = otherNode.id;
  datasetCompareState.mode = "node";
  renderDatasetCompareModal({ group, localNode, otherNode });
}

function mergeOverridesBySelection(baseOverrides, otherOverrides, recordKeys){
  const next = { ...(baseOverrides || {}) };
  recordKeys.forEach((rk) => {
    if (otherOverrides && Object.prototype.hasOwnProperty.call(otherOverrides, rk)) {
      next[rk] = otherOverrides[rk];
    } else {
      delete next[rk];
    }
  });
  return next;
}

function mergeRowsBySelection(baseRows, otherRows, recordKeys){
  const baseMap = new Map();
  baseRows.forEach(row => {
    const rk = getRecordKeyFromRow(row);
    if (!rk) return;
    baseMap.set(rk, row);
  });
  const otherMap = new Map();
  otherRows.forEach(row => {
    const rk = getRecordKeyFromRow(row);
    if (!rk) return;
    otherMap.set(rk, row);
  });
  recordKeys.forEach((rk) => {
    if (otherMap.has(rk)) {
      baseMap.set(rk, otherMap.get(rk));
    }
  });
  return Array.from(baseMap.values());
}

function applyDatasetCompareSelection(){
  const groupKey = datasetCompareState.groupKey;
  if (!groupKey) return;
  const group = getHistoryDatasetGroups().find(item => item.key === groupKey);
  if (!group) return;
  const localId = getLocalDataNodeId();
  const localNode = group.nodes.find(node => node.id === localId);
  const otherNode = group.nodes.find(node => node.id === datasetCompareState.otherNodeId);
  if (!localNode || !otherNode) return;
  if (datasetCompareState.mode === "node") {
    const targetNode = datasetCompareState.nodeSelection === "other" ? otherNode : localNode;
    applyHistoryNode(targetNode);
    syncLocalDataNode();
    closeDatasetCompareModal();
    return;
  }
  const selectedChildKeys = Array.from(datasetCompareState.childSelections.entries())
    .filter(([, value]) => value === "other")
    .map(([key]) => key);
  const selectedRecordKeys = Array.from(datasetCompareState.recordSelections.entries())
    .filter(([, value]) => value === "other")
    .map(([key]) => key);
  const basePayload = localNode.payload || {};
  const otherPayload = otherNode.payload || {};
  const baseRows = Array.isArray(basePayload.originalRows) ? basePayload.originalRows : [];
  const otherRows = Array.isArray(otherPayload.originalRows) ? otherPayload.originalRows : [];
  let mergedRows = baseRows;
  if (selectedChildKeys.length) {
    const childKeySet = new Set(selectedChildKeys);
    mergedRows = mergedRows.filter(row => !childKeySet.has(childKey({ name: row?.["名前"], school: row?.["園"], clazz: row?.["所属"] })));
    const otherChildRows = otherRows.filter(row => childKeySet.has(childKey({ name: row?.["名前"], school: row?.["園"], clazz: row?.["所属"] })));
    mergedRows = mergedRows.concat(otherChildRows);
  }
  if (selectedRecordKeys.length) {
    mergedRows = mergeRowsBySelection(mergedRows, otherRows, selectedRecordKeys);
  }
  const baseOverrides = basePayload.state?.overridesByKey || {};
  const otherOverrides = otherPayload.state?.overridesByKey || {};
  let mergedOverrides = { ...baseOverrides };
  if (selectedChildKeys.length) {
    const baseDetails = basePayload.lastResult?.details || [];
    const recordKeysForChildren = baseDetails
      .filter(detail => selectedChildKeys.includes(childKey(detail)))
      .map(detail => detail.recordKey)
      .filter(Boolean);
    mergedOverrides = mergeOverridesBySelection(mergedOverrides, otherOverrides, recordKeysForChildren);
  }
  if (selectedRecordKeys.length) {
    mergedOverrides = mergeOverridesBySelection(mergedOverrides, otherOverrides, selectedRecordKeys);
  }
  const nextState = {
    ...cloneDefaults(),
    ...(basePayload.state || {}),
    overridesByKey: mergedOverrides
  };
  const nextResult = calculate(mergedRows);
  const nextBaseResult = calculate(mergedRows, stripTypeOverrides(mergedOverrides));
  const mergedPayload = {
    state: nextState,
    lastResult: nextResult,
    lastBaseResult: nextBaseResult,
    originalRows: mergedRows
  };
  applyDataNodePayload(mergedPayload, localId);
  state.dataNodeSelectedId = localId;
  setDataSourceMeta(`データセット比較: ${formatNodeUsers(localNode)}`, new Date());
  syncLocalDataNode();
  closeDatasetCompareModal();
}

function formatHistoryRangeLabel(range){
  const start = keyToDate(range?.minKey);
  const end = keyToDate(range?.maxKey);
  if (!start || !end) return "—";
  const startLabel = formatYMD(start.getFullYear(), start.getMonth() + 1, start.getDate());
  const endLabel = formatYMD(end.getFullYear(), end.getMonth() + 1, end.getDate());
  return `${startLabel}〜${endLabel}`;
}

function getNodeChangeCount(payload){
  const changes = payload?.state?.typeChangeHistory;
  return Array.isArray(changes) ? changes.length : 0;
}

function formatNodeUsers(node){
  const baseLabel = Array.isArray(node?.user)
    ? (node.user.filter(Boolean).join("、") || "ゲスト")
    : (node?.user || "ゲスト");
  return node?.confirmedAt ? `${baseLabel}（確定）` : baseLabel;
}

function normalizeNodeMeta(node){
  const userList = listifyUsers(node?.user);
  const createdAt = node?.createdAt || node?.updatedAt || null;
  const createdBy = node?.createdBy || userList[0] || "不明";
  const updatedBy = uniq([...listifyUsers(node?.updatedBy), ...userList]);
  const owners = uniq([...listifyUsers(node?.owners), ...userList]);
  const versionName = node?.versionName || APP_VERSION.label;
  return {
    updatedAt: node?.updatedAt || null,
    createdAt,
    createdBy,
    updatedBy,
    owners,
    versionName
  };
}

function buildStartupWorkMetaRows(node, options = {}){
  if (!node) return [];
  const { forceZeroTime = false } = options;
  const meta = normalizeNodeMeta(node);
  const { startAt, endAt, workEffort } = getNodeWorkMeta(node);
  const workDate = startAt || endAt;
  const timePlaceholder = forceZeroTime ? "00:00" : null;
  const startLabel = timePlaceholder || (startAt ? formatWorkTime(startAt) : "—");
  const endLabel = timePlaceholder || (endAt ? formatWorkTime(endAt) : "—");
  return [
    { label: "作業日", value: workDate ? formatWorkDate(workDate) : "—" },
    { label: "作業開始", value: startLabel },
    { label: "作業終了時間", value: endLabel },
    { label: "作業工程数", value: `${workEffort.toLocaleString()}回` },
    { label: "作成者", value: meta.createdBy || "不明" },
    { label: "更新者", value: meta.updatedBy.length ? meta.updatedBy.join("、") : "—" }
  ];
}

function renderStartupMetaRows(container, rows, emptyLabel){
  if (!container) return;
  if (!rows || !rows.length) {
    container.innerHTML = `<div class="startup-choice-empty">${esc(emptyLabel || "データがありません。")}</div>`;
    return;
  }
  container.innerHTML = rows.map(row => `
    <div class="startup-choice-meta-row">
      <div class="startup-choice-meta-label">${esc(row.label)}</div>
      <div class="startup-choice-meta-value">${esc(row.value)}</div>
    </div>
  `).join("");
}

function getStartupCalendarNodes(mode){
  const activeId = state.dataNodeSelectedId || getLocalDataNodeId();
  const nodes = getUniqueDataNodes(loadDataNodes(), { activeId })
    .filter(node => dataNodeHasData(node.payload));
  const localId = getLocalDataNodeId();
  if (mode === "last") {
    const activeId = state.dataNodeSelectedId || localId;
    const activeNode = nodes.find(node => node.id === activeId);
    return activeNode ? [activeNode] : [];
  }
  return nodes.filter(node => node.id !== localId);
}

function buildStartupCalendarEntries(mode){
  const nodes = getStartupCalendarNodes(mode);
  const entryMap = new Map();
  nodes.forEach((node) => {
    const { workDateKey, startAt, endAt, workEffort } = getNodeWorkMeta(node);
    if (!workDateKey) return;
    const existing = entryMap.get(workDateKey) || {
      key: workDateKey,
      date: parseWorkDateKey(workDateKey),
      nodes: [],
      startAt,
      endAt,
      workEffort,
      updatedAt: 0,
      node: null
    };
    existing.nodes.push(node);
    const updatedAt = node.updatedAt || node.confirmedAt || node.createdAt || 0;
    if (updatedAt >= (existing.updatedAt || 0)) {
      existing.updatedAt = updatedAt;
      existing.startAt = startAt;
      existing.endAt = endAt;
      existing.workEffort = workEffort;
      existing.node = node;
    }
    entryMap.set(workDateKey, existing);
  });
  return Array.from(entryMap.values()).sort((a, b) => {
    return (b.date?.getTime() || 0) - (a.date?.getTime() || 0);
  });
}

function syncStartupCalendarSelection(entries){
  if (!entries.length) {
    startupCalendarSelection = null;
    return;
  }
  if (!startupCalendarSelection || !entries.some(entry => entry.key === startupCalendarSelection)) {
    startupCalendarSelection = entries[0].key;
  }
}

function ensureStartupCalendarMonth(entries){
  if (startupCalendarMonth instanceof Date && !Number.isNaN(startupCalendarMonth.getTime())) {
    return;
  }
  const entry = entries.find(item => item.key === startupCalendarSelection) || entries[0];
  const baseDate = entry?.date || new Date();
  startupCalendarMonth = new Date(baseDate.getFullYear(), baseDate.getMonth(), 1);
}

function shiftStartupCalendarMonth(delta){
  if (!startupCalendarMonth) {
    startupCalendarMonth = new Date();
  }
  startupCalendarMonth = new Date(startupCalendarMonth.getFullYear(), startupCalendarMonth.getMonth() + delta, 1);
  renderStartupCalendar();
}

function renderStartupCalendar(){
  startupCalendarEntries = buildStartupCalendarEntries(startupChoiceMode);
  syncStartupCalendarSelection(startupCalendarEntries);
  if (!startupCalendarGrid || !startupCalendarLabel) return;
  if (!startupCalendarEntries.length) {
    startupCalendarGrid.innerHTML = `<div class="startup-choice-empty">履歴データがありません。</div>`;
    startupCalendarLabel.textContent = "—";
    renderStartupMetaRows(startupHistoryMeta, [], "履歴データがありません。");
    if (startupCalendarStartBtn) startupCalendarStartBtn.disabled = true;
    return;
  }
  ensureStartupCalendarMonth(startupCalendarEntries);
  const year = startupCalendarMonth.getFullYear();
  const month = startupCalendarMonth.getMonth();
  startupCalendarLabel.textContent = `${year}年${String(month + 1).padStart(2, "0")}月`;
  const firstDay = new Date(year, month, 1);
  const startWeekday = firstDay.getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const entriesByDate = new Map(startupCalendarEntries.map(item => [item.key, item]));
  const cells = [];
  for (let i = 0; i < startWeekday; i += 1) {
    cells.push(`<div class="startup-calendar-cell" aria-hidden="true"></div>`);
  }
  for (let day = 1; day <= daysInMonth; day += 1) {
    const dateKey = formatWorkDateKey(new Date(year, month, day));
    const entry = entriesByDate.get(dateKey);
    const isSelected = entry && entry.key === startupCalendarSelection;
    const startLabel = entry?.startAt ? formatWorkTime(entry.startAt) : "—";
    const endLabel = entry?.endAt ? formatWorkTime(entry.endAt) : "—";
    const effortLabel = entry ? `${entry.workEffort.toLocaleString()}回` : "—";
    const dateLabel = entry ? formatWorkDate(entry.date || new Date(year, month, day)) : `${day}日`;
    const buttonDisabled = !entry;
    const buttonClass = [
      "startup-calendar-day",
      entry ? "has-work" : "",
      isSelected ? "is-selected" : ""
    ].filter(Boolean).join(" ");
    cells.push(`
      <div class="startup-calendar-cell">
        <button type="button" class="${buttonClass}" data-startup-calendar-day="${dateKey}" ${buttonDisabled ? "disabled" : ""}>
          <span class="date">${esc(dateLabel)}</span>
          <span class="meta">開始 ${esc(startLabel)}</span>
          <span class="meta">終了 ${esc(endLabel)}</span>
          <span class="meta">工数 ${esc(effortLabel)}</span>
        </button>
      </div>
    `);
  }
  startupCalendarGrid.innerHTML = cells.join("");
  const selectedEntry = startupCalendarEntries.find(item => item.key === startupCalendarSelection);
  renderStartupMetaRows(startupHistoryMeta, buildStartupWorkMetaRows(selectedEntry?.node), "履歴データがありません。");
  if (startupCalendarStartBtn) startupCalendarStartBtn.disabled = !selectedEntry?.node;
}

function setStartupChoiceMode(mode){
  startupChoiceMode = mode === "history" ? "history" : "last";
  if (startupOpenLastBtn) startupOpenLastBtn.classList.toggle("is-active", startupChoiceMode === "last");
  if (startupOpenHistoryBtn) startupOpenHistoryBtn.classList.toggle("is-active", startupChoiceMode === "history");
  if (startupCalendarTitle) {
    startupCalendarTitle.textContent = startupChoiceMode === "history"
      ? "履歴データの選択（カレンダー）"
      : "前回の画面の作業日（カレンダー）";
  }
  startupCalendarMonth = null;
  renderStartupCalendar();
}

function buildDatasetCompareMetaRows(node){
  const meta = normalizeNodeMeta(node);
  const rows = [
    { label: "最終更新日", value: meta.updatedAt ? formatNodeUpdatedAt(meta.updatedAt) : "更新日時不明" },
    { label: "作成者", value: meta.createdBy || "不明" },
    { label: "更新者", value: meta.updatedBy.length ? meta.updatedBy.join("、") : "—" },
    { label: "作成日", value: meta.createdAt ? formatNodeUpdatedAt(meta.createdAt) : "作成日時不明" },
    { label: "所有者", value: meta.owners.length ? meta.owners.join("、") : "—" },
    { label: "バージョン名", value: meta.versionName || "—" }
  ];
  return rows.map(row => `
    <div class="dataset-compare-meta-row">
      <div class="dataset-compare-meta-label">${esc(row.label)}</div>
      <div class="dataset-compare-meta-value">${esc(row.value)}</div>
    </div>
  `).join("");
}

function deriveDatasetMetaFromNode(node){
  const { workDateKey, startAt, endAt } = getNodeWorkMeta(node);
  const workDate = workDateKey ? parseWorkDateKey(workDateKey) : null;
  const dateLabel = workDate ? formatWorkDate(workDate) : "作業日未設定";
  return {
    key: workDateKey || "unknown",
    label: dateLabel,
    ymLabel: "作業日",
    schoolLabel: dateLabel,
    sortKey: (startAt || endAt || 0),
    range: workDate ? { start: workDate.getTime(), end: workDate.getTime() } : null
  };
}

function getHistoryDatasetGroups(){
  const activeId = state.dataNodeSelectedId || getLocalDataNodeId();
  const nodes = getUniqueDataNodes(loadDataNodes(), { activeId })
    .filter(node => dataNodeHasData(node.payload));
  const groups = new Map();
  nodes.forEach((node) => {
    const meta = deriveDatasetMetaFromNode(node);
    const current = groups.get(meta.key) || { ...meta, nodes: [] };
    current.nodes.push(node);
    groups.set(meta.key, current);
  });
  return Array.from(groups.values()).map(group => {
    const latestUpdatedAt = Math.max(...group.nodes.map(node => node.updatedAt || 0));
    const isOwned = group.nodes.some(node => isNodeOwnedByActiveUser(node));
    return { ...group, latestUpdatedAt, isOwned };
  }).sort((a, b) => {
    if (a.isOwned !== b.isOwned) return a.isOwned ? -1 : 1;
    if (a.latestUpdatedAt !== b.latestUpdatedAt) return b.latestUpdatedAt - a.latestUpdatedAt;
    return b.sortKey - a.sortKey;
  });
}

function selectHistoryDataset(datasetKey){
  historyDatasetState.datasetKey = datasetKey;
  historyDatasetState.unitId = null;
  renderHistoryDatasetPanels();
}

function selectHistoryDatasetUnit(unitId){
  historyDatasetState.unitId = unitId;
  renderHistoryDatasetPanels();
}

function deleteHistoryDataset(datasetKey){
  const groups = getHistoryDatasetGroups();
  const targetGroup = groups.find(group => group.key === datasetKey);
  if (!targetGroup) return;
  const localId = getLocalDataNodeId();
  const deletableIds = new Set(targetGroup.nodes.map(node => node.id).filter(id => id !== localId));
  if (!deletableIds.size) return;
  const nodes = loadDataNodes().filter(node => !deletableIds.has(node.id));
  saveDataNodes(nodes);
  if (deletableIds.has(state.dataNodeSelectedId)) {
    state.dataNodeSelectedId = getLocalDataNodeId();
    saveState();
  }
  if (historyDatasetState.datasetKey === datasetKey) {
    historyDatasetState.datasetKey = null;
    historyDatasetState.unitId = null;
  }
  renderHistoryDatasetPanels();
}

function renderHistoryDatasetPanels(){
  const groups = getHistoryDatasetGroups();
  if (!groups.length) {
    if (historyDatasetList) {
      historyDatasetList.innerHTML = `<div class="history-dataset-empty">履歴データがありません。</div>`;
    }
    if (historyDatasetDetailList) {
      historyDatasetDetailList.innerHTML = `<div class="history-dataset-empty">データセットを選択してください。</div>`;
    }
    if (historyDatasetSwapList) {
      historyDatasetSwapList.innerHTML = `<div class="history-dataset-empty">入れ替え候補はありません。</div>`;
    }
    return;
  }
  const activeGroup = groups.find(group => group.key === historyDatasetState.datasetKey)
    || groups[0];
  historyDatasetState.datasetKey = activeGroup?.key || null;
  const localId = getLocalDataNodeId();
  const activeUnit = activeGroup?.nodes.find(node => node.id === historyDatasetState.unitId)
    || activeGroup?.nodes.find(node => node.id === localId)
    || activeGroup?.nodes.find(node => node.id === state.dataNodeSelectedId)
    || activeGroup?.nodes[0];
  historyDatasetState.unitId = activeUnit?.id || null;
  renderHistoryDatasetList(groups, activeGroup?.key);
  renderHistoryDatasetDetailList(activeGroup);
  renderHistoryDatasetSwapList(activeGroup, activeUnit);
}

function renderHistoryDatasetList(groups, activeKey){
  if (!historyDatasetList) return;
  if (!groups.length) {
    historyDatasetList.innerHTML = `<div class="history-dataset-empty">履歴データがありません。</div>`;
    return;
  }
  const localId = getLocalDataNodeId();
  historyDatasetList.innerHTML = groups.map(group => {
    const isActive = group.key === activeKey;
    const users = uniq(group.nodes.map(node => formatNodeUsers(node))).join("、") || "ゲスト";
    const latestUpdatedAt = Math.max(...group.nodes.map(node => node.updatedAt || 0));
    const deletableCount = group.nodes.filter(node => node.id !== localId).length;
    const deleteDisabled = deletableCount === 0;
    const compareDisabled = group.nodes.length < 2;
    const ownedBadge = group.isOwned ? `<span class="history-dataset-badge">自分のデータ</span>` : "";
    const metaLine = [
      `最終更新: ${esc(formatNodeUpdatedAt(latestUpdatedAt))}`,
      `更新者: ${esc(users)}`,
      `バージョン: ${group.nodes.length}`
    ].join(" ｜ ");
    return `
      <div class="data-node-row history-dataset-row ${isActive ? "is-active" : ""}" data-history-dataset-row="${esc(group.key)}">
        <div class="data-node-info">
          <div class="data-node-user">${esc(group.label)}${ownedBadge}${isActive ? "（選択中）" : ""}</div>
          <div class="data-node-meta">${metaLine}</div>
        </div>
        <div class="data-node-actions">
          <button type="button" class="primary" data-history-dataset-detail="${esc(group.key)}">詳細</button>
          <button type="button" data-history-dataset-compare="${esc(group.key)}" ${compareDisabled ? "disabled" : ""}>組み合わせ</button>
          <button type="button" data-history-dataset-delete="${esc(group.key)}" ${deleteDisabled ? "disabled" : ""}>削除</button>
        </div>
      </div>
    `;
  }).join("");
}

function renderHistoryDatasetDetailList(group){
  if (!historyDatasetDetailList) return;
  if (!group) {
    historyDatasetDetailList.innerHTML = `<div class="history-dataset-empty">データセットを選択してください。</div>`;
    if (historyDatasetDetailTitle) historyDatasetDetailTitle.textContent = "データセット詳細";
    return;
  }
  if (historyDatasetDetailTitle) {
    historyDatasetDetailTitle.textContent = `${group.label} の内容`;
  }
  historyDatasetDetailList.innerHTML = group.nodes.map(node => {
    const payload = node.payload || {};
    const rowCount = Array.isArray(payload.originalRows) ? payload.originalRows.length : 0;
    const changeCount = getNodeChangeCount(payload);
    const isSelected = node.id === historyDatasetState.unitId;
    const isActive = node.id === state.dataNodeSelectedId;
    const metaLine = [
      `最終更新: ${esc(formatNodeUpdatedAt(node.updatedAt))}`,
      `データ行: ${rowCount.toLocaleString()}行`,
      `変更回数: ${changeCount.toLocaleString()}回`
    ].join(" ｜ ");
    const actionButton = isActive
      ? `<div class="data-node-actions">
          <button type="button" class="primary" data-history-type-change="${esc(node.id)}">区分変更</button>
        </div>`
      : "";
    return `
      <div class="data-node-row history-dataset-row ${isSelected ? "is-selected" : ""} ${isActive ? "is-active" : ""}" data-history-unit="${esc(node.id)}">
        <div class="data-node-info">
          <div class="data-node-user">${esc(formatNodeUsers(node))}${isActive ? "（表示中）" : ""}</div>
          <div class="data-node-meta">${metaLine}</div>
        </div>
        ${actionButton}
      </div>
    `;
  }).join("");
}

function renderHistoryDatasetSwapList(group, activeUnit){
  if (!historyDatasetSwapList) return;
  if (!group || !activeUnit) {
    historyDatasetSwapList.innerHTML = `<div class="history-dataset-empty">入れ替え候補はありません。</div>`;
    if (historyDatasetSwapTitle) historyDatasetSwapTitle.textContent = "入れ替え候補";
    return;
  }
  if (historyDatasetSwapTitle) {
    historyDatasetSwapTitle.textContent = `${esc(formatNodeUsers(activeUnit))} の入れ替え候補`;
  }
  historyDatasetSwapList.innerHTML = group.nodes.map(node => {
    const payload = node.payload || {};
    const rowCount = Array.isArray(payload.originalRows) ? payload.originalRows.length : 0;
    const changeCount = getNodeChangeCount(payload);
    const users = formatNodeUsers(node);
    const metaLine = [
      `最終更新: ${esc(formatNodeUpdatedAt(node.updatedAt))}`,
      `更新者: ${esc(users)}`,
      `データ行: ${rowCount.toLocaleString()}行`,
      `変更回数: ${changeCount.toLocaleString()}回`
    ].join(" ｜ ");
    const isActive = node.id === state.dataNodeSelectedId;
    return `
      <div class="data-node-row history-dataset-row ${isActive ? "is-active" : ""}">
        <div class="data-node-info">
          <div class="data-node-user">${esc(users)}${isActive ? "（表示中）" : ""}</div>
          <div class="data-node-meta">${metaLine}</div>
        </div>
        <div class="data-node-actions">
          <button type="button" class="primary" data-history-swap="${esc(node.id)}">入れ替え</button>
        </div>
      </div>
    `;
  }).join("");
}

function renderStartupChoiceInfo(){
  const nodes = loadDataNodes();
  const localId = getLocalDataNodeId();
  const activeId = state.dataNodeSelectedId || localId;
  const activeNode = nodes.find(node => node.id === activeId && dataNodeHasData(node.payload));
  renderStartupMetaRows(
    startupLastMeta,
    buildStartupWorkMetaRows(activeNode, { forceZeroTime: true }),
    "前回のデータがありません。"
  );
  renderStartupCalendar();
}

function openHistoryDetailModal(){
  if(!historyDetailModal) return;
  const groups = getHistoryDatasetGroups();
  if (!groups.length) {
    showToast("履歴データがありません。");
    return;
  }
  if (!historyDatasetState.datasetKey) {
    const nodes = loadDataNodes();
    const activeNode = nodes.find(node => node.id === state.dataNodeSelectedId);
    const ownedGroup = groups.find(group => group.isOwned);
    historyDatasetState.datasetKey = activeNode ? deriveDatasetMetaFromNode(activeNode).key : (ownedGroup?.key || groups[0].key);
  }
  const localId = getLocalDataNodeId();
  const currentGroup = groups.find(group => group.key === historyDatasetState.datasetKey);
  const localUnit = currentGroup?.nodes.find(node => node.id === localId);
  if (localUnit) {
    historyDatasetState.unitId = localUnit.id;
  }
  renderHistoryDatasetPanels();
  historyDetailModal.classList.add("open");
  historyDetailModal.setAttribute("aria-hidden", "false");
}

function closeHistoryDetailModal(){
  if(!historyDetailModal) return;
  historyDetailModal.classList.remove("open");
  historyDetailModal.setAttribute("aria-hidden", "true");
}

function openDataReloadModal(){
  if (!dataReloadModal) return;
  dataReloadModal.classList.add("open");
  dataReloadModal.setAttribute("aria-hidden", "false");
}

function openTestDataModal(){
  if (!testDataModal) return;
  renderTestDataOptions();
  testDataModal.classList.add("open");
  testDataModal.setAttribute("aria-hidden", "false");
}

function closeTestDataModal(){
  if (!testDataModal) return;
  testDataModal.classList.remove("open");
  testDataModal.setAttribute("aria-hidden", "true");
}

function openStartupChoiceModal(){
  if (!startupChoiceModal) return;
  const hasHistory = buildStartupCalendarEntries("history").length > 0;
  setStartupChoiceMode(hasHistory ? "history" : "last");
  renderStartupChoiceInfo();
  startupChoiceModal.classList.add("open");
  startupChoiceModal.setAttribute("aria-hidden", "false");
}

function closeStartupChoiceModal(){
  if (!startupChoiceModal) return;
  startupChoiceModal.classList.remove("open");
  startupChoiceModal.setAttribute("aria-hidden", "true");
  maybeOpenUsageGuide();
}

function closeDataReloadModal(){
  if (!dataReloadModal) return;
  dataReloadModal.classList.remove("open");
  dataReloadModal.setAttribute("aria-hidden", "true");
}

function closeDataNodeModal(){
  if(!dataNodeModal) return;
  dataNodeModal.classList.remove("open");
  dataNodeModal.setAttribute("aria-hidden", "true");
}

function maybePromptDataNodeConflict(){
  const nodes = loadDataNodes();
  const localId = getLocalDataNodeId();
  const localNode = nodes.find(node => node.id === localId);
  const otherNodes = nodes.filter(node => node.id !== localId && dataNodeHasData(node.payload));
  if(!localNode || !otherNodes.length) return;
  const localHasData = dataNodeHasData(localNode.payload);
  if(!localHasData && !otherNodes.length) return;
  const hasMatch = otherNodes.some(node => areDataNodePayloadsEqual(node.payload, localNode.payload));
  if(!hasMatch){
    openDataNodeModal();
  }
}

function maybePromptDatasetCompareForCurrentData(){
  if (datasetCompareModal?.classList.contains("open")) return;
  const localId = getLocalDataNodeId();
  const nodes = loadDataNodes().filter(node => dataNodeHasData(node.payload));
  const localNode = nodes.find(node => node.id === localId);
  if (!localNode) return;
  const groupKey = deriveDatasetMetaFromNode(localNode).key;
  const group = getHistoryDatasetGroups().find(item => item.key === groupKey);
  if (!group) return;
  const hasDiff = group.nodes.some(node => node.id !== localId && !areDataNodePayloadsEqual(node.payload, localNode.payload));
  if (hasDiff) {
    openDatasetCompareModal(groupKey);
  }
}

/* =========================
   永続化
========================= */
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return cloneDefaults();
    const s = JSON.parse(raw);
    return {
      ...cloneDefaults(),
      ...s,
      overridesByKey: s.overridesByKey || {},
      typeChangeHistory: Array.isArray(s.typeChangeHistory) ? s.typeChangeHistory : []
    };
  }catch{
    return cloneDefaults();
  }
}

function saveState({ skipNodeSync = false, skipPersist = false } = {}){
  if (!state.dataNodeSelectedId) {
    state.dataNodeSelectedId = getLocalDataNodeId();
  }
  state.lastUpdatedAt = Date.now();
  if (!state.workStartAt) {
    state.workStartAt = windowSession.startAt;
  }
  windowSession.workEffort = Number(windowSession.workEffort || 0) + 1;
  state.workEffort = windowSession.workEffort;
  if (!skipPersist) {
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }catch(error){
      console.error(error);
      showToast("保存容量が不足しているため、設定を保存できませんでした。");
      recoverStorageFromOverflow({ reason: "設定保存" });
    }
  }
  if (!skipNodeSync) syncLocalDataNode();
}

function normalizeVacationPeriods(periods = DEFAULT_SETTINGS.vacationPeriods){
  return {
    summer: {
      start: periods?.summer?.start || "",
      end: periods?.summer?.end || ""
    },
    winter: {
      start: periods?.winter?.start || "",
      end: periods?.winter?.end || ""
    },
    spring: {
      start: periods?.spring?.start || "",
      end: periods?.spring?.end || ""
    }
  };
}

function normalizeTimeSettings(settings = DEFAULT_TIME_SETTINGS){
  const source = settings || {};
  const fallback = DEFAULT_TIME_SETTINGS;
  const normalizeTime = (value, fallbackValue) => sanitizeHHMM(value) || fallbackValue;
  return {
    standard: {
      start: normalizeTime(source.standard?.start, fallback.standard.start),
      end: normalizeTime(source.standard?.end, fallback.standard.end)
    },
    short: {
      start: normalizeTime(source.short?.start, fallback.short.start),
      end: normalizeTime(source.short?.end, fallback.short.end)
    },
    onegou: {
      amStart: normalizeTime(source.onegou?.amStart, fallback.onegou.amStart),
      amEnd: normalizeTime(source.onegou?.amEnd, fallback.onegou.amEnd),
      pmStart: normalizeTime(source.onegou?.pmStart, fallback.onegou.pmStart),
      pmEnd: normalizeTime(source.onegou?.pmEnd, fallback.onegou.pmEnd),
      fullStart: normalizeTime(source.onegou?.fullStart, fallback.onegou.fullStart),
      fullEnd: normalizeTime(source.onegou?.fullEnd, fallback.onegou.fullEnd)
    },
    azukari: {
      amStart: normalizeTime(source.azukari?.amStart, fallback.azukari.amStart),
      amEnd: normalizeTime(source.azukari?.amEnd, fallback.azukari.amEnd),
      pmStart: normalizeTime(source.azukari?.pmStart, fallback.azukari.pmStart),
      pmEnd: normalizeTime(source.azukari?.pmEnd, fallback.azukari.pmEnd),
      fullStart: normalizeTime(source.azukari?.fullStart, fallback.azukari.fullStart),
      fullEnd: normalizeTime(source.azukari?.fullEnd, fallback.azukari.fullEnd)
    }
  };
}

function normalizeFeeSettings(settings = DEFAULT_FEE_SETTINGS){
  const source = settings || {};
  const fallback = DEFAULT_FEE_SETTINGS;
  const toFee = (value, fallbackValue) => {
    const n = Number(value);
    if (Number.isFinite(n)) return Math.max(0, Math.round(n));
    return fallbackValue;
  };
  return {
    azukari: {
      am: toFee(source.azukari?.am, fallback.azukari.am),
      pm: toFee(source.azukari?.pm, fallback.azukari.pm),
      full: toFee(source.azukari?.full, fallback.azukari.full)
    },
    extension: {
      standardShort: toFee(source.extension?.standardShort, fallback.extension.standardShort),
      onegouAzukari: toFee(source.extension?.onegouAzukari, fallback.extension.onegouAzukari)
    },
    extras: {
      snack: toFee(source.extras?.snack, fallback.extras.snack),
      lunch: toFee(source.extras?.lunch, fallback.extras.lunch)
    }
  };
}

function applySettingsToInputs(){
  arriveBufferEl.value = String(state.arriveBuffer ?? 0);
  leaveBufferEl.value  = String(state.leaveBuffer ?? 0);
  extBufferEl.value    = String(state.extBuffer ?? 0);
  azJudgeEl.value      = String(state.azJudge ?? "15:00");
  const timeSettings = normalizeTimeSettings(state.timeSettings);
  const feeSettings = normalizeFeeSettings(state.feeSettings);
  if (standardStartTimeEl) standardStartTimeEl.value = timeSettings.standard.start;
  if (standardEndTimeEl) standardEndTimeEl.value = timeSettings.standard.end;
  if (shortStartTimeEl) shortStartTimeEl.value = timeSettings.short.start;
  if (shortEndTimeEl) shortEndTimeEl.value = timeSettings.short.end;
  if (onegouAmStartTimeEl) onegouAmStartTimeEl.value = timeSettings.onegou.amStart;
  if (onegouAmEndTimeEl) onegouAmEndTimeEl.value = timeSettings.onegou.amEnd;
  if (onegouPmStartTimeEl) onegouPmStartTimeEl.value = timeSettings.onegou.pmStart;
  if (onegouPmEndTimeEl) onegouPmEndTimeEl.value = timeSettings.onegou.pmEnd;
  if (onegouFullStartTimeEl) onegouFullStartTimeEl.value = timeSettings.onegou.fullStart;
  if (onegouFullEndTimeEl) onegouFullEndTimeEl.value = timeSettings.onegou.fullEnd;
  if (azukariAmStartTimeEl) azukariAmStartTimeEl.value = timeSettings.azukari.amStart;
  if (azukariAmEndTimeEl) azukariAmEndTimeEl.value = timeSettings.azukari.amEnd;
  if (azukariPmStartTimeEl) azukariPmStartTimeEl.value = timeSettings.azukari.pmStart;
  if (azukariPmEndTimeEl) azukariPmEndTimeEl.value = timeSettings.azukari.pmEnd;
  if (azukariFullStartTimeEl) azukariFullStartTimeEl.value = timeSettings.azukari.fullStart;
  if (azukariFullEndTimeEl) azukariFullEndTimeEl.value = timeSettings.azukari.fullEnd;
  if (azukariFeeAmEl) azukariFeeAmEl.value = String(feeSettings.azukari.am);
  if (azukariFeePmEl) azukariFeePmEl.value = String(feeSettings.azukari.pm);
  if (azukariFeeFullEl) azukariFeeFullEl.value = String(feeSettings.azukari.full);
  if (extFeeStandardShortEl) extFeeStandardShortEl.value = String(feeSettings.extension.standardShort);
  if (extFeeOnegouAzukariEl) extFeeOnegouAzukariEl.value = String(feeSettings.extension.onegouAzukari);
  if (extraSnackFeeEl) extraSnackFeeEl.value = String(feeSettings.extras.snack);
  if (extraLunchFeeEl) extraLunchFeeEl.value = String(feeSettings.extras.lunch);
  if (toastColorEl) toastColorEl.value = state.toastColor || DEFAULT_SETTINGS.toastColor;
  if (toastDurationEl) toastDurationEl.value = String((state.toastDuration ?? DEFAULT_SETTINGS.toastDuration) / 1000);
  if (chargeEarlyExtensionEl) chargeEarlyExtensionEl.checked = state.chargeEarlyExtension !== false;
  if (showSaveButtonEl) showSaveButtonEl.checked = state.showSaveButton !== false;
  const periods = normalizeVacationPeriods(state.vacationPeriods);
  if (vacationSummerStartEl) vacationSummerStartEl.value = periods.summer.start;
  if (vacationSummerEndEl) vacationSummerEndEl.value = periods.summer.end;
  if (vacationWinterStartEl) vacationWinterStartEl.value = periods.winter.start;
  if (vacationWinterEndEl) vacationWinterEndEl.value = periods.winter.end;
  if (vacationSpringStartEl) vacationSpringStartEl.value = periods.spring.start;
  if (vacationSpringEndEl) vacationSpringEndEl.value = periods.spring.end;
  applySaveButtonVisibility();
}

// フローティングメニューの初期化
updateChildSelectOptions(childTypeSelect);
updateBulkMenuContext({ school: state.activeSchool, clazz: state.activeClass });
childTypeSelect?.addEventListener("change", ()=>{
  updateChildTarget(decodeChildSelection(childTypeSelect.value));
});
bulkSchoolList?.addEventListener("click", (e)=>{
  const target = e.target;
  if(!(target instanceof HTMLElement)) return;
  const button = target.closest(".bulk-option-btn");
  if(!button) return;
  if(button.hasAttribute("disabled")) return;
  const school = button.dataset.school;
  if(!school) return;
  bulkSelectedSchool = school;
  bulkSelectedClass = null;
  renderBulkSchoolList(bulkSelectedSchool);
  renderBulkClassList(bulkSelectedSchool, null);
  renderBulkChildList(null, []);
  moveBulkToSelectionStep();
});
bulkClassList?.addEventListener("click", (e)=>{
  const target = e.target;
  if(!(target instanceof HTMLElement)) return;
  const button = target.closest(".bulk-option-btn");
  if(!button) return;
  const clazz = button.dataset.class;
  if(!clazz || !bulkSelectedSchool) return;
  bulkSelectedClass = { school: bulkSelectedSchool, clazz };
  renderBulkClassList(bulkSelectedSchool, clazz);
  const selectedNames = getBulkTargets()
    .filter(t=>classKey(t) === classKey(bulkSelectedClass))
    .map(t=>t.name);
  renderBulkChildList(bulkSelectedClass, selectedNames);
  moveBulkToSelectionStep();
});
bulkChildList?.addEventListener("click", (e)=>{
  const target = e.target;
  if(!(target instanceof HTMLElement)) return;
  const button = target.closest(".bulk-child-btn");
  if(!button) return;
  button.classList.toggle("is-selected");
  button.setAttribute("aria-pressed", button.classList.contains("is-selected") ? "true" : "false");
  syncBulkTargetsFromUI();
  pruneBulkSelections();
  bulkSelectionConfirmed = false;
  renderBulkChangeList([]);
  updateBulkSelectionSummary();
  updateBulkRangeLabel();
  updateBulkStatus();
});
bulkChangeList?.addEventListener("click", (e)=>{
  const target = e.target;
  if(!(target instanceof HTMLElement)) return;
  const historyBtn = target.closest(".bulk-history-btn");
  if(historyBtn){
    if(historyBtn.hasAttribute("disabled")) return;
    const row = historyBtn.closest(".bulk-change-row");
    if(!row) return;
    const name = row.dataset.childName;
    const school = row.dataset.school;
    const clazz = row.dataset.clazz;
    if(!name || !school || !clazz) return;
    openChangeHistoryModal({ name, school, clazz });
    return;
  }
  const button = target.closest(".bulk-type-btn");
  if(!button) return;
  const row = button.closest(".bulk-change-row");
  if(!row) return;
  const typeKey = button.dataset.type;
  const childKeyValue = row.dataset.childKey;
  if(!typeKey || !childKeyValue) return;
  row.querySelectorAll(".bulk-type-btn").forEach(btn=>{
    btn.classList.toggle("is-selected", btn === button);
  });
  bulkTypeSelections.set(childKeyValue, typeKey);
  updateBulkChangeRowMeta(row);
});
bulkChangeList?.addEventListener("change", (e)=>{
  const target = e.target;
  if(!(target instanceof HTMLInputElement)) return;
  if(!target.classList.contains("bulk-change-start")) return;
  const row = target.closest(".bulk-change-row");
  if(!row) return;
  const childKeyValue = row.dataset.childKey;
  const parsed = parseDateInput(target.value || "");
  if(childKeyValue && parsed){
    bulkStartDateSelections.set(childKeyValue, parsed.key);
  }
  updateBulkChangeRowMeta(row);
  updateBulkChangeRowCalendar(row);
});
bulkHeaderBack?.addEventListener("click", ()=>{
  if(!bulkSelectionConfirmed) return;
  moveBulkToSelectionStep();
});
bulkHeaderConfirm?.addEventListener("click", ()=>{
  if(!bulkSelectionConfirmed){
    moveBulkToChangeStep();
    return;
  }
  const applied = applyBulkTypeChange();
  if(applied && typeBulkModal){
    typeBulkModal.classList.remove("open");
    typeBulkModal.setAttribute("aria-hidden", "true");
  }
});
childTypeList?.addEventListener("change", (e)=>{
  const target = e.target;
  if(!(target instanceof HTMLSelectElement)) return;
  if(!target.classList.contains("child-type-select")) return;
  applyTypeSelection(target.dataset.rk, target.value);
});

const openTypeBulkModal = ({ shouldCloseUserMenu = false, shouldCloseHistoryDetail = false } = {}) => {
  if(!typeBulkModal) return;
  if (shouldCloseUserMenu) closeUserMenu();
  if (shouldCloseHistoryDetail) closeHistoryDetailModal();
  typeBulkModal.classList.add("open");
  typeBulkModal.setAttribute("aria-hidden", "false");
  updateBulkMenuContext({ school: state.activeSchool, clazz: state.activeClass });
};

typeBulkMenuToggle?.addEventListener("click", ()=>{
  logWithCategory("log", "user", "区分変更ボタンをタップ");
  logWithCategory("log", "user", "区分変更ボタンをタップしました");
  openTypeBulkModal({ shouldCloseUserMenu: true });
});
typeBulkMenuClose?.addEventListener("click", ()=>{
  if(!typeBulkModal) return;
  typeBulkModal.classList.remove("open");
  typeBulkModal.setAttribute("aria-hidden", "true");
});
typeBulkModal?.addEventListener("click", (e)=>{
  if (e.target !== typeBulkModal) return;
  typeBulkModal.classList.remove("open");
  typeBulkModal.setAttribute("aria-hidden", "true");
});
typeChangeModalClose?.addEventListener("click", closeTypeChangeModal);
typeChangeModal?.addEventListener("click", (e)=>{
  if (e.target !== typeChangeModal) return;
  closeTypeChangeModal();
});
typeChangeDateInput?.addEventListener("change", updateTypeChangeModalFromDate);
typeChangeAfterButtons?.addEventListener("click", (e)=>{
  const target = e.target;
  if(!(target instanceof HTMLElement)) return;
  const button = target.closest("[data-type-change-to]");
  if(!button) return;
  const typeKey = button.getAttribute("data-type-change-to");
  if(!typeKey) return;
  typeChangeModalState.selectedType = typeKey;
  renderTypeChangeModalButtons();
});
typeChangeApply?.addEventListener("click", applyTypeChangeFromModal);
const featureSuggestionFloat = document.getElementById("featureSuggestionFloat");
const featureSuggestionContext = document.getElementById("featureSuggestionContext");
const featureSuggestionClose = document.getElementById("featureSuggestionClose");
const featureSuggestionForm = document.getElementById("featureSuggestionForm");
const featureSuggestionMessage = document.getElementById("featureSuggestionMessage");
const featureSuggestionCancel = document.getElementById("featureSuggestionCancel");
const featureSuggestionSubmit = document.getElementById("featureSuggestionSubmit");
const suggestionBadgeCount = document.getElementById("suggestionBadgeCount");
const suggestionModal = document.getElementById("suggestionModal");
const suggestionModalClose = document.getElementById("suggestionModalClose");
const suggestionCancel = document.getElementById("suggestionCancel");
const suggestionSubmit = document.getElementById("suggestionSubmit");
const suggestionInput = document.getElementById("suggestionInput");
const suggestionMeta = document.getElementById("suggestionMeta");
const suggestionPreview = document.getElementById("suggestionPreview");
const suggestionPreviewImg = document.getElementById("suggestionPreviewImg");
const suggestionPreviewPlaceholder = document.getElementById("suggestionPreviewPlaceholder");
const suggestionInboxModal = document.getElementById("suggestionInboxModal");
const suggestionInboxClose = document.getElementById("suggestionInboxClose");
const suggestionInboxList = document.getElementById("suggestionInboxList");
const suggestionRangeOverlay = document.getElementById("suggestionRangeOverlay");
const suggestionRangeBox = document.getElementById("suggestionRangeBox");
const suggestionInboxHeaderButton = document.getElementById("suggestionInboxHeaderButton");
const suggestionInboxHeaderBadge = document.getElementById("suggestionInboxHeaderBadge");
const suggestionReplyHeaderButton = document.getElementById("suggestionReplyHeaderButton");
const suggestionReplyHeaderBadge = document.getElementById("suggestionReplyHeaderBadge");
const suggestionReplyChatBadge = document.getElementById("suggestionReplyChatBadge");
const issueInboxHeaderButton = document.getElementById("issueInboxHeaderButton");
const issueInboxHeaderBadge = document.getElementById("issueInboxHeaderBadge");
const issueReplyHeaderBadge = document.getElementById("issueReplyHeaderBadge");
const issueModal = document.getElementById("issueModal");
const issueModalClose = document.getElementById("issueModalClose");
const issueCancel = document.getElementById("issueCancel");
const issueSubmit = document.getElementById("issueSubmit");
const issueInput = document.getElementById("issueInput");
const issueMeta = document.getElementById("issueMeta");
const issuePreview = document.getElementById("issuePreview");
const issuePreviewImg = document.getElementById("issuePreviewImg");
const issuePreviewPlaceholder = document.getElementById("issuePreviewPlaceholder");
const issueTagList = document.getElementById("issueTagList");
const issueInboxModal = document.getElementById("issueInboxModal");
const issueInboxClose = document.getElementById("issueInboxClose");
const issueInboxList = document.getElementById("issueInboxList");
const SUGGESTION_STORAGE_KEY = "encho_feature_suggestions_v1";
const SUGGESTION_GROUP_KEY = "encho_feature_suggestion_groups_v1";
const SUGGESTION_REPLY_KEY = "encho_feature_suggestion_replies_v1";
const ISSUE_STORAGE_KEY = "encho_issue_reports_v1";
const ISSUE_GROUP_KEY = "encho_issue_report_groups_v1";
const ISSUE_REPLY_KEY = "encho_issue_report_replies_v1";
const ISSUE_ITEM_KEY = "encho_issue_report_items_v1";
const ISSUE_TAG_KEY = "encho_issue_report_tags_v1";
const TEACHER_LINE_LINK_KEY = "encho_teacher_line_link_v1";

const readSuggestions = () => {
  try {
    const raw = localStorage.getItem(SUGGESTION_STORAGE_KEY);
    if (!raw) return [];
    const parsed = JSON.parse(raw);
    return Array.isArray(parsed) ? normalizeSuggestions(parsed) : [];
  } catch (error) {
    console.warn("希望データの読み込みに失敗しました", error);
    return [];
  }
};

const writeSuggestions = (items) => {
  localStorage.setItem(SUGGESTION_STORAGE_KEY, JSON.stringify(items));
};

const buildSuggestionGroupKey = (item) => {
  const mode = item?.mode || "request";
  const context = item?.context || item?.targetLabel || item?.text || "";
  return `${mode}::${context}`;
};

const normalizeSuggestions = (items) => {
  let updated = false;
  const normalized = items.map((item) => {
    const next = { ...item };
    if (!next.createdAt) {
      next.createdAt = new Date().toISOString();
      updated = true;
    }
    if (!next.groupKey) {
      next.groupKey = buildSuggestionGroupKey(next);
      updated = true;
    }
    return next;
  });
  if (updated) writeSuggestions(normalized);
  return normalized;
};

const readSuggestionGroupMap = () => {
  try {
    const raw = localStorage.getItem(SUGGESTION_GROUP_KEY);
    if (!raw) return { lastId: 0, map: {} };
    const parsed = JSON.parse(raw);
    return {
      lastId: Number(parsed?.lastId) || 0,
      map: parsed?.map || {}
    };
  } catch (error) {
    console.warn("希望グループIDの読み込みに失敗しました", error);
    return { lastId: 0, map: {} };
  }
};

const writeSuggestionGroupMap = (data) => {
  localStorage.setItem(SUGGESTION_GROUP_KEY, JSON.stringify(data));
};

const getSuggestionGroupId = (groupKey) => {
  if (!groupKey) return "SUG-000";
  const data = readSuggestionGroupMap();
  if (data.map[groupKey]) return data.map[groupKey];
  const nextId = data.lastId + 1;
  const id = `SUG-${String(nextId).padStart(3, "0")}`;
  data.lastId = nextId;
  data.map[groupKey] = id;
  writeSuggestionGroupMap(data);
  return id;
};

const readSuggestionReplies = () => {
  try {
    const raw = localStorage.getItem(SUGGESTION_REPLY_KEY);
    if (!raw) return {};
    const parsed = JSON.parse(raw);
    return parsed && typeof parsed === "object" ? parsed : {};
  } catch (error) {
    console.warn("希望返信データの読み込みに失敗しました", error);
    return {};
  }
};

const writeSuggestionReplies = (data) => {
  localStorage.setItem(SUGGESTION_REPLY_KEY, JSON.stringify(data));
};

const updateSuggestionBadges = () => {
  const items = normalizeSuggestions(readSuggestions());
  const total = items.length;
  if (suggestionBadgeCount) suggestionBadgeCount.textContent = String(total);
  if (suggestionInboxHeaderBadge) {
    suggestionInboxHeaderBadge.textContent = String(total);
    suggestionInboxHeaderBadge.style.display = total ? "inline-flex" : "none";
  }
  if (suggestionReplyHeaderBadge) {
    const replies = readSuggestionReplies();
    const groupMap = new Map();
    items.forEach((item) => {
      const groupKey = item.groupKey || buildSuggestionGroupKey(item);
      const bucket = groupMap.get(groupKey) || [];
      bucket.push(item);
      groupMap.set(groupKey, bucket);
    });
    let pendingCount = 0;
    groupMap.forEach((groupItems, groupKey) => {
      const latestCreatedAt = groupItems.reduce((latest, entry) => {
        const current = new Date(entry.createdAt || 0).getTime();
        return Math.max(latest, current);
      }, 0);
      const reply = replies[groupKey];
      const repliedAt = reply?.repliedAt ? new Date(reply.repliedAt).getTime() : 0;
      if (!repliedAt || latestCreatedAt > repliedAt) {
        pendingCount += 1;
      }
    });
    suggestionReplyHeaderBadge.textContent = String(pendingCount);
    suggestionReplyHeaderBadge.style.display = pendingCount ? "inline-flex" : "none";
    if (suggestionReplyChatBadge) {
      suggestionReplyChatBadge.classList.toggle("is-visible", pendingCount > 0);
    }
  }
};

const suggestionState = {
  selectionText: "",
  targetLabel: "",
  targetRect: null,
  mode: "request"
};
const SUGGESTION_REPLY_OPTIONS = [
  "いけそう！",
  "時間がかかりそう…",
  "園長会で相談",
  "園長補佐会で相談",
  "無理！"
];
const ISSUE_DEFAULT_TAGS = [
  "園長会で検討",
  "園長補佐会で検討",
  "できた！",
  "無理そう…"
];
const ISSUE_REPLY_OPTIONS = [...ISSUE_DEFAULT_TAGS];

const issueState = {
  selectionText: "",
  targetLabel: "",
  targetRect: null,
  mode: "select",
  selectedTags: new Set()
};

const getSelectionText = () => {
  const selection = window.getSelection();
  if (!selection || selection.isCollapsed) return "";
  const text = selection.toString().trim();
  if (!text) return "";
  const anchor = selection.anchorNode instanceof Element
    ? selection.anchorNode
    : selection.anchorNode?.parentElement;
  if (anchor?.closest("input, textarea")) return "";
  return text;
};

const getSelectionRect = () => {
  const selection = window.getSelection();
  if (!selection || selection.isCollapsed || selection.rangeCount === 0) return null;
  const range = selection.getRangeAt(0);
  const rect = range.getBoundingClientRect();
  if (!rect || (!rect.width && !rect.height)) return null;
  return rect;
};

const getTargetRectFromElement = (target) => {
  if (!(target instanceof HTMLElement)) return null;
  const rect = target.getBoundingClientRect();
  if (!rect || (!rect.width && !rect.height)) return null;
  return rect;
};

const isSuggestionEligibleTarget = (target) => {
  if (!(target instanceof HTMLElement)) return false;
  if (target.closest("#featureSuggestionFloat")) return false;
  if (target.closest("input, textarea, select, option")) return false;
  if (target.closest("[contenteditable='true']")) return false;
  if (target.closest("button, a, .icon-button, .header-btn, .tool-tab")) return true;
  return Boolean(target.textContent && target.textContent.trim().length);
};

const getSuggestionLabelFromTarget = (target) => {
  if (!(target instanceof HTMLElement)) return "";
  const button = target.closest("button");
  if (button) {
    return (button.getAttribute("aria-label") || button.textContent || "").trim();
  }
  const labeled = target.closest("[aria-label]");
  if (labeled) return labeled.getAttribute("aria-label")?.trim() || "";
  return (target.textContent || "").trim().slice(0, 40);
};

const formatSuggestionContext = ({ selectionText, targetLabel }) => {
  if (selectionText) {
    const trimmed = selectionText.length > 48 ? `${selectionText.slice(0, 48)}…` : selectionText;
    return `選択範囲: ${trimmed}`;
  }
  return targetLabel ? `対象: ${targetLabel}` : "対象を選択しました。";
};

const readIssueReports = () => {
  try {
    const raw = localStorage.getItem(ISSUE_STORAGE_KEY);
    if (!raw) return [];
    const parsed = JSON.parse(raw);
    return Array.isArray(parsed) ? normalizeIssueReports(parsed) : [];
  } catch (error) {
    console.warn("不具合報告データの読み込みに失敗しました", error);
    return [];
  }
};

const writeIssueReports = (items) => {
  localStorage.setItem(ISSUE_STORAGE_KEY, JSON.stringify(items));
};

const buildIssueGroupKey = (item) => {
  const mode = item?.mode || "select";
  const context = item?.context || item?.targetLabel || item?.text || "";
  return `${mode}::${context}`;
};

const normalizeIssueReports = (items) => {
  let updated = false;
  const normalized = items.map((item) => {
    const next = { ...item };
    if (!next.createdAt) {
      next.createdAt = new Date().toISOString();
      updated = true;
    }
    if (!next.groupKey) {
      next.groupKey = buildIssueGroupKey(next);
      updated = true;
    }
    return next;
  });
  if (updated) writeIssueReports(normalized);
  return normalized;
};

const readIssueGroupMap = () => {
  try {
    const raw = localStorage.getItem(ISSUE_GROUP_KEY);
    if (!raw) return { lastId: 0, map: {} };
    const parsed = JSON.parse(raw);
    return {
      lastId: Number(parsed?.lastId) || 0,
      map: parsed?.map || {}
    };
  } catch (error) {
    console.warn("不具合グループIDの読み込みに失敗しました", error);
    return { lastId: 0, map: {} };
  }
};

const writeIssueGroupMap = (data) => {
  localStorage.setItem(ISSUE_GROUP_KEY, JSON.stringify(data));
};

const getIssueGroupId = (groupKey) => {
  if (!groupKey) return "BUG-000";
  const data = readIssueGroupMap();
  if (data.map[groupKey]) return data.map[groupKey];
  const nextId = data.lastId + 1;
  const id = `BUG-${String(nextId).padStart(3, "0")}`;
  data.lastId = nextId;
  data.map[groupKey] = id;
  writeIssueGroupMap(data);
  return id;
};

const readIssueItemMeta = () => {
  try {
    const raw = localStorage.getItem(ISSUE_ITEM_KEY);
    if (!raw) return { lastId: 0 };
    const parsed = JSON.parse(raw);
    return { lastId: Number(parsed?.lastId) || 0 };
  } catch (error) {
    console.warn("不具合IDの読み込みに失敗しました", error);
    return { lastId: 0 };
  }
};

const writeIssueItemMeta = (data) => {
  localStorage.setItem(ISSUE_ITEM_KEY, JSON.stringify(data));
};

const getIssueItemId = () => {
  const data = readIssueItemMeta();
  const nextId = data.lastId + 1;
  const id = `BUG-${String(nextId).padStart(4, "0")}`;
  data.lastId = nextId;
  writeIssueItemMeta(data);
  return id;
};

const readIssueReplies = () => {
  try {
    const raw = localStorage.getItem(ISSUE_REPLY_KEY);
    if (!raw) return {};
    const parsed = JSON.parse(raw);
    return parsed && typeof parsed === "object" ? parsed : {};
  } catch (error) {
    console.warn("不具合返信データの読み込みに失敗しました", error);
    return {};
  }
};

const writeIssueReplies = (data) => {
  localStorage.setItem(ISSUE_REPLY_KEY, JSON.stringify(data));
};

const readIssueTags = () => {
  try {
    const raw = localStorage.getItem(ISSUE_TAG_KEY);
    if (!raw) return ISSUE_DEFAULT_TAGS;
    const parsed = JSON.parse(raw);
    return Array.isArray(parsed) && parsed.length ? parsed : ISSUE_DEFAULT_TAGS;
  } catch (error) {
    console.warn("不具合タグの読み込みに失敗しました", error);
    return ISSUE_DEFAULT_TAGS;
  }
};

const writeIssueTags = (tags) => {
  localStorage.setItem(ISSUE_TAG_KEY, JSON.stringify(tags));
};

const updateIssueBadges = () => {
  const items = normalizeIssueReports(readIssueReports());
  const total = items.length;
  if (issueInboxHeaderBadge) {
    issueInboxHeaderBadge.textContent = String(total);
    issueInboxHeaderBadge.style.display = total ? "inline-flex" : "none";
  }
  if (issueReplyHeaderBadge) {
    const replies = readIssueReplies();
    const groupMap = new Map();
    items.forEach((item) => {
      const groupKey = item.groupKey || buildIssueGroupKey(item);
      const bucket = groupMap.get(groupKey) || [];
      bucket.push(item);
      groupMap.set(groupKey, bucket);
    });
    let pendingCount = 0;
    groupMap.forEach((groupItems, groupKey) => {
      const latestCreatedAt = groupItems.reduce((latest, entry) => {
        const current = new Date(entry.createdAt || 0).getTime();
        return Math.max(latest, current);
      }, 0);
      const reply = replies[groupKey];
      const repliedAt = reply?.repliedAt ? new Date(reply.repliedAt).getTime() : 0;
      if (!repliedAt || latestCreatedAt > repliedAt) {
        pendingCount += 1;
      }
    });
    issueReplyHeaderBadge.classList.toggle("is-visible", pendingCount > 0);
  }
};

const formatIssueContext = ({ selectionText, targetLabel }) => {
  if (selectionText) {
    const trimmed = selectionText.length > 48 ? `${selectionText.slice(0, 48)}…` : selectionText;
    return `選択範囲: ${trimmed}`;
  }
  return targetLabel ? `対象: ${targetLabel}` : "対象を選択しました。";
};

const updateSuggestionContext = () => {
  if (!featureSuggestionContext) return;
  const selectionText = suggestionState.selectionText;
  if (selectionText) {
    const trimmed = selectionText.length > 48 ? `${selectionText.slice(0, 48)}…` : selectionText;
    featureSuggestionContext.textContent = `選択範囲: ${trimmed}`;
    return;
  }
  const targetLabel = suggestionState.targetLabel;
  featureSuggestionContext.textContent = targetLabel
    ? `対象: ${targetLabel}`
    : "対象を選択しました。";
};

const positionSuggestionFloat = (x, y) => {
  if (!featureSuggestionFloat) return;
  featureSuggestionFloat.style.visibility = "hidden";
  featureSuggestionFloat.style.left = "0px";
  featureSuggestionFloat.style.top = "0px";
  requestAnimationFrame(() => {
    const rect = featureSuggestionFloat.getBoundingClientRect();
    const padding = 12;
    let left = clamp(x - rect.width / 2, padding, window.innerWidth - rect.width - padding);
    let top = y - rect.height - 18;
    if (top < padding) {
      top = clamp(y + 18, padding, window.innerHeight - rect.height - padding);
    }
    featureSuggestionFloat.style.left = `${left}px`;
    featureSuggestionFloat.style.top = `${top}px`;
    featureSuggestionFloat.style.visibility = "visible";
  });
};

const openFeatureSuggestionFloat = ({ x, y, selectionText = "", targetLabel = "", targetRect = null }) => {
  if (!featureSuggestionFloat) return;
  suggestionState.selectionText = selectionText;
  suggestionState.targetLabel = targetLabel;
  suggestionState.targetRect = targetRect;
  suggestionState.mode = "request";
  featureSuggestionFloat.classList.remove("is-form-open");
  if (featureSuggestionMessage) featureSuggestionMessage.value = "";
  const rangeButton = featureSuggestionFloat.querySelector("[data-suggestion-action='range']");
  if (rangeButton) rangeButton.toggleAttribute("disabled", !selectionText);
  updateSuggestionContext();
  featureSuggestionFloat.classList.add("is-open");
  featureSuggestionFloat.setAttribute("aria-hidden", "false");
  positionSuggestionFloat(x, y);
};

const closeFeatureSuggestionFloat = () => {
  if (!featureSuggestionFloat) return;
  featureSuggestionFloat.classList.remove("is-open");
  featureSuggestionFloat.classList.remove("is-form-open");
  featureSuggestionFloat.setAttribute("aria-hidden", "true");
};

const openSuggestionModal = ({ mode, label, rect }) => {
  if (!suggestionModal) return;
  suggestionState.mode = mode;
  if (suggestionInput) suggestionInput.value = "";
  if (suggestionMeta) suggestionMeta.textContent = label;
  if (suggestionPreview) suggestionPreview.classList.remove("has-image");
  if (suggestionPreviewImg) suggestionPreviewImg.src = "";
  if (suggestionPreviewPlaceholder) {
    suggestionPreviewPlaceholder.textContent = "スクリーンショットを取得中...";
    suggestionPreviewPlaceholder.style.display = "block";
  }
  suggestionModal.classList.add("open");
  suggestionModal.setAttribute("aria-hidden", "false");
  captureSuggestionImage(rect).then((dataUrl) => {
    if (!suggestionPreviewImg || !suggestionPreview) return;
    if (dataUrl) {
      suggestionPreviewImg.src = dataUrl;
      suggestionPreview.classList.add("has-image");
      if (suggestionPreviewPlaceholder) suggestionPreviewPlaceholder.style.display = "none";
      return;
    }
    if (suggestionPreviewPlaceholder) {
      suggestionPreviewPlaceholder.textContent = "スクリーンショットの取得に失敗しました。";
    }
  });
};

const closeSuggestionModal = () => {
  if (!suggestionModal) return;
  suggestionModal.classList.remove("open");
  suggestionModal.setAttribute("aria-hidden", "true");
};

const renderIssueTags = () => {
  if (!issueTagList) return;
  const tags = readIssueTags();
  issueTagList.innerHTML = "";
  tags.forEach((tag) => {
    const button = document.createElement("button");
    button.type = "button";
    button.className = "issue-tag";
    button.textContent = tag;
    button.dataset.tag = tag;
    if (issueState.selectedTags.has(tag)) {
      button.classList.add("is-active");
    }
    issueTagList.appendChild(button);
  });
  const addButton = document.createElement("button");
  addButton.type = "button";
  addButton.className = "issue-tag is-add";
  addButton.textContent = "＋追加";
  addButton.dataset.tagAdd = "true";
  issueTagList.appendChild(addButton);
};

const openIssueModal = ({ mode, label, rect }) => {
  if (!issueModal) return;
  issueState.mode = mode;
  issueState.selectedTags = new Set();
  if (issueInput) issueInput.value = "";
  if (issueMeta) issueMeta.textContent = label;
  if (issuePreview) issuePreview.classList.remove("has-image");
  if (issuePreviewImg) issuePreviewImg.src = "";
  if (issuePreviewPlaceholder) {
    issuePreviewPlaceholder.textContent = "スクリーンショットを取得中...";
    issuePreviewPlaceholder.style.display = "block";
  }
  renderIssueTags();
  issueModal.classList.add("open");
  issueModal.setAttribute("aria-hidden", "false");
  captureSuggestionImage(rect).then((dataUrl) => {
    if (!issuePreviewImg || !issuePreview) return;
    if (dataUrl) {
      issuePreviewImg.src = dataUrl;
      issuePreview.classList.add("has-image");
      if (issuePreviewPlaceholder) issuePreviewPlaceholder.style.display = "none";
      return;
    }
    if (issuePreviewPlaceholder) {
      issuePreviewPlaceholder.textContent = "スクリーンショットの取得に失敗しました。";
    }
  });
};

const closeIssueModal = () => {
  if (!issueModal) return;
  issueModal.classList.remove("open");
  issueModal.setAttribute("aria-hidden", "true");
};

const openIssueInbox = () => {
  if (!issueInboxModal || !issueInboxList) return;
  renderIssueInbox();
  issueInboxModal.classList.add("open");
  issueInboxModal.setAttribute("aria-hidden", "false");
};

const closeIssueInbox = () => {
  if (!issueInboxModal) return;
  issueInboxModal.classList.remove("open");
  issueInboxModal.setAttribute("aria-hidden", "true");
};

const openSuggestionInbox = () => {
  if (!suggestionInboxModal || !suggestionInboxList) return;
  renderSuggestionInbox();
  suggestionInboxModal.classList.add("open");
  suggestionInboxModal.setAttribute("aria-hidden", "false");
};

const closeSuggestionInbox = () => {
  if (!suggestionInboxModal) return;
  suggestionInboxModal.classList.remove("open");
  suggestionInboxModal.setAttribute("aria-hidden", "true");
};

const waitForHtml2Canvas = (timeoutMs = 1200) => new Promise((resolve) => {
  if (window.html2canvas) return resolve(true);
  const start = performance.now();
  const check = () => {
    if (window.html2canvas) return resolve(true);
    if (performance.now() - start >= timeoutMs) return resolve(false);
    requestAnimationFrame(check);
  };
  requestAnimationFrame(check);
});

const captureSuggestionImage = async (rect) => {
  const hasHtml2Canvas = await waitForHtml2Canvas();
  if (!hasHtml2Canvas) return null;
  const overlayActive = suggestionRangeOverlay?.classList.contains("is-active");
  if (overlayActive) suggestionRangeOverlay.classList.remove("is-active");
  document.body.classList.remove("is-range-selecting");
  await new Promise((resolve) => requestAnimationFrame(() => requestAnimationFrame(resolve)));
  await new Promise((resolve) => setTimeout(resolve, 80));
  try {
    const canvas = await window.html2canvas(document.body, {
      backgroundColor: "#ffffff",
      scale: window.devicePixelRatio || 1
    });
    if (!rect || rect.width <= 0 || rect.height <= 0) {
      return canvas.toDataURL("image/png");
    }
    const scale = canvas.width / document.documentElement.clientWidth;
    const offsetX = (rect.left + window.scrollX) * scale;
    const offsetY = (rect.top + window.scrollY) * scale;
    const width = rect.width * scale;
    const height = rect.height * scale;
    const cropCanvas = document.createElement("canvas");
    cropCanvas.width = Math.max(1, Math.floor(width));
    cropCanvas.height = Math.max(1, Math.floor(height));
    const ctx = cropCanvas.getContext("2d");
    if (!ctx) return canvas.toDataURL("image/png");
    ctx.drawImage(
      canvas,
      offsetX,
      offsetY,
      width,
      height,
      0,
      0,
      cropCanvas.width,
      cropCanvas.height
    );
    return cropCanvas.toDataURL("image/png");
  } catch (error) {
    console.warn("スクリーンショット取得に失敗しました", error);
    return null;
  } finally {
    if (overlayActive) suggestionRangeOverlay?.classList.add("is-active");
  }
};

const expandRect = (rect, padding = 24) => {
  if (!rect) return null;
  const left = Math.max(rect.left - padding, 0);
  const top = Math.max(rect.top - padding, 0);
  const right = Math.min(rect.right + padding, window.innerWidth);
  const bottom = Math.min(rect.bottom + padding, window.innerHeight);
  return {
    left,
    top,
    right,
    bottom,
    width: right - left,
    height: bottom - top
  };
};

const buildSuggestionReplyFlexMessage = ({ groupId, replyLabel, context }) => {
  return {
    type: "flex",
    altText: `アップデート希望返信: ${replyLabel}`,
    contents: {
      type: "bubble",
      hero: {
        type: "box",
        layout: "vertical",
        backgroundColor: "#f97316",
        contents: [
          {
            type: "text",
            text: "アップデート希望への返信",
            weight: "bold",
            size: "md",
            color: "#ffffff"
          }
        ],
        paddingAll: "12px"
      },
      body: {
        type: "box",
        layout: "vertical",
        spacing: "sm",
        contents: [
          {
            type: "text",
            text: `ID: ${groupId}`,
            size: "sm",
            color: "#64748b"
          },
          {
            type: "text",
            text: context || "対象: バージョンアップ希望",
            size: "sm",
            wrap: true,
            color: "#1f2937"
          },
          {
            type: "text",
            text: replyLabel,
            size: "lg",
            weight: "bold",
            color: "#0f172a"
          }
        ]
      }
    }
  };
};

const renderSuggestionInbox = () => {
  if (!suggestionInboxList) return;
  const items = readSuggestions();
  const replies = readSuggestionReplies();
  suggestionInboxList.innerHTML = "";
  if (!items.length) {
    const empty = document.createElement("div");
    empty.className = "suggestion-inbox-empty";
    empty.textContent = "まだ希望は届いていません。";
    suggestionInboxList.appendChild(empty);
    return;
  }
  const groups = new Map();
  items.forEach((item) => {
    const groupKey = item.groupKey || buildSuggestionGroupKey(item);
    const list = groups.get(groupKey) || [];
    list.push(item);
    groups.set(groupKey, list);
  });
  const sortedGroups = Array.from(groups.entries()).map(([groupKey, groupItems]) => {
    const sortedItems = groupItems.slice().sort((a, b) => {
      return new Date(b.createdAt || 0).getTime() - new Date(a.createdAt || 0).getTime();
    });
    const latestCreatedAt = sortedItems[0]?.createdAt || "";
    const reply = replies[groupKey];
    const repliedAt = reply?.repliedAt ? new Date(reply.repliedAt).getTime() : 0;
    const isNew = !repliedAt || new Date(latestCreatedAt || 0).getTime() > repliedAt;
    return {
      groupKey,
      groupId: getSuggestionGroupId(groupKey),
      items: sortedItems,
      latestCreatedAt,
      count: sortedItems.length,
      reply,
      isNew
    };
  });
  sortedGroups.sort((a, b) => {
    if (a.isNew !== b.isNew) return a.isNew ? -1 : 1;
    if (a.isNew) {
      if (a.count !== b.count) return b.count - a.count;
      return new Date(b.latestCreatedAt || 0).getTime() - new Date(a.latestCreatedAt || 0).getTime();
    }
    const aReplyAt = a.reply?.repliedAt ? new Date(a.reply.repliedAt).getTime() : 0;
    const bReplyAt = b.reply?.repliedAt ? new Date(b.reply.repliedAt).getTime() : 0;
    return aReplyAt - bReplyAt;
  });
  sortedGroups.forEach((group) => {
    const wrapper = document.createElement("div");
    wrapper.className = "suggestion-group-item";
    wrapper.dataset.groupKey = group.groupKey;
    const header = document.createElement("div");
    header.className = "suggestion-group-header";
    const title = document.createElement("div");
    title.className = "suggestion-group-title";
    const idEl = document.createElement("span");
    idEl.className = "suggestion-group-id";
    idEl.textContent = group.groupId;
    const countEl = document.createElement("span");
    countEl.className = "suggestion-group-count";
    countEl.textContent = `${group.count}件`;
    const statusEl = document.createElement("span");
    statusEl.className = `suggestion-group-status ${group.isNew ? "is-new" : ""}`;
    statusEl.textContent = group.isNew ? "新着" : "返信済み";
    title.appendChild(idEl);
    title.appendChild(countEl);
    title.appendChild(statusEl);
    const meta = document.createElement("div");
    meta.className = "suggestion-group-meta";
    const latest = document.createElement("span");
    latest.textContent = `最新: ${new Date(group.latestCreatedAt).toLocaleString()}`;
    const context = document.createElement("span");
    context.textContent = group.items[0]?.context || "対象: —";
    meta.appendChild(latest);
    meta.appendChild(context);
    header.appendChild(title);
    header.appendChild(meta);
    wrapper.appendChild(header);
    if (group.items[0]?.image) {
      const img = document.createElement("img");
      img.src = group.items[0].image;
      img.alt = "希望のスクリーンショット";
      wrapper.appendChild(img);
    }
    const list = document.createElement("div");
    list.className = "suggestion-group-list";
    group.items.slice(0, 4).forEach((item) => {
      const message = document.createElement("div");
      message.className = "suggestion-group-message";
      message.textContent = `${item.text} (${new Date(item.createdAt).toLocaleString()})`;
      list.appendChild(message);
    });
    if (group.items.length > 4) {
      const more = document.createElement("div");
      more.className = "suggestion-group-message";
      more.textContent = `ほか ${group.items.length - 4} 件`;
      list.appendChild(more);
    }
    wrapper.appendChild(list);
    const replySection = document.createElement("div");
    replySection.className = "suggestion-reply-actions";
    const replyLabel = document.createElement("div");
    replyLabel.className = "reply-label";
    replyLabel.textContent = "FlexMessage返信";
    const replyOptions = document.createElement("div");
    replyOptions.className = "suggestion-reply-options";
    SUGGESTION_REPLY_OPTIONS.forEach((label) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.textContent = label;
      btn.dataset.suggestionReply = label;
      btn.dataset.groupKey = group.groupKey;
      btn.dataset.groupId = group.groupId;
      btn.dataset.context = group.items[0]?.context || "";
      replyOptions.appendChild(btn);
    });
    replySection.appendChild(replyLabel);
    replySection.appendChild(replyOptions);
    const replyNote = document.createElement("div");
    replyNote.className = "suggestion-reply-note";
    if (group.reply?.label) {
      replyNote.textContent = `最新返信: ${group.reply.label} (${new Date(group.reply.repliedAt).toLocaleString()})`;
    } else {
      replyNote.textContent = "まだ返信がありません。";
    }
    replySection.appendChild(replyNote);
    wrapper.appendChild(replySection);
    suggestionInboxList.appendChild(wrapper);
  });
};

const renderIssueInbox = () => {
  if (!issueInboxList) return;
  const items = readIssueReports();
  const replies = readIssueReplies();
  issueInboxList.innerHTML = "";
  if (!items.length) {
    const empty = document.createElement("div");
    empty.className = "suggestion-inbox-empty";
    empty.textContent = "まだ不具合報告は届いていません。";
    issueInboxList.appendChild(empty);
    return;
  }
  const groups = new Map();
  items.forEach((item) => {
    const groupKey = item.groupKey || buildIssueGroupKey(item);
    const list = groups.get(groupKey) || [];
    list.push(item);
    groups.set(groupKey, list);
  });
  const sortedGroups = Array.from(groups.entries()).map(([groupKey, groupItems]) => {
    const sortedItems = groupItems.slice().sort((a, b) => {
      return new Date(b.createdAt || 0).getTime() - new Date(a.createdAt || 0).getTime();
    });
    const latestCreatedAt = sortedItems[0]?.createdAt || "";
    const reply = replies[groupKey];
    const repliedAt = reply?.repliedAt ? new Date(reply.repliedAt).getTime() : 0;
    const isNew = !repliedAt || new Date(latestCreatedAt || 0).getTime() > repliedAt;
    return {
      groupKey,
      groupId: getIssueGroupId(groupKey),
      items: sortedItems,
      latestCreatedAt,
      count: sortedItems.length,
      reply,
      isNew
    };
  });
  sortedGroups.sort((a, b) => {
    if (a.isNew !== b.isNew) return a.isNew ? -1 : 1;
    if (a.isNew) {
      if (a.count !== b.count) return b.count - a.count;
      return new Date(b.latestCreatedAt || 0).getTime() - new Date(a.latestCreatedAt || 0).getTime();
    }
    const aReplyAt = a.reply?.repliedAt ? new Date(a.reply.repliedAt).getTime() : 0;
    const bReplyAt = b.reply?.repliedAt ? new Date(b.reply.repliedAt).getTime() : 0;
    return aReplyAt - bReplyAt;
  });
  sortedGroups.forEach((group) => {
    const wrapper = document.createElement("div");
    wrapper.className = "suggestion-group-item";
    wrapper.dataset.groupKey = group.groupKey;
    const header = document.createElement("div");
    header.className = "suggestion-group-header";
    const title = document.createElement("div");
    title.className = "suggestion-group-title";
    const idEl = document.createElement("span");
    idEl.className = "suggestion-group-id";
    idEl.textContent = group.groupId;
    const countEl = document.createElement("span");
    countEl.className = "suggestion-group-count";
    countEl.textContent = `${group.count}件`;
    const statusEl = document.createElement("span");
    statusEl.className = `suggestion-group-status ${group.isNew ? "is-new" : ""}`;
    statusEl.textContent = group.isNew ? "新着" : "返信済み";
    title.appendChild(idEl);
    title.appendChild(countEl);
    title.appendChild(statusEl);
    const meta = document.createElement("div");
    meta.className = "issue-group-meta";
    const latest = document.createElement("span");
    latest.textContent = `最新: ${new Date(group.latestCreatedAt).toLocaleString()}`;
    const context = document.createElement("span");
    context.textContent = group.items[0]?.context || "対象: —";
    meta.appendChild(latest);
    meta.appendChild(context);
    header.appendChild(title);
    header.appendChild(meta);
    wrapper.appendChild(header);
    if (group.items[0]?.image) {
      const img = document.createElement("img");
      img.src = group.items[0].image;
      img.alt = "不具合報告のスクリーンショット";
      wrapper.appendChild(img);
    }
    const list = document.createElement("div");
    list.className = "issue-item-list";
    group.items.forEach((item) => {
      const message = document.createElement("div");
      message.className = "issue-item";
      const tagList = (item.tags || []).join(" / ");
      message.textContent = `${item.itemId || ""} ${item.text}${tagList ? ` (${tagList})` : ""}｜${new Date(item.createdAt).toLocaleString()}`;
      list.appendChild(message);
    });
    wrapper.appendChild(list);
    const replyCard = document.createElement("div");
    replyCard.className = "issue-reply-card";
    const replyLabel = document.createElement("div");
    replyLabel.className = "reply-label";
    replyLabel.textContent = "管理者回答";
    const replyTags = document.createElement("div");
    replyTags.className = "suggestion-reply-options";
    ISSUE_REPLY_OPTIONS.forEach((label) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.textContent = label;
      btn.dataset.issueReply = label;
      btn.dataset.groupKey = group.groupKey;
      btn.dataset.groupId = group.groupId;
      replyTags.appendChild(btn);
    });
    const addBtn = document.createElement("button");
    addBtn.type = "button";
    addBtn.textContent = "＋追加";
    addBtn.dataset.issueReplyAdd = "true";
    addBtn.dataset.groupKey = group.groupKey;
    addBtn.dataset.groupId = group.groupId;
    replyTags.appendChild(addBtn);
    const replyInput = document.createElement("textarea");
    replyInput.className = "issue-reply-input";
    replyInput.placeholder = "回答コメントを入力";
    replyInput.dataset.issueReplyComment = "true";
    replyInput.dataset.groupKey = group.groupKey;
    const replyActions = document.createElement("div");
    replyActions.className = "issue-reply-actions";
    const sendBtn = document.createElement("button");
    sendBtn.type = "button";
    sendBtn.className = "small primary";
    sendBtn.textContent = "回答を送信";
    sendBtn.dataset.issueReplySend = "true";
    sendBtn.dataset.groupKey = group.groupKey;
    sendBtn.dataset.groupId = group.groupId;
    replyActions.appendChild(sendBtn);
    replyCard.appendChild(replyLabel);
    replyCard.appendChild(replyTags);
    replyCard.appendChild(replyInput);
    replyCard.appendChild(replyActions);
    if (group.reply?.label) {
      const note = document.createElement("div");
      note.className = "suggestion-reply-note";
      note.textContent = `最新返信: ${group.reply.label}${group.reply.comment ? ` / ${group.reply.comment}` : ""} (${new Date(group.reply.repliedAt).toLocaleString()})`;
      replyCard.appendChild(note);
    }
    wrapper.appendChild(replyCard);
    issueInboxList.appendChild(wrapper);
  });
};

const handleSuggestionReply = async ({ groupKey, groupId, replyLabel, context }) => {
  if (!groupKey || !replyLabel) return;
  const payload = buildSuggestionReplyFlexMessage({ groupId, replyLabel, context });
  const replies = readSuggestionReplies();
  replies[groupKey] = {
    label: replyLabel,
    repliedAt: new Date().toISOString(),
    payload
  };
  writeSuggestionReplies(replies);
  await copyTextToClipboard(JSON.stringify(payload, null, 2));
  showToast({ title: "返信準備", message: `FlexMessageをコピーしました: ${replyLabel}` });
  updateSuggestionBadges();
  renderSuggestionInbox();
};

const handleIssueReply = ({ groupKey, groupId, replyLabel, comment }) => {
  if (!groupKey) return;
  const replies = readIssueReplies();
  replies[groupKey] = {
    label: replyLabel || "回答済み",
    comment: comment || "",
    repliedAt: new Date().toISOString(),
    groupId
  };
  writeIssueReplies(replies);
  updateIssueBadges();
  renderIssueInbox();
  showToast({ title: "管理者回答", message: "回答を送信しました。" });
};

let activeRangeTarget = "suggestion";
const openRangeSelection = (target = "suggestion") => {
  if (!suggestionRangeOverlay || !suggestionRangeBox) return;
  activeRangeTarget = target;
  suggestionRangeOverlay.classList.add("is-active");
  suggestionRangeOverlay.setAttribute("aria-hidden", "false");
  document.body.classList.add("is-range-selecting");
  suggestionRangeBox.style.width = "0px";
  suggestionRangeBox.style.height = "0px";
};

const closeRangeSelection = () => {
  if (!suggestionRangeOverlay) return;
  suggestionRangeOverlay.classList.remove("is-active");
  suggestionRangeOverlay.setAttribute("aria-hidden", "true");
  document.body.classList.remove("is-range-selecting");
  activeRangeTarget = "suggestion";
};

let rangeDragStart = null;

suggestionRangeOverlay?.addEventListener("pointerdown", (event) => {
  rangeDragStart = { x: event.clientX, y: event.clientY };
  suggestionRangeOverlay.setPointerCapture?.(event.pointerId);
  if (!suggestionRangeBox) return;
  suggestionRangeBox.style.left = `${rangeDragStart.x}px`;
  suggestionRangeBox.style.top = `${rangeDragStart.y}px`;
  suggestionRangeBox.style.width = "0px";
  suggestionRangeBox.style.height = "0px";
});

suggestionRangeOverlay?.addEventListener("pointermove", (event) => {
  if (!rangeDragStart || !suggestionRangeBox) return;
  const left = Math.min(rangeDragStart.x, event.clientX);
  const top = Math.min(rangeDragStart.y, event.clientY);
  const width = Math.abs(event.clientX - rangeDragStart.x);
  const height = Math.abs(event.clientY - rangeDragStart.y);
  suggestionRangeBox.style.left = `${left}px`;
  suggestionRangeBox.style.top = `${top}px`;
  suggestionRangeBox.style.width = `${width}px`;
  suggestionRangeBox.style.height = `${height}px`;
});

suggestionRangeOverlay?.addEventListener("pointerup", (event) => {
  if (!rangeDragStart || !suggestionRangeBox) return;
  const rect = suggestionRangeBox.getBoundingClientRect();
  rangeDragStart = null;
  suggestionRangeOverlay?.releasePointerCapture?.(event.pointerId);
  closeRangeSelection();
  if (rect.width < 24 || rect.height < 24) {
    showToast("範囲が小さすぎるためキャンセルしました。");
    return;
  }
  if (activeRangeTarget === "issue") {
    const formatted = formatIssueContext({ selectionText: "範囲指定", targetLabel: "" });
    openIssueModal({ mode: "range", label: formatted, rect });
  } else {
    const formatted = formatSuggestionContext({ selectionText: "範囲指定", targetLabel: "" });
    openSuggestionModal({ mode: "range", label: formatted, rect });
  }
});

suggestionRangeOverlay?.addEventListener("pointerleave", () => {
  rangeDragStart = null;
});

suggestionRangeOverlay?.addEventListener("pointercancel", () => {
  rangeDragStart = null;
  closeRangeSelection();
});

const submitSuggestion = () => {
  if (!suggestionInput) return;
  const text = suggestionInput.value.trim();
  if (!text) {
    showToast("希望内容を入力してください。");
    return;
  }
  const items = readSuggestions();
  const entry = {
    id: `suggestion-${Date.now()}`,
    text,
    image: suggestionPreviewImg?.src || "",
    mode: suggestionState.mode,
    context: suggestionMeta?.textContent || "",
    createdAt: new Date().toISOString()
  };
  entry.groupKey = buildSuggestionGroupKey(entry);
  items.push(entry);
  writeSuggestions(items);
  updateSuggestionBadges();
  closeSuggestionModal();
  showToast("バージョンアップ希望を送信しました。");
};

const submitIssue = () => {
  if (!issueInput) return;
  const text = issueInput.value.trim();
  if (!text) {
    showToast("コメントを入力してください。");
    return;
  }
  const items = readIssueReports();
  const entry = {
    id: `issue-${Date.now()}`,
    itemId: getIssueItemId(),
    text,
    image: issuePreviewImg?.src || "",
    mode: issueState.mode,
    context: issueMeta?.textContent || "",
    createdAt: new Date().toISOString(),
    tags: Array.from(issueState.selectedTags)
  };
  entry.groupKey = buildIssueGroupKey(entry);
  items.push(entry);
  writeIssueReports(items);
  updateIssueBadges();
  closeIssueModal();
  showToast("不具合報告を送信しました。");
};

updateSuggestionBadges();
updateIssueBadges();
updateTeacherLineLinkBadge();

const openSuggestionForm = (mode) => {
  if (!featureSuggestionFloat) return;
  suggestionState.mode = mode;
  featureSuggestionFloat.classList.add("is-form-open");
  featureSuggestionMessage?.focus();
};

const closeSuggestionForm = () => {
  if (!featureSuggestionFloat) return;
  featureSuggestionFloat.classList.remove("is-form-open");
};

featureSuggestionClose?.addEventListener("click", closeFeatureSuggestionFloat);
featureSuggestionFloat?.addEventListener("click", (event)=>{
  const target = event.target;
  if (!(target instanceof HTMLElement)) return;
  const button = target.closest("[data-suggestion-action]");
  if (!button) return;
  const action = button.getAttribute("data-suggestion-action");
  if (!action) return;
  if (action === "request") {
    const rect = expandRect(suggestionState.targetRect, 32);
    const label = formatSuggestionContext({
      selectionText: suggestionState.selectionText,
      targetLabel: suggestionState.targetLabel
    });
    openSuggestionModal({ mode: "around", label, rect });
  } else if (action === "range") {
    openRangeSelection();
    openSuggestionForm("request");
  } else if (action === "range") {
    openSuggestionForm("range");
  } else if (action === "view") {
    openSuggestionInbox();
  }
});

featureSuggestionCancel?.addEventListener("click", () => {
  closeSuggestionForm();
});

featureSuggestionSubmit?.addEventListener("click", () => {
  const message = featureSuggestionMessage?.value?.trim() || "（入力なし）";
  const modeLabel = suggestionState.mode === "range" ? "範囲指定" : "バージョンアップ希望";
  showToast(`${modeLabel}を送信しました: ${message}`);
  closeFeatureSuggestionFloat();
});

document.addEventListener("pointerdown", (event)=>{
  if (!featureSuggestionFloat?.classList.contains("is-open")) return;
  if (!(event.target instanceof HTMLElement)) return;
  if (featureSuggestionFloat.contains(event.target)) return;
  closeFeatureSuggestionFloat();
});

let longPressTimer = null;
let longPressStart = null;
let longPressTarget = null;
const LONG_PRESS_DURATION = 520;
const LONG_PRESS_TOLERANCE = 12;

const clearLongPress = () => {
  if (longPressTimer) {
    window.clearTimeout(longPressTimer);
  }
  longPressTimer = null;
  longPressStart = null;
  longPressTarget = null;
};

document.addEventListener("pointerdown", (event)=>{
  if (event.button && event.button !== 0) return;
  if (!(event.target instanceof HTMLElement)) return;
  if (!isSuggestionEligibleTarget(event.target)) return;
  longPressTarget = event.target;
  longPressStart = { x: event.clientX, y: event.clientY };
  longPressTimer = window.setTimeout(() => {
    const selectionText = getSelectionText();
    const targetLabel = selectionText ? "選択範囲" : getSuggestionLabelFromTarget(longPressTarget);
    const targetRect = selectionText ? getSelectionRect() : getTargetRectFromElement(longPressTarget);
    openFeatureSuggestionFloat({ x: event.clientX, y: event.clientY, selectionText, targetLabel, targetRect });
  }, LONG_PRESS_DURATION);
}, { passive: true });

document.addEventListener("pointermove", (event)=>{
  if (!longPressStart) return;
  const distance = Math.hypot(event.clientX - longPressStart.x, event.clientY - longPressStart.y);
  if (distance > LONG_PRESS_TOLERANCE) {
    clearLongPress();
  }
});

document.addEventListener("pointerup", clearLongPress);
document.addEventListener("pointercancel", clearLongPress);
document.addEventListener("scroll", clearLongPress, true);

document.addEventListener("contextmenu", (event)=>{
  const target = event.target;
  if (!(target instanceof HTMLElement)) return;
  const selectionText = getSelectionText();
  if (!selectionText && !isSuggestionEligibleTarget(target)) return;
  event.preventDefault();
  const targetLabel = selectionText ? "選択範囲" : getSuggestionLabelFromTarget(target);
  const targetRect = selectionText ? getSelectionRect() : getTargetRectFromElement(target);
  openFeatureSuggestionFloat({ x: event.clientX, y: event.clientY, selectionText, targetLabel, targetRect });
});

document.addEventListener("mouseup", (event)=>{
  if (event.button !== 0) return;
  const selectionText = getSelectionText();
  if (!selectionText) return;
  const rect = getSelectionRect();
  if (!rect) return;
  const x = rect.left + rect.width / 2;
  const y = rect.top;
  openFeatureSuggestionFloat({ x, y, selectionText, targetLabel: "選択範囲", targetRect: rect });
});
suggestionModalClose?.addEventListener("click", closeSuggestionModal);
suggestionCancel?.addEventListener("click", closeSuggestionModal);
suggestionModal?.addEventListener("click", (event) => {
  if (event.target !== suggestionModal) return;
  closeSuggestionModal();
});
suggestionInboxClose?.addEventListener("click", closeSuggestionInbox);
suggestionInboxModal?.addEventListener("click", (event) => {
  if (event.target !== suggestionInboxModal) return;
  closeSuggestionInbox();
});
issueModalClose?.addEventListener("click", closeIssueModal);
issueCancel?.addEventListener("click", closeIssueModal);
issueModal?.addEventListener("click", (event) => {
  if (event.target !== issueModal) return;
  closeIssueModal();
});
issueInboxClose?.addEventListener("click", closeIssueInbox);
issueInboxModal?.addEventListener("click", (event) => {
  if (event.target !== issueInboxModal) return;
  closeIssueInbox();
});
suggestionInboxList?.addEventListener("click", (event) => {
  const target = event.target instanceof HTMLElement ? event.target : null;
  if (!target) return;
  const button = target.closest("[data-suggestion-reply]");
  if (!button) return;
  const groupKey = button.getAttribute("data-group-key");
  const groupId = button.getAttribute("data-group-id");
  const replyLabel = button.getAttribute("data-suggestion-reply");
  const context = button.getAttribute("data-context") || "";
  handleSuggestionReply({ groupKey, groupId, replyLabel, context });
});
issueInboxList?.addEventListener("click", (event) => {
  const target = event.target instanceof HTMLElement ? event.target : null;
  if (!target) return;
  const replyButton = target.closest("[data-issue-reply]");
  const addButton = target.closest("[data-issue-reply-add]");
  const sendButton = target.closest("[data-issue-reply-send]");
  if (addButton) {
    const nextTag = window.prompt("追加するタグを入力してください。");
    if (!nextTag) return;
    const tags = readIssueTags();
    if (!tags.includes(nextTag)) {
      tags.push(nextTag);
      writeIssueTags(tags);
    }
    renderIssueInbox();
    return;
  }
  if (replyButton) {
    const replyLabel = replyButton.getAttribute("data-issue-reply");
    const groupKey = replyButton.getAttribute("data-group-key");
    const groupId = replyButton.getAttribute("data-group-id");
    const commentEl = issueInboxList.querySelector(`[data-issue-reply-comment][data-group-key="${groupKey}"]`);
    const comment = commentEl instanceof HTMLTextAreaElement ? commentEl.value.trim() : "";
    handleIssueReply({ groupKey, groupId, replyLabel, comment });
    return;
  }
  if (sendButton) {
    const groupKey = sendButton.getAttribute("data-group-key");
    const groupId = sendButton.getAttribute("data-group-id");
    const commentEl = issueInboxList.querySelector(`[data-issue-reply-comment][data-group-key="${groupKey}"]`);
    const comment = commentEl instanceof HTMLTextAreaElement ? commentEl.value.trim() : "";
    handleIssueReply({ groupKey, groupId, replyLabel: "回答済み", comment });
  }
});
issueTagList?.addEventListener("click", (event) => {
  const target = event.target instanceof HTMLElement ? event.target : null;
  const tagButton = target?.closest("[data-tag]");
  const addButton = target?.closest("[data-tag-add]");
  if (addButton) {
    const nextTag = window.prompt("追加するタグを入力してください。");
    if (!nextTag) return;
    const tags = readIssueTags();
    if (!tags.includes(nextTag)) {
      tags.push(nextTag);
      writeIssueTags(tags);
    }
    issueState.selectedTags.add(nextTag);
    renderIssueTags();
    return;
  }
  if (tagButton) {
    const tag = tagButton.getAttribute("data-tag");
    if (!tag) return;
    if (issueState.selectedTags.has(tag)) {
      issueState.selectedTags.delete(tag);
    } else {
      issueState.selectedTags.add(tag);
    }
    renderIssueTags();
  }
});
suggestionSubmit?.addEventListener("click", submitSuggestion);
suggestionInboxHeaderButton?.addEventListener("click", openSuggestionInbox);
suggestionReplyHeaderButton?.addEventListener("click", openSuggestionInbox);
issueSubmit?.addEventListener("click", submitIssue);
issueInboxHeaderButton?.addEventListener("click", openIssueInbox);
changeHistoryModalClose?.addEventListener("click", closeChangeHistoryModal);
changeHistoryModal?.addEventListener("click", (e)=>{
  if (e.target !== changeHistoryModal) return;
  closeChangeHistoryModal();
});
document.addEventListener("keydown", (e)=>{
  if (e.key !== "Escape") return;
  if (featureSuggestionFloat?.classList.contains("is-open")) {
    closeFeatureSuggestionFloat();
    return;
  }
  if (suggestionRangeOverlay?.classList.contains("is-active")) {
    closeRangeSelection();
    return;
  }
  if (suggestionModal?.classList.contains("open")) {
    closeSuggestionModal();
    return;
  }
  if (issueModal?.classList.contains("open")) {
    closeIssueModal();
    return;
  }
  if (suggestionInboxModal?.classList.contains("open")) {
    closeSuggestionInbox();
    return;
  }
  if (issueInboxModal?.classList.contains("open")) {
    closeIssueInbox();
    return;
  }
  if (placementSelection) {
    resetPlacementSelection();
    return;
  }
  if (teacherLineLinkModal?.classList.contains("open")) {
    closeTeacherLineModal();
    return;
  }
  if (changeHistoryModal?.classList.contains("open")) {
    closeChangeHistoryModal();
    return;
  }
  if (typeChangeModal?.classList.contains("open")) {
    closeTypeChangeModal();
    return;
  }
  if (!typeBulkModal?.classList.contains("open")) return;
  typeBulkModal.classList.remove("open");
  typeBulkModal.setAttribute("aria-hidden", "true");
});
applyBulkTypeBtn?.addEventListener("click", applyBulkTypeChange);
</script>
</body>
</html>
