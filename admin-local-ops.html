<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ローカル運用管理</title>
  <style>
    :root {
      --accent: #8b5cf6;
      --accent-2: #22d3ee;
      --panel: #0f172a;
      --panel-2: #111827;
      --border: #1f2937;
      --text: #e2e8f0;
      --sub: #cbd5e1;
      --danger: #f87171;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Noto Sans JP","Inter",system-ui,-apple-system,"Segoe UI",sans-serif;
      background: radial-gradient(circle at 12% 16%, rgba(139,92,246,.14), transparent 32%),
                  radial-gradient(circle at 78% 14%, rgba(34,211,238,.18), transparent 32%),
                  linear-gradient(180deg,#0b1021,#0f172a);
      color: var(--text);
      min-height: 100vh;
    }
    .container {
      max-width: 1160px;
      margin: 0 auto;
      padding: 24px 18px 42px;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 18px;
    }
    h1 { margin: 0; font-size: 22px; }
    .muted { color: var(--sub); font-size: 13px; }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: linear-gradient(120deg,var(--accent),var(--accent-2));
      color: #0b1021;
      font-weight: 900;
      text-decoration: none;
      cursor: pointer;
    }
    .btn.secondary {
      background: rgba(255,255,255,.05);
      color: var(--text);
      box-shadow: none;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px;
      align-items: start;
    }
    .card {
      border: 1px solid var(--border);
      border-radius: 14px;
      background: linear-gradient(160deg, rgba(255,255,255,.06), rgba(255,255,255,.03)), var(--panel-2);
      padding: 16px;
      box-shadow: 0 14px 34px rgba(0,0,0,.32);
    }
    .card h2 { margin: 0 0 8px; font-size: 18px; }
    .section-title { font-size: 16px; margin: 16px 0 8px; }
    label { display: block; font-weight: 700; font-size: 13px; color: var(--sub); }
    input, textarea, select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      font: inherit;
    }
    textarea { min-height: 70px; resize: vertical; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .status-text { margin-top: 6px; font-weight: 700; color: var(--sub); font-size: 13px; }
    .status-text.error { color: #fecdd3; }
    .toggle-item {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      margin-top: 8px;
    }
    .toggle-item input { margin-top: 4px; }
    .meta-chip {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid rgba(34,211,238,.3);
      background: rgba(34,211,238,.12);
      color: #bae6fd;
      font-weight: 700;
      font-size: 12px;
    }
    .list {
      display: grid;
      gap: 10px;
      margin-top: 12px;
    }
    .list-item {
      display: grid;
      gap: 8px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
    }
    .list-item .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .small-btn {
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.2);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight: 700;
      cursor: pointer;
    }
    .small-btn.danger {
      border-color: rgba(248,113,113,.45);
      color: #fecdd3;
    }
    .preview {
      width: 100%;
      min-height: 260px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #0b1021;
    }
    .qr-modal {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.72);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 100;
    }
    .qr-card {
      background: #0f172a;
      border-radius: 16px;
      padding: 20px;
      border: 1px solid var(--border);
      text-align: center;
    }
    .qr-card img { width: 220px; height: 220px; background: #fff; padding: 12px; border-radius: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>ローカル運用管理</h1>
        <div class="muted">FastAPI設定とHTML配布を1画面で管理できます。</div>
      </div>
      <div class="row">
        <a class="btn secondary" href="/admin/settings/wifi-local">旧Wi-Fi設定</a>
        <a class="btn secondary" href="/admin/login">管理ログイン</a>
      </div>
    </header>

    <div class="grid">
      <section class="card" id="fastapi-section">
        <h2>FastAPI ローカル設定</h2>
        <div class="row" style="margin-top:6px;">
          <span class="meta-chip" id="healthStatus">/health: 未確認</span>
          <span class="muted" id="healthTimestamp">最終確認: -</span>
        </div>

        <div class="section-title">サーバ状態</div>
        <label class="toggle-item">
          <input type="checkbox" id="fastapiEnabled">
          <div>
            <strong>FastAPI 稼働状態を有効化</strong>
            <span class="muted">OFFの場合はローカルアクセスを遮断します。</span>
          </div>
        </label>

        <div class="section-title">ネットワーク制御</div>
        <label for="allowedCidrs">allowed_cidr（複数行）</label>
        <textarea id="allowedCidrs" placeholder="192.168.0.0/24&#10;fd00::/64"></textarea>
        <div class="status-text" id="clientIpStatus">接続元IP: -</div>

        <div class="section-title">簡易セキュリティ</div>
        <label>共有トークン（X-Local-Token）</label>
        <div class="row">
          <input id="sharedToken" type="password">
          <button class="btn secondary" type="button" id="regenToken">再生成</button>
        </div>
        <div class="section-title">トークン必須API</div>
        <label class="toggle-item">
          <input type="checkbox" id="requireSaveToken">
          <div>
            <strong>POST /save</strong>
            <span class="muted">更新系APIの保護</span>
          </div>
        </label>
        <label class="toggle-item">
          <input type="checkbox" id="requireSyncToken">
          <div>
            <strong>POST /sync</strong>
            <span class="muted">同期APIの保護</span>
          </div>
        </label>
        <label class="toggle-item">
          <input type="checkbox" id="requireLatestToken">
          <div>
            <strong>GET /latest</strong>
            <span class="muted">公開する場合はOFF</span>
          </div>
        </label>

        <div class="section-title">ローカルモード</div>
        <label class="toggle-item">
          <input type="checkbox" id="localMode">
          <div>
            <strong>ローカル運用モードを有効化</strong>
            <span class="muted">OFFの場合は更新系APIを拒否します。</span>
          </div>
        </label>

        <div class="row" style="margin-top:14px;">
          <button class="btn" type="button" id="saveFastApi">設定を保存</button>
          <button class="btn secondary" type="button" id="healthCheck">/health 確認</button>
        </div>
        <div class="status-text" id="fastApiStatus"></div>
      </section>

      <section class="card" id="apps-section">
        <h2>Apps / HTML配布</h2>
        <div class="muted">HTMLの置き場を固定し、最新ファイルを配布します。</div>

        <div class="section-title">HTMLアップロード</div>
        <div class="row">
          <input id="appKey" placeholder="app_key (例: calcu)">
          <input id="appName" placeholder="App名 (例: CalCu)">
        </div>
        <div class="row" style="margin-top:8px;">
          <input id="appFile" type="file" accept=".html">
          <button class="btn" type="button" id="uploadApp">アップロード</button>
        </div>
        <div class="status-text" id="appsStatus"></div>

        <div class="section-title">配布中のApps</div>
        <div class="list" id="appsList"></div>

        <div class="section-title">プレビュー</div>
        <iframe id="appPreview" class="preview" title="App preview"></iframe>
      </section>
    </div>
  </div>

  <div class="qr-modal" id="qrModal">
    <div class="qr-card">
      <div class="muted" style="margin-bottom:8px;">iPadで読み込み</div>
      <img id="qrImage" alt="QR Code">
      <div class="row" style="margin-top:12px; justify-content:center;">
        <button class="btn secondary" type="button" id="closeQr">閉じる</button>
      </div>
    </div>
  </div>

  <script>
    const fastApiStatus = document.getElementById("fastApiStatus");
    const healthStatus = document.getElementById("healthStatus");
    const healthTimestamp = document.getElementById("healthTimestamp");
    const clientIpStatus = document.getElementById("clientIpStatus");
    const appsStatus = document.getElementById("appsStatus");
    const appsList = document.getElementById("appsList");
    const appPreview = document.getElementById("appPreview");
    const qrModal = document.getElementById("qrModal");
    const qrImage = document.getElementById("qrImage");

    function setStatus(el, message, isError = false) {
      if (!el) return;
      el.textContent = message;
      el.classList.toggle("error", !!isError);
    }

    async function loadFastApiSettings() {
      const res = await fetch("/admin/settings/fastapi-local");
      if (!res.ok) {
        setStatus(fastApiStatus, "設定取得に失敗しました。", true);
        return;
      }
      const data = await res.json();
      document.getElementById("fastapiEnabled").checked = !!data.enabled;
      document.getElementById("allowedCidrs").value = (data.allowed_cidr_list || []).join("\n");
      document.getElementById("sharedToken").value = data.shared_token || "";
      document.getElementById("localMode").checked = !!data.local_mode;
      document.getElementById("requireSaveToken").checked = !!data.require_save_token;
      document.getElementById("requireSyncToken").checked = !!data.require_sync_token;
      document.getElementById("requireLatestToken").checked = !!data.require_latest_token;
      const ipText = data.client_ip ? `接続元IP: ${data.client_ip}` : "接続元IP: 不明";
      const allowText = data.client_allowed ? "許可されています" : "許可されていません";
      clientIpStatus.textContent = `${ipText} (${allowText})`;
      clientIpStatus.classList.toggle("error", !data.client_allowed);
      setStatus(fastApiStatus, "設定を読み込みました。");
    }

    async function saveFastApiSettings() {
      const payload = {
        enabled: document.getElementById("fastapiEnabled").checked,
        allowed_cidr_list: document.getElementById("allowedCidrs").value.split("\n")
          .map(line => line.trim()).filter(Boolean),
        shared_token: document.getElementById("sharedToken").value,
        local_mode: document.getElementById("localMode").checked,
        require_save_token: document.getElementById("requireSaveToken").checked,
        require_sync_token: document.getElementById("requireSyncToken").checked,
        require_latest_token: document.getElementById("requireLatestToken").checked
      };
      const res = await fetch("/admin/settings/fastapi-local", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        setStatus(fastApiStatus, data.detail || "保存に失敗しました。", true);
        return;
      }
      setStatus(fastApiStatus, "設定を保存しました。");
      await loadFastApiSettings();
    }

    async function regenerateToken() {
      const res = await fetch("/admin/settings/fastapi-local/regenerate-token", { method: "POST" });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        setStatus(fastApiStatus, data.detail || "再生成に失敗しました。", true);
        return;
      }
      document.getElementById("sharedToken").value = data.shared_token || "";
      setStatus(fastApiStatus, "トークンを再生成しました。");
    }

    async function checkHealth() {
      const res = await fetch("/health");
      const now = new Date();
      if (!res.ok) {
        healthStatus.textContent = "/health: NG";
        healthStatus.style.borderColor = "rgba(248,113,113,.45)";
        setStatus(fastApiStatus, "ヘルスチェックに失敗しました。", true);
      } else {
        healthStatus.textContent = "/health: OK";
        setStatus(fastApiStatus, "ヘルスチェック成功。");
      }
      healthTimestamp.textContent = `最終確認: ${now.toLocaleString()}`;
    }

    async function loadApps() {
      const res = await fetch("/admin/apps");
      if (!res.ok) {
        setStatus(appsStatus, "Apps一覧の取得に失敗しました。", true);
        return;
      }
      const data = await res.json();
      const items = data.items || [];
      if (!items.length) {
        appsList.innerHTML = `<div class="muted">登録済みのAppsはありません。</div>`;
        return;
      }
      appsList.innerHTML = items.map(app => `
        <div class="list-item">
          <div>
            <strong>${app.app_name} (${app.app_key})</strong><br>
            <span class="muted">${app.filename} / ${app.version_label}</span><br>
            <span class="muted">更新者: ${app.updated_by} / ${new Date(app.updated_at).toLocaleString()}</span>
          </div>
          <div class="actions">
            <button class="small-btn" data-preview="${app.app_key}">表示</button>
            <a class="small-btn" href="/admin/apps/${app.app_key}/download">ダウンロード</a>
            <button class="small-btn" data-copy="${app.app_key}">共有URLコピー</button>
            <button class="small-btn" data-qr="${app.app_key}">QR表示</button>
          </div>
        </div>
      `).join("");

      appsList.querySelectorAll("button[data-preview]").forEach(btn => {
        btn.addEventListener("click", () => {
          const key = btn.dataset.preview;
          appPreview.src = `/apps/${key}/latest`;
        });
      });
      appsList.querySelectorAll("button[data-copy]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const key = btn.dataset.copy;
          const url = `${window.location.origin}/apps/${key}/latest`;
          await navigator.clipboard.writeText(url);
          setStatus(appsStatus, "共有URLをコピーしました。");
        });
      });
      appsList.querySelectorAll("button[data-qr]").forEach(btn => {
        btn.addEventListener("click", () => {
          const key = btn.dataset.qr;
          qrImage.src = `/admin/apps/${key}/qr`;
          qrModal.style.display = "flex";
        });
      });
    }

    async function uploadApp() {
      const appKey = document.getElementById("appKey").value.trim();
      const appName = document.getElementById("appName").value.trim();
      const fileInput = document.getElementById("appFile");
      const file = fileInput.files[0];
      if (!appKey || !appName || !file) {
        setStatus(appsStatus, "app_key / App名 / HTMLファイルを指定してください。", true);
        return;
      }
      const formData = new FormData();
      formData.append("app_name", appName);
      formData.append("file", file);
      const res = await fetch(`/admin/apps/${appKey}/upload`, {
        method: "POST",
        body: formData
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        setStatus(appsStatus, data.detail || "アップロードに失敗しました。", true);
        return;
      }
      setStatus(appsStatus, "アップロードしました。");
      fileInput.value = "";
      await loadApps();
    }

    document.getElementById("saveFastApi").addEventListener("click", saveFastApiSettings);
    document.getElementById("regenToken").addEventListener("click", regenerateToken);
    document.getElementById("healthCheck").addEventListener("click", checkHealth);
    document.getElementById("uploadApp").addEventListener("click", uploadApp);
    document.getElementById("closeQr").addEventListener("click", () => {
      qrModal.style.display = "none";
    });

    loadFastApiSettings();
    checkHealth();
    loadApps();
  </script>
</body>
</html>
